---
milestone: v1.1
audited: 2026-02-26T12:30:00Z
status: gaps_found
scores:
  requirements: 15/17
  phases: 3/3
  integration: 8/8
  flows: 3/3
gaps:
  requirements:
    - id: "EMAL-02"
      status: "unsatisfied"
      phase: "Phase 12"
      claimed_by_plans: []
      completed_by_plans: []
      verification_status: "missing"
      evidence: "Phase 12 (Email Notifications Wiring) not started. No phase directory, no plans, no implementation. REQUIREMENTS.md shows [ ] unchecked."
    - id: "EMAL-03"
      status: "unsatisfied"
      phase: "Phase 12"
      claimed_by_plans: []
      completed_by_plans: []
      verification_status: "missing"
      evidence: "Phase 12 (Email Notifications Wiring) not started. No phase directory, no plans, no implementation. REQUIREMENTS.md shows [ ] unchecked."
  integration: []
  flows: []
tech_debt:
  - phase: 11-pre-booking
    items:
      - "INFO: app/books/router.py line 142 — '# Phase 12 wires email here' comment + `_ = notified_user_ids` (intentional stub for Phase 12)"
  - phase: 10-admin-user-management
    items:
      - "INFO: JWT email claim decision still open (STATE.md) — Phase 12 needs user email for restock alerts; choose between DB fetch or adding email to JWT"
---

# Milestone v1.1 Audit: Pre-booking, Notifications & Admin

**Audited:** 2026-02-26
**Status:** gaps_found
**Milestone Goal:** Enable users to reserve out-of-stock books and receive email notifications; give admins user lifecycle management.

---

## Requirements Coverage (15/17)

### 3-Source Cross-Reference

| REQ-ID | Description | VERIFICATION.md | SUMMARY frontmatter | REQUIREMENTS.md | Final |
|--------|-------------|----------------|--------------------|-----------------|----|
| EMAL-01 | Email infrastructure with async SMTP | Phase 9: SATISFIED | 09-02: listed | `[x]` | satisfied |
| EMAL-02 | Order confirmation email after checkout | Phase 12: missing | not listed | `[ ]` | **UNSATISFIED** |
| EMAL-03 | Restock alert email for pre-booked books | Phase 12: missing | not listed | `[ ]` | **UNSATISFIED** |
| EMAL-04 | Jinja2 HTML templates with plain-text | Phase 9: SATISFIED | 09-02: listed | `[x]` | satisfied |
| EMAL-05 | Email never blocks API response | Phase 9: SATISFIED | 09-02: listed | `[x]` | satisfied |
| EMAL-06 | Email only after DB commit | Phase 9: SATISFIED | 09-02: listed | `[x]` | satisfied |
| ADMN-01 | Admin paginated user list | Phase 10: SATISFIED | 10-02: listed | `[x]` | satisfied |
| ADMN-02 | Admin filter by role/active status | Phase 10: SATISFIED | 10-02: listed | `[x]` | satisfied |
| ADMN-03 | Admin deactivate user + revoke tokens | Phase 10: SATISFIED | 10-02: listed | `[x]` | satisfied |
| ADMN-04 | Admin reactivate user | Phase 10: SATISFIED | 10-02: listed | `[x]` | satisfied |
| ADMN-05 | Admin cannot deactivate admin accounts | Phase 10: SATISFIED | 10-02: listed | `[x]` | satisfied |
| PRBK-01 | User can pre-book out-of-stock book | Phase 11: SATISFIED | 11-02: listed | `[x]` | satisfied |
| PRBK-02 | User can view pre-bookings | Phase 11: SATISFIED | 11-02: listed | `[x]` | satisfied |
| PRBK-03 | User can cancel pre-booking | Phase 11: SATISFIED | 11-02: listed | `[x]` | satisfied |
| PRBK-04 | Pre-booking rejected if in stock (409) | Phase 11: SATISFIED | 11-02: listed | `[x]` | satisfied |
| PRBK-05 | Status tracking with timestamps | Phase 11: SATISFIED | 11-02: listed | `[x]` | satisfied |
| PRBK-06 | Restock broadcast to all waiters | Phase 11: SATISFIED | 11-02: listed | `[x]` | satisfied |

### Unsatisfied Requirements

- **EMAL-02: Order confirmation email after checkout** (Phase 12)
  - Phase 12 not started — no directory, no plans, no implementation
  - EmailService infrastructure ready (Phase 9), checkout endpoint exists (Phase 7), but no email dispatch wiring

- **EMAL-03: Restock alert email for pre-booked books** (Phase 12)
  - Phase 12 not started — `notified_user_ids` captured in `app/books/router.py` line 139 but assigned to `_`
  - EmailService infrastructure ready (Phase 9), notification broadcast works (Phase 11), but no email dispatch wiring

---

## Phase Verification (3/3 complete phases)

| Phase | Status | Score | Tests | Key Deliverables |
|-------|--------|-------|-------|-----------------|
| 9. Email Infrastructure | passed | 9/9 | 10 | EmailService, base.html template, BackgroundTasks pipeline |
| 10. Admin User Management | passed | 7/7 | 21 | Admin user list/deactivate/reactivate, ActiveUser dep |
| 11. Pre-booking | passed | 7/7 | 18 | PreBooking CRUD, restock broadcast, partial unique index |

All 3 implemented phases passed verification. No gaps in implemented phases.

---

## Cross-Phase Integration (8/8 wired)

| Connection | From → To | Status |
|-----------|-----------|--------|
| ActiveUser protects /prebooks | Phase 10 → Phase 11 | WIRED |
| AdminUser protects /books/{id}/stock | Phase 10 → Phase 11 | WIRED |
| set_stock_and_notify restock bridge | Phase 11 BookService → Phase 11 PreBookRepo | WIRED |
| EmailSvc ready for Phase 12 | Phase 9 → (Phase 12) | Intentionally orphaned |
| is_active check in login | Phase 10 AuthService | WIRED |
| revoke_all_for_user atomic deactivation | Phase 10 AdminService → RefreshTokenRepo | WIRED |
| MAIL_* settings → EmailService | Phase 9 config → Phase 9 service | WIRED |
| AdminUser chains through get_active_user | Phase 10 deps | WIRED |

**No broken connections.** 1 intentionally orphaned export (EmailSvc — awaits Phase 12 consumers).

---

## E2E Flow Verification (3/3 complete)

### Flow 1: User Pre-Books and Gets Notified on Restock
Login → POST /prebooks (201) → Admin PATCH /books/{id}/stock → notify_waiting_by_book → GET /prebooks shows "notified" + notified_at
**Status:** Complete through status update. Email dispatch is Phase 12.

### Flow 2: Admin Deactivates User, Immediate Lockout
Admin PATCH /admin/users/{id}/deactivate → is_active=false + tokens revoked → User's access token rejected (403) → Login blocked (403) → Admin reactivates → Login works
**Status:** Complete. Integration-tested with 21 tests.

### Flow 3: Email Infrastructure Pipeline
EmailService.enqueue() → BackgroundTasks.add_task() → post-response dispatch → Jinja2 render → plain-text fallback → SUPPRESS_SEND in tests
**Status:** Complete. Pipeline tested end-to-end with 10 tests.

---

## Tech Debt

| Phase | Item | Severity |
|-------|------|----------|
| 11 | `_ = notified_user_ids` stub comment in books/router.py | INFO (Phase 12 will resolve) |
| 10 | JWT email claim decision open in STATE.md | INFO (must resolve before Phase 12 planning) |

---

## Summary

- **15/17** requirements satisfied across 3 completed phases
- **2 unsatisfied** requirements (EMAL-02, EMAL-03) assigned to Phase 12 which has not been started
- **0 integration gaps** in implemented code
- **0 broken E2E flows**
- **49 total tests** across phases 9-11 (10 + 21 + 18)
- All implemented phases verified and UAT-passed

The milestone cannot be marked complete until Phase 12 delivers EMAL-02 and EMAL-03.

---

*Audited: 2026-02-26*
*Auditor: Claude (gsd-audit-milestone)*
