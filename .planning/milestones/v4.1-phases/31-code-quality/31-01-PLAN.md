---
phase: 31-code-quality
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - frontend/src/components/admin/DeltaBadge.tsx
  - frontend/src/components/admin/StockBadge.tsx
  - frontend/src/app/admin/overview/page.tsx
  - frontend/src/app/admin/sales/page.tsx
  - frontend/src/app/admin/catalog/page.tsx
  - frontend/src/app/admin/inventory/page.tsx
  - frontend/src/lib/admin.ts
autonomous: true
requirements:
  - COMP-01
  - COMP-02
  - TYPE-01

must_haves:
  truths:
    - "DeltaBadge renders identically on overview and sales pages, sourced from a single shared file"
    - "StockBadge renders identically on catalog and inventory pages, sourced from a single shared file with a threshold parameter"
    - "No inline DeltaBadge or StockBadge definitions remain in any page file"
    - "updateBookStock returns Promise<BookResponse> with no type errors or casts"
  artifacts:
    - path: "frontend/src/components/admin/DeltaBadge.tsx"
      provides: "Shared DeltaBadge component"
      exports: ["DeltaBadge"]
    - path: "frontend/src/components/admin/StockBadge.tsx"
      provides: "Shared StockBadge component with threshold parameter"
      exports: ["StockBadge"]
  key_links:
    - from: "frontend/src/app/admin/overview/page.tsx"
      to: "frontend/src/components/admin/DeltaBadge.tsx"
      via: "named import"
      pattern: "import.*DeltaBadge.*from.*components/admin/DeltaBadge"
    - from: "frontend/src/app/admin/sales/page.tsx"
      to: "frontend/src/components/admin/DeltaBadge.tsx"
      via: "named import"
      pattern: "import.*DeltaBadge.*from.*components/admin/DeltaBadge"
    - from: "frontend/src/app/admin/catalog/page.tsx"
      to: "frontend/src/components/admin/StockBadge.tsx"
      via: "named import"
      pattern: "import.*StockBadge.*from.*components/admin/StockBadge"
    - from: "frontend/src/app/admin/inventory/page.tsx"
      to: "frontend/src/components/admin/StockBadge.tsx"
      via: "named import"
      pattern: "import.*StockBadge.*from.*components/admin/StockBadge"
---

<objective>
Extract duplicated DeltaBadge and StockBadge inline components into shared admin component files, and fix the updateBookStock return type.

Purpose: Eliminate duplicated component implementations across admin pages (COMP-01, COMP-02), and correct the TypeScript return type for updateBookStock so it matches the actual backend response (TYPE-01).

Output: Two new shared component files (DeltaBadge.tsx, StockBadge.tsx), four updated page files with inline definitions removed, and a corrected type in admin.ts.
</objective>

<execution_context>
@C:/Users/Sushasan/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Sushasan/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/31-code-quality/31-CONTEXT.md

<interfaces>
<!-- Key types and contracts the executor needs. Extracted from codebase. -->
<!-- Executor should use these directly — no codebase exploration needed. -->

From frontend/src/app/admin/overview/page.tsx (lines 33-49) — DeltaBadge to extract:
```typescript
function DeltaBadge({ delta }: { delta: number | null }) {
  if (delta === null || delta === 0) {
    return <span className="text-muted-foreground text-sm">— 0%</span>
  }
  if (delta > 0) {
    return (
      <span className="text-green-600 dark:text-green-400 text-sm font-medium">
        ▲ {delta.toFixed(1)}%
      </span>
    )
  }
  return (
    <span className="text-red-600 dark:text-red-400 text-sm font-medium">
      ▼ {Math.abs(delta).toFixed(1)}%
    </span>
  )
}
```

From frontend/src/app/admin/inventory/page.tsx (lines 17-33) — StockBadge to extract (this is the version with threshold parameter):
```typescript
function StockBadge({ stock, threshold }: { stock: number; threshold: number }) {
  if (stock === 0) {
    return (
      <Badge className="bg-red-100 text-red-700 border-red-200 dark:bg-red-900/30 dark:text-red-400">
        Out of Stock
      </Badge>
    )
  }
  if (stock <= threshold) {
    return (
      <Badge className="bg-amber-100 text-amber-700 border-amber-200 dark:bg-amber-900/30 dark:text-amber-400">
        Low Stock ({stock})
      </Badge>
    )
  }
  return <span className="font-medium">{stock}</span>
}
```

From frontend/src/lib/admin.ts (lines 140-153) — updateBookStock to fix:
```typescript
export async function updateBookStock(
  accessToken: string,
  bookId: number,
  quantity: number
): Promise<void> {              // BUG: should be Promise<BookResponse>
  return apiFetch<void>(        // BUG: should be apiFetch<BookResponse>
    `/books/${bookId}/stock`,
    {
      method: 'PATCH',
      body: JSON.stringify({ quantity }),
      headers: { Authorization: `Bearer ${accessToken}` },
    }
  )
}
```

From frontend/src/lib/admin.ts (line 8) — BookResponse type already imported:
```typescript
type BookResponse = components['schemas']['BookResponse']
```

From frontend/src/components/ui/badge.tsx — Badge component used by StockBadge (already exists, import path: `@/components/ui/badge`).
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create shared DeltaBadge and StockBadge component files</name>
  <files>frontend/src/components/admin/DeltaBadge.tsx, frontend/src/components/admin/StockBadge.tsx</files>
  <action>
Create two new component files in the existing `frontend/src/components/admin/` directory:

**DeltaBadge.tsx:**
- Export a named function `DeltaBadge` with props `{ delta: number | null }`.
- Copy the exact rendering logic from overview/page.tsx lines 33-49 (see interfaces block above).
- No `'use client'` directive needed — this is a pure presentational component that will be imported into client components.
- No additional imports needed — it renders only `<span>` elements.

**StockBadge.tsx:**
- Export a named function `StockBadge` with props `{ stock: number; threshold: number }`.
- Use the inventory page version (which accepts `threshold` as a parameter) — see interfaces block above.
- Import `Badge` from `@/components/ui/badge`.
- The catalog page version hardcodes `threshold=10`; the shared version requires it explicitly. Catalog call sites will pass `threshold={10}` explicitly.
- No `'use client'` directive needed — pure presentational component.

Both files follow the flat `components/admin/` convention (no sub-folders).
  </action>
  <verify>
    <automated>cd frontend && npx tsc --noEmit --pretty 2>&1 | head -30</automated>
  </verify>
  <done>DeltaBadge.tsx exports DeltaBadge function, StockBadge.tsx exports StockBadge function with required threshold parameter, both compile without errors</done>
</task>

<task type="auto">
  <name>Task 2: Replace inline definitions with shared imports and fix updateBookStock type</name>
  <files>frontend/src/app/admin/overview/page.tsx, frontend/src/app/admin/sales/page.tsx, frontend/src/app/admin/catalog/page.tsx, frontend/src/app/admin/inventory/page.tsx, frontend/src/lib/admin.ts</files>
  <action>
**overview/page.tsx:**
- Add import: `import { DeltaBadge } from '@/components/admin/DeltaBadge'`
- Remove the inline `DeltaBadge` function definition (lines 33-49) and the comment line above it (line 32: `// Helper components` section header, and line 31: the `// -----------` separator). Keep the `// Types` section and `formatCurrency` helper.
- All existing `<DeltaBadge delta={delta} />` usages remain unchanged.

**sales/page.tsx:**
- Add import: `import { DeltaBadge } from '@/components/admin/DeltaBadge'`
- Remove the inline `DeltaBadge` function definition (lines 46-62) and the helper components comment/separator above it (lines 44-45).
- Keep the `formatCurrency` helper.
- All existing `<DeltaBadge delta={delta} />` usages remain unchanged.

**catalog/page.tsx:**
- Add import: `import { StockBadge } from '@/components/admin/StockBadge'`
- Remove the inline `StockBadge` function definition (lines 49-65).
- Remove the `Badge` import from `@/components/ui/badge` (line 21) since it was only used by the inline StockBadge. Verify Badge is not used elsewhere in the file first — it is NOT used elsewhere, so safe to remove.
- Update the StockBadge usage in the stock column cell (line ~236): change `<StockBadge stock={row.original.stock_quantity} />` to `<StockBadge stock={row.original.stock_quantity} threshold={10} />` (explicit threshold per COMP-02 decision).

**inventory/page.tsx:**
- Add import: `import { StockBadge } from '@/components/admin/StockBadge'`
- Remove the inline `StockBadge` function definition (lines 17-33).
- Remove the `Badge` import from `@/components/ui/badge` (line 12) since it was only used by the inline StockBadge.
- Existing usage `<StockBadge stock={item.current_stock} threshold={debouncedThreshold} />` already passes threshold, so no change needed.

**admin.ts (TYPE-01):**
- Change `updateBookStock` return type from `Promise<void>` to `Promise<BookResponse>` (line 144).
- Change `apiFetch<void>` to `apiFetch<BookResponse>` in the implementation (line 145).
- `BookResponse` type is already defined at line 8 (`type BookResponse = components['schemas']['BookResponse']`), so no new import needed.
  </action>
  <verify>
    <automated>cd frontend && npx tsc --noEmit --pretty 2>&1 | head -30</automated>
  </verify>
  <done>All four page files import from shared components with zero inline DeltaBadge/StockBadge definitions remaining; catalog page passes threshold={10} explicitly; updateBookStock returns Promise&lt;BookResponse&gt;; TypeScript compiles cleanly</done>
</task>

</tasks>

<verification>
1. `cd frontend && npx tsc --noEmit` exits with 0 — no type errors
2. `grep -rn "function DeltaBadge" frontend/src/app/` returns no matches (no inline definitions remain)
3. `grep -rn "function StockBadge" frontend/src/app/` returns no matches (no inline definitions remain)
4. `grep -rn "DeltaBadge" frontend/src/components/admin/DeltaBadge.tsx` confirms the shared component exists
5. `grep -rn "StockBadge" frontend/src/components/admin/StockBadge.tsx` confirms the shared component exists
6. `grep -n "Promise<BookResponse>" frontend/src/lib/admin.ts` matches the updateBookStock function
7. `grep -n "threshold={10}" frontend/src/app/admin/catalog/page.tsx` confirms explicit threshold on catalog page
</verification>

<success_criteria>
- DeltaBadge exists as a single shared file imported by both overview and sales pages
- StockBadge exists as a single shared file with required threshold param, imported by both catalog and inventory pages
- No inline DeltaBadge or StockBadge function definitions remain in any page file
- updateBookStock correctly typed as returning Promise<BookResponse>
- TypeScript compiles with no errors
</success_criteria>

<output>
After completion, create `.planning/phases/31-code-quality/31-01-SUMMARY.md`
</output>
