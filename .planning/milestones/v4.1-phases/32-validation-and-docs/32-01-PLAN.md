---
phase: 32-validation-and-docs
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/app/email/templates/restock_alert.html
  - backend/app/books/router.py
  - backend/scripts/test_email.py
autonomous: false
requirements:
  - MAIL-01

must_haves:
  truths:
    - "Restock alert email displays a book cover image centered above the book title inside the book card"
    - "Restock alert cover uses 3-step fallback: cover_image_url first, Open Library ISBN second, book emoji placeholder third"
    - "Backend passes isbn and cover_image_url in the restock alert template context alongside book_title"
    - "A test script sends sample order confirmation and restock alert emails to a local SMTP trap"
    - "Order confirmation email renders with CID-embedded BookStore logo and book cover images"
    - "Restock alert email renders with CID-embedded BookStore logo and book cover image"
  artifacts:
    - path: "backend/app/email/templates/restock_alert.html"
      provides: "Restock alert template with cover image fallback chain"
      contains: "covers.openlibrary.org"
    - path: "backend/scripts/test_email.py"
      provides: "Developer tool to send test emails via local SMTP trap"
      min_lines: 40
  key_links:
    - from: "backend/app/books/router.py"
      to: "backend/app/email/templates/restock_alert.html"
      via: "email_svc.enqueue context dict with isbn and cover_image_url"
      pattern: "isbn.*cover_image_url"
---

<objective>
Add book cover image to restock alert email template, update the backend caller to pass isbn and cover_image_url to the template, and create a reusable test script that sends sample emails through a local SMTP trap for visual verification.

Purpose: Confirm email improvements (logo CID embedding, Open Library cover fallback) work end-to-end in a real SMTP environment. The restock alert template currently lacks a book cover image, unlike order_confirmation which has the full fallback chain.

Output: Updated restock_alert.html with cover image, updated router context, and backend/scripts/test_email.py developer tool.
</objective>

<execution_context>
@C:/Users/Sushasan/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Sushasan/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/32-validation-and-docs/32-CONTEXT.md

@backend/app/email/service.py
@backend/app/email/templates/base.html
@backend/app/email/templates/order_confirmation.html
@backend/app/email/templates/restock_alert.html
@backend/app/books/router.py

<interfaces>
<!-- Key interfaces the executor needs. Extracted from codebase. -->

From backend/app/email/service.py:
```python
class EmailService:
    def enqueue(self, background_tasks, to, template_name, subject, context) -> None:
        # Renders Jinja2 template, builds multipart/related MIME with CID logo
        ...
```

From backend/app/books/router.py (update_stock, line 147-189):
```python
@router.patch("/books/{book_id}/stock", response_model=BookResponse)
async def update_stock(book_id, body, db, admin, background_tasks, email_svc):
    # Current context passed to restock_alert.html:
    # {"book_title": book.title, "book_id": book.id}
    # MISSING: isbn, cover_image_url — must be added
```

From backend/app/books/models.py:
```python
class Book(Base):
    isbn: Mapped[str | None]  # nullable
    cover_image_url: Mapped[str | None]  # nullable, String(2048)
```

From backend/app/email/templates/order_confirmation.html (cover fallback pattern):
```html
{% if item.cover_image_url %}
<img src="{{ item.cover_image_url }}" ... />
{% elif item.isbn %}
<img src="https://covers.openlibrary.org/b/isbn/{{ item.isbn }}-M.jpg" ... />
{% else %}
<div ...><span>&#128214;</span></div>
{% endif %}
```

From backend/app/core/config.py:
```python
# MAIL_SERVER, MAIL_PORT, MAIL_USERNAME, MAIL_PASSWORD, MAIL_FROM, etc.
# MAIL_SUPPRESS_SEND controls whether emails are actually sent
```
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add cover image to restock alert template and update backend caller</name>
  <files>backend/app/email/templates/restock_alert.html, backend/app/books/router.py</files>
  <action>
**restock_alert.html** — Add a book cover image section centered above the book title, inside the existing book card `<td style="padding: 24px; text-align: center;">`. Insert BEFORE the "Back in Stock" badge table. Use the same 3-step fallback chain as order_confirmation.html:

1. `{% if cover_image_url %}` — `<img src="{{ cover_image_url }}">`
2. `{% elif isbn %}` — `<img src="https://covers.openlibrary.org/b/isbn/{{ isbn }}-M.jpg">`
3. `{% else %}` — emoji placeholder `<div>&#128214;</div>`

Image sizing: ~120px wide x 170px tall (medium hero-style, per CONTEXT.md decision — this is a single-book spotlight email, larger than order confirmation thumbnails). Style: `border-radius: 8px; object-fit: cover; border: 1px solid #e2e8f0; box-shadow: 0 2px 8px rgba(0,0,0,0.1);`. Add `margin-bottom: 16px;` below the image before the badge.

The emoji placeholder should match the style: 120x170px div with `background-color: #edf2f7; border-radius: 8px; border: 1px solid #e2e8f0;` and a large book emoji centered inside.

**router.py** — In the `update_stock` function (line ~176-187), update the email context dict to include `isbn` and `cover_image_url` from the `book` object. Apply the same safety filter as order_confirmation.html uses for cover_image_url:

```python
context={
    "book_title": book.title,
    "book_id": book.id,
    "isbn": book.isbn,
    "cover_image_url": (
        book.cover_image_url
        if book.cover_image_url
        and book.cover_image_url.startswith("http")
        and "localhost" not in book.cover_image_url
        and "127.0.0.1" not in book.cover_image_url
        else None
    ),
},
```

The `book` variable already has the full Book ORM model (from `service.set_stock_and_notify`), so `book.isbn` and `book.cover_image_url` are directly accessible.
  </action>
  <verify>
    <automated>cd D:/Python/claude-test/backend && python -c "from jinja2 import Environment, FileSystemLoader; env=Environment(loader=FileSystemLoader('app/email/templates'), autoescape=True); t=env.get_template('restock_alert.html'); html=t.render(book_title='Test Book', isbn='9780134685991', cover_image_url=None, store_url='#'); assert 'covers.openlibrary.org/b/isbn/9780134685991' in html; print('ISBN fallback: OK'); html2=t.render(book_title='Test', cover_image_url='https://example.com/img.jpg', isbn=None, store_url='#'); assert 'example.com/img.jpg' in html2; print('cover_image_url: OK'); html3=t.render(book_title='Test', cover_image_url=None, isbn=None, store_url='#'); assert '128214' in html3; print('emoji fallback: OK'); print('ALL PASS')"</automated>
  </verify>
  <done>restock_alert.html shows book cover with 3-step fallback chain. Backend router passes isbn and cover_image_url (with localhost filter) in template context.</done>
</task>

<task type="auto">
  <name>Task 2: Create email test script for local SMTP trap verification</name>
  <files>backend/scripts/test_email.py</files>
  <action>
Create `backend/scripts/test_email.py` — a standalone developer tool that sends sample order confirmation and restock alert emails through a local SMTP server (e.g., MailHog at localhost:1025 or mailpit or any SMTP trap).

The script should:

1. **Be self-contained** — import only stdlib + the project's EmailService. Does NOT need FastAPI running.
2. **Accept CLI args** — `--smtp-host` (default `localhost`), `--smtp-port` (default `1025`), `--to` (default `test@example.com`)
3. **Instantiate EmailService** by creating a minimal ConnectionConfig with the provided SMTP host/port, no auth, no TLS (SMTP traps don't need it). Override `MAIL_SUPPRESS_SEND=0` to ensure sending.
4. **Send two test emails:**

   a. **Order confirmation** with sample data:
   ```python
   context = {
       "customer_name": "Jane",
       "order_id": 42,
       "items": [
           {"title": "Effective Python", "author": "Brett Slatkin", "quantity": 1,
            "unit_price": "39.99", "cover_image_url": None, "isbn": "9780134853987"},
           {"title": "Clean Code", "author": "Robert C. Martin", "quantity": 2,
            "unit_price": "29.99", "cover_image_url": None, "isbn": "9780132350884"},
       ],
       "total_price": "99.97",
   }
   ```

   b. **Restock alert** with sample data (now including isbn and cover_image_url):
   ```python
   context = {
       "book_title": "Designing Data-Intensive Applications",
       "book_id": 7,
       "isbn": "9781449373320",
       "cover_image_url": None,  # Forces Open Library fallback
       "store_url": "http://localhost:3000",
   }
   ```

5. **Use smtplib directly** (not the async _send method) since this is a sync CLI script. Replicate the MIME building from EmailService.enqueue: multipart/related wrapping multipart/alternative (plain + html), with CID logo attachment. Import and reuse `_render_html`, `_strip_html` from EmailService or instantiate EmailService and call its methods.

   Actually, the simplest approach: instantiate EmailService with a mock config where `SUPPRESS_SEND=False`, then build the MIME message the same way `enqueue` does but send synchronously. You can create a thin wrapper or just replicate the MIME construction inline.

6. **Print status** for each email sent: "Sent order confirmation to {to}" and "Sent restock alert to {to}".
7. **Print instructions** at the top: "Make sure a local SMTP trap is running (e.g., `docker run -p 1025:1025 -p 8025:8025 mailhog/mailhog`)"

The script should be runnable as: `python backend/scripts/test_email.py` (with default args) or `python backend/scripts/test_email.py --smtp-port 1025 --to dev@test.com`.

Keep it in the repo as a developer tool per CONTEXT.md decision.
  </action>
  <verify>
    <automated>cd D:/Python/claude-test && python -c "import ast; ast.parse(open('backend/scripts/test_email.py').read()); print('Script parses OK')" && python backend/scripts/test_email.py --help 2>&1 | head -5</automated>
  </verify>
  <done>backend/scripts/test_email.py exists, parses cleanly, accepts --smtp-host/--smtp-port/--to args, and sends both order confirmation and restock alert test emails when an SMTP trap is running.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Visually verify emails in SMTP trap</name>
  <files>n/a</files>
  <action>
  Human verification checkpoint. What was built:
  Restock alert email template now shows a book cover image with 3-step fallback (local URL, Open Library ISBN, emoji placeholder). Backend passes isbn and cover_image_url to the template. A test script sends sample emails through a local SMTP trap.

  How to verify:
  1. Start a local SMTP trap: `docker run -d -p 1025:1025 -p 8025:8025 mailhog/mailhog` (or use mailpit/mailtrap)
  2. Run the test script: `cd backend && python scripts/test_email.py --smtp-port 1025`
  3. Open the SMTP trap web UI at http://localhost:8025
  4. Verify order confirmation email:
     - BookStore logo appears in the header (CID-embedded, not broken image)
     - Two book items shown with Open Library cover images (Effective Python, Clean Code)
     - Prices and totals formatted correctly
  5. Verify restock alert email:
     - BookStore logo appears in the header (CID-embedded)
     - Book cover image visible (Open Library fallback for "Designing Data-Intensive Applications" by ISBN 9781449373320)
     - "Back in Stock" badge and book title displayed
     - "Visit the Store" button present
  6. Both emails should have proper plain-text fallback (check raw source in SMTP trap)

  Resume signal: Type "approved" or describe issues
  </action>
  <verify>
    <automated>echo "Checkpoint: human visual verification required"</automated>
  </verify>
  <done>User visually confirmed both email templates render correctly with CID-embedded logo and book cover images in SMTP trap.</done>
</task>

</tasks>

<verification>
1. `restock_alert.html` contains `covers.openlibrary.org` URL pattern for ISBN fallback
2. `restock_alert.html` contains `cover_image_url` template variable for direct URL
3. `restock_alert.html` contains `&#128214;` emoji placeholder as final fallback
4. `router.py` update_stock context includes `isbn` and `cover_image_url` keys
5. `backend/scripts/test_email.py` exists and is syntactically valid Python
6. Test script sends both email types successfully to SMTP trap
7. Visual confirmation: logo CID-embedded, cover images visible in both templates
</verification>

<success_criteria>
- Restock alert email renders with book cover image using the same 3-step fallback as order confirmation
- Backend router passes isbn and cover_image_url to restock alert template context
- Test emails arrive in local SMTP trap with CID-embedded logo and visible cover images
- Test script is a reusable developer tool committed to the repo
</success_criteria>

<output>
After completion, create `.planning/phases/32-validation-and-docs/32-01-SUMMARY.md`
</output>
