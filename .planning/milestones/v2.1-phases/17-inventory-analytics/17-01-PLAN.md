---
phase: 17-inventory-analytics
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - app/admin/analytics_repository.py
  - app/admin/analytics_schemas.py
  - app/admin/analytics_router.py
  - tests/test_inventory_analytics.py
autonomous: true
requirements: [INV-01]

must_haves:
  truths:
    - "Admin can call GET /admin/analytics/inventory/low-stock?threshold=10 and receive all books with stock at or below 10, ordered by stock ascending"
    - "The threshold parameter is configurable per request — changing from threshold=5 to threshold=20 returns a different, correctly filtered set"
    - "Books with zero stock appear at the top of the low-stock list (ordered by stock ascending)"
    - "Response includes total_low_stock count and threshold echoed at top level and per item"
    - "Non-admin users receive 403, unauthenticated users receive 401"
    - "Negative threshold returns 422"
  artifacts:
    - path: "app/admin/analytics_repository.py"
      provides: "low_stock_books(threshold) method"
      contains: "async def low_stock_books"
    - path: "app/admin/analytics_schemas.py"
      provides: "LowStockBookEntry and LowStockResponse schemas"
      contains: "class LowStockResponse"
    - path: "app/admin/analytics_router.py"
      provides: "GET /inventory/low-stock endpoint"
      contains: "get_low_stock_books"
    - path: "tests/test_inventory_analytics.py"
      provides: "Integration tests for INV-01"
      min_lines: 100
  key_links:
    - from: "app/admin/analytics_router.py"
      to: "app/admin/analytics_repository.py"
      via: "AnalyticsRepository(db).low_stock_books(threshold=threshold)"
      pattern: "repo\\.low_stock_books"
    - from: "app/admin/analytics_router.py"
      to: "app/admin/analytics_schemas.py"
      via: "response_model=LowStockResponse"
      pattern: "LowStockResponse"
    - from: "app/admin/analytics_repository.py"
      to: "app/books/models.py"
      via: "Book.stock_quantity filter"
      pattern: "Book\\.stock_quantity\\s*<="
---

<objective>
Implement the low-stock inventory analytics endpoint and comprehensive integration tests.

Purpose: Deliver INV-01 — admins can answer "what do I need to restock?" by querying books at or below a configurable stock threshold. This is a single-endpoint, single-table feature extending the Phase 16 analytics infrastructure with minimal new code.

Output: Working `GET /admin/analytics/inventory/low-stock?threshold=10` endpoint with integration tests covering all boundary conditions.
</objective>

<execution_context>
@C:/Users/Sushasan/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Sushasan/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

<interfaces>
<!-- Key types and contracts the executor needs. Extracted from codebase. -->
<!-- Executor should use these directly — no codebase exploration needed. -->

From app/admin/analytics_repository.py:
```python
class AnalyticsRepository:
    def __init__(self, db: AsyncSession) -> None:
        self._db = db

    async def revenue_summary(self, *, period_start: datetime, period_end: datetime) -> dict: ...
    async def top_books(self, *, sort_by: str, limit: int = 10) -> list[dict]: ...
    # Return pattern: [row._asdict() for row in result.all()]
    # Book is already imported: from app.books.models import Book
```

From app/admin/analytics_schemas.py:
```python
from pydantic import BaseModel

class SalesSummaryResponse(BaseModel): ...
class TopBookEntry(BaseModel): ...
class TopBooksResponse(BaseModel):
    sort_by: str
    items: list[TopBookEntry]
```

From app/admin/analytics_router.py:
```python
from fastapi import APIRouter, Depends, Query
from app.admin.analytics_repository import AnalyticsRepository
from app.admin.analytics_schemas import SalesSummaryResponse, TopBooksResponse
from app.admin.analytics_service import AdminAnalyticsService
from app.core.deps import AdminUser, DbSession, require_admin

router = APIRouter(
    prefix="/admin/analytics",
    tags=["admin-analytics"],
    dependencies=[Depends(require_admin)],
)

# Existing endpoints:
# GET /sales/summary  (response_model=SalesSummaryResponse)
# GET /sales/top-books (response_model=TopBooksResponse)
# Router already registered in app/main.py — no main.py change needed.
```

From app/books/models.py:
```python
class Book(Base):
    __tablename__ = "books"
    # CheckConstraint("stock_quantity >= 0", name="ck_books_stock_non_negative")
    id: Mapped[int]           # primary key
    title: Mapped[str]
    author: Mapped[str]
    stock_quantity: Mapped[int]  # Integer, default=0, not nullable
    genre_id: Mapped[int]
    price: Mapped[Decimal]
```

From app/core/deps.py:
```python
AdminUser = Annotated[User, Depends(require_admin)]
DbSession = Annotated[AsyncSession, Depends(get_db)]
```

From tests/test_sales_analytics.py (fixture pattern):
```python
@pytest_asyncio.fixture
async def admin_headers(client: AsyncClient, db_session: AsyncSession) -> dict:
    repo = UserRepository(db_session)
    hashed = await hash_password("adminpass123")
    user = await repo.create(email="admin_analytics@example.com", hashed_password=hashed)
    await repo.set_role_admin(user.id)
    await db_session.flush()
    resp = await client.post("/auth/login", json={"email": "...", "password": "..."})
    return {"Authorization": f"Bearer {resp.json()['access_token']}"}
```
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add low_stock_books() repository method, LowStockBookEntry/LowStockResponse schemas, and GET /inventory/low-stock endpoint</name>
  <files>
    app/admin/analytics_repository.py
    app/admin/analytics_schemas.py
    app/admin/analytics_router.py
  </files>
  <action>
**1. Add `low_stock_books()` method to `AnalyticsRepository`** in `app/admin/analytics_repository.py`:

Add `asc` to the existing `from sqlalchemy import desc, func, select` import line (becomes `from sqlalchemy import asc, desc, func, select`).

Add the following method to the `AnalyticsRepository` class after the existing `top_books()` method:

```python
async def low_stock_books(self, *, threshold: int) -> list[dict]:
    """Return all books with stock_quantity at or below threshold, ordered ascending.

    Args:
        threshold: Inclusive upper bound for stock_quantity filter.

    Returns:
        List of dicts: {book_id, title, author, current_stock}.
        Ordered by current_stock ascending (zero-stock books first).
    """
    stmt = (
        select(
            Book.id.label("book_id"),
            Book.title,
            Book.author,
            Book.stock_quantity.label("current_stock"),
        )
        .where(Book.stock_quantity <= threshold)
        .order_by(asc(Book.stock_quantity))
    )
    result = await self._db.execute(stmt)
    return [row._asdict() for row in result.all()]
```

Key details:
- Uses `<=` (not `<`) — requirement says "at or below"
- `asc(Book.stock_quantity)` — zero-stock books sort first
- Single-table query against `books` — no joins to orders
- Returns `list[dict]` matching the existing `top_books()` pattern
- `Book` is already imported in this file

**2. Add `LowStockBookEntry` and `LowStockResponse` schemas** to `app/admin/analytics_schemas.py`:

Append after the existing `TopBooksResponse` class:

```python
class LowStockBookEntry(BaseModel):
    """Single book entry in the low-stock inventory report.

    threshold is echoed per-item per locked decision — allows dashboard to show
    "5 units (threshold: 10)" without a second API call.
    """

    book_id: int
    title: str
    author: str
    current_stock: int
    threshold: int


class LowStockResponse(BaseModel):
    """Response schema for GET /admin/analytics/inventory/low-stock."""

    threshold: int
    total_low_stock: int
    items: list[LowStockBookEntry]
```

Key details:
- `current_stock` is `int` (not `float`) — `stock_quantity` is `Integer` in the model, no Decimal conversion needed
- `threshold` appears in both `LowStockResponse` (top-level) and `LowStockBookEntry` (per-item) — locked decision

**3. Add `GET /inventory/low-stock` endpoint** to `app/admin/analytics_router.py`:

Update the import from `analytics_schemas` to include the new schemas:
```python
from app.admin.analytics_schemas import (
    LowStockResponse,
    SalesSummaryResponse,
    TopBooksResponse,
)
```

Add the endpoint after the existing `get_top_books` function:

```python
@router.get("/inventory/low-stock", response_model=LowStockResponse)
async def get_low_stock_books(
    db: DbSession,
    _admin: AdminUser,
    threshold: int = Query(10, ge=0),
) -> LowStockResponse:
    """Return all books with stock at or below the threshold, ordered by stock ascending.

    Query parameters:
    - threshold: Inclusive stock level cutoff (default 10, minimum 0).

    Zero-stock books appear at the top of the list. Admin only. threshold < 0 returns 422.
    """
    repo = AnalyticsRepository(db)
    books = await repo.low_stock_books(threshold=threshold)
    items = [{"threshold": threshold, **b} for b in books]
    return LowStockResponse(
        threshold=threshold,
        total_low_stock=len(items),
        items=items,
    )
```

Key details:
- `Query(10, ge=0)` — default threshold of 10, rejects negative values with 422 automatically
- No service layer — direct repository call, same pattern as `get_top_books`
- `total_low_stock=len(items)` — no second DB query since all results are returned (no pagination)
- Threshold injected into each item dict: `[{"threshold": threshold, **b} for b in books]`
- No changes to `app/main.py` — router is already registered
- `AdminAnalyticsService` import can remain (it's used by the sales summary endpoint); do NOT remove it
  </action>
  <verify>
    <automated>cd D:/Python/claude-test && python -c "from app.admin.analytics_repository import AnalyticsRepository; from app.admin.analytics_schemas import LowStockBookEntry, LowStockResponse; from app.admin.analytics_router import get_low_stock_books; print('All imports OK')"</automated>
  </verify>
  <done>
    - `AnalyticsRepository.low_stock_books(threshold)` method exists and uses `<=` with `asc()` ordering
    - `LowStockBookEntry` schema has fields: book_id, title, author, current_stock, threshold
    - `LowStockResponse` schema has fields: threshold, total_low_stock, items
    - `GET /inventory/low-stock` endpoint exists with `Query(10, ge=0)` default
    - No changes to `app/main.py`
  </done>
</task>

<task type="auto">
  <name>Task 2: Create comprehensive integration tests for the low-stock endpoint</name>
  <files>
    tests/test_inventory_analytics.py
  </files>
  <action>
Create `tests/test_inventory_analytics.py` with comprehensive integration tests for INV-01.

**Fixtures:**

```python
"""Integration tests for Phase 17 inventory analytics endpoint.

Tests cover:
  - INV-01: GET /admin/analytics/inventory/low-stock auth, threshold filtering,
    ordering, boundary conditions, and response schema.
"""

from decimal import Decimal

import pytest
import pytest_asyncio
from httpx import AsyncClient
from sqlalchemy.ext.asyncio import AsyncSession

from app.books.models import Book, Genre
from app.core.security import hash_password
from app.users.repository import UserRepository

LOW_STOCK_URL = "/admin/analytics/inventory/low-stock"
LOGIN_URL = "/auth/login"
```

**admin_headers fixture** — Create admin user with email `admin_inventory@example.com`, password `adminpass123`. Follow exact pattern from `tests/test_sales_analytics.py` (create via `UserRepository`, `set_role_admin`, flush, login, return Bearer headers).

**user_headers fixture** — Create regular user with email `user_inventory@example.com`, password `userpass123`. Same pattern, no `set_role_admin`.

**stock_books fixture** — Create a Genre and 5 books with specific stock levels designed to cover all boundary conditions:

```python
@pytest_asyncio.fixture
async def stock_books(db_session: AsyncSession) -> list[Book]:
    """Create books with specific stock_quantity values for boundary testing.

    Stock levels:
    - 0:  zero-stock, must sort first, included at any positive threshold
    - 5:  low-stock, below default threshold (10)
    - 10: exactly at default threshold (10), MUST be included (at-or-below)
    - 11: just above default threshold, MUST be excluded
    - 50: well stocked, always excluded at reasonable thresholds
    """
    genre = Genre(name="Inventory Test Genre")
    db_session.add(genre)
    await db_session.flush()

    books = [
        Book(title="Zero Stock Book",   author="Author Z", price=Decimal("10.00"), stock_quantity=0,  genre_id=genre.id),
        Book(title="Low Stock Book",    author="Author L", price=Decimal("10.00"), stock_quantity=5,  genre_id=genre.id),
        Book(title="Threshold Book",    author="Author T", price=Decimal("10.00"), stock_quantity=10, genre_id=genre.id),
        Book(title="Above Threshold",   author="Author A", price=Decimal("10.00"), stock_quantity=11, genre_id=genre.id),
        Book(title="Well Stocked Book", author="Author W", price=Decimal("10.00"), stock_quantity=50, genre_id=genre.id),
    ]
    db_session.add_all(books)
    await db_session.flush()
    return books
```

**Test classes and methods:**

`class TestLowStockAuth:` — Auth gate tests
- `test_requires_auth`: `GET /low-stock` without headers returns 401
- `test_requires_admin`: `GET /low-stock` with `user_headers` returns 403

`class TestLowStockBehavior:` — Core behavior tests (all use `admin_headers` + `stock_books`)
- `test_default_threshold_is_10`: Call without `?threshold=`. Verify 200, `data["threshold"] == 10`, `data["total_low_stock"] == 3` (stock 0, 5, 10 included; 11, 50 excluded)
- `test_custom_threshold_filters_correctly`: Call with `?threshold=5`. Verify `total_low_stock == 2` (stock 0, 5 included; 10, 11, 50 excluded)
- `test_book_at_exact_threshold_is_included`: Call with `?threshold=10`. Verify the book with `stock_quantity=10` ("Threshold Book") appears in items. This specifically tests `<=` vs `<`.
- `test_book_above_threshold_excluded`: Call with `?threshold=10`. Verify no item has `current_stock > 10`. The book with stock=11 ("Above Threshold") must not appear.
- `test_ordered_by_stock_ascending`: Call with `?threshold=10`. Extract `current_stock` values from items. Assert the list equals `sorted(stocks)` (i.e., `[0, 5, 10]`).
- `test_zero_stock_books_appear_first`: Call with `?threshold=10`. Assert `items[0]["current_stock"] == 0` and `items[0]["title"] == "Zero Stock Book"`.
- `test_threshold_echoed_in_each_item`: Call with `?threshold=7`. Every item in the response must have `item["threshold"] == 7`.
- `test_total_low_stock_count_correct`: Call with `?threshold=20`. Verify `total_low_stock == 4` (stock 0, 5, 10, 11 included; 50 excluded).
- `test_empty_result_when_no_books_below_threshold`: Call with `?threshold=0` but without `stock_books` fixture. Use `admin_headers` only (empty catalog). Verify 200, `total_low_stock == 0`, `items == []`.
- `test_no_books_below_threshold_returns_empty`: Call with `stock_books` fixture and `?threshold=-1` ... wait, negative is 422. Instead: use a separate approach — all books have stock >= 0, so `?threshold=0` should return only zero-stock book. This test is covered by `test_threshold_zero_returns_only_zero_stock`.
- `test_threshold_zero_returns_only_zero_stock`: Call with `?threshold=0`. Verify `total_low_stock == 1`, the single item has `current_stock == 0`.
- `test_negative_threshold_returns_422`: Call with `?threshold=-1`. Verify 422 status code.
- `test_response_schema_fields`: Call with `?threshold=10`. Verify top-level keys: `threshold`, `total_low_stock`, `items`. Verify first item has keys: `book_id`, `title`, `author`, `current_stock`, `threshold`. Verify no extra keys.
- `test_large_threshold_returns_all_books`: Call with `?threshold=100`. Verify `total_low_stock == 5` (all 5 books included since max stock is 50).

All tests use `@pytest.mark.asyncio` (or rely on `asyncio_mode = "auto"` from `pyproject.toml` — follow the pattern from `test_sales_analytics.py`; if it does NOT use `@pytest.mark.asyncio`, omit it here too). Check `test_sales_analytics.py` for the decorator pattern and follow it exactly.

Each test method should:
1. Make the HTTP request with `client.get(LOW_STOCK_URL, headers=admin_headers, params={...})`
2. Assert status code
3. Parse `resp.json()` and assert specific fields/values
  </action>
  <verify>
    <automated>cd D:/Python/claude-test && python -m pytest tests/test_inventory_analytics.py -x -v 2>&1 | tail -30</automated>
  </verify>
  <done>
    - All integration tests pass (15+ test methods)
    - Auth gate: 401 without token, 403 for regular user
    - Default threshold=10 returns correct 3-book set
    - Custom thresholds (0, 5, 20, 100) return correctly filtered sets
    - Book at exact threshold is included (tests <= not <)
    - Items ordered by stock ascending with zero-stock first
    - Threshold echoed in each item and at top level
    - total_low_stock count matches actual item count
    - Negative threshold returns 422
    - Empty catalog returns empty items with total_low_stock=0
    - Response schema has exactly the expected fields
  </done>
</task>

</tasks>

<verification>
1. `python -c "from app.admin.analytics_router import get_low_stock_books"` — endpoint importable
2. `python -m pytest tests/test_inventory_analytics.py -x -v` — all integration tests pass
3. `python -m pytest tests/test_sales_analytics.py -x -v` — Phase 16 tests still pass (no regression)
4. `python -m pytest tests/ -x` — full test suite passes
</verification>

<success_criteria>
- GET /admin/analytics/inventory/low-stock returns 200 with correct schema for admin users
- Default threshold=10, configurable per request via query parameter
- Books at or below threshold included (<=), ordered by stock ascending
- Zero-stock books appear first in the list
- threshold echoed in top-level response AND in each item
- total_low_stock count matches number of items returned
- 401 for unauthenticated, 403 for non-admin, 422 for negative threshold
- All Phase 16 tests remain passing (no regression)
- 15+ integration tests covering auth, filtering, ordering, boundaries, and schema
</success_criteria>

<output>
After completion, create `.planning/phases/17-inventory-analytics/17-01-SUMMARY.md`
</output>
