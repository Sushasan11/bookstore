---
phase: 11-pre-booking
plan: 02
type: execute
wave: 2
depends_on: ["11-01"]
files_modified:
  - tests/test_prebooks.py
autonomous: true
requirements: [PRBK-01, PRBK-02, PRBK-03, PRBK-04, PRBK-05, PRBK-06]

must_haves:
  truths:
    - "Test proves user can create a pre-booking for an out-of-stock book (PRBK-01)"
    - "Test proves pre-booking is rejected with 409 when book is in stock (PRBK-04)"
    - "Test proves duplicate pre-booking for same book is rejected (PRBK-01)"
    - "Test proves user can view their pre-bookings with status and timestamps (PRBK-02, PRBK-05)"
    - "Test proves user can cancel a pre-booking via soft-delete (PRBK-03)"
    - "Test proves restock broadcast transitions all waiting pre-bookings to notified atomically (PRBK-06)"
    - "Test proves restock of already-in-stock book does not trigger notifications (PRBK-06)"
    - "Test proves user can re-reserve after cancelling (PRBK-03 + partial unique index)"
  artifacts:
    - path: "tests/test_prebooks.py"
      provides: "Integration tests for all PRBK requirements"
      min_lines: 200
  key_links:
    - from: "tests/test_prebooks.py"
      to: "app/prebooks/router.py"
      via: "HTTP requests to /prebooks endpoints"
      pattern: "client\\.(post|get|delete).*prebooks"
    - from: "tests/test_prebooks.py"
      to: "app/books/router.py"
      via: "HTTP requests to /books/{id}/stock for restock tests"
      pattern: "client\\.patch.*stock"
---

<objective>
Write comprehensive integration tests proving all six PRBK requirements for the pre-booking feature. Tests exercise the full HTTP stack (router -> service -> repository -> DB) using the project's existing async test infrastructure.

Purpose: Prove that all pre-booking behaviors work correctly end-to-end, including edge cases (duplicate rejection, in-stock rejection, ownership isolation, restock broadcast atomicity, re-reservation after cancel).

Output: tests/test_prebooks.py with ~15-20 test cases organized by requirement, all passing.
</objective>

<execution_context>
@C:/Users/Sushasan/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Sushasan/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-pre-booking/11-01-PLAN.md

<interfaces>
<!-- Key types and contracts the executor needs for writing tests. -->

From tests/conftest.py:
```python
# Available fixtures (function-scoped):
#   db_session: AsyncSession (rolls back after each test)
#   client: AsyncClient (wired to FastAPI app with DB override)
#   mail_config: ConnectionConfig with SUPPRESS_SEND=1
#   email_service: EmailService with suppressed sending
```

From app/prebooks/router.py (expected endpoints):
```python
# POST /prebooks — body: {"book_id": int} — 201 with PreBookResponse
# GET /prebooks — 200 with PreBookListResponse
# DELETE /prebooks/{prebook_id} — 204 No Content
```

From app/prebooks/schemas.py (expected response shape):
```python
class PreBookResponse:
    id: int
    book_id: int
    book_title: str
    book_author: str
    status: str  # "waiting", "notified", "cancelled"
    created_at: datetime
    notified_at: datetime | None
    cancelled_at: datetime | None
```

From app/books/router.py (stock update endpoint):
```python
# PATCH /books/{book_id}/stock — body: {"quantity": int} — 200 with BookResponse
# Admin only (AdminUser dependency)
```

From app/core/deps.py:
```python
# ActiveUser dependency on all prebook endpoints — requires valid JWT + is_active
# AdminUser dependency on stock update endpoint — requires admin role
```

Test pattern from tests/test_wishlist.py and tests/test_admin_users.py:
```python
# Fixtures create users via UserRepository + hash_password, login via client.post("/auth/login")
# Books created via admin_headers + client.post("/books", ...)
# Module-specific email prefixes to avoid cross-test collisions
# Classes group tests by requirement (TestCreatePreBooking, TestListPreBookings, etc.)
```
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create test fixtures and PRBK-01/PRBK-04 tests</name>
  <files>tests/test_prebooks.py</files>
  <action>
Create `tests/test_prebooks.py` with the full test module. This task defines the file structure, fixtures, and the first set of tests.

**Module docstring:** Describe coverage of PRBK-01 through PRBK-06 with edge cases.

**Module-level constants:**
```python
PREBOOKS_URL = "/prebooks"
BOOKS_URL = "/books"
STOCK_URL_TPL = "/books/{book_id}/stock"
LOGIN_URL = "/auth/login"
```

**Fixtures** (follow tests/test_wishlist.py pattern with unique email prefixes `prebook_admin@`, `prebook_user@`, `prebook_user2@`):

1. `admin_headers(client, db_session)` — Create admin user (`prebook_admin@example.com`), login, return auth headers. Use `UserRepository.create()` + `set_role_admin()` + `hash_password()`.

2. `user_headers(client, db_session)` — Create regular user (`prebook_user@example.com`), login, return auth headers.

3. `user2_headers(client, db_session)` — Create second regular user (`prebook_user2@example.com`), login, return auth headers. For user isolation tests.

4. `out_of_stock_book(client, admin_headers)` — Create a book via `POST /books` with `stock_quantity=0`. Return the book response dict. Title: "Out of Stock Book", author: "Test Author", price: 19.99.

5. `in_stock_book(client, admin_headers)` — Create a book via `POST /books` with `stock_quantity=10`. Return the book response dict. Title: "In Stock Book", author: "Test Author", price: 29.99.

**Test class: TestCreatePreBooking** — covers PRBK-01, PRBK-04

Tests:
- `test_create_prebook_success` — POST /prebooks with out_of_stock_book.id. Assert 201, response has status="waiting", book_title matches, notified_at is None, cancelled_at is None. (PRBK-01)
- `test_create_prebook_in_stock_rejected` — POST /prebooks with in_stock_book.id. Assert 409, code="PREBOOK_BOOK_IN_STOCK". (PRBK-04)
- `test_create_prebook_duplicate_rejected` — POST /prebooks twice for same out_of_stock_book. First succeeds (201), second gets 409 with code="PREBOOK_DUPLICATE". (PRBK-01 duplicate guard)
- `test_create_prebook_nonexistent_book` — POST /prebooks with book_id=99999. Assert 404, code="BOOK_NOT_FOUND".
- `test_create_prebook_unauthenticated` — POST /prebooks without auth headers. Assert 401.
  </action>
  <verify>
    <automated>cd D:/Python/claude-test && poetry run pytest tests/test_prebooks.py::TestCreatePreBooking -x -v 2>&1 | tail -20</automated>
  </verify>
  <done>
    - 5 tests in TestCreatePreBooking all pass
    - PRBK-01 proven: user can pre-book out-of-stock book, duplicates rejected
    - PRBK-04 proven: in-stock book pre-booking rejected with 409
    - Edge cases covered: nonexistent book (404), unauthenticated (401)
  </done>
</task>

<task type="auto">
  <name>Task 2: Add PRBK-02/03/05/06 tests for list, cancel, status tracking, and restock broadcast</name>
  <files>tests/test_prebooks.py</files>
  <action>
Add the remaining test classes to `tests/test_prebooks.py`:

**Test class: TestListPreBookings** — covers PRBK-02, PRBK-05

Tests:
- `test_list_prebooks_empty` — GET /prebooks with no pre-bookings. Assert 200, items is empty list. (PRBK-02)
- `test_list_prebooks_with_items` — Create 2 pre-bookings (need 2 out-of-stock books), GET /prebooks. Assert 200, items has 2 entries with correct book_title, status="waiting", ordered by created_at DESC. (PRBK-02, PRBK-05)
- `test_list_prebooks_user_isolation` — User 1 creates a pre-booking. User 2 calls GET /prebooks. Assert User 2 sees empty list. (PRBK-02 isolation)
- `test_list_prebooks_shows_all_statuses` — Create a pre-booking, cancel it, create another. GET /prebooks. Assert items include both the cancelled one and the new waiting one. (PRBK-05 — all statuses visible)

**Test class: TestCancelPreBooking** — covers PRBK-03

Tests:
- `test_cancel_prebook_success` — Create pre-booking, DELETE /prebooks/{id}. Assert 204. Then GET /prebooks — the item has status="cancelled" and cancelled_at is not None. (PRBK-03)
- `test_cancel_prebook_already_cancelled` — Create, cancel, then cancel again. Assert 409 code="PREBOOK_ALREADY_CANCELLED". (PRBK-03 idempotency guard)
- `test_cancel_prebook_not_found` — DELETE /prebooks/99999. Assert 404. (PRBK-03 edge case)
- `test_cancel_prebook_other_user` — User 1 creates pre-booking. User 2 tries to cancel it. Assert 404 (ownership — not 403, to prevent enumeration). (PRBK-03 ownership)
- `test_rebook_after_cancel` — Create pre-booking, cancel it, create new pre-booking for same book. Assert 201 — the partial unique index allows re-reservation after cancellation. GET /prebooks shows both entries. (PRBK-03 + partial unique index validation)

**Test class: TestRestockNotification** — covers PRBK-06

Tests:
- `test_restock_notifies_waiting_prebooks` — User 1 and User 2 both pre-book the same out-of-stock book. Admin sets stock to 5 via PATCH /books/{id}/stock. Both users GET /prebooks and see status="notified" with notified_at not None. (PRBK-06 broadcast)
- `test_restock_already_in_stock_no_notification` — Create a pre-booking for an out-of-stock book. Admin sets stock to 5 (pre-bookings transition to notified). Admin sets stock to 10 (was already >0). Assert the pre-booking status is still "notified" (no re-notification). (PRBK-06 — only 0->positive triggers)
- `test_restock_does_not_notify_cancelled` — User creates and cancels a pre-booking. Admin restocks the book. GET /prebooks shows status still "cancelled" (not "notified"). (PRBK-06 — only waiting status transitions)
- `test_restock_zero_to_zero_no_notification` — Pre-book, then admin sets stock to 0 (still 0). Assert status remains "waiting". (PRBK-06 — 0->0 is not a positive transition)

**Helper function** (if needed):
```python
async def _create_out_of_stock_book(client, admin_headers, title="OOS Book", price=19.99):
    """Create an out-of-stock book. Returns book response dict."""
    resp = await client.post(
        BOOKS_URL,
        json={"title": title, "author": "Test Author", "price": price, "stock_quantity": 0},
        headers=admin_headers,
    )
    assert resp.status_code == 201
    return resp.json()
```

All tests use the existing conftest fixtures (client, db_session) and module-level fixtures (admin_headers, user_headers, user2_headers). Each test is self-contained with respect to test data created via HTTP calls.
  </action>
  <verify>
    <automated>cd D:/Python/claude-test && poetry run pytest tests/test_prebooks.py -x -v 2>&1 | tail -30</automated>
  </verify>
  <done>
    - All ~18 tests in test_prebooks.py pass
    - PRBK-01: Create pre-booking + duplicate rejection proven
    - PRBK-02: List pre-bookings with book details proven, user isolation proven
    - PRBK-03: Cancel (soft-delete) proven, re-reservation after cancel proven
    - PRBK-04: In-stock rejection (409) proven
    - PRBK-05: Status tracking (waiting/notified/cancelled) with timestamps proven
    - PRBK-06: Restock broadcast proven (both users notified), edge cases proven (already in stock, cancelled not notified, 0->0)
    - ruff check passes on test file
  </done>
</task>

</tasks>

<verification>
After both tasks complete:

1. **Full test suite:** `poetry run pytest tests/test_prebooks.py -v` — all tests pass
2. **Requirement coverage check:**
   - PRBK-01: TestCreatePreBooking::test_create_prebook_success, test_create_prebook_duplicate_rejected
   - PRBK-02: TestListPreBookings::test_list_prebooks_with_items, test_list_prebooks_user_isolation
   - PRBK-03: TestCancelPreBooking::test_cancel_prebook_success, test_rebook_after_cancel
   - PRBK-04: TestCreatePreBooking::test_create_prebook_in_stock_rejected
   - PRBK-05: TestListPreBookings::test_list_prebooks_shows_all_statuses
   - PRBK-06: TestRestockNotification::test_restock_notifies_waiting_prebooks, test_restock_already_in_stock_no_notification, test_restock_does_not_notify_cancelled
3. **Lint:** `poetry run ruff check tests/test_prebooks.py`
4. **No regression:** `poetry run pytest tests/ -x --timeout=120` (existing tests still pass)
</verification>

<success_criteria>
- tests/test_prebooks.py exists with ~18 integration tests
- All tests pass against the test database
- Every PRBK requirement (01-06) has at least one dedicated test proving it
- Edge cases covered: duplicate, nonexistent book, unauthenticated, user isolation, already cancelled, re-reservation, 0->0 restock, already-in-stock restock
- Existing test suite (tests/) continues to pass without regression
</success_criteria>

<output>
After completion, create `.planning/phases/11-pre-booking/11-02-SUMMARY.md`
</output>
