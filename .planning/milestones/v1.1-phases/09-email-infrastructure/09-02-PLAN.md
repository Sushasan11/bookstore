---
phase: 09-email-infrastructure
plan: 02
type: execute
wave: 2
depends_on:
  - 09-01
files_modified:
  - tests/conftest.py
  - tests/test_email.py
autonomous: true
requirements:
  - EMAL-01
  - EMAL-04
  - EMAL-05
  - EMAL-06

must_haves:
  truths:
    - "EmailService instantiates with valid ConnectionConfig (EMAL-01)"
    - "Jinja2 renders base.html without error and template variables are accessible (EMAL-04)"
    - "Plain-text fallback is generated by stripping HTML tags (EMAL-04)"
    - "BackgroundTasks enqueue does not block the HTTP response (EMAL-05)"
    - "No email is dispatched when the route raises an exception before add_task (EMAL-06)"
    - "record_messages() outbox captures sent emails for assertion in tests"
  artifacts:
    - path: "tests/test_email.py"
      provides: "Unit + integration tests for email service"
      contains: "test_service_instantiates"
      min_lines: 100
    - path: "tests/conftest.py"
      provides: "Updated conftest with mail_config and email_service fixtures"
      contains: "mail_config"
  key_links:
    - from: "tests/test_email.py"
      to: "app/email/service.py"
      via: "imports EmailService, get_email_config"
      pattern: "from app.email.service import"
    - from: "tests/test_email.py"
      to: "fastapi_mail"
      via: "record_messages() outbox capture"
      pattern: "record_messages"
    - from: "tests/conftest.py"
      to: "app/email/service.py"
      via: "email_service fixture with SUPPRESS_SEND=1"
      pattern: "get_email_service|EmailService"
    - from: "tests/test_email.py"
      to: "app/email/service.py::enqueue()"
      via: "test_enqueue_includes_plain_text_alternative asserts alternative_body is non-empty"
      pattern: "alternative_body|MultipartSubtypeEnum"
---

<objective>
Create unit tests and integration tests that prove the email infrastructure satisfies EMAL-01, EMAL-04, EMAL-05, and EMAL-06.

Purpose: Validate that the email service works correctly, templates render, BackgroundTasks pattern is non-blocking, and the post-commit safety guarantee holds.

Output: `tests/test_email.py` with both unit and integration tests, plus updated `tests/conftest.py` with email fixtures.
</objective>

<execution_context>
@C:/Users/Sushasan/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Sushasan/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-email-infrastructure/09-RESEARCH.md
@.planning/phases/09-email-infrastructure/09-01-SUMMARY.md

<interfaces>
<!-- Key types and contracts from 09-01 that tests will exercise. -->

From app/email/service.py (created in 09-01):
```python
from fastapi_mail import ConnectionConfig, FastMail, MessageSchema, MessageType
from fastapi_mail.schemas import MultipartSubtypeEnum
from jinja2 import Environment, FileSystemLoader
from app.core.config import get_settings

def get_email_config() -> ConnectionConfig:
    """Build ConnectionConfig from Settings."""
    ...

class EmailService:
    def __init__(self, config: ConnectionConfig) -> None: ...
    fm: FastMail
    _jinja_env: Environment  # Jinja2 environment for manual template rendering

    @staticmethod
    def _strip_html(html: str) -> str:
        """Strip HTML tags, collapse whitespace."""
        ...

    def _render_plain_text(self, template_name: str, context: dict) -> str:
        """Render template to HTML via Jinja2, then strip tags for plain-text fallback."""
        ...

    def enqueue(
        self,
        background_tasks: BackgroundTasks,
        to: str,
        template_name: str,
        subject: str,
        context: dict,
    ) -> None:
        """Add email send to BackgroundTasks (post-commit safe).

        Calls _render_plain_text() to generate alternative_body.
        Builds MessageSchema with multipart_subtype=MultipartSubtypeEnum.alternative.
        """
        ...

    async def _send(self, message: MessageSchema, template_name: str) -> None:
        """Internal send — logs and drops on failure."""
        ...

@lru_cache
def get_email_service() -> EmailService: ...

EmailSvc = Annotated[EmailService, Depends(get_email_service)]
```

From app/email/templates/base.html (created in 09-01):
- Jinja2 template with blocks: title, content, footer
- table-based email layout

From tests/conftest.py (existing):
```python
@pytest_asyncio.fixture(scope="session")
async def test_engine(): ...

@pytest_asyncio.fixture
async def db_session(test_engine): ...

@pytest_asyncio.fixture
async def client(db_session): ...
```
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add email fixtures to conftest and create unit tests</name>
  <files>tests/conftest.py, tests/test_email.py</files>
  <action>
1. **Update `tests/conftest.py`** — add email-related fixtures AFTER the existing `client` fixture. Do NOT modify existing fixtures.

   Add these imports at the top (merge with existing imports):
   ```python
   from pathlib import Path
   from fastapi_mail import ConnectionConfig, FastMail
   from app.email.service import EmailService
   ```

   Add these fixtures:
   ```python
   @pytest_asyncio.fixture
   async def mail_config():
       """ConnectionConfig with SUPPRESS_SEND=1 for test email capture."""
       return ConnectionConfig(
           MAIL_USERNAME="test",
           MAIL_PASSWORD="test",
           MAIL_FROM="test@bookstore.com",
           MAIL_PORT=587,
           MAIL_SERVER="smtp.test.com",
           MAIL_FROM_NAME="Bookstore Test",
           MAIL_STARTTLS=True,
           MAIL_SSL_TLS=False,
           USE_CREDENTIALS=True,
           VALIDATE_CERTS=False,
           SUPPRESS_SEND=1,
           TEMPLATE_FOLDER=Path(__file__).resolve().parent.parent / "app" / "email" / "templates",
       )

   @pytest_asyncio.fixture
   async def email_service(mail_config):
       """EmailService instance with suppressed sending for tests."""
       return EmailService(config=mail_config)
   ```

2. **Create `tests/test_email.py`** with the following unit tests:

   ```python
   """Tests for email infrastructure (EMAL-01, EMAL-04, EMAL-05, EMAL-06)."""

   import pytest
   from fastapi_mail import MessageSchema, MessageType
   ```

   **Class: TestEmailService (unit tests for EMAL-01)**

   - `test_service_instantiates(email_service)`: Assert `email_service` is an instance of `EmailService`, and `email_service.fm` is a `FastMail` instance.

   - `test_get_email_config_from_settings()`: Call `get_email_config()` and verify it returns a `ConnectionConfig`. Verify `SUPPRESS_SEND` is set (since default Settings has MAIL_SUPPRESS_SEND=1). Import `get_email_config` from `app.email.service`.

   **Class: TestEmailTemplates (unit tests for EMAL-04)**

   - `test_base_template_renders(email_service)`: Use `email_service.fm.record_messages() as outbox`, send a `MessageSchema` with `template_body={"test_var": "hello"}`, `subtype=MessageType.html`, `subject="Test"`, `recipients=["user@test.com"]` via `await email_service.fm.send_message(message, template_name="base.html")`. Assert `len(outbox) == 1`. Assert `outbox[0]["To"]` contains `"user@test.com"`. Assert `outbox[0]["subject"]` equals `"Test"`.

   - `test_strip_html()`: Call `EmailService._strip_html("<p>Hello <b>World</b></p>")` and assert the result is `"Hello World"`. Also test with nested tags: `"<div><h1>Title</h1><p>Body</p></div>"` should return `"Title Body"`. Also test empty string returns empty string.

   - `test_strip_html_collapses_whitespace()`: Call `EmailService._strip_html("<p>  Hello  </p>  <p>  World  </p>")` and assert the result has no leading/trailing whitespace and internal whitespace is collapsed to single spaces.

   - `test_render_plain_text(email_service)`: Call `email_service._render_plain_text("base.html", {})` and assert the result is a non-empty string. Assert the result does NOT contain any HTML tags (no `<` or `>` characters). Assert the result contains "Bookstore" (from the base template header/footer). This proves `_render_plain_text()` renders the Jinja2 template and strips HTML.

   - `test_enqueue_includes_plain_text_alternative(email_service)`: Create a `BackgroundTasks` instance. Call `email_service.enqueue(background_tasks, "user@test.com", "base.html", "Test", {})`. Inspect the background task that was added: the first positional arg to `_send` is the `MessageSchema`. Assert that `message.alternative_body` is a non-empty string (the plain-text fallback). Assert that `message.multipart_subtype` equals `MultipartSubtypeEnum.alternative`. This directly proves that `enqueue()` wires `_strip_html()` into the send path via `alternative_body`.

     To inspect the enqueued task, use `background_tasks.tasks` (Starlette's BackgroundTasks stores tasks internally). The task is `(self._send, message, template_name)` — extract the `message` argument. Alternatively, mock `email_service._send` or use `unittest.mock.patch.object` to capture the args.
  </action>
  <verify>
    <automated>cd D:/Python/claude-test && python -m pytest tests/test_email.py::TestEmailService -x -v && python -m pytest tests/test_email.py::TestEmailTemplates -x -v</automated>
  </verify>
  <done>
    - `tests/conftest.py` has `mail_config` and `email_service` fixtures.
    - `TestEmailService::test_service_instantiates` passes — EmailService and FastMail instances verified.
    - `TestEmailService::test_get_email_config_from_settings` passes — ConnectionConfig built from Settings.
    - `TestEmailTemplates::test_base_template_renders` passes — base.html renders, outbox captures message.
    - `TestEmailTemplates::test_strip_html` passes — HTML tags stripped correctly.
    - `TestEmailTemplates::test_strip_html_collapses_whitespace` passes — whitespace normalized.
    - `TestEmailTemplates::test_render_plain_text` passes — _render_plain_text() renders template and strips HTML.
    - `TestEmailTemplates::test_enqueue_includes_plain_text_alternative` passes — enqueue() builds MessageSchema with non-empty alternative_body and MultipartSubtypeEnum.alternative.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create integration tests for BackgroundTasks and post-commit safety</name>
  <files>tests/test_email.py</files>
  <action>
Add integration tests to `tests/test_email.py` (same file as Task 1, append after unit test classes).

These tests need a temporary FastAPI app with a test endpoint to exercise BackgroundTasks + email integration.

**Class: TestEmailIntegration**

At the class level or in a fixture, create a minimal FastAPI test app:

```python
import time
from fastapi import FastAPI, BackgroundTasks, Depends
from fastapi_mail import ConnectionConfig, FastMail
from httpx import ASGITransport, AsyncClient
from pathlib import Path
from app.email.service import EmailService
from app.core.exceptions import AppError
```

Create a fixture `integration_app` that:
1. Creates a `ConnectionConfig` with `SUPPRESS_SEND=1` and `TEMPLATE_FOLDER` pointing to `app/email/templates/`.
2. Creates an `EmailService` with that config.
3. Creates a minimal `FastAPI()` app.
4. Adds a `POST /test-send-email` endpoint that:
   - Accepts `BackgroundTasks` as a parameter
   - Calls `email_service.enqueue(background_tasks, "user@test.com", "base.html", "Test Subject", {"test_var": "value"})`
   - Returns `{"status": "ok"}`
5. Adds a `POST /test-send-email-error` endpoint that:
   - Raises `AppError(status_code=500, detail="Simulated failure", code="TEST_ERROR")` BEFORE calling enqueue
   - (This simulates a service failure where email should NOT be sent)
6. Returns the app + email_service.fm for outbox capture.

**Tests:**

- `test_background_task_sends_email(integration_app)`:
  Use `fm.record_messages() as outbox`. Create `AsyncClient` with `ASGITransport(app=test_app)`. POST to `/test-send-email`. Assert response status is 200. Assert `len(outbox) == 1`. Assert `outbox[0]["subject"] == "Test Subject"`. Assert `"user@test.com"` in `outbox[0]["To"]`.

  This proves EMAL-05 (BackgroundTasks enqueue) and EMAL-01 (infrastructure works end-to-end).

- `test_no_email_on_route_error(integration_app)`:
  Use `fm.record_messages() as outbox`. Create `AsyncClient`. POST to `/test-send-email-error`. Assert response status is 500 (or the error handler's status). Assert `len(outbox) == 0` — no email was dispatched because the exception was raised before `enqueue()` was called.

  This proves EMAL-06 (no email on failure/rollback).

- `test_response_not_delayed_by_email(integration_app)`:
  Use `fm.record_messages() as outbox`. Measure time: `start = time.monotonic()`, POST to `/test-send-email`, `elapsed = time.monotonic() - start`. Assert `elapsed < 1.0` (response returns in under 1 second — email is background, not blocking). Assert `len(outbox) == 1` (email was still sent).

  This proves EMAL-05 (non-blocking).

**Important implementation details:**
- The `integration_app` fixture must be `async` (use `@pytest_asyncio.fixture` or `@pytest.fixture`).
- The error endpoint must raise BEFORE calling `enqueue()` to prove the structural guarantee.
- `record_messages()` must wrap the entire `await client.post(...)` call — the background task runs within the ASGITransport lifecycle before the context manager exits.
- These integration tests do NOT need the database — they test email mechanics only.
  </action>
  <verify>
    <automated>cd D:/Python/claude-test && python -m pytest tests/test_email.py::TestEmailIntegration -x -v</automated>
  </verify>
  <done>
    - `TestEmailIntegration::test_background_task_sends_email` passes — email captured in outbox after BackgroundTasks execution.
    - `TestEmailIntegration::test_no_email_on_route_error` passes — outbox is empty when route raises before enqueue.
    - `TestEmailIntegration::test_response_not_delayed_by_email` passes — response returns in under 1 second.
    - All tests run with SUPPRESS_SEND=1 (no real SMTP connections).
  </done>
</task>

</tasks>

<verification>
1. Full email test suite passes: `pytest tests/test_email.py -v` — all tests green.
2. Existing tests still pass: `pytest tests/test_health.py -x` — no regressions from conftest changes.
3. No real SMTP connections made: All tests use `SUPPRESS_SEND=1`.
4. Requirement coverage:
   - EMAL-01: `test_service_instantiates` + `test_get_email_config_from_settings` + `test_background_task_sends_email`
   - EMAL-04: `test_base_template_renders` + `test_strip_html` + `test_strip_html_collapses_whitespace` + `test_render_plain_text` + `test_enqueue_includes_plain_text_alternative`
   - EMAL-05: `test_background_task_sends_email` + `test_response_not_delayed_by_email`
   - EMAL-06: `test_no_email_on_route_error`
</verification>

<success_criteria>
- `pytest tests/test_email.py -v` shows all 10 tests passing
- `pytest tests/test_health.py -x` still passes (no regressions)
- Every requirement (EMAL-01, EMAL-04, EMAL-05, EMAL-06) has at least one test proving it
- No real SMTP connections during tests
</success_criteria>

<output>
After completion, create `.planning/phases/09-email-infrastructure/09-02-SUMMARY.md`
</output>
