# Phase 9: Email Infrastructure - Context

**Gathered:** 2026-02-26
**Status:** Ready for planning

<domain>
## Phase Boundary

A tested, reusable email service that sends async HTML emails via BackgroundTasks, never blocking the API and never sending before a DB commit. This phase builds the infrastructure and base template only — actual email types (order confirmation, restock alert) are wired in Phase 12.

</domain>

<decisions>
## Implementation Decisions

### Template design
- Shared base layout (base.html with header/footer/branding) — each email template extends it
- Templates colocated with email module at `app/email/templates/`
- Plain-text fallback auto-generated by stripping HTML tags from rendered output — no separate .txt templates
- Phase 9 ships base layout only; concrete email templates (order confirmation, restock alert) are Phase 12

### Service interface
- Direct service call pattern — endpoint calls `email_service.send(to, template, context)` explicitly
- EmailService class injected via FastAPI `Depends` — consistent with existing repository/service DI pattern
- Single recipient per call (`to: str`) — no CC/BCC support needed
- Use `fastapi-mail` library — built-in Jinja2 support, MAIL_SUPPRESS_SEND flag, battle-tested FastAPI integration

### Post-commit safety
- BackgroundTasks pattern — email added to FastAPI's BackgroundTasks in the endpoint, runs after response/commit
- Log and drop on SMTP failure — structured log entry with recipient, template, error; no retry mechanism
- Trust the caller — no runtime guard checking DB commit state; document the correct usage pattern
- Logging only for failed sends — no failed-email DB table; check logs if issues arise

### Dev/test workflow
- MAIL_* config fields added to existing pydantic-settings Settings class — env vars for all environments
- Suppressed emails captured in a mailbox fixture for test assertions (recipient, subject, rendered content)
- Dev mode logs rendered email to console (recipient, subject, HTML/text body) — no external SMTP trap needed
- Both unit tests (template rendering, service logic) and integration tests (full render-send-capture pipeline)

### Claude's Discretion
- Exact base template HTML/CSS styling
- mailbox fixture implementation details
- Console logging format for dev mode
- How to structure the auto-strip HTML-to-text conversion

</decisions>

<specifics>
## Specific Ideas

No specific requirements — open to standard approaches

</specifics>

<deferred>
## Deferred Ideas

None — discussion stayed within phase scope

</deferred>

---

*Phase: 09-email-infrastructure*
*Context gathered: 2026-02-26*
