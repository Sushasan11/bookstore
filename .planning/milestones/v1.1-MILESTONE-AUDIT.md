---
milestone: v1.1
audited: 2026-02-26T13:30:00Z
status: passed
scores:
  requirements: 17/17
  phases: 4/4
  integration: 14/14
  flows: 3/3
gaps:
  requirements: []
  integration: []
  flows: []
tech_debt:
  - phase: 12-email-notifications-wiring
    items:
      - "book_id passed in restock_alert.html context but unused in template (cosmetic — no deep-link rendered)"
---

# Milestone v1.1 Audit Report: Pre-booking, Notifications & Admin

**Audited:** 2026-02-26
**Status:** PASSED
**Milestone:** v1.1 Pre-booking, Notifications & Admin

---

## Scores

| Category | Score | Status |
|----------|-------|--------|
| Requirements | 17/17 | All satisfied |
| Phases | 4/4 | All verified (passed) |
| Integration | 14/14 | All exports wired |
| E2E Flows | 3/3 | All complete |

---

## Requirements Coverage (3-Source Cross-Reference)

| REQ-ID | Description | VERIFICATION.md | SUMMARY Frontmatter | REQUIREMENTS.md | Final |
|--------|-------------|-----------------|---------------------|-----------------|-------|
| EMAL-01 | Email infrastructure with async SMTP via fastapi-mail | passed (P9) | 09-01, 09-02 | [x] | satisfied |
| EMAL-02 | Order confirmation email after checkout | passed (P12) | 12-01, 12-02 | [x] | satisfied |
| EMAL-03 | Restock alert email for pre-booked books | passed (P12) | 12-01, 12-02 | [x] | satisfied |
| EMAL-04 | Jinja2 HTML templates with plain-text fallback | passed (P9) | 09-01, 09-02 | [x] | satisfied |
| EMAL-05 | Email never blocks API response (BackgroundTasks) | passed (P9) | 09-01, 09-02 | [x] | satisfied |
| EMAL-06 | Email only after DB commit (no email on rollback) | passed (P9) | 09-01, 09-02 | [x] | satisfied |
| ADMN-01 | Admin paginated user list | passed (P10) | 10-01, 10-02 | [x] | satisfied |
| ADMN-02 | Admin filter users by role/active status | passed (P10) | 10-01, 10-02 | [x] | satisfied |
| ADMN-03 | Admin deactivate user (is_active + revoke tokens) | passed (P10) | 10-01, 10-02 | [x] | satisfied |
| ADMN-04 | Admin reactivate user | passed (P10) | 10-01, 10-02 | [x] | satisfied |
| ADMN-05 | Admin cannot deactivate admin accounts | passed (P10) | 10-01, 10-02 | [x] | satisfied |
| PRBK-01 | User can pre-book out-of-stock book | passed (P11) | 11-02 | [x] | satisfied |
| PRBK-02 | User can view pre-booked books | passed (P11) | 11-02 | [x] | satisfied |
| PRBK-03 | User can cancel pre-booking | passed (P11) | 11-02 | [x] | satisfied |
| PRBK-04 | Pre-booking rejected when book in stock (409) | passed (P11) | 11-02 | [x] | satisfied |
| PRBK-05 | Pre-booking status tracking with timestamps | passed (P11) | 11-02 | [x] | satisfied |
| PRBK-06 | Restock broadcast notifies all waiting pre-bookers | passed (P11) | 11-02 | [x] | satisfied |

**Orphaned requirements:** 0
**Unsatisfied requirements:** 0

---

## Phase Verifications

| Phase | Goal | Score | Status |
|-------|------|-------|--------|
| 9: Email Infrastructure | Reusable email service with BackgroundTasks | 9/9 | passed |
| 10: Admin User Management | Admin user list, deactivate/reactivate | 7/7 | passed |
| 11: Pre-booking | Reserve OOS books, view/cancel, restock notification | 7/7 | passed |
| 12: Email Notifications Wiring | Order confirmation + restock alert emails | 9/9 | passed |

---

## Cross-Phase Integration

| From | To | Via | Status |
|------|----|-----|--------|
| Phase 9 EmailSvc | Phase 12 orders/router.py | EmailSvc dependency injection | WIRED |
| Phase 9 EmailSvc | Phase 12 books/router.py | EmailSvc dependency injection | WIRED |
| Phase 9 base.html | Phase 12 order_confirmation.html | Jinja2 extends | WIRED |
| Phase 9 base.html | Phase 12 restock_alert.html | Jinja2 extends | WIRED |
| Phase 10 ActiveUser | Phase 11 prebooks/router.py | Dependency on all endpoints | WIRED |
| Phase 10 ActiveUser | Phase 12 orders/router.py | Dependency on checkout | WIRED |
| Phase 10 AdminUser | Phase 11 books/router.py | Dependency on stock update | WIRED |
| Phase 10 AdminUser | Phase 10 admin/router.py | Dependency on user management | WIRED |
| Phase 10 is_active check | Phase 10 users/service.py | Login guard after password verify | WIRED |
| Phase 11 set_stock_and_notify() | Phase 12 books/router.py | notified_user_ids return value | WIRED |
| Phase 11 PreBookRepository | Phase 11 books/router.py | Local import in update_stock() | WIRED |
| Phase 12 UserRepository.get_emails_by_ids | Phase 12 books/router.py | Batch email lookup for restock | WIRED |
| Phase 12 UserRepository.get_by_id | Phase 12 orders/router.py | Single user email for checkout | WIRED |
| Phase 9 get_email_service lru_cache | Phase 12 test teardown | cache_clear() prevents leaks | WIRED |

**All 14 integration points verified.**

---

## E2E Flows

### Flow 1: Pre-book → Restock → Email Alert
POST /prebooks → PreBookService.create() (stock guard) → PreBookRepository.add() → ... → PATCH /books/{id}/stock → BookService.set_stock_and_notify() → PreBookRepository.notify_waiting_by_book() → UserRepository.get_emails_by_ids() → email_svc.enqueue(restock_alert.html) per user

**Status:** COMPLETE. Proven by test_restock_sends_alert_to_all_prebookers (2 users, 2 emails).

### Flow 2: Cart → Checkout → Confirmation Email
POST /cart/items → ... → POST /orders/checkout → OrderService.checkout() → OrderResponse.model_validate() → UserRepository.get_by_id() → email_svc.enqueue(order_confirmation.html)

**Status:** COMPLETE. Proven by test_checkout_sends_confirmation_email and test_confirmation_email_contains_order_details.

### Flow 3: Admin Deactivate → User Lockout
PATCH /admin/users/{id}/deactivate → AdminUserService.deactivate_user() → is_active=False + revoke_all_for_user() → subsequent requests hit get_active_user() → 403

**Status:** COMPLETE. Proven by test_deactivate_blocks_access_token, test_deactivate_blocks_login.

---

## Tech Debt

| Phase | Item | Severity |
|-------|------|----------|
| 12 | `book_id` passed in restock_alert.html context but not rendered in template (no deep-link to book page) | cosmetic |

**Total:** 1 cosmetic item across 4 phases.

---

## Test Coverage

| Phase | Test File | Tests | Status |
|-------|-----------|-------|--------|
| 9 | tests/test_email.py | 10 | All pass |
| 10 | tests/test_admin_users.py | 21 | All pass |
| 11 | tests/test_prebooks.py | 18 | All pass |
| 12 | tests/test_email_notifications.py | 8 | All pass |
| **Total** | | **57 milestone tests** | |
| **Full suite** | | **178 tests** | All pass |

---

_Audited: 2026-02-26_
_Auditor: Claude (gsd-audit-milestone)_
