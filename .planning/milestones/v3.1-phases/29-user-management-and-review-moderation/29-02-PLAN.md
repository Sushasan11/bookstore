---
phase: 29-user-management-and-review-moderation
plan: "02"
type: execute
wave: 2
depends_on: ["29-01"]
files_modified:
  - frontend/src/app/admin/reviews/page.tsx
autonomous: true
requirements: [REVW-01, REVW-02, REVW-03, REVW-04]

must_haves:
  truths:
    - "Admin sees a paginated review table with book title, reviewer name, rating, text snippet, and date"
    - "Admin can filter reviews by book ID, user ID, rating range (min/max), and sort by date or rating"
    - "Admin can delete a single review via row action with a confirmation dialog showing book title and reviewer"
    - "Admin can select multiple reviews via checkboxes (including select-all for current page)"
    - "Admin can bulk-delete selected reviews with a confirmation dialog that states the count"
    - "Checkbox selection clears after bulk delete succeeds and after page/filter changes"
  artifacts:
    - path: "frontend/src/app/admin/reviews/page.tsx"
      provides: "Review Moderation page with DataTable, filters, single-delete, bulk-delete with checkbox selection"
      min_lines: 150
  key_links:
    - from: "frontend/src/app/admin/reviews/page.tsx"
      to: "frontend/src/lib/admin.ts"
      via: "import { adminKeys, fetchAdminReviews, deleteSingleReview, bulkDeleteReviews }"
      pattern: "import.*adminKeys.*fetchAdminReviews.*from.*admin"
    - from: "frontend/src/app/admin/reviews/page.tsx"
      to: "frontend/src/components/admin/DataTable.tsx"
      via: "import { DataTable }"
      pattern: "DataTable.*columns.*data"
    - from: "frontend/src/app/admin/reviews/page.tsx"
      to: "frontend/src/components/admin/ConfirmDialog.tsx"
      via: "import { ConfirmDialog }"
      pattern: "ConfirmDialog.*open.*onConfirm"
---

<objective>
Build the Review Moderation page at `/admin/reviews` with a paginated, filterable table supporting single-review delete and bulk-delete via checkbox selection.

Purpose: Enables admin to moderate reviews — filter by book, user, rating range, sort by date or rating, delete individual reviews, or select multiple reviews via checkboxes and bulk-delete them in one action. Completes the second half of Phase 29.

Output: Working Review Moderation page replacing the placeholder, with full filter bar, checkbox column, and dual delete paths (single + bulk).
</objective>

<execution_context>
@C:/Users/Sushasan/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Sushasan/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/29-user-management-and-review-moderation/29-RESEARCH.md
@.planning/phases/29-user-management-and-review-moderation/29-01-SUMMARY.md

<interfaces>
<!-- Key types and contracts the executor needs. Extracted from codebase. -->
<!-- Executor should use these directly — no codebase exploration needed. -->

From frontend/src/types/api.generated.ts:
```typescript
AdminReviewAuthor: {
  user_id: number;
  display_name: string;
}

AdminReviewBook: {
  book_id: number;
  title: string;
}

AdminReviewEntry: {
  id: number;
  rating: number;
  text: string | null;
  created_at: string;   // Format: date-time
  updated_at: string;
  author: AdminReviewAuthor;
  book: AdminReviewBook;
}

AdminReviewListResponse: {
  items: AdminReviewEntry[];
  total_count: number;   // NOTE: NOT "total" — must map to AdminPagination's total prop
  page: number;
  per_page: number;
  total_pages: number;
}

BulkDeleteRequest: { review_ids: number[] }  // min 1, max 50
BulkDeleteResponse: { deleted_count: number }
```

From frontend/src/lib/admin.ts (added in Plan 29-01):
```typescript
export const adminKeys = {
  // ... existing ...
  reviews: {
    all: ['admin', 'reviews'] as const,
    list: (params: { book_id?, user_id?, rating_min?, rating_max?, sort_by?, sort_dir?, page? }) =>
      ['admin', 'reviews', 'list', params] as const,
  },
}

export async function fetchAdminReviews(accessToken, params): Promise<AdminReviewListResponse>
export async function deleteSingleReview(accessToken, reviewId): Promise<void>
export async function bulkDeleteReviews(accessToken, reviewIds: number[]): Promise<BulkDeleteResponse>
```

From frontend/src/components/admin/DataTable.tsx:
```typescript
interface DataTableProps<TData> {
  columns: ColumnDef<TData, unknown>[]
  data: TData[]
  isLoading?: boolean
  emptyMessage?: string
  loadingRows?: number
}
```

From frontend/src/components/admin/ConfirmDialog.tsx:
```typescript
interface ConfirmDialogProps {
  open: boolean
  onOpenChange: (open: boolean) => void
  title: string
  description: string
  confirmLabel?: string  // default: 'Delete'
  onConfirm: () => void
  isPending?: boolean
}
```

From frontend/src/components/admin/AdminPagination.tsx:
```typescript
interface AdminPaginationProps {
  page: number
  total: number   // Pass total_count here
  size: number
  onPageChange: (page: number) => void
}
```
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Build Review Moderation page with filters, single-delete, and bulk-delete</name>
  <files>frontend/src/app/admin/reviews/page.tsx</files>
  <action>
Replace the placeholder reviews page with a full `'use client'` page. This is the most complex page in Phase 29 due to the checkbox selection state and dual-delete paths.

**Imports:**
- `useState` from react, `useSession` from next-auth/react
- `useQuery`, `useMutation`, `useQueryClient` from @tanstack/react-query
- `type ColumnDef` from @tanstack/react-table
- `MoreHorizontal`, `Star` from lucide-react, `toast` from sonner
- `adminKeys`, `fetchAdminReviews`, `deleteSingleReview`, `bulkDeleteReviews` from @/lib/admin
- `ApiError` from @/lib/api
- `DataTable` from @/components/admin/DataTable
- `AdminPagination` from @/components/admin/AdminPagination
- `ConfirmDialog` from @/components/admin/ConfirmDialog
- `Button`, `Input`, `Select/SelectContent/SelectItem/SelectTrigger/SelectValue`, `DropdownMenu/DropdownMenuContent/DropdownMenuItem/DropdownMenuTrigger` from @/components/ui/*
- `type components` from @/types/api.generated

**Type alias:**
```typescript
type AdminReviewEntry = components['schemas']['AdminReviewEntry']
```

**Page state (const PAGE_SIZE = 20):**
- `bookIdFilter: string` — default '' (empty = no filter), used as `type="number"` input
- `userIdFilter: string` — default '' (empty = no filter), used as `type="number"` input
- `ratingMin: string` — default 'any' (Select value: 'any' | '1' | '2' | '3' | '4' | '5')
- `ratingMax: string` — default 'any'
- `sortBy: string` — default 'date' ('date' | 'rating')
- `sortDir: string` — default 'desc' ('desc' | 'asc')
- `page: number` — default 1
- `selectedIds: Set<number>` — default `new Set()`, tracks selected review IDs for bulk delete
- `deleteTarget: AdminReviewEntry | null` — review being single-deleted
- `bulkConfirmOpen: boolean` — controls bulk delete confirmation dialog

**Query:**
```typescript
const reviewsQuery = useQuery({
  queryKey: adminKeys.reviews.list({
    book_id: bookIdFilter ? Number(bookIdFilter) : null,
    user_id: userIdFilter ? Number(userIdFilter) : null,
    rating_min: ratingMin !== 'any' ? Number(ratingMin) : null,
    rating_max: ratingMax !== 'any' ? Number(ratingMax) : null,
    sort_by: sortBy,
    sort_dir: sortDir,
    page,
  }),
  queryFn: () => fetchAdminReviews(accessToken, {
    page,
    per_page: PAGE_SIZE,
    book_id: bookIdFilter ? Number(bookIdFilter) : null,
    user_id: userIdFilter ? Number(userIdFilter) : null,
    rating_min: ratingMin !== 'any' ? Number(ratingMin) : null,
    rating_max: ratingMax !== 'any' ? Number(ratingMax) : null,
    sort_by: sortBy,
    sort_dir: sortDir,
  }),
  enabled: !!accessToken,
  staleTime: 30_000,
})
```

**Checkbox selection helpers (computed inside the component):**
```typescript
const allPageIds = (reviewsQuery.data?.items ?? []).map((r) => r.id)
const allPageSelected = allPageIds.length > 0 && allPageIds.every((id) => selectedIds.has(id))
```

**Mutations (two: single-delete and bulk-delete):**

1. `singleDeleteMutation`:
   - `mutationFn: () => deleteSingleReview(accessToken, deleteTarget!.id)`
   - `onSuccess`: invalidate `adminKeys.reviews.all`, `toast.success('Review deleted')`, `setDeleteTarget(null)`
   - `onError`: ApiError check pattern

2. `bulkDeleteMutation`:
   - `mutationFn: () => bulkDeleteReviews(accessToken, Array.from(selectedIds))`
   - `onSuccess(data)`: invalidate `adminKeys.reviews.all`, `toast.success(\`${data.deleted_count} review${data.deleted_count === 1 ? '' : 's'} deleted\`)`, `setSelectedIds(new Set())`, `setBulkConfirmOpen(false)`
   - `onError`: ApiError check pattern

**Filter change handlers — ALL must reset page to 1 AND clear selectedIds:**
- `handlePageChange(newPage)` — sets page, clears selectedIds
- Filter handlers for bookId, userId, ratingMin, ratingMax, sortBy, sortDir — each sets state, resets page to 1, clears selectedIds

**Column definitions (ColumnDef<AdminReviewEntry, unknown>[]):**

1. **Checkbox column** `id: 'select'` — header renders a checkbox for select-all (checked = `allPageSelected`), onChange toggles all page IDs in/out of selectedIds. Cell renders a checkbox per row (checked = `selectedIds.has(row.original.id)`), onChange toggles that ID. Use native `<input type="checkbox">` with `aria-label`. The header checkbox should use `ref` with `indeterminate` set to `selectedIds.size > 0 && !allPageSelected` for partial selection state — but since native checkboxes need imperative indeterminate, a simpler approach is to just use checked/unchecked (skip indeterminate).

2. `id: 'book'` — header "Book", cell renders `row.original.book.title` in `font-medium`

3. `id: 'reviewer'` — header "Reviewer", cell renders `row.original.author.display_name` in `text-muted-foreground`

4. `accessorKey: 'rating'` — header "Rating", cell renders `row.original.rating` with star icon: e.g., `<span className="flex items-center gap-1"><Star className="h-3 w-3 fill-amber-400 text-amber-400" />{row.original.rating}</span>`

5. `id: 'text'` — header "Review", cell renders truncated text: `row.original.text ? row.original.text.substring(0, 80) + (row.original.text.length > 80 ? '...' : '') : '—'` in `text-muted-foreground text-xs max-w-[200px]`

6. `id: 'date'` — header "Date", cell renders `new Date(row.original.created_at).toLocaleDateString()` in `text-muted-foreground`

7. `id: 'actions'` — header "", cell renders DropdownMenu with single "Delete" item, `className="text-destructive"`, onClick sets `setDeleteTarget(row.original)`

**JSX layout:**

1. **Page header:** `<h1>Review Moderation</h1>` (no add button)

2. **Filter bar** (flex wrap gap-3):
   - `Input` with `type="number"` placeholder "Book ID" for bookIdFilter, `className="w-28"`, onChange resets page + clears selection
   - `Input` with `type="number"` placeholder "User ID" for userIdFilter, `className="w-28"`, onChange resets page + clears selection
   - `Select` for ratingMin: "Min ★" placeholder, options: "Any" + 1-5 with "N ★" labels
   - `Select` for ratingMax: "Max ★" placeholder, options: "Any" + 1-5 with "N ★" labels
   - `Select` for sortBy: "Date" / "Rating"
   - `Select` for sortDir: "Desc" / "Asc" (or "Newest First" / "Oldest First" for date, "Highest First" / "Lowest First" for rating — keep it simple with "Desc" / "Asc")

3. **Bulk action bar** (conditional, appears only when `selectedIds.size > 0`):
   ```tsx
   {selectedIds.size > 0 && (
     <div className="flex items-center gap-3 rounded-lg border bg-muted/50 px-4 py-2">
       <span className="text-sm font-medium">
         {selectedIds.size} selected
       </span>
       <Button
         variant="destructive"
         size="sm"
         onClick={() => setBulkConfirmOpen(true)}
       >
         Delete Selected
       </Button>
     </div>
   )}
   ```

4. **Error state:** Same pattern as catalog/users page

5. **DataTable:** `<DataTable columns={columns} data={reviews} isLoading={reviewsQuery.isLoading} emptyMessage="No reviews found." />`

6. **AdminPagination:** `total={reviewsQuery.data?.total_count ?? 0}` — **CRITICAL: use total_count, NOT total**

7. **Single-delete ConfirmDialog:**
   ```tsx
   <ConfirmDialog
     open={deleteTarget !== null}
     onOpenChange={(open) => { if (!open) setDeleteTarget(null) }}
     title="Delete Review"
     description={`Delete the review by ${deleteTarget?.author.display_name} for '${deleteTarget?.book.title}'? This cannot be undone.`}
     confirmLabel="Delete"
     onConfirm={() => singleDeleteMutation.mutate()}
     isPending={singleDeleteMutation.isPending}
   />
   ```

8. **Bulk-delete ConfirmDialog:**
   ```tsx
   <ConfirmDialog
     open={bulkConfirmOpen}
     onOpenChange={(open) => { if (!open) setBulkConfirmOpen(false) }}
     title="Delete Reviews"
     description={`Delete ${selectedIds.size} selected review${selectedIds.size === 1 ? '' : 's'}? This cannot be undone.`}
     confirmLabel="Delete"
     onConfirm={() => bulkDeleteMutation.mutate()}
     isPending={bulkDeleteMutation.isPending}
   />
   ```

**Key pitfalls to avoid:**
- Use `total_count` not `total` for AdminPagination total prop
- Clear `selectedIds` on page change AND filter changes — prevents stale selection state
- Single-review delete endpoint is `DELETE /reviews/{id}` NOT `/admin/reviews/{id}`
- Bulk delete button must not be clickable when `selectedIds.size === 0` (but it only renders when size > 0, so this is naturally guarded)
- `book_id` and `user_id` filter inputs use `type="number"` — the API expects integers
  </action>
  <verify>
    <automated>cd D:/Python/claude-test/frontend && npx tsc --noEmit 2>&1 | head -20 && npm run build 2>&1 | tail -10</automated>
  </verify>
  <done>Review Moderation page renders with paginated table including checkbox column, filter bar with book ID, user ID, rating min/max, sort by, sort direction, single-delete via row DropdownMenu + ConfirmDialog, bulk-delete via conditional toolbar + ConfirmDialog, selection state clears on bulk delete success and page/filter changes, total_count mapped correctly to AdminPagination, TypeScript compiles and Next.js builds without errors</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` — zero TypeScript errors
2. `npm run build` — production build succeeds with /admin/reviews as a dynamic route
3. Checkbox column has `id: 'select'` with header select-all and per-row checkboxes
4. Filter bar includes book ID input, user ID input, rating min/max selects, sort by select, sort dir select
5. Bulk action bar appears conditionally when `selectedIds.size > 0`
6. Single-delete ConfirmDialog shows book title and reviewer name
7. Bulk-delete ConfirmDialog shows selected count
8. `selectedIds` clears on bulk delete success, page change, and filter change
9. AdminPagination receives `total_count` (not `total`)
10. Single-review delete calls `/reviews/{id}` (not `/admin/reviews/{id}`)
</verification>

<success_criteria>
- Admin can view a paginated review table at /admin/reviews with book title, reviewer, rating (with star icon), text snippet, date, and action columns
- Admin can filter reviews by book ID, user ID, rating range (min/max), and sort by date or rating in ascending or descending order
- Admin can delete a single review: row DropdownMenu → Delete → ConfirmDialog showing "Delete the review by X for 'Y'?" → toast success
- Admin can select multiple reviews via checkboxes, including select-all for the current page
- Admin sees a "N selected — Delete Selected" toolbar when checkboxes are checked
- Admin can bulk-delete selected reviews: Delete Selected → ConfirmDialog showing "Delete N selected reviews?" → toast success with deleted count
- After bulk delete, all checkboxes clear automatically
- Changing page or any filter clears the checkbox selection
- Pagination uses total_count field from AdminReviewListResponse (not catalog's total)
</success_criteria>

<output>
After completion, create `.planning/phases/29-user-management-and-review-moderation/29-02-SUMMARY.md`
</output>
