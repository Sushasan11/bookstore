---
phase: 29-user-management-and-review-moderation
plan: "01"
type: execute
wave: 1
depends_on: []
files_modified:
  - frontend/src/lib/admin.ts
  - frontend/src/app/admin/users/page.tsx
autonomous: true
requirements: [USER-01, USER-02, USER-03, USER-04]

must_haves:
  truths:
    - "Admin sees a paginated user table with email, role badge, active status badge, join date, and action buttons"
    - "Admin can filter the user table by role (all/user/admin) and active status (all/active/inactive)"
    - "Admin can deactivate a non-admin user via a confirmation dialog that warns about immediate lockout"
    - "Admin cannot deactivate an admin-role user — the Deactivate menu item is disabled for admin rows"
    - "Admin can reactivate an inactive user via a confirmation dialog"
    - "After deactivate or reactivate, the table refreshes and shows the updated status"
  artifacts:
    - path: "frontend/src/lib/admin.ts"
      provides: "adminKeys.users and adminKeys.reviews namespaces, fetchAdminUsers, deactivateUser, reactivateUser, fetchAdminReviews, deleteSingleReview, bulkDeleteReviews functions"
      contains: "adminKeys.users"
    - path: "frontend/src/app/admin/users/page.tsx"
      provides: "User Management page with DataTable, filters, mutations"
      min_lines: 100
  key_links:
    - from: "frontend/src/app/admin/users/page.tsx"
      to: "frontend/src/lib/admin.ts"
      via: "import { adminKeys, fetchAdminUsers, deactivateUser, reactivateUser }"
      pattern: "import.*adminKeys.*from.*admin"
    - from: "frontend/src/app/admin/users/page.tsx"
      to: "frontend/src/components/admin/DataTable.tsx"
      via: "import { DataTable }"
      pattern: "DataTable.*columns.*data"
    - from: "frontend/src/app/admin/users/page.tsx"
      to: "frontend/src/components/admin/ConfirmDialog.tsx"
      via: "import { ConfirmDialog }"
      pattern: "ConfirmDialog.*open.*onConfirm"
---

<objective>
Extend the admin data layer with user and review fetch/mutation functions, then build the User Management page at `/admin/users` with a paginated, filterable table supporting deactivate and reactivate actions.

Purpose: Enables admin to view all user accounts, filter by role and status, and manage user access (deactivate/reactivate) — the first half of Phase 29's user management and review moderation goal.

Output: Extended `admin.ts` with all Phase 29 functions (users + reviews), working User Management page replacing the placeholder.
</objective>

<execution_context>
@C:/Users/Sushasan/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Sushasan/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/29-user-management-and-review-moderation/29-RESEARCH.md

<interfaces>
<!-- Key types and contracts the executor needs. Extracted from codebase. -->
<!-- Executor should use these directly — no codebase exploration needed. -->

From frontend/src/types/api.generated.ts:
```typescript
AdminUserResponse: {
  id: number;
  email: string;
  full_name?: string | null;
  role: string;
  is_active: boolean;
  created_at: string;  // Format: date-time
}

UserListResponse: {
  items: AdminUserResponse[];
  total_count: number;  // NOTE: NOT "total" — different from catalog's PaginatedResponse
  page: number;
  per_page: number;
  total_pages: number;
}

AdminReviewEntry: {
  id: number;
  rating: number;
  text: string | null;
  created_at: string;
  updated_at: string;
  author: { user_id: number; display_name: string };
  book: { book_id: number; title: string };
}

AdminReviewListResponse: {
  items: AdminReviewEntry[];
  total_count: number;  // NOTE: NOT "total"
  page: number;
  per_page: number;
  total_pages: number;
}

BulkDeleteRequest: { review_ids: number[] }
BulkDeleteResponse: { deleted_count: number }
```

From frontend/src/lib/admin.ts (existing pattern to extend):
```typescript
export const adminKeys = {
  all: ['admin'] as const,
  sales: { /* ... */ },
  inventory: { /* ... */ },
  catalog: {
    all: ['admin', 'catalog'] as const,
    list: (params: { q?: string; genre_id?: number; page?: number }) =>
      ['admin', 'catalog', 'list', params] as const,
    genres: ['admin', 'catalog', 'genres'] as const,
  },
} as const
```

From frontend/src/components/admin/DataTable.tsx:
```typescript
interface DataTableProps<TData> {
  columns: ColumnDef<TData, unknown>[]
  data: TData[]
  isLoading?: boolean
  emptyMessage?: string
  loadingRows?: number
}
export function DataTable<TData>({ columns, data, isLoading, emptyMessage, loadingRows }: DataTableProps<TData>)
```

From frontend/src/components/admin/ConfirmDialog.tsx:
```typescript
interface ConfirmDialogProps {
  open: boolean
  onOpenChange: (open: boolean) => void
  title: string
  description: string
  confirmLabel?: string  // default: 'Delete'
  onConfirm: () => void
  isPending?: boolean
}
```

From frontend/src/components/admin/AdminPagination.tsx:
```typescript
interface AdminPaginationProps {
  page: number
  total: number  // Pass total_count from UserListResponse here
  size: number
  onPageChange: (page: number) => void
}
```

From frontend/src/lib/api.ts:
```typescript
export function apiFetch<T>(url: string, init?: RequestInit): Promise<T>
export class ApiError extends Error { detail?: string }
```
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend admin.ts with users and reviews namespaces and all fetch/mutation functions</name>
  <files>frontend/src/lib/admin.ts</files>
  <action>
Add `users` and `reviews` namespaces to the existing `adminKeys` object, and add 6 new fetch/mutation functions. All follow the exact same `apiFetch` + Bearer token pattern as existing functions in this file.

**adminKeys extension** — add after the `catalog` namespace:
```typescript
users: {
  all: ['admin', 'users'] as const,
  list: (params: { role?: string | null; is_active?: boolean | null; page?: number }) =>
    ['admin', 'users', 'list', params] as const,
},
reviews: {
  all: ['admin', 'reviews'] as const,
  list: (params: {
    book_id?: number | null; user_id?: number | null;
    rating_min?: number | null; rating_max?: number | null;
    sort_by?: string; sort_dir?: string; page?: number;
  }) => ['admin', 'reviews', 'list', params] as const,
},
```

**Type imports** — add at top of file alongside existing type imports:
```typescript
type AdminUserResponse = components['schemas']['AdminUserResponse']
type UserListResponse = components['schemas']['UserListResponse']
type AdminReviewListResponse = components['schemas']['AdminReviewListResponse']
type BulkDeleteResponse = components['schemas']['BulkDeleteResponse']
```

**Fetch functions** — add after existing `deleteBook` function:

1. `fetchAdminUsers(accessToken, params: { page?, per_page?, role?, is_active? })` → `GET /admin/users?{qs}` → `UserListResponse`
   - Build URLSearchParams: set `page`, `per_page` if truthy; set `role` if not null; set `is_active` as `"true"`/`"false"` string if not null

2. `deactivateUser(accessToken, userId)` → `PATCH /admin/users/${userId}/deactivate` → `AdminUserResponse`

3. `reactivateUser(accessToken, userId)` → `PATCH /admin/users/${userId}/reactivate` → `AdminUserResponse`

4. `fetchAdminReviews(accessToken, params: { page?, per_page?, book_id?, user_id?, rating_min?, rating_max?, sort_by?, sort_dir? })` → `GET /admin/reviews?{qs}` → `AdminReviewListResponse`
   - Build URLSearchParams: set each param if not null/undefined

5. `deleteSingleReview(accessToken, reviewId)` → `DELETE /reviews/${reviewId}` (NOT `/admin/reviews/` — admin bypass is automatic via token) → `void`

6. `bulkDeleteReviews(accessToken, reviewIds: number[])` → `DELETE /admin/reviews/bulk` with `{ review_ids: reviewIds }` body → `BulkDeleteResponse`
   - Must use `body: JSON.stringify({ review_ids: reviewIds })` — the DELETE body pattern (same as apiFetch handles)

All functions export individually (named exports, not default). Follow the exact JSDoc comment style of existing functions in the file.
  </action>
  <verify>
    <automated>cd D:/Python/claude-test/frontend && npx tsc --noEmit 2>&1 | head -20</automated>
  </verify>
  <done>adminKeys has `users` and `reviews` namespaces; all 6 functions compile without TypeScript errors; function signatures match the API schema types from api.generated.ts</done>
</task>

<task type="auto">
  <name>Task 2: Build User Management page with DataTable, filters, and deactivate/reactivate</name>
  <files>frontend/src/app/admin/users/page.tsx</files>
  <action>
Replace the placeholder users page with a full `'use client'` page that mirrors the catalog page structure. The page must:

**Imports:**
- `useState` from react, `useSession` from next-auth/react
- `useQuery`, `useMutation`, `useQueryClient` from @tanstack/react-query
- `type ColumnDef` from @tanstack/react-table
- `MoreHorizontal` from lucide-react, `toast` from sonner
- `adminKeys`, `fetchAdminUsers`, `deactivateUser`, `reactivateUser` from @/lib/admin
- `ApiError` from @/lib/api
- `DataTable` from @/components/admin/DataTable
- `AdminPagination` from @/components/admin/AdminPagination
- `ConfirmDialog` from @/components/admin/ConfirmDialog
- `Badge`, `Button`, `Select/SelectContent/SelectItem/SelectTrigger/SelectValue`, `DropdownMenu/DropdownMenuContent/DropdownMenuItem/DropdownMenuTrigger` from @/components/ui/*
- `type components` from @/types/api.generated

**Type alias:**
```typescript
type AdminUserResponse = components['schemas']['AdminUserResponse']
```

**Page state (const PAGE_SIZE = 20):**
- `roleFilter: string` — 'all' | 'user' | 'admin', default 'all'
- `statusFilter: string` — 'all' | 'active' | 'inactive', default 'all'
- `page: number` — default 1
- `actionTarget: AdminUserResponse | null` — user being acted on
- `pendingAction: 'deactivate' | 'reactivate' | null` — which action is pending

**Query:**
- `useQuery` with `adminKeys.users.list({ role, is_active, page })` — convert roleFilter ('all' → undefined) and statusFilter ('all' → undefined, 'active' → true, 'inactive' → false). `enabled: !!accessToken`, `staleTime: 30_000`.

**Mutations (two separate useMutation):**
- `deactivateMutation`: calls `deactivateUser(accessToken, actionTarget!.id)`, onSuccess invalidates `adminKeys.users.all`, shows `toast.success(\`${actionTarget!.email} has been deactivated\`)`, clears actionTarget and pendingAction. onError uses ApiError check pattern.
- `reactivateMutation`: same pattern, calls `reactivateUser`, toast says "has been reactivated".

**Filter change handlers:**
- `handleRoleChange(value)` — sets roleFilter, resets page to 1
- `handleStatusChange(value)` — sets statusFilter, resets page to 1

**Inline badge components (defined inside the file, above the page component):**
- `RoleBadge({ role })` — admin: purple-100/purple-700 badge text "Admin"; user: blue-100/blue-700 badge text "User". Include dark mode classes (dark:bg-purple-900/30 dark:text-purple-400, dark:bg-blue-900/30 dark:text-blue-400).
- `ActiveBadge({ isActive })` — active: green-100/green-700 text "Active"; inactive: red-100/red-700 text "Inactive". Include dark mode classes.

**Column definitions (ColumnDef<AdminUserResponse, unknown>[]):**
1. `accessorKey: 'email'` — header "Email", cell renders email as `font-medium`
2. `id: 'role'` — header "Role", cell renders `<RoleBadge role={row.original.role} />`
3. `id: 'status'` — header "Status", cell renders `<ActiveBadge isActive={row.original.is_active} />`
4. `id: 'joined'` — header "Joined", cell renders `new Date(row.original.created_at).toLocaleDateString()` in `text-muted-foreground`
5. `id: 'actions'` — header "", cell renders DropdownMenu with:
   - If `user.is_active === true`: show "Deactivate" item, `disabled={user.role === 'admin'}` with `className={user.role === 'admin' ? 'cursor-not-allowed opacity-50' : ''}`, onClick sets actionTarget and pendingAction to 'deactivate'
   - If `user.is_active === false`: show "Reactivate" item, onClick sets actionTarget and pendingAction to 'reactivate'

**JSX layout (follows catalog page structure):**
1. Page header: `<h1>User Management</h1>` (no add button — users are not created from admin)
2. Filter bar: two `Select` dropdowns side by side
   - Role filter: "All Roles" / "User" / "Admin" with values 'all' / 'user' / 'admin'
   - Status filter: "All Status" / "Active" / "Inactive" with values 'all' / 'active' / 'inactive'
3. Error state: same pattern as catalog (border-destructive, Retry button)
4. `<DataTable>` with columns, data from `usersQuery.data?.items ?? []`, isLoading, emptyMessage "No users found."
5. `<AdminPagination>` — **CRITICAL:** pass `total={usersQuery.data?.total_count ?? 0}` (NOT `.total` — admin endpoints use `total_count`)
6. Single `<ConfirmDialog>` driven by `actionTarget` and `pendingAction`:
   - `open={actionTarget !== null && pendingAction !== null}`
   - `title` = "Deactivate User" or "Reactivate User" based on pendingAction
   - `description` = deactivate: "This will immediately revoke {email}'s session tokens and lock them out. They will not be able to log in until reactivated." / reactivate: "Restore access for {email}? They will be able to log in immediately."
   - `confirmLabel` = "Deactivate" or "Reactivate"
   - `onConfirm` dispatches the correct mutation
   - `isPending` = either mutation's isPending
  </action>
  <verify>
    <automated>cd D:/Python/claude-test/frontend && npx tsc --noEmit 2>&1 | head -20 && npm run build 2>&1 | tail -10</automated>
  </verify>
  <done>User Management page renders with paginated table, role and status filter dropdowns, DropdownMenu per row with Deactivate (disabled for admins) or Reactivate, ConfirmDialog with severity-aware description text, all mutations invalidate adminKeys.users.all, total_count mapped correctly to AdminPagination total prop, TypeScript compiles and Next.js builds without errors</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` — zero TypeScript errors
2. `npm run build` — production build succeeds with /admin/users as a dynamic route
3. `adminKeys.users` and `adminKeys.reviews` exist in admin.ts
4. All 6 new fetch/mutation functions are exported from admin.ts
5. User page imports DataTable, AdminPagination, ConfirmDialog from admin components
6. AdminPagination receives `total_count` (not `total`) from the query response
7. Deactivate DropdownMenuItem has `disabled={user.role === 'admin'}` guard
8. ConfirmDialog description text differs for deactivate vs reactivate (severity-aware)
</verification>

<success_criteria>
- Admin can view a paginated user table at /admin/users with email, role badge, active status badge, join date, and actions columns
- Admin can filter by role (All Roles / User / Admin) and active status (All Status / Active / Inactive) via Select dropdowns
- Admin can deactivate a non-admin user via DropdownMenu → Deactivate → ConfirmDialog → toast success
- Admin cannot deactivate an admin-role user (Deactivate item is disabled and visually muted)
- Admin can reactivate an inactive user via DropdownMenu → Reactivate → ConfirmDialog → toast success
- Table refreshes after deactivate/reactivate via cache invalidation
- Pagination uses total_count field from UserListResponse (not catalog's total)
</success_criteria>

<output>
After completion, create `.planning/phases/29-user-management-and-review-moderation/29-01-SUMMARY.md`
</output>
