---
phase: 27-sales-analytics-and-inventory-alerts
plan: 02
type: execute
wave: 2
depends_on:
  - 27-01
files_modified:
  - frontend/src/app/admin/inventory/page.tsx
  - frontend/src/lib/admin.ts
autonomous: true
requirements:
  - INVT-01
  - INVT-02
  - INVT-03

must_haves:
  truths:
    - "Admin on the Inventory Alerts page sees books sorted by stock ascending with red badges for out-of-stock and amber badges for low stock"
    - "Admin can change the stock threshold via a free-form input field and the table updates after 500ms debounce"
    - "Admin can still use preset buttons (5, 10, 20) as quick threshold shortcuts alongside the input field"
    - "Admin can click Update Stock on any row to open a modal showing book title, current stock, and a number input for new quantity"
    - "After successful stock update the modal closes, the table refetches, and a success toast appears"
  artifacts:
    - path: "frontend/src/app/admin/inventory/page.tsx"
      provides: "Enhanced Inventory Alerts page with Badge components, debounced threshold input, preset buttons, and stock update modal"
      min_lines: 150
    - path: "frontend/src/lib/admin.ts"
      provides: "updateBookStock function wrapping PATCH /books/{book_id}/stock"
      exports: ["adminKeys", "fetchSalesSummary", "fetchTopBooks", "fetchLowStock", "updateBookStock"]
  key_links:
    - from: "frontend/src/app/admin/inventory/page.tsx"
      to: "frontend/src/lib/admin.ts"
      via: "useQuery with adminKeys.inventory.lowStock and useMutation with updateBookStock"
      pattern: "adminKeys\\.inventory\\.lowStock|updateBookStock"
    - from: "frontend/src/app/admin/inventory/page.tsx"
      to: "@/components/ui/dialog"
      via: "Dialog, DialogContent, DialogHeader, DialogTitle, DialogFooter imports for stock update modal"
      pattern: "Dialog"
    - from: "frontend/src/app/admin/inventory/page.tsx"
      to: "@/components/ui/badge"
      via: "Badge component with className override for red/amber stock status pills"
      pattern: "Badge.*className.*red|amber"
---

<objective>
Enhance the existing Inventory Alerts page with shadcn Badge components for stock status, a free-form threshold input with 500ms debounce alongside preset buttons, and an "Update Stock" action per row that opens a Dialog modal with a useMutation call to PATCH /books/{book_id}/stock.

Purpose: Gives admins a polished inventory view with at-a-glance stock status badges and a quick way to restock books directly from the alerts page.
Output: Enhanced Inventory Alerts page at `/admin/inventory` with badges, flexible threshold control, and stock update modal.
</objective>

<execution_context>
@C:/Users/Sushasan/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Sushasan/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/27-sales-analytics-and-inventory-alerts/27-CONTEXT.md
@.planning/phases/27-sales-analytics-and-inventory-alerts/27-RESEARCH.md
@.planning/phases/27-sales-analytics-and-inventory-alerts/27-01-SUMMARY.md
@frontend/src/app/admin/inventory/page.tsx
@frontend/src/lib/admin.ts
@frontend/src/lib/api.ts

<interfaces>
<!-- Key types and contracts the executor needs. Extracted from codebase. -->

From frontend/src/lib/admin.ts (after Plan 27-01 updates):
```typescript
export type LowStockResponse = {
  threshold: number
  total_low_stock: number
  items: Array<{
    book_id: number
    title: string
    author: string
    current_stock: number
    threshold: number
  }>
}

export const adminKeys = {
  // ... (sales keys already updated in Plan 01)
  inventory: {
    all: ['admin', 'inventory'] as const,
    lowStock: (threshold: number) => ['admin', 'inventory', 'low-stock', threshold] as const,
  },
} as const

export async function fetchLowStock(accessToken: string, threshold?: number): Promise<LowStockResponse>
// updateBookStock will be ADDED in Task 1 of this plan
```

From frontend/src/lib/api.ts:
```typescript
export async function apiFetch<T>(path: string, options?: RequestInit): Promise<T>
// Handles 204 No Content as `return undefined as T`
```

From frontend/src/components/ui/badge.tsx:
```typescript
export { Badge, badgeVariants }
// Badge supports className override for custom colors (red/amber)
// Do NOT add new variants — use className override per RESEARCH.md Pattern 6
```

From frontend/src/components/ui/dialog.tsx:
```typescript
export {
  Dialog, DialogClose, DialogContent, DialogDescription,
  DialogFooter, DialogHeader, DialogOverlay, DialogPortal,
  DialogTitle, DialogTrigger,
}
```

From frontend/src/components/ui/input.tsx:
```typescript
// Standard shadcn Input component with forwardRef
// Use: <Input type="number" ... />
```

From use-debounce (v10.1.0, already installed):
```typescript
import { useDebounce } from 'use-debounce'
// useDebounce(value: T, delay: number) => [debouncedValue: T, controls]
```

From sonner (already installed and wired in providers):
```typescript
import { toast } from 'sonner'
// toast.success('message'), toast.error('message')
```

Backend endpoint (no backend changes needed):
```
PATCH /books/{book_id}/stock
Body: { "quantity": int (>= 0) }
Auth: Bearer token (admin-only)
Response: 200 with updated book object, or 204 No Content
```
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add updateBookStock function to admin.ts</name>
  <files>
    frontend/src/lib/admin.ts
  </files>
  <action>
Add the `updateBookStock` function to `frontend/src/lib/admin.ts` after the existing `fetchLowStock` function.

```typescript
/**
 * Update a book's stock quantity.
 * Backend: PATCH /books/{book_id}/stock with { quantity: int (>= 0) }
 * Admin-only endpoint. Triggers restock alerts if quantity goes from 0 to positive.
 */
export async function updateBookStock(
  accessToken: string,
  bookId: number,
  quantity: number
): Promise<void> {
  return apiFetch<void>(
    `/books/${bookId}/stock`,
    {
      method: 'PATCH',
      body: JSON.stringify({ quantity }),
      headers: { Authorization: `Bearer ${accessToken}` },
    }
  )
}
```

Note: `apiFetch` handles 204 No Content by returning `undefined as T`, so the `void` return type works correctly. The function uses the same auth pattern as all other admin fetch functions in this file.
  </action>
  <verify>
    <automated>cd frontend && npx tsc --noEmit --pretty 2>&1 | head -20 && node -e "const c = require('fs').readFileSync('src/lib/admin.ts', 'utf8'); console.log(c.includes('updateBookStock') ? 'PASS: updateBookStock exists' : 'FAIL: updateBookStock missing')"</automated>
  </verify>
  <done>
    - updateBookStock function exported from admin.ts
    - Function accepts (accessToken, bookId, quantity) and calls PATCH /books/{bookId}/stock
    - TypeScript compiles without errors
  </done>
</task>

<task type="auto">
  <name>Task 2: Enhance Inventory Alerts page with Badge components, debounced threshold input, and stock update modal</name>
  <files>
    frontend/src/app/admin/inventory/page.tsx
  </files>
  <action>
Rewrite `frontend/src/app/admin/inventory/page.tsx` to enhance the existing page with three improvements: Badge components for stock status, a free-form threshold input with debounce, and an "Update Stock" button per row opening a Dialog modal.

**Imports to add (beyond existing):**
- `import { useDebounce } from 'use-debounce'`
- `import { useMutation, useQueryClient } from '@tanstack/react-query'`
- `import { updateBookStock } from '@/lib/admin'`
- `import { Badge } from '@/components/ui/badge'`
- `import { Input } from '@/components/ui/input'`
- `import { Dialog, DialogContent, DialogHeader, DialogTitle, DialogFooter, DialogDescription } from '@/components/ui/dialog'`
- `import { toast } from 'sonner'`

**State changes:**

Replace the current `threshold` state (which is typed as `Threshold` from a union of 5|10|20) with:
```typescript
const [thresholdInput, setThresholdInput] = useState<number>(10)
const [debouncedThreshold] = useDebounce(thresholdInput, 500)
```
Use `debouncedThreshold` in the query key and queryFn instead of the raw `thresholdInput`. This enables debounced live updates as the admin types.

Add modal state:
```typescript
const [selectedBook, setSelectedBook] = useState<{ book_id: number; title: string; current_stock: number } | null>(null)
const [newQuantity, setNewQuantity] = useState<number>(0)
const modalOpen = selectedBook !== null
```

**useMutation for stock update:**
```typescript
const queryClient = useQueryClient()

const stockMutation = useMutation({
  mutationFn: ({ bookId, quantity }: { bookId: number; quantity: number }) =>
    updateBookStock(accessToken, bookId, quantity),
  onSuccess: () => {
    queryClient.invalidateQueries({ queryKey: adminKeys.inventory.all })
    toast.success('Stock updated successfully')
    setSelectedBook(null)  // closes modal
  },
  onError: () => {
    toast.error('Failed to update stock')
  },
})
```

**Threshold control section (replace existing preset-only buttons):**
- Keep the three preset buttons (5, 10, 20) — they set `thresholdInput` directly
- Add a free-form `<Input type="number" min={0} max={999} />` next to the preset buttons
- Input value bound to `thresholdInput`, onChange sets `setThresholdInput(Number(e.target.value))`
- Layout: preset buttons on the left, then a separator (pipe `|` or gap), then the Input with a label like "Custom:"
- When a preset button is clicked, it sets `thresholdInput` to that value (the input field updates to reflect it)
- The 500ms debounce applies to both preset clicks and manual typing — this is acceptable per CONTEXT.md

**Stock status badges (replace inline colored text in the stock column):**
Create a `StockBadge` inline component or helper:
```typescript
function StockBadge({ stock, threshold }: { stock: number; threshold: number }) {
  if (stock === 0) {
    return (
      <Badge className="bg-red-100 text-red-700 border-red-200 dark:bg-red-900/30 dark:text-red-400">
        Out of Stock
      </Badge>
    )
  }
  if (stock <= threshold) {
    return (
      <Badge className="bg-amber-100 text-amber-700 border-amber-200 dark:bg-amber-900/30 dark:text-amber-400">
        Low Stock ({stock})
      </Badge>
    )
  }
  return <span className="font-medium">{stock}</span>
}
```
Replace the current `<td>` that shows `item.current_stock` with inline colored text — instead render `<StockBadge stock={item.current_stock} threshold={debouncedThreshold} />`.

**Table changes:**
- Add a 5th column: "Actions" (right-aligned header, `w-32`)
- In each row, add an "Update Stock" `<Button variant="outline" size="sm">` that calls:
  ```typescript
  onClick={() => {
    setSelectedBook({ book_id: item.book_id, title: item.title, current_stock: item.current_stock })
    setNewQuantity(item.current_stock)
  }}
  ```
- Update the `colSpan` in loading, error, and empty states from `4` to `5`

**Stock Update Modal (Dialog):**
Render a `<Dialog>` at the end of the component:
```tsx
<Dialog
  open={modalOpen}
  onOpenChange={(open) => {
    if (!open) {
      setSelectedBook(null)
      setNewQuantity(0)
    }
  }}
>
  <DialogContent>
    <DialogHeader>
      <DialogTitle>Update Stock</DialogTitle>
      <DialogDescription>
        Set a new stock quantity for {selectedBook?.title}
      </DialogDescription>
    </DialogHeader>
    <div className="space-y-4 py-4">
      <div className="text-sm text-muted-foreground">
        Current stock: <span className="font-medium text-foreground">{selectedBook?.current_stock}</span>
      </div>
      <div className="space-y-2">
        <label htmlFor="stock-input" className="text-sm font-medium">
          New quantity
        </label>
        <Input
          id="stock-input"
          type="number"
          min={0}
          value={newQuantity}
          onChange={(e) => setNewQuantity(Number(e.target.value))}
        />
      </div>
    </div>
    <DialogFooter>
      <Button variant="outline" onClick={() => setSelectedBook(null)}>
        Cancel
      </Button>
      <Button
        onClick={() => {
          if (selectedBook) {
            stockMutation.mutate({ bookId: selectedBook.book_id, quantity: newQuantity })
          }
        }}
        disabled={stockMutation.isPending}
      >
        {stockMutation.isPending ? 'Updating...' : 'Save'}
      </Button>
    </DialogFooter>
  </DialogContent>
</Dialog>
```

**Key implementation notes:**
- Reset `newQuantity` and `selectedBook` in `onOpenChange` when `open` becomes `false` to prevent stale state when reopening for a different book (see RESEARCH.md Pitfall 5)
- The `Save` button is disabled while `stockMutation.isPending` to prevent double submissions
- `onSuccess` invalidates `adminKeys.inventory.all` (covers all threshold variants in the cache)
- The summary card text should use `debouncedThreshold` to stay in sync with the table
  </action>
  <verify>
    <automated>cd frontend && npx tsc --noEmit --pretty 2>&1 | head -30 && echo "---TSC DONE---" && node -e "const c = require('fs').readFileSync('src/app/admin/inventory/page.tsx', 'utf8'); const checks = [['useDebounce', c.includes('useDebounce')], ['useMutation', c.includes('useMutation')], ['Badge', c.includes('Badge')], ['Dialog', c.includes('Dialog')], ['updateBookStock', c.includes('updateBookStock')], ['toast', c.includes('toast')], ['Input', c.includes('Input')], ['StockBadge or badge logic', c.includes('Out of Stock') || c.includes('out-of-stock')], ['debouncedThreshold', c.includes('debouncedThreshold')]]; checks.forEach(([name, ok]) => console.log(ok ? 'PASS' : 'FAIL', name))"</automated>
  </verify>
  <done>
    - Inventory page uses Badge components: red pill for stock=0 ("Out of Stock"), amber pill for stock 1+ below threshold ("Low Stock (N)")
    - Free-form Input type="number" for threshold with 500ms useDebounce, alongside preset buttons (5, 10, 20)
    - Debounced threshold value drives the TanStack Query queryKey and queryFn
    - "Update Stock" button on each table row opens a Dialog modal
    - Modal shows book title, current stock reference, and number input for new quantity
    - useMutation calls updateBookStock, invalidates inventory cache on success, shows toast
    - Modal resets state on close to prevent stale data
    - Table has 5 columns (Title, Author, Stock with Badge, Threshold, Actions)
    - TypeScript compiles without errors
  </done>
</task>

</tasks>

<verification>
1. `cd frontend && npx tsc --noEmit` — TypeScript compiles without errors
2. `cd frontend && npm run build 2>&1 | tail -20` — Next.js production build succeeds
3. Visual check: Navigate to `/admin/inventory` — see Badge components for stock status (red/amber pills)
4. Type a custom threshold in the input field — table updates after 500ms debounce
5. Click preset buttons (5, 10, 20) — input field reflects value, table updates
6. Click "Update Stock" on a row — modal opens with book title and current stock
7. Enter a new quantity in the modal and click Save — modal closes, toast appears, table refetches
8. Open modal for Book A, close without saving, open for Book B — modal shows Book B's data (no stale state)
</verification>

<success_criteria>
- Stock values displayed as shadcn Badge pills (red for out-of-stock, amber for low stock)
- Free-form threshold input works with 500ms debounce and preset buttons (5, 10, 20) still work
- "Update Stock" button on each row opens a Dialog modal with book title, current stock, and quantity input
- Stock update mutation calls PATCH /books/{book_id}/stock, invalidates cache, shows toast, closes modal
- Modal state resets on close (no stale data between different books)
- Production build completes without errors
</success_criteria>

<output>
After completion, create `.planning/phases/27-sales-analytics-and-inventory-alerts/27-02-SUMMARY.md`
</output>
