---
phase: 27-sales-analytics-and-inventory-alerts
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - frontend/src/components/admin/RevenueChart.tsx
  - frontend/src/app/admin/sales/page.tsx
  - frontend/src/lib/admin.ts
  - frontend/src/app/admin/overview/page.tsx
autonomous: true
requirements:
  - SALE-01
  - SALE-02
  - SALE-03
  - SALE-04

must_haves:
  truths:
    - "Admin on the Sales Analytics page sees a two-bar chart comparing current period revenue to the prior period, rendered without hydration errors"
    - "Admin can read summary stats (revenue, order count, AOV, delta percentage) displayed as KPI cards above the chart"
    - "Admin can toggle the top-sellers table between revenue ranking and volume ranking"
    - "Admin can select a row limit of 5, 10, or 25 for the top-sellers table and the table updates accordingly"
    - "Admin can switch period between Today, This Week, and This Month on the Sales page and all data updates"
  artifacts:
    - path: "frontend/src/components/admin/RevenueChart.tsx"
      provides: "Recharts BarChart wrapped in shadcn ChartContainer with two bars (current vs prior)"
      min_lines: 30
    - path: "frontend/src/app/admin/sales/page.tsx"
      provides: "Sales Analytics page with KPI cards, dynamic-imported chart, top-sellers table with toggles"
      min_lines: 100
    - path: "frontend/src/lib/admin.ts"
      provides: "Updated adminKeys.sales.topBooks key factory with sort_by parameter"
      exports: ["adminKeys", "fetchSalesSummary", "fetchTopBooks", "fetchLowStock"]
  key_links:
    - from: "frontend/src/app/admin/sales/page.tsx"
      to: "frontend/src/components/admin/RevenueChart.tsx"
      via: "next/dynamic({ ssr: false })"
      pattern: "dynamic.*import.*RevenueChart"
    - from: "frontend/src/app/admin/sales/page.tsx"
      to: "frontend/src/lib/admin.ts"
      via: "useQuery with adminKeys.sales.summary and adminKeys.sales.topBooks"
      pattern: "adminKeys\\.sales\\.(summary|topBooks)"
    - from: "frontend/src/app/admin/overview/page.tsx"
      to: "frontend/src/lib/admin.ts"
      via: "Updated topBooks call with explicit sort_by parameter"
      pattern: "adminKeys\\.sales\\.topBooks\\(5.*revenue"
---

<objective>
Build the Sales Analytics page replacing the current placeholder, with a revenue comparison bar chart (recharts via shadcn), KPI summary cards, and an interactive top-sellers table with revenue/volume toggle and configurable row limit.

Purpose: Gives admins a detailed sales performance view beyond the dashboard overview, with visual revenue comparison and flexible top-sellers ranking.
Output: Working Sales Analytics page at `/admin/sales` with chart, KPI cards, and top-sellers table.
</objective>

<execution_context>
@C:/Users/Sushasan/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Sushasan/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/27-sales-analytics-and-inventory-alerts/27-CONTEXT.md
@.planning/phases/27-sales-analytics-and-inventory-alerts/27-RESEARCH.md
@frontend/src/lib/admin.ts
@frontend/src/lib/api.ts
@frontend/src/app/admin/overview/page.tsx
@frontend/src/app/admin/sales/page.tsx

<interfaces>
<!-- Key types and contracts the executor needs. Extracted from codebase. -->

From frontend/src/lib/admin.ts:
```typescript
export type SalesSummaryResponse = {
  period: string
  revenue: number
  order_count: number
  aov: number
  delta_percentage: number | null
}

export type TopBookEntry = {
  book_id: number
  title: string
  author: string
  total_revenue: number
  units_sold: number
}

export type TopBooksResponse = {
  sort_by: string
  items: TopBookEntry[]
}

export const adminKeys = {
  all: ['admin'] as const,
  sales: {
    all: ['admin', 'sales'] as const,
    summary: (period: string) => ['admin', 'sales', 'summary', period] as const,
    topBooks: (limit: number) => ['admin', 'sales', 'top-books', limit] as const,
    // ^^^ MUST be updated to include sort_by parameter
  },
  inventory: {
    all: ['admin', 'inventory'] as const,
    lowStock: (threshold: number) => ['admin', 'inventory', 'low-stock', threshold] as const,
  },
} as const

export async function fetchSalesSummary(accessToken: string, period: 'today' | 'week' | 'month'): Promise<SalesSummaryResponse>
export async function fetchTopBooks(accessToken: string, limit?: number, sort_by?: 'revenue' | 'volume'): Promise<TopBooksResponse>
```

From frontend/src/lib/api.ts:
```typescript
export async function apiFetch<T>(path: string, options?: RequestInit): Promise<T>
// Handles 204 No Content as `return undefined as T`
```

From frontend/src/components/ui (all already installed):
```typescript
// Button, Card, CardContent, CardHeader, CardTitle, Skeleton — already used in overview/page.tsx
// chart.tsx — WILL BE installed by Task 1 via `npx shadcn@latest add chart`
```

From frontend/src/app/admin/overview/page.tsx (helper patterns to reuse):
```typescript
// DeltaBadge component: renders ▲/▼ percentage with green/red coloring
function DeltaBadge({ delta }: { delta: number | null }) { ... }
// formatCurrency helper
const formatCurrency = (value: number) => `$${Math.round(value).toLocaleString('en-US')}`
// Period selector toggle pattern (Button group in rounded-lg border)
// Table pattern: rounded-lg border, bg-muted/50 header, hover:bg-muted/30 rows, Skeleton loading
```
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install recharts via shadcn, create RevenueChart component, fix adminKeys.sales.topBooks cache key</name>
  <files>
    frontend/src/components/admin/RevenueChart.tsx
    frontend/src/lib/admin.ts
    frontend/src/app/admin/overview/page.tsx
    frontend/package.json
    frontend/src/components/ui/chart.tsx
  </files>
  <action>
**Step 1 — Install recharts via shadcn chart CLI:**
```bash
cd frontend
npx shadcn@latest add chart
npm install
```
This installs `recharts ^2.15.x`, creates `src/components/ui/chart.tsx` (provides `ChartContainer`, `ChartTooltip`, `ChartTooltipContent`, `ChartConfig`), and adds `"overrides": { "react-is": "^19.0.0" }` to `package.json`. Verify both `chart.tsx` exists and `recharts` appears in `package.json` dependencies.

**Step 2 — Fix adminKeys.sales.topBooks in `src/lib/admin.ts`:**
Update the `topBooks` key factory to include `sort_by` as a second parameter:

Current (line 49):
```typescript
topBooks: (limit: number) => ['admin', 'sales', 'top-books', limit] as const,
```

Change to:
```typescript
topBooks: (limit: number, sort_by: 'revenue' | 'volume' = 'revenue') =>
  ['admin', 'sales', 'top-books', limit, sort_by] as const,
```

This ensures TanStack Query distinguishes cache entries for revenue-sorted vs volume-sorted results. Without this fix, toggling sort_by on the Sales page would return stale cached data.

**Step 3 — Update overview/page.tsx call site:**
Update the existing `topBooksQuery` in `frontend/src/app/admin/overview/page.tsx` (around line 71) to pass `sort_by` explicitly for backward compatibility:

Current:
```typescript
queryKey: adminKeys.sales.topBooks(5),
```

Change to:
```typescript
queryKey: adminKeys.sales.topBooks(5, 'revenue'),
```

**Step 4 — Create `RevenueChart.tsx`:**
Create `frontend/src/components/admin/RevenueChart.tsx` as a `'use client'` component:

- Import `BarChart`, `Bar`, `XAxis`, `YAxis`, `CartesianGrid` from `recharts`
- Import `ChartContainer`, `ChartTooltip`, `ChartTooltipContent`, `type ChartConfig` from `@/components/ui/chart`
- Define `chartConfig` with `current` (label: "Current Period", color: `hsl(var(--chart-1))`) and `prior` (label: "Prior Period", color: `hsl(var(--chart-2))`)
- Props: `{ currentRevenue: number; priorRevenue: number | null; periodLabel: string }`
- Data: single data point `[{ name: periodLabel, current: currentRevenue, prior: priorRevenue ?? 0 }]`
- Render `ChartContainer` with `className="h-[300px] w-full"` wrapping a `BarChart`
- Include `CartesianGrid vertical={false}`, `XAxis` with `tickLine={false} axisLine={false}`, `YAxis` with dollar formatter `(v) => '$' + v.toLocaleString()`
- Two `Bar` elements: `dataKey="current"` with `fill="var(--color-current)"` and `dataKey="prior"` with `fill="var(--color-prior)"`, both with `radius={4}`
- Add `ChartTooltip` with `ChartTooltipContent` for hover details
- If `priorRevenue` is `null`, render only the current bar (set prior data to 0 and optionally add a "No prior period data" text note below the chart)
- Export as `default`

This component will be imported ONLY via `next/dynamic({ ssr: false })` in the sales page — NEVER directly imported with a static import statement.
  </action>
  <verify>
    <automated>cd frontend && node -e "const p = require('./package.json'); if (!p.dependencies?.recharts) throw 'recharts not installed'; console.log('recharts OK:', p.dependencies.recharts)" && test -f src/components/ui/chart.tsx && echo "chart.tsx exists" && test -f src/components/admin/RevenueChart.tsx && echo "RevenueChart.tsx exists" && npx tsc --noEmit --pretty 2>&1 | head -30</automated>
  </verify>
  <done>
    - recharts ^2.15.x in package.json dependencies with react-is override
    - chart.tsx exists in components/ui/
    - RevenueChart.tsx exists with 'use client' directive, BarChart with two Bar elements, ChartContainer wrapper, default export
    - adminKeys.sales.topBooks accepts (limit, sort_by) with sort_by defaulting to 'revenue'
    - overview/page.tsx passes 'revenue' explicitly to topBooks(5, 'revenue')
    - TypeScript compiles without errors
  </done>
</task>

<task type="auto">
  <name>Task 2: Build Sales Analytics page with KPI cards, dynamic chart, period selector, and top-sellers table</name>
  <files>
    frontend/src/app/admin/sales/page.tsx
  </files>
  <action>
Replace the placeholder Sales page entirely (`frontend/src/app/admin/sales/page.tsx`) with a full Sales Analytics page.

**Page structure — `'use client'` component:**

1. **State variables:**
   - `period: 'today' | 'week' | 'month'` (default `'today'`)
   - `sortBy: 'revenue' | 'volume'` (default `'revenue'`)
   - `limit: 5 | 10 | 25` (default `10`)

2. **Auth and queries:**
   - `useSession()` for `accessToken`
   - `summaryQuery = useQuery({ queryKey: adminKeys.sales.summary(period), queryFn: () => fetchSalesSummary(accessToken, period), enabled: !!accessToken, staleTime: 60_000 })`
   - `topBooksQuery = useQuery({ queryKey: adminKeys.sales.topBooks(limit, sortBy), queryFn: () => fetchTopBooks(accessToken, limit, sortBy), enabled: !!accessToken, staleTime: 60_000 })`

3. **Prior revenue derivation (CRITICAL — see RESEARCH.md Pattern 3):**
   ```typescript
   const summaryData = summaryQuery.data
   const delta = summaryData?.delta_percentage ?? null
   const priorRevenue =
     delta !== null && delta !== -100
       ? (summaryData?.revenue ?? 0) / (1 + delta / 100)
       : null
   ```
   Guard against `delta === null` (no prior data) and `delta === -100` (division by zero). Pass `priorRevenue` to `RevenueChart`.

4. **Dynamic import for RevenueChart:**
   ```typescript
   import dynamic from 'next/dynamic'
   const RevenueChart = dynamic(
     () => import('@/components/admin/RevenueChart'),
     { ssr: false, loading: () => <Skeleton className="h-[300px] w-full rounded-lg" /> }
   )
   ```
   NEVER use a static import for RevenueChart — recharts will crash SSR.

5. **Layout (top to bottom, using `space-y-6`):**

   **Header row:** `<h1>Sales Analytics</h1>` + period selector toggle (reuse exact Button group pattern from overview/page.tsx: `PERIOD_LABELS` map, `variant={period === p ? 'default' : 'ghost'}`, `size="sm"`, `className="h-8 text-sm"`).

   **KPI cards grid** (`grid gap-4 md:grid-cols-2 lg:grid-cols-4`):
   - Revenue card: `formatCurrency(summaryData?.revenue ?? 0)` + `DeltaBadge`
   - Orders card: `summaryData?.order_count ?? 0` + `DeltaBadge`
   - AOV card: `formatCurrency(summaryData?.aov ?? 0)` + `DeltaBadge`
   - Period card: Shows the currently selected period label (e.g., "This Week") as informational context
   - Each card has loading skeleton and error state matching the overview pattern exactly.
   - Copy `DeltaBadge` and `formatCurrency` helpers from overview/page.tsx into this file (or extract to a shared module — either approach is fine; copying is simpler and keeps each page self-contained).

   **Revenue Chart section:**
   - `<h2>Revenue Comparison</h2>` heading
   - Render `<RevenueChart currentRevenue={summaryData?.revenue ?? 0} priorRevenue={priorRevenue} periodLabel={PERIOD_LABELS[period]} />`
   - Show chart loading skeleton (`<Skeleton className="h-[300px] w-full rounded-lg" />`) when `summaryQuery.isLoading`
   - Show error state with Retry button when `summaryQuery.isError`

   **Top Sellers section:**
   - `<h2>Top Sellers</h2>` heading
   - Controls row with two toggle groups side by side:
     - Sort toggle: two buttons — "Revenue" and "Volume" (same Button group pattern, variant toggles on `sortBy`)
     - Limit selector: three buttons — "5", "10", "25" (same Button group pattern, variant toggles on `limit`)
   - Table with columns:
     - `#` (rank, 1-indexed)
     - `Title` (book.title)
     - `Author` (book.author)
     - If sortBy === 'revenue': `Revenue` column showing `formatCurrency(book.total_revenue)` (right-aligned)
     - If sortBy === 'volume': `Units Sold` column showing `book.units_sold` (right-aligned)
   - Use the same table styling pattern: `rounded-lg border` wrapper, `bg-muted/50` header, `hover:bg-muted/30` rows
   - Loading: Skeleton rows (count = current limit value)
   - Error: colspan error message with Retry button
   - Empty: "No sales data available." message

**IMPORTANT — Time granularity note:**
The CONTEXT.md mentions "Time granularity adapts to selected period: today -> hourly bars, week -> daily bars, month -> daily bars." However, the backend `sales/summary` endpoint returns a SINGLE aggregate (one revenue number per period), NOT hourly/daily breakdowns. A timeseries endpoint does NOT exist and is explicitly deferred to v3.2+ (SALE-05 in Future Requirements). The chart MUST be a two-bar comparison (current vs prior period totals) as documented in RESEARCH.md. The period label on the X-axis indicates which period is being compared.
  </action>
  <verify>
    <automated>cd frontend && npx tsc --noEmit --pretty 2>&1 | head -30 && echo "---TSC DONE---" && node -e "const fs = require('fs'); const c = fs.readFileSync('src/app/admin/sales/page.tsx', 'utf8'); const checks = [['use client', c.includes(\"'use client'\")], ['dynamic import', c.includes('next/dynamic')], ['ssr: false', c.includes('ssr: false')], ['adminKeys.sales.summary', c.includes('adminKeys.sales.summary')], ['adminKeys.sales.topBooks', c.includes('adminKeys.sales.topBooks')], ['priorRevenue derivation', c.includes('delta !== -100')], ['DeltaBadge', c.includes('DeltaBadge')], ['formatCurrency', c.includes('formatCurrency')]]; checks.forEach(([name, ok]) => console.log(ok ? 'PASS' : 'FAIL', name))"</automated>
  </verify>
  <done>
    - Sales page at /admin/sales replaces the placeholder completely
    - Page has 'use client' directive, uses useSession/useQuery
    - RevenueChart imported via next/dynamic with ssr: false and Skeleton loading fallback
    - Period selector toggle (Today/This Week/This Month) controls both KPI cards and chart
    - KPI cards show revenue (formatted), order count, AOV (formatted), each with DeltaBadge
    - Prior revenue correctly derived from delta_percentage with null and -100 guards
    - Top-sellers table with revenue/volume sort toggle and 5/10/25 limit selector
    - Table shows rank, title, author, and revenue OR units_sold depending on sortBy
    - Loading skeletons, error states with retry, and empty states all handled
    - TypeScript compiles without errors
  </done>
</task>

</tasks>

<verification>
1. `cd frontend && npx tsc --noEmit` — TypeScript compiles without errors
2. `cd frontend && npm run build 2>&1 | tail -20` — Next.js production build succeeds (catches SSR issues with recharts)
3. Visual check: Navigate to `/admin/sales` — chart renders, KPI cards display, top-sellers table is interactive
4. Toggle period selector — chart and KPI cards update with new data
5. Toggle sort between Revenue and Volume — table re-renders with correct column
6. Change limit (5, 10, 25) — table shows correct number of rows
</verification>

<success_criteria>
- recharts installed via shadcn chart CLI, chart.tsx component present
- RevenueChart.tsx renders a two-bar comparison chart (current vs prior) without SSR hydration errors
- Sales Analytics page shows KPI cards (revenue, orders, AOV) with delta badges
- Top-sellers table supports revenue/volume toggle and 5/10/25 row limit selector
- adminKeys.sales.topBooks cache key includes sort_by to prevent stale data on toggle
- Production build (`npm run build`) completes without errors
</success_criteria>

<output>
After completion, create `.planning/phases/27-sales-analytics-and-inventory-alerts/27-01-SUMMARY.md`
</output>
