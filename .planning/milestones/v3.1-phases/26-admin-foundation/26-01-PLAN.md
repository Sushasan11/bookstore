---
phase: 26-admin-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - frontend/src/app/layout.tsx
  - frontend/src/app/(store)/layout.tsx
  - frontend/src/app/(store)/page.tsx
  - frontend/src/app/(store)/catalog/
  - frontend/src/app/(store)/books/
  - frontend/src/app/(store)/cart/
  - frontend/src/app/(store)/orders/
  - frontend/src/app/(store)/wishlist/
  - frontend/src/app/(store)/account/
  - frontend/src/proxy.ts
  - frontend/src/app/admin/layout.tsx
  - frontend/src/app/admin/page.tsx
  - frontend/src/components/admin/AppSidebar.tsx
  - frontend/src/components/admin/SidebarFooterUser.tsx
  - frontend/src/components/ui/sidebar.tsx
  - frontend/src/components/layout/UserMenu.tsx
autonomous: true
requirements:
  - ADMF-01
  - ADMF-02
  - ADMF-03
  - ADMF-04

must_haves:
  truths:
    - "Admin visiting /admin sees a sidebar layout with no customer Header or Footer"
    - "Non-admin user navigating to /admin is silently redirected to / by both proxy.ts and admin layout Server Component"
    - "Admin sidebar shows 5 nav items (Overview, Sales, Catalog, Users, Reviews) with the active section highlighted"
    - "Sidebar collapses to icon-only mode on desktop and renders as a slide-out drawer on mobile"
    - "Customer storefront pages continue to work at existing URLs with Header and Footer"
    - "Admin link appears in UserMenu dropdown only for admin-role users"
  artifacts:
    - path: "frontend/src/app/(store)/layout.tsx"
      provides: "Customer layout wrapping Header + Footer"
      contains: "Header"
    - path: "frontend/src/app/admin/layout.tsx"
      provides: "Admin layout with defense-in-depth role check + SidebarProvider"
      exports: ["default"]
      contains: "auth()"
    - path: "frontend/src/components/admin/AppSidebar.tsx"
      provides: "Collapsible sidebar with 5 nav items and active highlighting"
      contains: "usePathname"
    - path: "frontend/src/components/admin/SidebarFooterUser.tsx"
      provides: "User info + sign out in sidebar footer"
      contains: "useSession"
    - path: "frontend/src/proxy.ts"
      provides: "Admin route protection at middleware layer"
      contains: "adminPrefixes"
  key_links:
    - from: "frontend/src/proxy.ts"
      to: "/admin routes"
      via: "adminPrefixes check with role === 'admin'"
      pattern: "userRole.*admin"
    - from: "frontend/src/app/admin/layout.tsx"
      to: "auth()"
      via: "Server Component independent role check"
      pattern: "session.user.role.*admin"
    - from: "frontend/src/components/admin/AppSidebar.tsx"
      to: "usePathname()"
      via: "isActive prop on SidebarMenuButton"
      pattern: "pathname.startsWith"
---

<objective>
Restructure the Next.js app directory into route groups, install the shadcn sidebar, create the protected admin layout shell with defense-in-depth role checking (CVE-2025-29927), and build the collapsible admin sidebar with active nav highlighting.

Purpose: Establish the admin section infrastructure that all subsequent admin phases (27-29) build upon. The route group restructure separates customer storefront layout from admin layout, and the defense-in-depth pattern ensures admin routes cannot be accessed by non-admin users even if middleware is bypassed.

Output: Working admin layout at /admin with sidebar, customer storefront at existing URLs unchanged, and proxy.ts + admin layout dual role enforcement.
</objective>

<execution_context>
@C:/Users/Sushasan/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Sushasan/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/26-admin-foundation/26-RESEARCH.md

<interfaces>
<!-- Key types and contracts the executor needs. Extracted from codebase. -->
<!-- Executor should use these directly -- no codebase exploration needed. -->

From frontend/src/auth.ts:
```typescript
export const { handlers, auth, signIn, signOut } = NextAuth({...})
// auth() returns session with session.user.role ('admin' | 'user')
// Use auth() in Server Components, useSession() in Client Components
```

From frontend/src/proxy.ts:
```typescript
const protectedPrefixes = ["/account", "/orders", "/checkout", "/wishlist", "/prebook", "/cart"]
const authOnlyPaths = ["/login", "/register"]
export const proxy = auth((req) => {
  const isLoggedIn = !!req.auth
  const { pathname } = req.nextUrl
  // ... redirects
})
export const config = { matcher: ["/((?!api|_next/static|_next/image|favicon.ico).*)"] }
```

From frontend/src/app/layout.tsx (CURRENT — will be refactored):
```typescript
import { Providers } from '@/components/providers'
import { Header } from '@/components/layout/Header'
import { Footer } from '@/components/layout/Footer'
// Currently: html+body+Providers+Header+Footer all in root layout
// AFTER: html+body+Providers only in root; Header+Footer move to (store)/layout.tsx
```

From frontend/src/components/layout/UserMenu.tsx:
```typescript
'use client'
export function UserMenu() {
  const { data: session, status } = useSession()
  // Currently shows email + Sign Out for authenticated users
  // Will add: Admin link for admin-role users
}
```

From frontend/src/app/(auth)/layout.tsx:
```typescript
export default function AuthLayout({ children }: { children: React.ReactNode }) {
  // Centers children — no Header/Footer (route group handles this)
  // This layout is NOT moved — stays as-is under (auth)/
}
```
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install shadcn sidebar and restructure routes into (store)/ group</name>
  <files>
    frontend/src/components/ui/sidebar.tsx
    frontend/src/app/layout.tsx
    frontend/src/app/(store)/layout.tsx
    frontend/src/app/(store)/page.tsx
    frontend/src/app/(store)/catalog/
    frontend/src/app/(store)/books/
    frontend/src/app/(store)/cart/
    frontend/src/app/(store)/orders/
    frontend/src/app/(store)/wishlist/
    frontend/src/app/(store)/account/
  </files>
  <action>
**Step 1: Install shadcn sidebar component.**

Run from `frontend/` directory:
```bash
npx shadcn@latest add sidebar
```
This installs `sidebar.tsx` into `components/ui/` and any peer components (tooltip, collapsible) if not already present. If the CLI prompts for confirmation, accept defaults. Verify `frontend/src/components/ui/sidebar.tsx` exists after installation.

If tooltip or collapsible are missing after sidebar install, run:
```bash
npx shadcn@latest add tooltip collapsible
```

**Step 2: Create the `(store)/` route group and move customer pages.**

Create `frontend/src/app/(store)/` directory. Move (not copy) these directories and files into it:
```bash
cd frontend/src/app
mkdir -p "(store)"
git mv page.tsx "(store)/page.tsx"
git mv catalog "(store)/catalog"
git mv books "(store)/books"
git mv cart "(store)/cart"
git mv orders "(store)/orders"
git mv wishlist "(store)/wishlist"
git mv account "(store)/account"
```

**CRITICAL: Do NOT move these — they stay at app root:**
- `layout.tsx` (will be refactored in place)
- `not-found.tsx` (must stay at root for global 404)
- `globals.css` (imported by root layout)
- `favicon.ico`
- `(auth)/` (already a route group, stays as-is)
- `api/` (API routes, stays as-is)

**Step 3: Create `(store)/layout.tsx` with Header + Footer.**

This is the customer layout that wraps all storefront pages. Extract the Header+Footer wrapper from root layout into here:

```typescript
// frontend/src/app/(store)/layout.tsx
import { Header } from '@/components/layout/Header'
import { Footer } from '@/components/layout/Footer'

export default function StoreLayout({ children }: { children: React.ReactNode }) {
  return (
    <div className="relative flex min-h-screen flex-col">
      <Header />
      <main className="flex-1">{children}</main>
      <Footer />
    </div>
  )
}
```

**Step 4: Refactor root `layout.tsx` to Providers-only shell.**

Remove Header and Footer from root layout. It becomes a minimal shell:

```typescript
// frontend/src/app/layout.tsx — AFTER refactoring
import type { Metadata } from 'next'
import { Providers } from '@/components/providers'
import './globals.css'

export const metadata: Metadata = {
  title: {
    default: 'Bookstore',
    template: '%s | Bookstore',
  },
  description: 'Discover and purchase books from our curated catalog',
}

export default function RootLayout({
  children,
}: Readonly<{
  children: React.ReactNode
}>) {
  return (
    <html lang="en" suppressHydrationWarning>
      <body className="min-h-screen bg-background font-sans antialiased">
        <Providers>{children}</Providers>
      </body>
    </html>
  )
}
```

**Step 5: Verify no duplicate route errors.**

Run `cd frontend && npm run build` (or `npx next build`) to confirm no "Conflicting paths" errors. The build should complete without route conflicts. If there ARE conflicts, it means a file was copied instead of moved — find and delete the duplicate.
  </action>
  <verify>
    <automated>cd frontend && npx next build 2>&1 | head -50</automated>
  </verify>
  <done>
    - shadcn sidebar.tsx exists in components/ui/
    - All customer pages (catalog, books, cart, orders, wishlist, account, home) accessible at same URLs
    - Root layout contains only html+body+Providers (no Header/Footer)
    - (store)/layout.tsx wraps children with Header + Footer
    - No duplicate route errors in Next.js build
    - (auth)/ group unchanged and functional
  </done>
</task>

<task type="auto">
  <name>Task 2: Create admin layout with defense-in-depth role check, sidebar, and UserMenu admin link</name>
  <files>
    frontend/src/proxy.ts
    frontend/src/app/admin/layout.tsx
    frontend/src/app/admin/page.tsx
    frontend/src/components/admin/AppSidebar.tsx
    frontend/src/components/admin/SidebarFooterUser.tsx
    frontend/src/components/layout/UserMenu.tsx
  </files>
  <action>
**Step 1: Update proxy.ts with admin route protection (Layer 1 — UX redirect).**

Add `/admin` to protected routes AND add admin-specific role check. The proxy.ts is the UX layer — fast redirects, but NOT the security boundary (CVE-2025-29927 means middleware can theoretically be bypassed).

Modify `frontend/src/proxy.ts`:
- Add `const adminPrefixes = ["/admin"]` above the existing `proxy` function
- Add `/admin` to `protectedPrefixes` array OR handle it separately (separate is cleaner — admin needs role check, not just auth check)
- Inside the `proxy` callback, after the existing `isProtected` check and before the `authOnlyPaths` check, add:

```typescript
// Admin routes require admin role — silent redirect to / (don't reveal route exists)
const isAdminRoute = adminPrefixes.some((p) => pathname.startsWith(p))
if (isAdminRoute && !isLoggedIn) {
  return NextResponse.redirect(new URL("/", req.nextUrl.origin))
}
if (isAdminRoute && req.auth?.user?.role !== "admin") {
  return NextResponse.redirect(new URL("/", req.nextUrl.origin))
}
```

Note: Non-admin users get redirected to `/` silently (no toast, no error) per user decision. Unauthenticated users also go to `/` (not `/login`) to avoid revealing the admin route exists.

**Step 2: Create `admin/layout.tsx` (Layer 2 — real security boundary).**

This Server Component independently calls `auth()` and checks role. Even if proxy.ts is bypassed (CVE-2025-29927 scenario), this check runs server-side and cannot be bypassed by HTTP headers.

```typescript
// frontend/src/app/admin/layout.tsx
import { auth } from '@/auth'
import { redirect } from 'next/navigation'
import { SidebarProvider, SidebarInset, SidebarTrigger } from '@/components/ui/sidebar'
import { AppSidebar } from '@/components/admin/AppSidebar'

export default async function AdminLayout({ children }: { children: React.ReactNode }) {
  const session = await auth()

  // Defense-in-depth: independent role check NOT reliant on middleware
  if (!session?.user || session.user.role !== 'admin') {
    redirect('/')
  }

  return (
    <SidebarProvider>
      <AppSidebar />
      <SidebarInset>
        <header className="flex h-14 items-center gap-2 border-b px-4">
          <SidebarTrigger />
        </header>
        <div className="flex-1 overflow-y-auto p-4">
          {children}
        </div>
      </SidebarInset>
    </SidebarProvider>
  )
}
```

**Step 3: Create `admin/page.tsx` redirect.**

The `/admin` URL should redirect to `/admin/overview` (the dashboard page, built in Plan 02):

```typescript
// frontend/src/app/admin/page.tsx
import { redirect } from 'next/navigation'

export default function AdminPage() {
  redirect('/admin/overview')
}
```

**Step 4: Create `AppSidebar.tsx` client component.**

Build the collapsible sidebar with 5 nav items, branding, "Back to Store" link, and active item highlighting via `usePathname()`. Follow the shadcn Sidebar pattern with `collapsible="icon"` for desktop collapse and automatic Sheet-based drawer on mobile.

```typescript
// frontend/src/components/admin/AppSidebar.tsx
'use client'

import { usePathname } from 'next/navigation'
import {
  Sidebar, SidebarContent, SidebarHeader, SidebarFooter,
  SidebarMenu, SidebarMenuItem, SidebarMenuButton, SidebarGroup, SidebarGroupContent,
} from '@/components/ui/sidebar'
import { LayoutDashboard, TrendingUp, BookOpen, Users, Star, ChevronLeft } from 'lucide-react'
import Link from 'next/link'
import { Badge } from '@/components/ui/badge'
import { SidebarFooterUser } from './SidebarFooterUser'

const navItems = [
  { href: '/admin/overview', label: 'Overview', icon: LayoutDashboard },
  { href: '/admin/sales', label: 'Sales', icon: TrendingUp },
  { href: '/admin/catalog', label: 'Catalog', icon: BookOpen },
  { href: '/admin/users', label: 'Users', icon: Users },
  { href: '/admin/reviews', label: 'Reviews', icon: Star },
]

export function AppSidebar() {
  const pathname = usePathname()

  return (
    <Sidebar collapsible="icon">
      <SidebarHeader>
        <div className="flex items-center gap-2 px-2 py-1.5">
          <span className="font-bold text-lg group-data-[collapsible=icon]:hidden">BookStore</span>
          <Badge variant="secondary" className="text-xs group-data-[collapsible=icon]:hidden">Admin</Badge>
        </div>
        <SidebarMenu>
          <SidebarMenuItem>
            <SidebarMenuButton asChild tooltip="Back to Store">
              <Link href="/">
                <ChevronLeft className="h-4 w-4" />
                <span>Back to Store</span>
              </Link>
            </SidebarMenuButton>
          </SidebarMenuItem>
        </SidebarMenu>
      </SidebarHeader>

      <SidebarContent>
        <SidebarGroup>
          <SidebarGroupContent>
            <SidebarMenu>
              {navItems.map((item) => (
                <SidebarMenuItem key={item.href}>
                  <SidebarMenuButton
                    asChild
                    isActive={pathname.startsWith(item.href)}
                    tooltip={item.label}
                  >
                    <Link href={item.href}>
                      <item.icon className="h-4 w-4" />
                      <span>{item.label}</span>
                    </Link>
                  </SidebarMenuButton>
                </SidebarMenuItem>
              ))}
            </SidebarMenu>
          </SidebarGroupContent>
        </SidebarGroup>
      </SidebarContent>

      <SidebarFooter>
        <SidebarFooterUser />
      </SidebarFooter>
    </Sidebar>
  )
}
```

**Step 5: Create `SidebarFooterUser.tsx` client component.**

Shows user email + sign out button. Collapses to avatar-only when sidebar is in icon mode. Uses `useSidebar()` to detect collapsed state.

```typescript
// frontend/src/components/admin/SidebarFooterUser.tsx
'use client'

import { useSession, signOut } from 'next-auth/react'
import { SidebarMenuButton, SidebarMenuItem, SidebarMenu, useSidebar } from '@/components/ui/sidebar'
import { LogOut, User } from 'lucide-react'

export function SidebarFooterUser() {
  const { data: session } = useSession()
  const { state } = useSidebar()
  const email = session?.user?.email ?? ''

  return (
    <SidebarMenu>
      <SidebarMenuItem>
        <SidebarMenuButton size="lg" tooltip={email}>
          <User className="h-4 w-4 shrink-0" />
          {state === 'expanded' && (
            <span className="truncate text-sm">{email}</span>
          )}
        </SidebarMenuButton>
      </SidebarMenuItem>
      <SidebarMenuItem>
        <SidebarMenuButton onClick={() => signOut({ callbackUrl: '/' })} tooltip="Sign Out">
          <LogOut className="h-4 w-4" />
          {state === 'expanded' && <span>Sign Out</span>}
        </SidebarMenuButton>
      </SidebarMenuItem>
    </SidebarMenu>
  )
}
```

**Step 6: Add admin link to UserMenu dropdown.**

Modify `frontend/src/components/layout/UserMenu.tsx` to add an "Admin" link visible only to admin-role users. Add it before the Sign Out button in the authenticated state:

In the authenticated return block, add before the Sign Out button:
```typescript
import Link from 'next/link'  // add to imports if not present

// In the authenticated return block, add:
{session?.user?.role === 'admin' && (
  <Link href="/admin">
    <Button variant="ghost" size="sm">
      Admin
    </Button>
  </Link>
)}
```

The admin link should appear between the email display and the Sign Out button.
  </action>
  <verify>
    <automated>cd frontend && npx next build 2>&1 | tail -20</automated>
  </verify>
  <done>
    - proxy.ts redirects non-admin users from /admin to / silently
    - proxy.ts redirects unauthenticated users from /admin to / (not /login)
    - admin/layout.tsx independently calls auth() and checks role (defense-in-depth)
    - /admin redirects to /admin/overview
    - AppSidebar renders 5 nav items with correct icons and active highlighting via usePathname()
    - Sidebar collapses to icon-only on desktop toggle, shows as Sheet drawer on mobile
    - Sidebar header shows "BookStore" + "Admin" badge + "Back to Store" link
    - Sidebar footer shows user email + Sign Out (collapses to avatar-only in icon mode)
    - UserMenu shows "Admin" button only when session.user.role === 'admin'
    - Next.js build succeeds without errors
  </done>
</task>

</tasks>

<verification>
1. Navigate to `/catalog` — customer storefront with Header + Footer renders normally
2. Navigate to `/admin` as non-admin user — silently redirected to `/`
3. Navigate to `/admin` as admin user — sidebar layout appears with no Header/Footer
4. Click each sidebar nav item — active item is highlighted
5. Toggle sidebar collapse — switches between full labels and icon-only
6. Check mobile viewport — sidebar renders as slide-out drawer
7. In storefront, check UserMenu — "Admin" link visible only for admin role
8. `npx next build` succeeds without errors
</verification>

<success_criteria>
- Route group restructure complete: customer pages in (store)/, admin in admin/
- Defense-in-depth: both proxy.ts and admin layout Server Component enforce admin role
- Collapsible sidebar with 5 nav items, active highlighting, branding, and user footer
- Customer storefront unaffected — all existing URLs work with Header + Footer
- Admin link in UserMenu for admin-role users only
</success_criteria>

<output>
After completion, create `.planning/phases/26-admin-foundation/26-01-SUMMARY.md`
</output>
