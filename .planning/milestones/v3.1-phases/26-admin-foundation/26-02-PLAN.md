---
phase: 26-admin-foundation
plan: 02
type: execute
wave: 2
depends_on:
  - 26-01
files_modified:
  - frontend/src/lib/admin.ts
  - frontend/src/app/admin/overview/page.tsx
autonomous: true
requirements:
  - DASH-01
  - DASH-02
  - DASH-03
  - DASH-04
  - DASH-05

must_haves:
  truths:
    - "Admin on the overview page sees 4 KPI cards: Revenue, Orders, AOV, and Low Stock"
    - "Admin can toggle the period selector between Today, This Week, and This Month — KPI cards update with fresh data for the selected period"
    - "Each KPI card shows a colored delta badge: green up-arrow for positive, red down-arrow for negative, grey dash for zero/null"
    - "Currency values display as whole dollars with comma separators (e.g., $12,450)"
    - "Low-stock card shows count with amber/warning styling and links to /admin/inventory"
    - "Top-5 best-sellers mini-table shows Rank, Title, Author, and Revenue columns"
  artifacts:
    - path: "frontend/src/lib/admin.ts"
      provides: "Admin fetch functions, TypeScript types, and TanStack Query key factory"
      exports: ["adminKeys", "fetchSalesSummary", "fetchTopBooks", "fetchLowStock", "SalesSummaryResponse", "TopBooksResponse", "TopBookEntry", "LowStockResponse"]
    - path: "frontend/src/app/admin/overview/page.tsx"
      provides: "Dashboard overview page with KPI cards, period selector, and best-sellers mini-table"
      contains: "useQuery"
  key_links:
    - from: "frontend/src/app/admin/overview/page.tsx"
      to: "frontend/src/lib/admin.ts"
      via: "import adminKeys, fetch functions, types"
      pattern: "import.*from.*@/lib/admin"
    - from: "frontend/src/lib/admin.ts"
      to: "/admin/analytics/sales/summary"
      via: "apiFetch with Bearer token"
      pattern: "apiFetch.*admin/analytics/sales/summary"
    - from: "frontend/src/lib/admin.ts"
      to: "/admin/analytics/sales/top-books"
      via: "apiFetch with Bearer token"
      pattern: "apiFetch.*admin/analytics/sales/top-books"
    - from: "frontend/src/lib/admin.ts"
      to: "/admin/analytics/inventory/low-stock"
      via: "apiFetch with Bearer token"
      pattern: "apiFetch.*admin/analytics/inventory/low-stock"
    - from: "frontend/src/app/admin/overview/page.tsx"
      to: "TanStack Query"
      via: "useQuery with adminKeys.sales.summary(period)"
      pattern: "adminKeys\\.sales\\.summary\\(period\\)"
---

<objective>
Create the admin data-fetching layer (types, fetch functions, query key factory) and the dashboard overview page with KPI cards, period selector, delta badges, low-stock quick-link, and top-5 best-sellers mini-table.

Purpose: Establish the admin API integration layer that all future admin phases (27-29) will import from, and deliver the first visible admin feature — the dashboard overview that gives admins a quick glance at business metrics.

Output: `src/lib/admin.ts` with reusable fetch functions + query keys, and a working `/admin/overview` page showing live data from the backend analytics endpoints.
</objective>

<execution_context>
@C:/Users/Sushasan/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Sushasan/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/26-admin-foundation/26-RESEARCH.md
@.planning/phases/26-admin-foundation/26-01-SUMMARY.md

<interfaces>
<!-- Key types and contracts the executor needs. Extracted from codebase + research. -->
<!-- Executor should use these directly -- no codebase exploration needed. -->

From frontend/src/lib/api.ts:
```typescript
export class ApiError extends Error {
  constructor(message: string, public status: number, public detail?: string, public data?: unknown)
}
export async function apiFetch<T>(path: string, options?: RequestInit): Promise<T>
// apiFetch prepends API_BASE, sets Content-Type: application/json, includes credentials
// Admin endpoints require Authorization: Bearer ${accessToken} passed in options.headers
```

From frontend/src/auth.ts (session shape for useSession()):
```typescript
interface Session {
  accessToken: string      // FastAPI JWT — pass to admin fetch functions
  error?: string
  user: { id: string; role: string; email?: string; name?: string }
}
```

Backend API response shapes (from analytics_schemas.py):
```typescript
// GET /admin/analytics/sales/summary?period=today|week|month
type SalesSummaryResponse = {
  period: string
  revenue: number
  order_count: number
  aov: number
  delta_percentage: number | null  // null when prior period had 0 revenue
}

// GET /admin/analytics/sales/top-books?sort_by=revenue&limit=5
type TopBooksResponse = {
  sort_by: string
  items: Array<{
    book_id: number
    title: string
    author: string
    total_revenue: number
    units_sold: number
  }>
}

// GET /admin/analytics/inventory/low-stock?threshold=10
type LowStockResponse = {
  threshold: number
  total_low_stock: number   // Use this for the count card
  items: Array<{
    book_id: number
    title: string
    author: string
    current_stock: number
    threshold: number
  }>
}
```

From shadcn/ui components (already installed):
```typescript
// Card: import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card'
// Badge: import { Badge } from '@/components/ui/badge'
// Skeleton: import { Skeleton } from '@/components/ui/skeleton'
// Button: import { Button } from '@/components/ui/button'
```
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create admin fetch layer with types and query key factory</name>
  <files>frontend/src/lib/admin.ts</files>
  <action>
Create `frontend/src/lib/admin.ts` with three sections: TypeScript types, query key factory, and fetch functions.

**Section 1: TypeScript types** mirroring backend analytics_schemas.py:

```typescript
// Type definitions mirroring backend analytics_schemas.py
export type SalesSummaryResponse = {
  period: string
  revenue: number
  order_count: number
  aov: number
  delta_percentage: number | null
}

export type TopBookEntry = {
  book_id: number
  title: string
  author: string
  total_revenue: number
  units_sold: number
}

export type TopBooksResponse = {
  sort_by: string
  items: TopBookEntry[]
}

export type LowStockResponse = {
  threshold: number
  total_low_stock: number
  items: Array<{
    book_id: number
    title: string
    author: string
    current_stock: number
    threshold: number
  }>
}
```

**Section 2: Query key factory** — hierarchical prefix enables scoped invalidation:

```typescript
export const adminKeys = {
  all: ['admin'] as const,
  sales: {
    all: ['admin', 'sales'] as const,
    summary: (period: string) => ['admin', 'sales', 'summary', period] as const,
    topBooks: (limit: number) => ['admin', 'sales', 'top-books', limit] as const,
  },
  inventory: {
    all: ['admin', 'inventory'] as const,
    lowStock: (threshold: number) => ['admin', 'inventory', 'low-stock', threshold] as const,
  },
} as const
```

**Section 3: Fetch functions** — all require accessToken (admin endpoints enforce `require_admin`):

```typescript
import { apiFetch } from '@/lib/api'

export async function fetchSalesSummary(
  accessToken: string,
  period: 'today' | 'week' | 'month'
): Promise<SalesSummaryResponse> {
  return apiFetch<SalesSummaryResponse>(
    `/admin/analytics/sales/summary?period=${period}`,
    { headers: { Authorization: `Bearer ${accessToken}` } }
  )
}

export async function fetchTopBooks(
  accessToken: string,
  limit: number = 5,
  sort_by: 'revenue' | 'volume' = 'revenue'
): Promise<TopBooksResponse> {
  return apiFetch<TopBooksResponse>(
    `/admin/analytics/sales/top-books?sort_by=${sort_by}&limit=${limit}`,
    { headers: { Authorization: `Bearer ${accessToken}` } }
  )
}

export async function fetchLowStock(
  accessToken: string,
  threshold: number = 10
): Promise<LowStockResponse> {
  return apiFetch<LowStockResponse>(
    `/admin/analytics/inventory/low-stock?threshold=${threshold}`,
    { headers: { Authorization: `Bearer ${accessToken}` } }
  )
}
```

**CRITICAL:** Every fetch function passes `Authorization: Bearer ${accessToken}` in headers. Without this, the backend returns 403. The `accessToken` comes from `session.accessToken` via `useSession()` in client components.
  </action>
  <verify>
    <automated>cd frontend && npx tsc --noEmit --pretty 2>&1 | tail -20</automated>
  </verify>
  <done>
    - `src/lib/admin.ts` exports adminKeys, 3 fetch functions, and 4 type definitions
    - All types match backend analytics_schemas.py field names exactly
    - Query keys are hierarchical: ['admin', 'sales', 'summary', period]
    - TypeScript compilation succeeds with no errors
  </done>
</task>

<task type="auto">
  <name>Task 2: Build dashboard overview page with KPI cards, period selector, and mini-table</name>
  <files>frontend/src/app/admin/overview/page.tsx</files>
  <action>
Create `frontend/src/app/admin/overview/page.tsx` as a client component ('use client') that renders:

**1. Page header with period selector:**
- "Dashboard Overview" heading (h1, text-2xl font-bold)
- Period selector: segmented button group, right-aligned on same line as heading
- Three options: Today | This Week | This Month
- Use shadcn `Button` with `variant="outline"` for inactive and `variant="default"` for active
- State: `const [period, setPeriod] = useState<'today' | 'week' | 'month'>('today')`

**2. Three TanStack Query hooks:**
```typescript
const { data: session } = useSession()
const accessToken = session?.accessToken ?? ''

const summaryQuery = useQuery({
  queryKey: adminKeys.sales.summary(period),
  queryFn: () => fetchSalesSummary(accessToken, period),
  enabled: !!accessToken,
  staleTime: 60_000,
})

const topBooksQuery = useQuery({
  queryKey: adminKeys.sales.topBooks(5),
  queryFn: () => fetchTopBooks(accessToken, 5, 'revenue'),
  enabled: !!accessToken,
  staleTime: 60_000,
})

const lowStockQuery = useQuery({
  queryKey: adminKeys.inventory.lowStock(10),
  queryFn: () => fetchLowStock(accessToken, 10),
  enabled: !!accessToken,
  staleTime: 60_000,
})
```

**3. KPI cards grid (4 cards in a row, responsive stacking):**

Use `<div className="grid gap-4 md:grid-cols-2 lg:grid-cols-4">` for the card grid.

Each card uses shadcn `Card` + `CardHeader` + `CardContent`:

**Revenue card:**
- Title: "Revenue"
- Value: `$${Math.round(summaryQuery.data?.revenue ?? 0).toLocaleString('en-US')}` (whole dollars, comma-separated)
- Delta badge below value

**Orders card:**
- Title: "Orders"
- Value: `summaryQuery.data?.order_count ?? 0`
- Delta badge (same delta_percentage from summary — applies to revenue comparison)

**AOV card:**
- Title: "Avg. Order Value"
- Value: formatted same as revenue (whole dollars)
- Delta badge

**Low Stock card:**
- Title: "Low Stock Items"
- Value: `lowStockQuery.data?.total_low_stock ?? 0`
- No delta badge — instead show amber/warning accent: use `className="border-amber-500/50 bg-amber-500/5"` on the Card
- Link text below value: "View Inventory Alerts →" linking to `/admin/inventory` (future page — use `<Link>`)

**Delta badge component** (inline helper or separate):
```typescript
function DeltaBadge({ delta }: { delta: number | null }) {
  if (delta === null || delta === 0) {
    return <span className="text-muted-foreground text-sm">— 0%</span>
  }
  if (delta > 0) {
    return <span className="text-green-600 dark:text-green-400 text-sm font-medium">▲ {delta.toFixed(1)}%</span>
  }
  return <span className="text-red-600 dark:text-red-400 text-sm font-medium">▼ {Math.abs(delta).toFixed(1)}%</span>
}
```

**Loading state:** When `summaryQuery.isLoading`, show `Skeleton` components (import from `@/components/ui/skeleton`) inside each card matching the value + delta layout. When `lowStockQuery.isLoading`, show skeleton in low-stock card.

**Error state:** If any query has `isError`, show a muted error message inside the card: "Failed to load" with a retry button that calls `query.refetch()`.

**4. Top-5 best-sellers mini-table:**

Below the card grid, render a simple HTML table (or use shadcn's `Table` if available — check `components/ui/table.tsx`; if not present, use a clean HTML `<table>` with Tailwind classes).

Table columns: Rank (#), Title, Author, Revenue (formatted as currency).
- Map over `topBooksQuery.data?.items` with index for rank (1-based)
- Show loading skeleton rows (5 placeholder rows) when `topBooksQuery.isLoading`
- Show "No sales data" empty state when items array is empty

Table header:
```html
<h2 className="text-lg font-semibold mt-8 mb-4">Top 5 Best Sellers</h2>
```

Table styling: Use Tailwind: `w-full text-sm`, header cells `text-left text-muted-foreground font-medium py-2`, body cells `py-2 border-t`.

**Currency formatting helper** (reuse across cards and table):
```typescript
const formatCurrency = (value: number) =>
  `$${Math.round(value).toLocaleString('en-US')}`
```
  </action>
  <verify>
    <automated>cd frontend && npx next build 2>&1 | tail -20</automated>
  </verify>
  <done>
    - /admin/overview renders 4 KPI cards in a responsive grid
    - Period selector toggles between Today/This Week/This Month and triggers data refetch
    - Revenue, Orders, AOV cards show values with correct currency formatting (whole dollars, commas)
    - Delta badges show green ▲ for positive, red ▼ for negative, grey — for zero/null
    - Low-stock card has amber accent and "View Inventory Alerts →" link to /admin/inventory
    - Top-5 best-sellers mini-table shows Rank, Title, Author, Revenue
    - Loading skeletons appear while data is fetching
    - Error states show "Failed to load" with retry option
    - Next.js build succeeds
  </done>
</task>

</tasks>

<verification>
1. Navigate to `/admin/overview` as admin — see 4 KPI cards and mini-table
2. Click "This Week" period button — cards update with new data, period button becomes active
3. Check delta badges — green for positive delta, red for negative, grey dash for zero
4. Check low-stock card — amber styling, count displayed, link to /admin/inventory
5. Check mini-table — 5 rows with rank, title, author, revenue columns
6. Check loading state — skeletons visible during data fetch
7. `npx next build` succeeds
8. TypeScript compilation (`npx tsc --noEmit`) passes with no errors
</verification>

<success_criteria>
- `src/lib/admin.ts` provides reusable fetch functions, types, and query keys for all admin phases
- Dashboard overview displays live KPI data from backend analytics endpoints
- Period selector drives TanStack Query refetch via query key change
- Delta badges render correctly for all three states (positive, negative, zero/null)
- Low-stock card distinguished with amber accent and inventory link
- Top-5 mini-table renders backend data in clean tabular format
</success_criteria>

<output>
After completion, create `.planning/phases/26-admin-foundation/26-02-SUMMARY.md`
</output>
