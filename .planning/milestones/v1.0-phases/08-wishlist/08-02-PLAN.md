---
phase: 08-wishlist
plan: 02
type: tdd
wave: 2
depends_on:
  - "08-01"
files_modified:
  - tests/test_wishlist.py
autonomous: true
requirements:
  - ENGM-01
  - ENGM-02

must_haves:
  truths:
    - "Adding a valid book to wishlist returns 201 with book details (title, price, stock_quantity)"
    - "Adding a duplicate book to wishlist returns 409 with WISHLIST_ITEM_DUPLICATE code"
    - "Adding a nonexistent book returns 404 with BOOK_NOT_FOUND code"
    - "GET /wishlist returns all items for the authenticated user with current book data"
    - "DELETE /wishlist/{book_id} removes the item and returns 204"
    - "Deleting a non-wishlisted book returns 404"
    - "Unauthenticated requests to all wishlist endpoints return 401"
    - "A user cannot see another user's wishlist items"
  artifacts:
    - path: "tests/test_wishlist.py"
      provides: "Integration tests for ENGM-01 and ENGM-02"
      min_lines: 150
  key_links:
    - from: "tests/test_wishlist.py"
      to: "/wishlist"
      via: "httpx AsyncClient"
      pattern: "client\\.(post|get|delete).*wishlist"
---

<objective>
Integration tests for the wishlist feature covering add, remove, list, duplicate prevention, book validation, auth enforcement, and user isolation.

Purpose: Prove all ENGM-01 and ENGM-02 behaviors work correctly through the full HTTP stack, following the project's TDD test plan pattern established in test_cart.py and test_orders.py.
Output: tests/test_wishlist.py with 10+ test cases, all passing.
</objective>

<execution_context>
@C:/Users/Sushasan/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Sushasan/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-wishlist/08-RESEARCH.md
@.planning/phases/08-wishlist/08-01-SUMMARY.md

# Test patterns to follow
@tests/test_cart.py
@tests/conftest.py
</context>

<feature>
  <name>Wishlist integration tests</name>
  <files>tests/test_wishlist.py</files>
  <behavior>
    ENGM-01 — Add/remove books from wishlist:
    - POST /wishlist {book_id: valid} → 201, response has id, book_id, added_at, book (title, author, price, stock_quantity, cover_image_url)
    - POST /wishlist {book_id: already_on_wishlist} → 409, code WISHLIST_ITEM_DUPLICATE
    - POST /wishlist {book_id: nonexistent} → 404, code BOOK_NOT_FOUND
    - DELETE /wishlist/{book_id} (valid item) → 204
    - DELETE /wishlist/{book_id} (not on wishlist) → 404
    - POST /wishlist without auth → 401
    - DELETE /wishlist/{book_id} without auth → 401

    ENGM-02 — View wishlist:
    - GET /wishlist → 200, items list with book details including stock_quantity (current stock status)
    - GET /wishlist (empty) → 200, items: []
    - GET /wishlist without auth → 401
    - User A cannot see User B's wishlist items (user isolation)
    - Wishlist items ordered by added_at descending (most recent first)
  </behavior>
  <implementation>
    Create tests/test_wishlist.py following the project test patterns:

    **Fixtures (module-specific email prefixes to avoid collisions):**
    - `admin_headers`: creates wishlist_admin@example.com, gets JWT
    - `user_headers`: creates wishlist_user@example.com, gets JWT
    - `user2_headers`: creates wishlist_user2@example.com for isolation tests
    - `sample_genre`: creates test genre via POST /genres
    - `sample_book`: creates test book via POST /books (returns book dict with id)
    - `sample_book2`: creates second book for multi-item list tests

    **Test classes:**
    - `TestAddToWishlist`: success (201 + response structure), duplicate (409), nonexistent book (404), unauthenticated (401)
    - `TestViewWishlist`: list with items (200 + book details including stock_quantity), empty list (200 + items=[]), user isolation (user2 sees empty even after user1 adds), ordering (most recent first)
    - `TestRemoveFromWishlist`: success (204), not on wishlist (404), unauthenticated (401)

    **Key patterns from test_cart.py to follow:**
    - Use `wishlist_` email prefix for all fixture users
    - Use `pytest_asyncio.fixture` for async fixtures
    - Admin creates books, regular user interacts with wishlist
    - Verify response structure fields (not just status codes)
    - Use `db_session` and `UserRepository` for user creation in fixtures
    - Use `hash_password` from app.core.security
  </implementation>
</feature>

<verification>
1. `poetry run pytest tests/test_wishlist.py -v` — all tests pass
2. `poetry run pytest tests/ -x -q` — full suite passes (108+ existing + new wishlist tests)
3. `poetry run ruff check tests/test_wishlist.py` — zero lint violations
</verification>

<success_criteria>
- 10+ integration tests covering all ENGM-01 and ENGM-02 behaviors
- Tests cover happy paths: add, list, remove
- Tests cover error paths: duplicate add (409), nonexistent book (404), not on wishlist (404)
- Tests cover auth enforcement: unauthenticated requests return 401
- Tests cover user isolation: user A's wishlist invisible to user B
- Tests verify response structure: book details include stock_quantity (success criteria 3)
- All existing tests pass (no regressions)
- ruff check clean
</success_criteria>

<output>
After completion, create `.planning/phases/08-wishlist/08-02-SUMMARY.md`
</output>
