---
phase: 01-infrastructure
plan: 03
type: execute
wave: 3
depends_on:
  - 01-02
files_modified:
  - alembic.ini
  - alembic/env.py
  - alembic/script.py.mako
  - alembic/versions/.gitkeep
autonomous: true
requirements:
  - INFRA-ALEMBIC

must_haves:
  truths:
    - "Alembic is initialized with the async template and configured for asyncpg"
    - "env.py reads DATABASE_URL from pydantic-settings, not from alembic.ini"
    - "env.py imports Base from app.db.base so autogenerate sees all registered models"
    - "alembic upgrade head runs cleanly against the dev database"
  artifacts:
    - path: "alembic.ini"
      provides: "Alembic configuration entry point"
      contains: "script_location = alembic"
    - path: "alembic/env.py"
      provides: "Async migration runner with model import and settings-based URL"
      contains: "from app.db.base import Base"
    - path: "alembic/script.py.mako"
      provides: "Migration file template"
      contains: "revision"
  key_links:
    - from: "alembic/env.py"
      to: "app/db/base.py"
      via: "imports Base for target_metadata"
      pattern: "from app\\.db\\.base import Base"
    - from: "alembic/env.py"
      to: "app/core/config.py"
      via: "get_settings() for DATABASE_URL"
      pattern: "get_settings.*DATABASE_URL"
    - from: "alembic/env.py"
      to: "async_engine_from_config"
      via: "async migration runner"
      pattern: "async_engine_from_config"
---

<objective>
Initialize Alembic with the async template and configure env.py to use the application's settings and model metadata. Verify the migration system works end-to-end.

Purpose: Every feature phase creates database models that need migrations. If Alembic is misconfigured (wrong URL, empty metadata, sync instead of async), every subsequent migration will fail or silently produce empty/destructive scripts.
Output: Working Alembic setup where `alembic upgrade head` runs against the async PostgreSQL database and `alembic revision --autogenerate` correctly detects model changes.
</objective>

<execution_context>
@C:/Users/Sushasan/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Sushasan/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-infrastructure/01-RESEARCH.md
@.planning/phases/01-infrastructure/01-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Initialize Alembic with async template and configure env.py</name>
  <files>
    alembic.ini
    alembic/env.py
    alembic/script.py.mako
    alembic/versions/.gitkeep
  </files>
  <action>
    1. Run `poetry run alembic init -t async alembic` to generate the async Alembic template. This creates:
       - alembic.ini (config file)
       - alembic/env.py (async-ready migration runner)
       - alembic/script.py.mako (migration template)
       - alembic/versions/ (empty directory for migrations)

    2. Edit alembic/env.py to replace the generated template with the project-specific configuration (per RESEARCH.md Pattern 3):

       Key changes to the generated async template:
       a. Add imports at top: `from app.core.config import get_settings` and `from app.db.base import Base`
       b. Set `settings = get_settings()` and `target_metadata = Base.metadata`
       c. Create `def get_url() -> str: return settings.DATABASE_URL`
       d. In run_migrations_offline(): use `url=get_url()`, add `compare_type=True`
       e. In run_async_migrations() (the template's async function): override the config URL with `configuration["sqlalchemy.url"] = get_url()`
       f. In do_run_migrations(): add `compare_type=True` to context.configure()
       g. Keep the async template's structure (it uses `run_async_migrations()` and `asyncio.runner.run()`). Do NOT replace the template's async runner — just modify the URL source and metadata.

       CRITICAL: The import `from app.db.base import Base` MUST be present. Without it, target_metadata is empty and autogenerate produces destructive migrations.

    3. Edit alembic.ini:
       - Set `sqlalchemy.url = driver://user:pass@localhost/dbname` as a placeholder (overridden by env.py at runtime)
       - Ensure `script_location = alembic`
       - The URL in alembic.ini is never used at runtime because env.py overrides it

    4. Create alembic/versions/.gitkeep to ensure the directory is tracked by git.

    5. Verify the setup works by running `poetry run alembic check` — it should report "No new upgrade operations detected" (since there are no models yet) rather than an error.

    Note: Do NOT run `alembic revision --autogenerate` in this plan. There are no models yet, so it would produce an empty migration. The first real migration happens in Phase 2 when the User model is created.
  </action>
  <verify>
    <automated>cd D:/Python/claude-test && poetry run python -c "from alembic.config import Config; from alembic import command; config = Config('alembic.ini'); print('Alembic config loaded OK')" && poetry run python -c "
import ast, inspect
# Verify env.py imports Base and get_settings
with open('alembic/env.py') as f:
    content = f.read()
assert 'from app.db.base import Base' in content, 'Missing Base import'
assert 'get_settings' in content, 'Missing get_settings'
assert 'compare_type' in content, 'Missing compare_type'
print('env.py configuration verified: Base import, get_settings, compare_type all present')
"</automated>
    <manual>Verify alembic/env.py imports Base from app.db.base and reads URL from get_settings()</manual>
  </verify>
  <done>Alembic initialized with async template. env.py imports Base for target_metadata, reads DATABASE_URL from get_settings() (not alembic.ini), and has compare_type=True. alembic.ini exists as entry point. versions/ directory is git-tracked.</done>
</task>

<task type="auto">
  <name>Task 2: Verify Alembic connects to database and migration system works</name>
  <files></files>
  <action>
    1. Start Docker Compose to ensure PostgreSQL is running:
       - Run `docker compose up -d` in the project root
       - Wait for the healthcheck on bookstore_dev to pass (up to 30 seconds)

    2. Run `poetry run alembic upgrade head` against the dev database:
       - Should complete without errors (no migrations to apply yet, but it verifies the async connection works)
       - This confirms: async engine creation works, asyncpg connects to PostgreSQL, env.py configuration is correct

    3. Run `poetry run alembic check` to verify no pending migrations:
       - Should output "No new upgrade operations detected" (since no models exist yet)
       - This confirms: target_metadata is reachable and Alembic can compare schema state

    4. If either command fails due to Docker not running, the error message will guide the user. Do not modify env.py to handle missing Docker — that is expected to require Docker Compose running.
  </action>
  <verify>
    <automated>cd D:/Python/claude-test && docker compose up -d --wait 2>&1 && poetry run alembic upgrade head 2>&1 && poetry run alembic check 2>&1</automated>
    <manual>Confirm alembic upgrade head runs cleanly and alembic check reports no pending migrations</manual>
  </verify>
  <done>Alembic connects to PostgreSQL via asyncpg. `alembic upgrade head` completes without errors. `alembic check` confirms no pending migrations. The migration system is verified end-to-end.</done>
</task>

</tasks>

<verification>
1. alembic.ini exists and has `script_location = alembic`
2. alembic/env.py contains `from app.db.base import Base` and `from app.core.config import get_settings`
3. alembic/env.py uses `compare_type=True` in context.configure
4. `poetry run alembic upgrade head` runs without errors (with Docker running)
5. `poetry run alembic check` reports no pending migrations
</verification>

<success_criteria>
- Alembic initialized with async template (not sync)
- env.py reads DATABASE_URL from pydantic-settings (single source of truth)
- env.py imports Base from app.db.base (autogenerate will see all models)
- compare_type=True enabled for column type change detection
- alembic upgrade head connects to PostgreSQL and succeeds
- alembic check confirms no drift between models and database schema
</success_criteria>

<output>
After completion, create `.planning/phases/01-infrastructure/01-03-SUMMARY.md`
</output>
