---
phase: 03-oauth
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - app/users/models.py
  - app/db/base.py
  - app/core/config.py
  - app/core/oauth.py
  - app/main.py
  - alembic/versions/xxxx_add_oauth_accounts_and_nullable_password.py
autonomous: true
requirements:
  - AUTH-06
user_setup:
  - service: google-oauth
    why: "Google OAuth login"
    env_vars:
      - name: GOOGLE_CLIENT_ID
        source: "Google Cloud Console -> APIs & Services -> Credentials -> OAuth 2.0 Client ID"
      - name: GOOGLE_CLIENT_SECRET
        source: "Google Cloud Console -> APIs & Services -> Credentials -> OAuth 2.0 Client Secret"
    dashboard_config:
      - task: "Create OAuth 2.0 Client ID (Web application type)"
        location: "Google Cloud Console -> APIs & Services -> Credentials"
      - task: "Add http://localhost:8000/auth/google/callback to Authorized redirect URIs"
        location: "OAuth 2.0 Client ID settings"
  - service: github-oauth
    why: "GitHub OAuth login"
    env_vars:
      - name: GITHUB_CLIENT_ID
        source: "GitHub -> Settings -> Developer settings -> OAuth Apps -> Client ID"
      - name: GITHUB_CLIENT_SECRET
        source: "GitHub -> Settings -> Developer settings -> OAuth Apps -> Client Secret"
    dashboard_config:
      - task: "Create new OAuth App"
        location: "GitHub -> Settings -> Developer settings -> OAuth Apps"
      - task: "Set Authorization callback URL to http://localhost:8000/auth/github/callback"
        location: "OAuth App settings"

must_haves:
  truths:
    - "OAuthAccount model exists and stores provider + provider_user_id linkages"
    - "User.hashed_password is nullable so OAuth-only users can exist without a password"
    - "OAuth client registry configures Google (OIDC) and GitHub (plain OAuth2) providers"
    - "SessionMiddleware is registered for Authlib CSRF state management"
  artifacts:
    - path: "app/users/models.py"
      provides: "OAuthAccount model with UniqueConstraint on (oauth_provider, oauth_account_id)"
      contains: "class OAuthAccount"
    - path: "app/core/oauth.py"
      provides: "OAuth client registry with Google and GitHub provider registrations"
      exports: ["oauth", "configure_oauth"]
    - path: "app/core/config.py"
      provides: "GOOGLE_CLIENT_ID, GOOGLE_CLIENT_SECRET, GITHUB_CLIENT_ID, GITHUB_CLIENT_SECRET settings"
      contains: "GOOGLE_CLIENT_ID"
    - path: "alembic/versions/xxxx_add_oauth_accounts_and_nullable_password.py"
      provides: "Migration making hashed_password nullable and creating oauth_accounts table"
  key_links:
    - from: "app/users/models.py"
      to: "app/db/base.py"
      via: "import for Alembic discovery"
      pattern: "from app.users.models import.*OAuthAccount"
    - from: "app/main.py"
      to: "starlette.middleware.sessions"
      via: "SessionMiddleware registration"
      pattern: "SessionMiddleware"
    - from: "app/core/oauth.py"
      to: "app/core/config.py"
      via: "get_settings() for client IDs and secrets"
      pattern: "get_settings"
---

<objective>
Add the OAuthAccount data model, Alembic migration (nullable hashed_password + oauth_accounts table), OAuth provider configuration via Authlib, and SessionMiddleware -- the foundation all OAuth endpoints depend on.

Purpose: Establishes the data layer and provider registry that Plan 02 will use for the actual OAuth login/callback endpoints and account linking logic.
Output: OAuthAccount model, migration, oauth.py client registry, updated config.py and main.py.
</objective>

<execution_context>
@C:/Users/Sushasan/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Sushasan/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@D:/Python/claude-test/.planning/ROADMAP.md
@D:/Python/claude-test/.planning/STATE.md
@D:/Python/claude-test/.planning/phases/03-oauth/03-RESEARCH.md
@D:/Python/claude-test/app/users/models.py
@D:/Python/claude-test/app/db/base.py
@D:/Python/claude-test/app/core/config.py
@D:/Python/claude-test/app/main.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install Authlib + itsdangerous, add OAuthAccount model, update User model, add config settings</name>
  <files>
    app/users/models.py
    app/db/base.py
    app/core/config.py
    app/core/oauth.py
    app/main.py
    pyproject.toml
  </files>
  <action>
1. Install dependencies:
   ```
   poetry add authlib itsdangerous
   ```

2. In `app/core/config.py`, add four new fields to the `Settings` class (after the existing Security section):
   ```python
   # OAuth - Google
   GOOGLE_CLIENT_ID: str = ""
   GOOGLE_CLIENT_SECRET: str = ""
   # OAuth - GitHub
   GITHUB_CLIENT_ID: str = ""
   GITHUB_CLIENT_SECRET: str = ""
   ```
   Empty string defaults allow the app to start without OAuth credentials (OAuth endpoints will fail gracefully if not configured).

3. In `app/users/models.py`:
   - Change `hashed_password` on `User` from `Mapped[str]` to `Mapped[str | None]` and change `nullable=False` to `nullable=True`. This allows OAuth-only users to exist without a password.
   - Add `oauth_accounts` relationship to `User`:
     ```python
     oauth_accounts: Mapped[list["OAuthAccount"]] = relationship(
         back_populates="user", cascade="all, delete-orphan"
     )
     ```
   - Add `OAuthAccount` model class AFTER the `User` class (but before `RefreshToken`):
     ```python
     class OAuthAccount(Base):
         __tablename__ = "oauth_accounts"
         id: Mapped[int] = mapped_column(primary_key=True)
         user_id: Mapped[int] = mapped_column(ForeignKey("users.id"), nullable=False)
         oauth_provider: Mapped[str] = mapped_column(String(50), nullable=False)
         oauth_account_id: Mapped[str] = mapped_column(String(255), nullable=False)
         created_at: Mapped[datetime] = mapped_column(
             DateTime(timezone=True), server_default=func.now(), nullable=False
         )
         __table_args__ = (
             UniqueConstraint("oauth_provider", "oauth_account_id", name="uq_oauth_provider_account"),
         )
         user: Mapped["User"] = relationship(back_populates="oauth_accounts")
     ```
   - Add `UniqueConstraint` to the imports from `sqlalchemy`.

4. In `app/db/base.py`, add the OAuthAccount import alongside the existing model imports:
   ```python
   from app.users.models import OAuthAccount, RefreshToken, User  # noqa: F401, E402
   ```

5. Create `app/core/oauth.py`:
   ```python
   """OAuth client registry using Authlib.

   Call configure_oauth() during app startup to register Google and GitHub providers.
   The `oauth` instance is imported by route handlers for authorize_redirect / authorize_access_token.
   """
   from authlib.integrations.starlette_client import OAuth
   from app.core.config import get_settings

   oauth = OAuth()

   def configure_oauth() -> None:
       settings = get_settings()
       oauth.register(
           name="google",
           client_id=settings.GOOGLE_CLIENT_ID,
           client_secret=settings.GOOGLE_CLIENT_SECRET,
           server_metadata_url="https://accounts.google.com/.well-known/openid-configuration",
           client_kwargs={"scope": "openid email profile"},
       )
       oauth.register(
           name="github",
           client_id=settings.GITHUB_CLIENT_ID,
           client_secret=settings.GITHUB_CLIENT_SECRET,
           access_token_url="https://github.com/login/oauth/access_token",
           authorize_url="https://github.com/login/oauth/authorize",
           api_base_url="https://api.github.com/",
           client_kwargs={"scope": "user:email"},
       )
   ```

6. In `app/main.py`:
   - Add `from starlette.middleware.sessions import SessionMiddleware`
   - Add `from app.core.config import get_settings`
   - Add `from app.core.oauth import configure_oauth`
   - Inside `create_app()`, BEFORE `application.include_router(...)` calls, add:
     ```python
     application.add_middleware(
         SessionMiddleware,
         secret_key=get_settings().SECRET_KEY,
         max_age=600,
     )
     configure_oauth()
     ```
  </action>
  <verify>
    <automated>cd D:/Python/claude-test && poetry run python -c "from app.users.models import OAuthAccount; from app.core.oauth import oauth, configure_oauth; print('imports OK')" && poetry run ruff check app/users/models.py app/core/oauth.py app/core/config.py app/main.py app/db/base.py</automated>
    <manual>Verify OAuthAccount model has UniqueConstraint, User.hashed_password is Mapped[str | None], SessionMiddleware registered in main.py</manual>
  </verify>
  <done>OAuthAccount model defined with correct columns and UniqueConstraint. User.hashed_password is nullable. Config has OAuth settings. oauth.py exports oauth instance and configure_oauth. SessionMiddleware registered in create_app(). All imports clean.</done>
</task>

<task type="auto">
  <name>Task 2: Create Alembic migration for nullable hashed_password and oauth_accounts table</name>
  <files>
    alembic/versions/xxxx_add_oauth_accounts_and_nullable_password.py
  </files>
  <action>
1. Generate the migration using Alembic autogenerate:
   ```
   cd D:/Python/claude-test && poetry run alembic revision --autogenerate -m "add_oauth_accounts_and_nullable_password"
   ```

2. Review the generated migration file. It MUST contain:
   - `op.alter_column("users", "hashed_password", existing_type=sa.String(255), nullable=True)` in upgrade
   - `op.create_table("oauth_accounts", ...)` with columns: id (Integer, PK), user_id (Integer, FK to users.id), oauth_provider (String(50)), oauth_account_id (String(255)), created_at (DateTime(timezone=True), server_default=func.now())
   - `UniqueConstraint("oauth_provider", "oauth_account_id", name="uq_oauth_provider_account")` on oauth_accounts
   - Index on oauth_accounts.user_id
   - Downgrade must reverse both operations: drop oauth_accounts table and alter hashed_password back to nullable=False

3. If autogenerate misses the index on user_id, add it manually:
   ```python
   op.create_index("ix_oauth_accounts_user_id", "oauth_accounts", ["user_id"])
   ```

4. Run the migration against the dev database:
   ```
   poetry run alembic upgrade head
   ```

5. Verify no pending migrations:
   ```
   poetry run alembic check
   ```
  </action>
  <verify>
    <automated>cd D:/Python/claude-test && poetry run alembic upgrade head && poetry run alembic check</automated>
    <manual>Verify oauth_accounts table exists with correct columns and hashed_password is nullable</manual>
  </verify>
  <done>Migration created and applied. oauth_accounts table exists with UniqueConstraint on (oauth_provider, oauth_account_id). users.hashed_password is nullable. alembic check reports no pending migrations.</done>
</task>

</tasks>

<verification>
1. `poetry run python -c "from app.users.models import OAuthAccount; print('model OK')"` succeeds
2. `poetry run alembic check` reports no pending migrations
3. `poetry run ruff check app/` passes
4. `poetry run task test` -- existing tests still pass (no regressions)
</verification>

<success_criteria>
- OAuthAccount model exists with user_id FK, oauth_provider, oauth_account_id columns, and UniqueConstraint
- User.hashed_password is nullable (Mapped[str | None])
- oauth.py has configure_oauth() registering Google (OIDC) and GitHub (plain OAuth2)
- Config.py has GOOGLE_CLIENT_ID, GOOGLE_CLIENT_SECRET, GITHUB_CLIENT_ID, GITHUB_CLIENT_SECRET with empty defaults
- SessionMiddleware is registered in create_app() with SECRET_KEY and max_age=600
- Alembic migration applied successfully; alembic check clean
- All existing tests still pass
</success_criteria>

<output>
After completion, create `.planning/phases/03-oauth/03-01-SUMMARY.md`
</output>
