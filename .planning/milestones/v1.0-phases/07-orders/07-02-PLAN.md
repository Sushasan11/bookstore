---
phase: 07-orders
plan: 02
type: tdd
wave: 2
depends_on:
  - "07-01"
files_modified:
  - tests/test_orders.py
autonomous: true
requirements:
  - COMM-03
  - COMM-04
  - COMM-05
  - ENGM-06

must_haves:
  truths:
    - "Checkout creates order with line items and decrements stock for each purchased book"
    - "Checkout with empty cart is rejected with 422"
    - "Checkout with insufficient stock is rejected with 409 indicating which items are short"
    - "Payment failure preserves cart contents and creates no order"
    - "Concurrent checkouts for stock=1 book result in exactly one success and one failure (no negative stock)"
    - "Checkout response includes order ID, line items with unit_price snapshot, and computed total"
    - "User can list their own orders and see line items"
    - "User cannot access another user's order (404)"
    - "Admin can view all orders from all users"
    - "Non-admin cannot access admin orders endpoint (403)"
  artifacts:
    - path: "tests/test_orders.py"
      provides: "Integration tests covering COMM-03, COMM-04, COMM-05, ENGM-06"
      min_lines: 200
  key_links:
    - from: "tests/test_orders.py"
      to: "POST /orders/checkout"
      via: "httpx AsyncClient"
      pattern: "client.post.*checkout"
    - from: "tests/test_orders.py"
      to: "GET /orders"
      via: "httpx AsyncClient"
      pattern: "client.get.*orders"
    - from: "tests/test_orders.py"
      to: "GET /admin/orders"
      via: "httpx AsyncClient"
      pattern: "client.get.*admin/orders"
---

<objective>
Integration tests for the complete orders feature — checkout flow (success, empty cart, insufficient stock, payment failure, concurrent race condition), order confirmation response structure, order history (user isolation, detail view), and admin orders access control.

Purpose: Prove all 4 phase requirements (COMM-03, COMM-04, COMM-05, ENGM-06) work end-to-end through HTTP, including the critical race condition safety test for concurrent checkouts.
Output: tests/test_orders.py with 13+ integration tests, all passing alongside the existing 94 tests.
</objective>

<execution_context>
@C:/Users/Sushasan/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Sushasan/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@.planning/phases/07-orders/07-CONTEXT.md
@.planning/phases/07-orders/07-RESEARCH.md
@.planning/phases/07-orders/07-01-SUMMARY.md

@app/orders/models.py
@app/orders/schemas.py
@app/orders/repository.py
@app/orders/service.py
@app/orders/router.py
@tests/conftest.py
@tests/test_cart.py
</context>

<feature>
  <name>Order Integration Tests</name>
  <files>tests/test_orders.py</files>
  <behavior>
    Test cases covering all order endpoints and behaviors:

    **COMM-03 — Checkout creates order, decrements stock, clears cart:**
    1. `test_checkout_success_creates_order_and_decrements_stock` — Add book to cart, checkout, verify 201 response with order data, verify stock decremented, verify cart is now empty (GET /cart returns 0 items).
    2. `test_checkout_empty_cart_rejected` — Checkout with no items in cart, verify 422 ORDER_CART_EMPTY.
    3. `test_checkout_insufficient_stock_rejected` — Add book to cart with quantity > stock, checkout, verify 409 ORDER_INSUFFICIENT_STOCK.
    4. `test_checkout_payment_failure_preserves_cart` — Checkout with `force_payment_failure: true`, verify 402 ORDER_PAYMENT_FAILED, verify cart still has items (GET /cart), verify no order created (GET /orders returns empty).
    5. `test_checkout_concurrent_race_condition_safe` — Two users both have the same book (stock=1) in their carts. Use `asyncio.gather` to fire two concurrent POST /orders/checkout requests. Verify exactly one succeeds (201) and one fails (409). Verify book stock is 0, not negative.

    **COMM-04 — Order confirmation response structure:**
    6. `test_checkout_response_structure` — Verify checkout response includes `id`, `status` ("confirmed"), `created_at`, `items` list with `book_id`, `quantity`, `unit_price`, `book` summary, and computed `total_price`.
    7. `test_checkout_unit_price_snapshot` — Create book at price X, add to cart, change book price to Y (admin PUT), checkout. Verify `unit_price` in order items equals X (price at time of cart add/checkout, not current price). Note: price is snapshotted from `book.price` at checkout time, so the test should update price AFTER adding to cart but BEFORE checkout.

    **COMM-05 — Order history:**
    8. `test_list_orders_for_user` — Create two orders (checkout twice with re-added cart items), GET /orders, verify 2 orders returned with items.
    9. `test_list_orders_user_isolation` — User A has orders, User B has no orders. GET /orders as User B returns empty list.
    10. `test_get_order_detail` — GET /orders/{id} returns the order with correct items.
    11. `test_get_order_not_found` — GET /orders/{nonexistent_id} returns 404 ORDER_NOT_FOUND.

    **ENGM-06 — Admin order view:**
    12. `test_admin_list_all_orders` — Admin GET /admin/orders returns orders from all users.
    13. `test_admin_orders_requires_admin` — Non-admin GET /admin/orders returns 403.
  </behavior>
  <implementation>
    **Fixture pattern** (matches test_cart.py conventions):
    - `admin_headers` — Create admin user via UserRepository + set role + login via HTTP. Use `orders_admin@example.com` email prefix.
    - `user_headers` — Create regular user + login. Use `orders_user@example.com`.
    - `user2_headers` — Second regular user for isolation and concurrency tests. Use `orders_user2@example.com`.
    - `sample_book` — Create book via admin POST /books, PATCH /books/{id}/stock to set stock=10. Returns book dict.
    - Helper `_add_to_cart(client, headers, book_id, quantity=1)` — POST /cart/items, assert 201, return response dict.
    - Helper `_checkout(client, headers, force_fail=False)` — POST /orders/checkout with CheckoutRequest body, return response object (not asserting status — caller checks).

    **Concurrent test approach** (per RESEARCH.md Open Question 1):
    - Create all test data (users, books, cart items) via HTTP calls (which commit via get_db), not via db_session fixture.
    - Use `asyncio.gather` with two concurrent `client.post("/orders/checkout", ...)` calls.
    - After both complete, check: exactly one 201 and one 409 (or 402). Check stock via GET /books/{id}.

    **Key conventions:**
    - No `@pytest.mark.asyncio` decorators (asyncio_mode=auto handles it).
    - Module-specific email prefixes to avoid collision with other test modules.
    - All tests use `client` fixture from conftest.py for HTTP calls.
    - Use `pytest_asyncio.fixture` for async fixtures.
    - `abs(float(total_price) - expected) < 0.02` for Decimal comparison tolerance.
  </implementation>
</feature>

<verification>
1. `poetry run pytest tests/test_orders.py -x -v` — all 13+ tests pass
2. `poetry run task test` — full suite passes (94 + 13 = 107+ tests, zero regressions)
3. `poetry run ruff check tests/test_orders.py && poetry run ruff format --check tests/test_orders.py` — clean
</verification>

<success_criteria>
- 13+ integration tests covering COMM-03, COMM-04, COMM-05, ENGM-06
- Concurrent checkout test proves race condition safety (exactly one success, stock never negative)
- Payment failure test proves cart preservation (no order, no stock change)
- Order history tests prove user isolation (User B cannot see User A's orders)
- Admin test proves access control (non-admin gets 403)
- Full test suite (107+ tests) passes with zero regressions
</success_criteria>

<output>
After completion, create `.planning/phases/07-orders/07-02-SUMMARY.md`
</output>
