---
phase: 05-discovery
plan: "03"
type: execute
wave: 3
depends_on:
  - "05-02"
files_modified:
  - tests/test_discovery.py
autonomous: true
requirements:
  - DISC-01
  - DISC-02
  - DISC-03
  - DISC-04

must_haves:
  truths:
    - "20+ integration tests covering all 4 discovery requirements pass with pytest"
    - "Pagination tests verify page/size/total fields in response envelope"
    - "Sort tests verify results are ordered by title, price, date, created_at"
    - "FTS search test: searching by partial word prefix returns matching books"
    - "FTS search test: searching by author name returns books by that author"
    - "Filter test: genre_id filter returns only books in the specified genre"
    - "Filter test: author filter returns only books matching the author substring"
    - "Combined filter test: q + genre_id applied together narrow results correctly"
    - "Book detail test: GET /books/{id} returns in_stock=true when stock_quantity > 0"
    - "Book detail test: GET /books/{id} returns in_stock=false when stock_quantity = 0"
    - "Error test: GET /books/{id} with unknown ID returns 404"
  artifacts:
    - path: "tests/test_discovery.py"
      provides: "Integration tests for all discovery endpoints"
      min_lines: 200
      contains: "test_list_books_pagination"
  key_links:
    - from: "tests/test_discovery.py"
      to: "GET /books"
      via: "client.get('/books', params=...)"
      pattern: "client.get.*books"
    - from: "tests/test_discovery.py"
      to: "GET /books/{id}"
      via: "client.get(f'/books/{book_id}')"
      pattern: "client.get.*books.*id"
    - from: "tests/test_discovery.py"
      to: "tests/conftest.py"
      via: "client fixture (AsyncClient with app) and db_session fixture for DB setup"
      pattern: "async def test_.*client"
---

<objective>
Write comprehensive integration tests for the Phase 5 discovery endpoints: GET /books (pagination, sort, FTS search, filters) and GET /books/{id} (detail + in_stock). Tests use the existing conftest.py async test infrastructure (AsyncClient, db_session with rollback, asyncio_mode=auto).

Purpose: Validates all four discovery requirements are correctly implemented end-to-end against the real test PostgreSQL database with the search_vector generated column active. Tests also serve as regression protection for future phases that add data to the books table.

Output: `tests/test_discovery.py` with 20+ test cases covering happy paths and edge cases for DISC-01, DISC-02, DISC-03, DISC-04.
</objective>

<execution_context>
@C:/Users/Sushasan/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Sushasan/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-discovery/05-CONTEXT.md
@.planning/phases/05-discovery/05-RESEARCH.md
@tests/conftest.py
@tests/test_catalog.py
@app/books/schemas.py
@app/books/router.py
@.planning/phases/05-discovery/05-01-SUMMARY.md
@.planning/phases/05-discovery/05-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Write integration tests for GET /books (pagination, sort, search, filters) and GET /books/{id} (detail + in_stock)</name>
  <files>tests/test_discovery.py</files>
  <action>
Create `tests/test_discovery.py` with the full discovery test suite. Follow the exact same patterns as `tests/test_catalog.py` — no `@pytest.mark.asyncio` decorators (asyncio_mode=auto handles this), same `client`/`db_session`/`admin_headers` fixture usage.

**Test file structure:**

```python
"""Integration tests for Phase 5 Discovery: GET /books (pagination, sort, search, filter)
and GET /books/{id} (detail with in_stock).

Coverage:
  DISC-01: pagination and sorting
  DISC-02: full-text search (FTS) across title and author
  DISC-03: filtering by genre_id and author
  DISC-04: book detail with in_stock boolean

Uses the existing conftest.py async infrastructure:
  - asyncio_mode = "auto" (no @pytest.mark.asyncio needed)
  - client: AsyncClient against the test app
  - db_session: function-scoped with rollback (test isolation)
  - admin_headers: Authorization header for admin-only endpoints
"""

import pytest
from httpx import AsyncClient
```

**Fixtures needed:**

Define a module-level async fixture `seeded_books` that uses `admin_headers` and `client` to POST several books (and optionally genres) via the API, returning a dict of created book IDs by test name. Alternatively, use a helper async function `_create_book(client, admin_headers, **kwargs)` that POSTs to `/books` and returns the created book dict.

Create at least:
- 3-5 books with distinct titles, authors, genres, prices, stock quantities, publish dates
- At least 1 genre (POST /genres as admin)
- At least 1 out-of-stock book (stock_quantity=0) and 1 in-stock book (stock_quantity > 0)

**Test cases to implement (group by requirement):**

DISC-01 — Pagination and sorting:
- `test_list_books_returns_paginated_envelope`: GET /books returns `{items, total, page, size}` structure
- `test_list_books_default_sort_title`: GET /books without sort param returns books alphabetically by title
- `test_list_books_sort_price`: GET /books?sort=price returns books in ascending price order
- `test_list_books_sort_date`: GET /books?sort=date returns books in ascending publish_date order (books with null publish_date last or first — document behavior)
- `test_list_books_sort_created_at`: GET /books?sort=created_at returns newest books first
- `test_list_books_pagination_page_size`: GET /books?page=1&size=2 returns 2 items; GET /books?page=2&size=2 returns the next batch
- `test_list_books_empty_result`: GET /books when no books returns `{items: [], total: 0, page: 1, size: 20}`

DISC-02 — Full-text search:
- `test_search_by_title_word`: GET /books?q=dune returns book with "Dune" in title
- `test_search_by_title_prefix`: GET /books?q=du returns book with "Dune" in title (prefix match)
- `test_search_by_author_name`: GET /books?q=tolkien returns book authored by "J.R.R. Tolkien"
- `test_search_returns_relevance_ranked`: GET /books?q=common_word with multiple matches returns title-weight matches first (title A vs author B)
- `test_search_no_results`: GET /books?q=xyzunmatchable returns empty items list with total=0
- `test_search_special_chars_no_error`: GET /books?q=C%2B%2B returns 200 (not 500) — special chars stripped safely

DISC-03 — Filtering:
- `test_filter_by_genre_id`: GET /books?genre_id={id} returns only books in that genre
- `test_filter_by_author`: GET /books?author=tolkien returns books with "tolkien" in author (case-insensitive)
- `test_filter_combined_q_and_genre`: GET /books?q=ring&genre_id={id} returns only books matching both conditions
- `test_filter_no_match_returns_empty`: GET /books?genre_id=99999 returns empty items (non-existent genre)

DISC-04 — Book detail:
- `test_get_book_detail_in_stock`: GET /books/{id} for book with stock_quantity=5 returns `in_stock: true`
- `test_get_book_detail_out_of_stock`: GET /books/{id} for book with stock_quantity=0 returns `in_stock: false`
- `test_get_book_detail_full_fields`: GET /books/{id} response includes id, title, author, price, isbn, genre_id, description, cover_image_url, publish_date, stock_quantity, in_stock
- `test_get_book_detail_not_found`: GET /books/99999 returns 404

**Implementation notes:**
- No `@pytest.mark.asyncio` decorators — asyncio_mode=auto in pyproject.toml handles all async tests (matches test_catalog.py style)
- Each test that needs books should either use a shared `autouse=False` fixture or call `_create_book` within the test body — prefer the helper function approach to keep tests readable and independent
- Use `admin_headers` fixture for POST /books calls (already defined in conftest.py)
- For FTS tests, book data matters: use "Dune" by "Frank Herbert" and "The Fellowship of the Ring" by "J.R.R. Tolkien" as canonical test books — these are realistic and their tokens are unambiguous
- After creating books via API, stock is 0 by default — use PATCH /books/{id}/stock with admin_headers to set stock for the in_stock tests
- Verify the FTS test DB correctly generates search_vector by asserting the FTS search returns a result (if search_vector is not generated, the FTS test will return empty and fail with a clear message)

**Minimum test count:** 20 tests. Do not skimp on edge cases — the research identified FTS pitfalls (special chars, empty results, case sensitivity) that should be explicitly covered.
  </action>
  <verify>
    <automated>cd D:/Python/claude-test && poetry run pytest tests/test_discovery.py -v --tb=short 2>&1 | tail -30</automated>
    <manual>
      Confirm:
        1. All tests pass (no FAILED or ERROR lines)
        2. At least 20 tests collected
        3. FTS tests actually exercise the search_vector column (search tests return matching books, not empty)
    </manual>
  </verify>
  <done>
    - `tests/test_discovery.py` exists with 20+ test cases
    - All tests pass: `pytest tests/test_discovery.py` exits 0
    - Tests cover all 4 requirement groups: pagination+sort (DISC-01), FTS search (DISC-02), filters (DISC-03), detail+in_stock (DISC-04)
    - No `@pytest.mark.asyncio` decorators used (asyncio_mode=auto handles it)
    - FTS tests use real books (Dune, Tolkien) and verify actual search results, not just response status
  </done>
</task>

<task type="auto">
  <name>Task 2: Run full test suite and confirm no regression</name>
  <files></files>
  <action>
Run the complete test suite (all phases) to confirm Phase 5 tests pass alongside all previously passing tests.

```bash
cd D:/Python/claude-test && poetry run task test
```

Expected outcome: All tests pass — Phase 1 smoke tests, Phase 2 auth tests, Phase 3 OAuth tests, Phase 4 catalog tests, and Phase 5 discovery tests.

If any test fails:
1. Identify whether the failure is in the new discovery tests or in a regression of prior tests
2. For regression failures: check whether the `GET /books` or `GET /books/{id}` endpoint changes (Phase 02 plan) affected existing test_catalog.py assertions. The `GET /books/{id}` now returns `BookDetailResponse` (superset of `BookResponse`) — existing tests checking `BookResponse` fields should still pass since all original fields are present.
3. Fix any failures before completing this task.

Also run ruff to confirm no lint errors from the new files:
```bash
poetry run task lint
```
  </action>
  <verify>
    <automated>cd D:/Python/claude-test && poetry run task test && poetry run task lint</automated>
    <manual>
      Confirm:
        1. `pytest` output shows all tests collected and passed (green)
        2. `ruff check` output shows "All checks passed."
        3. Discovery test count is 20+
    </manual>
  </verify>
  <done>
    - `poetry run task test` exits 0 (all tests pass)
    - `poetry run task lint` exits 0 (no lint errors)
    - Discovery tests are 20+ cases covering DISC-01 through DISC-04
    - No regression in Phase 2, 3, or 4 tests
  </done>
</task>

</tasks>

<verification>
Final Phase 5 verification — all four discovery requirements satisfied:

```bash
cd D:/Python/claude-test && poetry run pytest tests/test_discovery.py -v 2>&1 | grep -E "PASSED|FAILED|ERROR|test_"
```

Manual cross-check against roadmap success criteria:
1. DISC-01: test_list_books_pagination_page_size + test_list_books_sort_price pass
2. DISC-02: test_search_by_title_prefix + test_search_by_author_name pass
3. DISC-03: test_filter_by_genre_id + test_filter_combined_q_and_genre pass
4. DISC-04: test_get_book_detail_in_stock + test_get_book_detail_out_of_stock pass
</verification>

<success_criteria>
- `poetry run pytest tests/test_discovery.py` passes with 20+ tests
- All 4 requirement groups covered: DISC-01, DISC-02, DISC-03, DISC-04
- FTS tests validate actual search results (not just HTTP 200)
- `poetry run task test` passes (full suite, no regression)
- `poetry run task lint` passes (ruff clean)
</success_criteria>

<output>
After completion, create `.planning/phases/05-discovery/05-03-SUMMARY.md` following the summary template.
</output>
