---
phase: 05-discovery
plan: "01"
type: execute
wave: 1
depends_on: []
files_modified:
  - app/books/models.py
  - alembic/versions/a1b2c3d4e5f6_add_books_search_vector.py
  - alembic/env.py
autonomous: true
requirements:
  - DISC-02

must_haves:
  truths:
    - "The books table has a search_vector TSVECTOR GENERATED ALWAYS AS STORED column"
    - "A GIN index ix_books_search_vector exists on the search_vector column"
    - "Alembic upgrade head applies cleanly with no errors"
    - "Subsequent alembic revision --autogenerate does NOT re-detect the GIN index as changed"
    - "The Book ORM model exposes search_vector as a deferred Computed column"
  artifacts:
    - path: "app/books/models.py"
      provides: "Book model with search_vector Computed column"
      contains: "Computed.*persisted=True"
    - path: "alembic/versions/a1b2c3d4e5f6_add_books_search_vector.py"
      provides: "Hand-written migration adding tsvector column + GIN index"
      contains: "ix_books_search_vector"
    - path: "alembic/env.py"
      provides: "include_object filter excluding GIN index from autogenerate"
      contains: "include_object"
  key_links:
    - from: "alembic/versions/a1b2c3d4e5f6_add_books_search_vector.py"
      to: "alembic/versions/c3d4e5f6a7b8_create_genres_and_books.py"
      via: "down_revision = 'c3d4e5f6a7b8'"
      pattern: "down_revision.*c3d4e5f6a7b8"
    - from: "app/books/models.py"
      to: "PostgreSQL books.search_vector"
      via: "Computed(persisted=True) generates GENERATED ALWAYS AS DDL"
      pattern: "Computed.*setweight.*to_tsvector"
    - from: "alembic/env.py"
      to: "ix_books_search_vector"
      via: "include_object filter returning False for this index"
      pattern: "ix_books_search_vector"
---

<objective>
Add PostgreSQL full-text search infrastructure to the books table: a tsvector GENERATED ALWAYS AS STORED column weighted by title (A) and author (B), backed by a GIN index for fast FTS queries. Fix alembic/env.py to prevent the Alembic autogenerate bug that would re-detect this GIN index as changed on every run.

Purpose: This is the foundation for DISC-02 (full-text search). Without the generated column and GIN index, every FTS query would require a full table scan and on-the-fly tsvector computation — unacceptably slow and complex to query. All FTS query patterns in Plan 02 depend on this column existing.

Output: One new migration file, one updated ORM model, one updated alembic/env.py. After `alembic upgrade head`, the books table has `search_vector` that PostgreSQL maintains automatically as books are inserted/updated.
</objective>

<execution_context>
@C:/Users/Sushasan/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Sushasan/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-discovery/05-CONTEXT.md
@.planning/phases/05-discovery/05-RESEARCH.md
@app/books/models.py
@alembic/env.py
@alembic/versions/c3d4e5f6a7b8_create_genres_and_books.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add search_vector Computed column to Book ORM model</name>
  <files>app/books/models.py</files>
  <action>
Add the `search_vector` column to the `Book` class in `app/books/models.py`.

Exact changes:

1. Add to the existing import block from `sqlalchemy`:
   - Add `Computed` and `Index` to the imports from `sqlalchemy`
   - Add `from sqlalchemy.dialects.postgresql import TSVECTOR`

2. Update `Book.__table_args__` to include the GIN index:
   ```python
   __table_args__ = (
       CheckConstraint("stock_quantity >= 0", name="ck_books_stock_non_negative"),
       CheckConstraint("price > 0", name="ck_books_price_positive"),
       Index("ix_books_search_vector", "search_vector", postgresql_using="gin"),
   )
   ```

3. Add the `search_vector` column at the end of the `Book` column definitions (after `updated_at`, before the `genre` relationship):
   ```python
   search_vector: Mapped[str] = mapped_column(
       TSVECTOR,
       Computed(
           "setweight(to_tsvector('simple', coalesce(title, '')), 'A') || "
           "setweight(to_tsvector('simple', coalesce(author, '')), 'B')",
           persisted=True,
       ),
       nullable=True,
       deferred=True,
   )
   ```

IMPORTANT: Use `'simple'` dictionary (NOT `'english'`) — `'simple'` avoids stemming proper names like "Tolkien" and "Herbert". Use `deferred=True` so the column is NOT loaded on every SELECT; it will only be fetched when explicitly included in a query.

Do NOT include `search_vector` in `BookResponse`, `BookCreate`, or any user-facing schema — it is internal storage format only.
  </action>
  <verify>
    <automated>cd D:/Python/claude-test && poetry run python -c "from app.books.models import Book; col = Book.__table__.c['search_vector']; print('column type:', col.type); print('deferred OK')"</automated>
    <manual>Confirm `search_vector` column shows in `Book.__table__.columns` with TSVECTOR type.</manual>
  </verify>
  <done>
    - `app/books/models.py` imports `Computed`, `Index` from sqlalchemy and `TSVECTOR` from sqlalchemy.dialects.postgresql
    - `Book.__table_args__` contains `Index("ix_books_search_vector", "search_vector", postgresql_using="gin")`
    - `Book.search_vector` column exists with `Computed(..., persisted=True)` and `deferred=True`
    - `python -c "from app.books.models import Book"` imports without error
  </done>
</task>

<task type="auto">
  <name>Task 2: Write hand-crafted Alembic migration for tsvector column + GIN index, and fix env.py include_object</name>
  <files>
    alembic/versions/a1b2c3d4e5f6_add_books_search_vector.py
    alembic/env.py
  </files>
  <action>
**Part A — Hand-write the Alembic migration file.**

Create `alembic/versions/a1b2c3d4e5f6_add_books_search_vector.py` with this exact content (do NOT run `alembic revision --autogenerate` — that triggers Alembic bug #1390 with GIN indexes):

```python
"""Add search_vector tsvector generated column and GIN index to books.

Revision ID: a1b2c3d4e5f6
Revises: c3d4e5f6a7b8
Create Date: 2026-02-25
"""

import sqlalchemy as sa
from alembic import op
from sqlalchemy.dialects import postgresql

revision: str = "a1b2c3d4e5f6"
down_revision: str | None = "c3d4e5f6a7b8"
branch_labels = None
depends_on = None


def upgrade() -> None:
    # Add generated tsvector column: PostgreSQL maintains this automatically.
    # 'simple' dictionary: no stemming — preserves proper names like "Tolkien".
    # setweight A for title (higher rank), B for author.
    op.add_column(
        "books",
        sa.Column(
            "search_vector",
            postgresql.TSVECTOR(),
            sa.Computed(
                "setweight(to_tsvector('simple', coalesce(title, '')), 'A') || "
                "setweight(to_tsvector('simple', coalesce(author, '')), 'B')",
                persisted=True,
            ),
            nullable=True,
        ),
    )
    # GIN index for fast full-text search (orders of magnitude faster than LIKE).
    op.create_index(
        "ix_books_search_vector",
        "books",
        ["search_vector"],
        postgresql_using="gin",
    )


def downgrade() -> None:
    op.drop_index("ix_books_search_vector", table_name="books")
    op.drop_column("books", "search_vector")
```

**Part B — Fix alembic/env.py to exclude GIN index from autogenerate.**

Add an `include_object` function and register it in BOTH `run_migrations_offline` and `do_run_migrations`:

```python
def include_object(object, name, type_, reflected, compare_to):
    """Exclude FTS GIN index from autogenerate detection (Alembic bug #1390).

    Alembic repeatedly detects expression-based GIN indexes as changed due to
    PostgreSQL normalizing the stored expression differently from what Alembic writes.
    Excluding this index prevents spurious migrations after initial creation.
    """
    if type_ == "index" and name == "ix_books_search_vector":
        return False
    return True
```

Then in `run_migrations_offline`, add `include_object=include_object` to the `context.configure(...)` call.
In `do_run_migrations`, add `include_object=include_object` to the `context.configure(...)` call.

After writing the migration, run it to verify it applies cleanly:
```bash
poetry run alembic upgrade head
```

Then check for spurious autogenerate detection:
```bash
poetry run alembic check
```
`alembic check` should print "No new upgrade operations detected." If it prints anything about `ix_books_search_vector`, the `include_object` fix is not working.
  </action>
  <verify>
    <automated>cd D:/Python/claude-test && poetry run alembic upgrade head && poetry run alembic check</automated>
    <manual>
      1. `alembic upgrade head` should complete with no errors and show the a1b2c3d4e5f6 migration applied.
      2. `alembic check` should output "No new upgrade operations detected." — NOT any mention of ix_books_search_vector.
    </manual>
  </verify>
  <done>
    - `alembic/versions/a1b2c3d4e5f6_add_books_search_vector.py` exists with correct `down_revision = "c3d4e5f6a7b8"`
    - `alembic upgrade head` completes without error
    - `alembic check` reports no pending migrations (GIN index not re-detected)
    - `alembic/env.py` has `include_object` function and it is passed to `context.configure()` in both offline and online paths
  </done>
</task>

</tasks>

<verification>
Run the full existing test suite to confirm nothing regressed:

```bash
cd D:/Python/claude-test && poetry run task test
```

All 21 existing catalog tests and auth tests should still pass. The `search_vector` column is `deferred=True` and not included in any existing schema, so no existing endpoint or test should be affected.

Also confirm the model imports correctly in isolation:
```bash
poetry run python -c "from app.books.models import Book, Genre; print('OK')"
```
</verification>

<success_criteria>
- `alembic upgrade head` applies cleanly (migration a1b2c3d4e5f6 succeeds)
- `alembic check` reports "No new upgrade operations detected" (include_object working)
- `poetry run task test` passes all existing tests (no regression from model changes)
- `Book.search_vector` column visible in model with `Computed(persisted=True)` and `deferred=True`
- `search_vector` NOT present in BookResponse or any user-facing schema
</success_criteria>

<output>
After completion, create `.planning/phases/05-discovery/05-01-SUMMARY.md` following the summary template.
</output>
