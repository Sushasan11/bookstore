---
phase: 19-monorepo-frontend-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/app/main.py
  - backend/app/core/config.py
  - backend/pyproject.toml
  - backend/alembic.ini
  - backend/docker-compose.yml
  - backend/.env
  - backend/.env.example
  - .gitignore
  - package.json
autonomous: true
requirements:
  - FOUND-01
  - FOUND-03

must_haves:
  truths:
    - "Running `cd backend && poetry install && poetry run pytest` passes all existing backend tests"
    - "Running `cd backend && poetry run alembic current` succeeds without import errors"
    - "Running `cd backend && poetry run task dev` starts uvicorn on port 8000"
    - "FastAPI responds to requests from http://localhost:3000 without CORS errors (Access-Control-Allow-Origin header present)"
  artifacts:
    - path: "backend/app/main.py"
      provides: "FastAPI application factory with CORSMiddleware"
      contains: "CORSMiddleware"
    - path: "backend/app/core/config.py"
      provides: "Settings with ALLOWED_ORIGINS"
      contains: "ALLOWED_ORIGINS"
    - path: "backend/pyproject.toml"
      provides: "Poetry project config"
      contains: 'packages = [{include = "app"}]'
    - path: "backend/alembic.ini"
      provides: "Alembic config"
      contains: "script_location"
    - path: "backend/docker-compose.yml"
      provides: "Postgres dev + test services"
    - path: "package.json"
      provides: "Root-level convenience scripts (concurrently)"
      contains: "concurrently"
    - path: ".gitignore"
      provides: "Updated ignore rules for monorepo + frontend"
      contains: "node_modules"
  key_links:
    - from: "backend/app/main.py"
      to: "backend/app/core/config.py"
      via: "get_settings().ALLOWED_ORIGINS feeds CORSMiddleware allow_origins"
      pattern: "allow_origins.*get_settings.*ALLOWED_ORIGINS"
---

<objective>
Restructure the existing flat Python repo into a monorepo with all backend code under `backend/` using `git mv` to preserve git history. Add CORSMiddleware to FastAPI for frontend origin access. Create a root-level `package.json` with `concurrently` for coordinated dev scripts.

Purpose: Establishes the monorepo directory structure that all subsequent v3.0 phases depend on. CORS is required before the frontend can communicate with the backend.
Output: `backend/` directory containing all existing Python code with passing tests, CORSMiddleware on FastAPI, root `package.json` with dev convenience scripts.
</objective>

<execution_context>
@C:/Users/Sushasan/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Sushasan/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/19-monorepo-frontend-foundation/19-RESEARCH.md

<interfaces>
<!-- Key existing code the executor needs. Extracted from codebase. -->

From app/main.py (lines 41-92):
```python
def create_app() -> FastAPI:
    application = FastAPI(
        title="Bookstore API",
        version="1.0.0",
        description="Bookstore e-commerce API — browse, purchase, and manage books.",
    )
    # Exception handlers...
    # SessionMiddleware
    application.add_middleware(
        SessionMiddleware,
        secret_key=get_settings().SECRET_KEY,
        max_age=600,
    )
    # OAuth...
    # Routers...
    return application

app = create_app()
```

From app/core/config.py (lines 12-47):
```python
class Settings(BaseSettings):
    # ...
    ALLOWED_ORIGINS: list[str] = ["http://localhost:3000"]
    # ...
    model_config = SettingsConfigDict(
        env_file=".env",
        env_file_encoding="utf-8",
        case_sensitive=False,
    )
```

From pyproject.toml:
```toml
packages = [{include = "app"}]
testpaths = ["tests"]
[tool.taskipy.tasks]
dev = "uvicorn app.main:app --reload --host 0.0.0.0 --port 8000"
```

From alembic.ini:
```ini
script_location = %(here)s/alembic
prepend_sys_path = .
```
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Move all backend code into backend/ directory using git mv</name>
  <files>
    backend/app/*
    backend/tests/*
    backend/alembic/*
    backend/alembic.ini
    backend/pyproject.toml
    backend/poetry.lock
    backend/docker-compose.yml
    backend/scripts/*
    backend/.env
    backend/.env.example
  </files>
  <action>
Move all existing Python backend code into a `backend/` subdirectory using `git mv` to preserve history. Execute from repo root:

```bash
mkdir -p backend
git mv app backend/app
git mv tests backend/tests
git mv alembic backend/alembic
git mv alembic.ini backend/alembic.ini
git mv pyproject.toml backend/pyproject.toml
git mv poetry.lock backend/poetry.lock
git mv docker-compose.yml backend/docker-compose.yml
git mv scripts backend/scripts
git mv .env backend/.env
git mv .env.example backend/.env.example
```

After the move, verify that all config paths still resolve correctly:

1. **pyproject.toml** — `packages = [{include = "app"}]` and `testpaths = ["tests"]` are relative to the file's location, so they remain correct after the move. No change needed.

2. **alembic.ini** — `script_location = %(here)s/alembic` uses `%(here)s` which resolves to the directory containing `alembic.ini`. After the move, `%(here)s` = `backend/`, so `%(here)s/alembic` = `backend/alembic` — correct. `prepend_sys_path = .` adds CWD to sys.path. When running `cd backend && poetry run alembic`, CWD is `backend/` where `app/` lives — correct.

3. **pyproject.toml model_config** — `env_file=".env"` resolves relative to CWD. After move, `.env` is at `backend/.env`. Running `cd backend && poetry run task dev` will find it. Correct.

4. **taskipy tasks** — `dev = "uvicorn app.main:app --reload --host 0.0.0.0 --port 8000"` is module-based, not path-based. As long as CWD has `app/` it works. From `backend/`, `app/` exists. Correct.

5. **Update `.gitignore`** at repo root to include Node.js/frontend patterns alongside existing Python patterns, and ensure `.env` rules cover both `backend/.env` and `frontend/.env*`:

```gitignore
# Python
__pycache__/
*.py[cod]
*.pyo
*.pyc
*.pyd
.venv/
venv/
env/
*.egg-info/
dist/
build/
*.egg
.mypy_cache/
.pytest_cache/
.ruff_cache/
.cache/
.coverage
htmlcov/

# Node.js / Frontend
node_modules/
.next/
out/
.turbo/

# Environment variables (never commit secrets)
.env
.env.local
.env.*.local
backend/.env

# IDE
.idea/
.vscode/
*.swp
*.swo

# Planning (internal)
.planning/
```

6. After all moves, run `cd backend && poetry install` to re-create the venv from the new location. Then run `cd backend && poetry run pytest` to verify all 306 tests pass.

Commit the restructure as a single atomic commit: `refactor(19-01): restructure repo into monorepo with backend/ directory`
  </action>
  <verify>
    <automated>cd backend && poetry install --no-interaction && poetry run pytest --tb=short -q</automated>
  </verify>
  <done>All backend files are under `backend/`, git history preserved (verify with `git log --follow backend/app/main.py`), all existing tests pass, alembic commands work from `backend/` directory.</done>
</task>

<task type="auto">
  <name>Task 2: Add CORSMiddleware to FastAPI and create root package.json</name>
  <files>
    backend/app/main.py
    package.json
  </files>
  <action>
**Part A — CORSMiddleware:**

Edit `backend/app/main.py` inside `create_app()`. Add `CORSMiddleware` as the LAST `add_middleware` call so it runs FIRST in the middleware stack (FastAPI middleware runs in reverse registration order). Add it AFTER the existing `SessionMiddleware` registration:

```python
from fastapi.middleware.cors import CORSMiddleware

# Inside create_app(), AFTER SessionMiddleware:
application.add_middleware(
    CORSMiddleware,
    allow_origins=get_settings().ALLOWED_ORIGINS,  # ["http://localhost:3000"]
    allow_credentials=True,
    allow_methods=["GET", "POST", "PUT", "DELETE", "PATCH", "OPTIONS"],
    allow_headers=["Authorization", "Content-Type"],
)
```

CRITICAL: Do NOT use `allow_origins=["*"]` with `allow_credentials=True` — browsers reject this combination. The existing `ALLOWED_ORIGINS` setting already has `["http://localhost:3000"]` which is the correct explicit origin.

Also update `ALLOWED_ORIGINS` default in `backend/app/core/config.py` to include both `localhost` and `127.0.0.1` variants (browsers treat them as different origins):

```python
ALLOWED_ORIGINS: list[str] = ["http://localhost:3000", "http://127.0.0.1:3000"]
```

**Part B — Root package.json:**

Create a minimal root `package.json` (no workspaces) with `concurrently` for coordinated dev scripts:

```json
{
  "name": "bookstore-monorepo",
  "private": true,
  "scripts": {
    "dev": "concurrently -n backend,frontend -c blue,green \"cd backend && poetry run task dev\" \"cd frontend && npm run dev\"",
    "dev:backend": "cd backend && poetry run task dev",
    "dev:frontend": "cd frontend && npm run dev"
  },
  "devDependencies": {
    "concurrently": "^9.1.0"
  }
}
```

Run `npm install` at repo root to install concurrently and generate `package-lock.json`. Add `node_modules/` to `.gitignore` (already handled in Task 1).

Commit: `feat(19-01): add CORSMiddleware to FastAPI and root package.json with concurrently`
  </action>
  <verify>
    <automated>cd backend && poetry run pytest tests/ --tb=short -q && cd .. && node -e "require('./node_modules/concurrently/package.json').version"</automated>
  </verify>
  <done>CORSMiddleware is registered in FastAPI's `create_app()` after SessionMiddleware, using explicit `ALLOWED_ORIGINS` (not wildcard). Root `package.json` exists with `concurrently` installed. `npm run dev:backend` can start the backend server. All backend tests still pass.</done>
</task>

</tasks>

<verification>
1. `cd backend && poetry run pytest` — all 306 existing tests pass
2. `cd backend && poetry run alembic current` — runs without import errors
3. `cd backend && poetry run task dev` — starts uvicorn on port 8000
4. `curl -s -I -H "Origin: http://localhost:3000" http://localhost:8000/health` returns `Access-Control-Allow-Origin: http://localhost:3000` header
5. `git log --follow backend/app/main.py` — shows full history before and after the move
6. `cat package.json` — root-level package.json exists with concurrently
</verification>

<success_criteria>
- All backend code lives under `backend/` with git history intact
- `cd backend && poetry run pytest` passes all tests (same count as before restructure)
- CORSMiddleware is active with explicit origin `http://localhost:3000` and `allow_credentials=True`
- Root `package.json` has `concurrently` installed and `dev:backend` script works
- `.gitignore` covers both Python and Node.js patterns
</success_criteria>

<output>
After completion, create `.planning/phases/19-monorepo-frontend-foundation/19-01-SUMMARY.md`
</output>
