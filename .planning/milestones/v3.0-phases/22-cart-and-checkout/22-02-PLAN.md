---
phase: 22-cart-and-checkout
plan: 02
type: execute
wave: 2
depends_on: ["22-01"]
files_modified:
  - frontend/src/app/books/[id]/_components/ActionButtons.tsx
  - frontend/src/app/books/[id]/page.tsx
  - frontend/src/app/catalog/_components/BookCard.tsx
autonomous: true
requirements: [SHOP-01, SHOP-10]

must_haves:
  truths:
    - "User can click 'Add to Cart' on the book detail page and see a success toast"
    - "User can click a cart icon on a catalog BookCard and see a success toast"
    - "If the book is already in cart, the toast says 'Already in cart' with a link to /cart"
    - "Adding to cart optimistically increments the Header cart badge"
    - "Out-of-stock books show a disabled 'Out of Stock' button instead of 'Add to Cart'"
  artifacts:
    - path: "frontend/src/app/books/[id]/_components/ActionButtons.tsx"
      provides: "Functional Add to Cart button on book detail page"
      contains: "'use client'"
    - path: "frontend/src/app/catalog/_components/BookCard.tsx"
      provides: "BookCard with cart icon button for add-to-cart"
      contains: "'use client'"
  key_links:
    - from: "frontend/src/app/books/[id]/_components/ActionButtons.tsx"
      to: "frontend/src/lib/cart.ts"
      via: "useCart().addItem mutation"
      pattern: "useCart|addItem"
    - from: "frontend/src/app/catalog/_components/BookCard.tsx"
      to: "frontend/src/lib/cart.ts"
      via: "useCart().addItem mutation"
      pattern: "useCart|addItem"
    - from: "frontend/src/app/books/[id]/page.tsx"
      to: "frontend/src/app/books/[id]/_components/ActionButtons.tsx"
      via: "Passes bookId and inStock props"
      pattern: "bookId.*inStock|ActionButtons"
---

<objective>
Wire the "Add to Cart" interaction on both the book detail page (ActionButtons) and the catalog grid (BookCard), converting both to client components and connecting them to the useCart hook.

Purpose: Users can add books to their cart from anywhere they see a book — the detail page and the catalog grid.
Output: Functional add-to-cart on ActionButtons.tsx and BookCard.tsx with optimistic badge updates and toast feedback.
</objective>

<execution_context>
@C:/Users/Sushasan/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Sushasan/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/22-cart-and-checkout/22-01-SUMMARY.md

<interfaces>
<!-- Key types and contracts from Plan 01 output -->

From frontend/src/lib/cart.ts (created in Plan 01):
```typescript
export const CART_KEY = ['cart'] as const

export function useCart(): {
  cartQuery: UseQueryResult<CartResponse>
  addItem: UseMutationResult<CartItemResponse, Error, { bookId: number }>
  updateItem: UseMutationResult<CartItemResponse, Error, { itemId: number; quantity: number }>
  removeItem: UseMutationResult<void, Error, number>
  checkoutMutation: UseMutationResult<OrderResponse, Error, void>
}
```

From frontend/src/app/books/[id]/_components/ActionButtons.tsx (current):
```typescript
interface ActionButtonsProps {
  inStock: boolean
}
export function ActionButtons({ inStock }: ActionButtonsProps)
// Currently: disabled buttons with "Coming soon" text
// No 'use client' directive — Server Component
```

From frontend/src/app/books/[id]/page.tsx (current):
```typescript
// Server Component — renders ActionButtons:
<ActionButtons inStock={book.in_stock} />
// Must pass bookId prop after this plan
```

From frontend/src/app/catalog/_components/BookCard.tsx (current):
```typescript
import type { BookResponse } from '@/lib/catalog'
export function BookCard({ book }: { book: BookResponse })
// Currently: pure Server Component, no 'use client'
// Wraps entire card in <Link href={`/books/${book.id}`}>
```
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Convert ActionButtons to client component with functional Add to Cart</name>
  <files>
    frontend/src/app/books/[id]/_components/ActionButtons.tsx
    frontend/src/app/books/[id]/page.tsx
  </files>
  <action>
**Step 1: Update `ActionButtons.tsx`**

Convert to a client component by adding `'use client'` at the top. Update props to accept `bookId: number` in addition to `inStock: boolean`.

Wire the "Add to Cart" button:
- Import `useCart` from `@/lib/cart` and `useSession` from `next-auth/react`
- Call `const { addItem } = useCart()`
- On click: call `addItem.mutate({ bookId })`
- Button states:
  - If `!inStock`: disabled, text = "Out of Stock"
  - If `addItem.isPending`: disabled, show loading spinner or "Adding..."
  - Otherwise: enabled, text = "Add to Cart"
- Keep the Wishlist button disabled (Phase 24 will enable it) — keep the `<Heart />` icon and "Add to Wishlist" text, still disabled
- Remove the "Coming soon" `<p>` tag entirely
- If user is not authenticated (`!session`), the "Add to Cart" button should link to `/login?callbackUrl=` + current path instead of calling addItem. Use `usePathname()` from `next/navigation` to get the current path. Alternatively, since /cart is protected and useCart returns empty when no session, just let the mutation fire — it will fail with a toast. Simpler: show a "Sign in to add" toast if `!session?.accessToken` on click, using `router.push('/login')`.

Recommended approach for unauthenticated state: Check `session?.accessToken` in the click handler. If missing, show `toast.error('Please sign in to add items to your cart')` and call `router.push('/login')`. This is simpler than conditional rendering and handles edge cases.

```typescript
'use client'

import { ShoppingCart, Heart } from 'lucide-react'
import { Button } from '@/components/ui/button'
import { useCart } from '@/lib/cart'
import { useSession } from 'next-auth/react'
import { useRouter } from 'next/navigation'
import { toast } from 'sonner'

interface ActionButtonsProps {
  bookId: number
  inStock: boolean
}

export function ActionButtons({ bookId, inStock }: ActionButtonsProps) {
  const { data: session } = useSession()
  const { addItem } = useCart()
  const router = useRouter()

  const handleAddToCart = () => {
    if (!session?.accessToken) {
      toast.error('Please sign in to add items to your cart')
      router.push('/login')
      return
    }
    addItem.mutate({ bookId })
  }

  return (
    <div className="mt-6">
      <div className="flex flex-wrap gap-4">
        <Button
          size="lg"
          variant="default"
          disabled={!inStock || addItem.isPending}
          onClick={handleAddToCart}
        >
          <ShoppingCart />
          {!inStock ? 'Out of Stock' : addItem.isPending ? 'Adding...' : 'Add to Cart'}
        </Button>
        <Button disabled size="lg" variant="outline">
          <Heart />
          Add to Wishlist
        </Button>
      </div>
    </div>
  )
}
```

**Step 2: Update `page.tsx` to pass `bookId`**

In `frontend/src/app/books/[id]/page.tsx`, change:
```tsx
<ActionButtons inStock={book.in_stock} />
```
To:
```tsx
<ActionButtons bookId={book.id} inStock={book.in_stock} />
```

No other changes to page.tsx needed.
  </action>
  <verify>
    <automated>cd D:/Python/claude-test/frontend && npx tsc --noEmit 2>&1 | head -30</automated>
  </verify>
  <done>
    - ActionButtons.tsx is a 'use client' component with useCart().addItem wired to the button
    - Out-of-stock shows disabled "Out of Stock"; in-stock shows "Add to Cart" with loading state
    - Unauthenticated users get a toast and redirect to /login
    - page.tsx passes bookId prop to ActionButtons
    - Wishlist button remains disabled (Phase 24)
    - "Coming soon" text is removed
  </done>
</task>

<task type="auto">
  <name>Task 2: Add cart icon to BookCard on catalog grid</name>
  <files>
    frontend/src/app/catalog/_components/BookCard.tsx
  </files>
  <action>
Convert `BookCard.tsx` to a client component by adding `'use client'` at the top.

Add a small cart icon button that appears on hover (desktop) and is always visible (mobile) per the locked CONTEXT.md decision.

Key changes:
1. Add `'use client'` directive
2. Import `useCart` from `@/lib/cart`, `useSession` from `next-auth/react`, `useRouter` from `next/navigation`, `toast` from `sonner`, `ShoppingCart` from `lucide-react`, `Button` from `@/components/ui/button`
3. The card currently wraps everything in a `<Link>` — restructure so the cart button is OUTSIDE the Link (otherwise clicking the cart icon navigates to the book detail page). Use a wrapper `<div>` with the card styling, put the `<Link>` around the cover + info, and position the cart button absolutely.

Restructured layout:
```tsx
'use client'

import Image from 'next/image'
import Link from 'next/link'
import { ShoppingCart } from 'lucide-react'
import { Badge } from '@/components/ui/badge'
import { Button } from '@/components/ui/button'
import { useCart } from '@/lib/cart'
import { useSession } from 'next-auth/react'
import { useRouter } from 'next/navigation'
import { toast } from 'sonner'
import type { BookResponse } from '@/lib/catalog'

export function BookCard({ book }: { book: BookResponse }) {
  const { data: session } = useSession()
  const { addItem } = useCart()
  const router = useRouter()
  const price = parseFloat(book.price).toFixed(2)
  const inStock = book.stock_quantity > 0

  const handleAddToCart = (e: React.MouseEvent) => {
    e.preventDefault()  // Prevent Link navigation
    e.stopPropagation()
    if (!session?.accessToken) {
      toast.error('Please sign in to add items to your cart')
      router.push('/login')
      return
    }
    addItem.mutate({ bookId: book.id })
  }

  return (
    <div className="group relative flex flex-col rounded-lg overflow-hidden border hover:shadow-md transition-shadow">
      <Link href={`/books/${book.id}`} className="flex flex-col flex-1">
        {/* Cover area */}
        <div className="relative aspect-[2/3] w-full">
          {book.cover_image_url ? (
            <Image ... />
          ) : (
            <CoverPlaceholder book={book} />
          )}
        </div>

        {/* Book info */}
        <div className="flex flex-col gap-1 p-3">
          <p className="font-medium text-sm line-clamp-1">{book.title}</p>
          <p className="text-xs text-muted-foreground line-clamp-1">{book.author}</p>
          <p className="text-sm font-semibold">${price}</p>
          <div>
            {inStock ? <Badge ...>In Stock</Badge> : <Badge ...>Out of Stock</Badge>}
          </div>
        </div>
      </Link>

      {/* Cart icon button — visible on hover (desktop) / always visible (mobile) */}
      {inStock && (
        <Button
          variant="secondary"
          size="icon"
          className="absolute top-2 right-2 h-8 w-8 opacity-100 md:opacity-0 md:group-hover:opacity-100 transition-opacity shadow-sm"
          onClick={handleAddToCart}
          disabled={addItem.isPending}
          aria-label={`Add ${book.title} to cart`}
        >
          <ShoppingCart className="h-4 w-4" />
        </Button>
      )}
    </div>
  )
}
```

Key details:
- Use `e.preventDefault()` and `e.stopPropagation()` on the cart button click to prevent the parent Link from navigating
- Cart icon: visible always on mobile, `opacity-0 group-hover:opacity-100` on md+ breakpoint
- Only show cart icon when `inStock` is true
- Keep the `CoverPlaceholder` component and all existing styling (colors, badges) identical
- The `group` class on the wrapper div enables the `group-hover:opacity-100` on the button
  </action>
  <verify>
    <automated>cd D:/Python/claude-test/frontend && npx tsc --noEmit 2>&1 | head -30</automated>
  </verify>
  <done>
    - BookCard.tsx is a 'use client' component
    - Cart icon button appears on hover (desktop) and always visible (mobile) for in-stock books
    - Clicking cart icon adds to cart with optimistic badge update and toast feedback
    - Clicking the rest of the card still navigates to book detail page
    - Out-of-stock books have no cart icon
    - Unauthenticated users get a toast and redirect to /login
  </done>
</task>

</tasks>

<verification>
1. `cd frontend && npx tsc --noEmit` passes
2. `cd frontend && npm run build` completes without errors
3. Book detail page "Add to Cart" button triggers addItem mutation with toast feedback
4. Catalog BookCard shows cart icon on hover (desktop) with add-to-cart functionality
5. Cart badge in Header updates after adding an item
</verification>

<success_criteria>
- Users can add books to cart from both book detail page and catalog grid
- Add-to-cart shows success toast or "Already in cart" toast with correct messaging
- Cart badge increments optimistically on add
- Out-of-stock books show disabled state (no cart icon on BookCard, disabled button on detail page)
- Unauthenticated users are redirected to login
</success_criteria>

<output>
After completion, create `.planning/phases/22-cart-and-checkout/22-02-SUMMARY.md`
</output>
