---
phase: 22-cart-and-checkout
plan: 04
type: execute
wave: 3
depends_on: ["22-03"]
files_modified:
  - frontend/src/app/cart/_components/CheckoutDialog.tsx
  - frontend/src/app/cart/_components/CartPageContent.tsx
  - frontend/src/app/orders/[id]/page.tsx
  - frontend/src/app/orders/[id]/_components/OrderDetail.tsx
autonomous: true
requirements: [SHOP-05, SHOP-06]

must_haves:
  truths:
    - "User clicks Checkout and sees a confirmation dialog asking 'Place order for $X.XX?'"
    - "Confirming the dialog places the order and redirects to /orders/{id}?confirmed=true"
    - "Order confirmation page shows success banner, order number, date, items, and total"
    - "Order confirmation page has 'Continue Shopping' and 'View All Orders' CTAs"
    - "Checkout errors (409 insufficient stock, 402 payment failed, 422 empty cart) show specific toasts"
  artifacts:
    - path: "frontend/src/app/cart/_components/CheckoutDialog.tsx"
      provides: "Confirmation dialog for checkout with loading state"
      contains: "Dialog"
    - path: "frontend/src/app/orders/[id]/page.tsx"
      provides: "Order detail / confirmation page (server component)"
      min_lines: 15
    - path: "frontend/src/app/orders/[id]/_components/OrderDetail.tsx"
      provides: "Client component rendering order details with optional confirmation banner"
      min_lines: 30
  key_links:
    - from: "frontend/src/app/cart/_components/CheckoutDialog.tsx"
      to: "frontend/src/lib/cart.ts"
      via: "checkoutMutation from useCart"
      pattern: "checkoutMutation|useCart"
    - from: "frontend/src/app/cart/_components/CartPageContent.tsx"
      to: "frontend/src/app/cart/_components/CheckoutDialog.tsx"
      via: "CheckoutDialog rendered with open state"
      pattern: "<CheckoutDialog"
    - from: "frontend/src/app/orders/[id]/page.tsx"
      to: "frontend/src/lib/cart.ts"
      via: "fetchOrder server-side call"
      pattern: "fetchOrder"
---

<objective>
Build the checkout confirmation dialog and order confirmation page, completing the purchase flow from cart to order.

Purpose: Users can place an order from their cart via a confirmation dialog and land on a confirmation page showing their order details.
Output: CheckoutDialog component, updated CartPageContent to use it, /orders/[id] page with order details and confirmation banner.
</objective>

<execution_context>
@C:/Users/Sushasan/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Sushasan/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/22-cart-and-checkout/22-01-SUMMARY.md
@.planning/phases/22-cart-and-checkout/22-03-SUMMARY.md

<interfaces>
<!-- Key contracts from prior plans -->

From frontend/src/lib/cart.ts (Plan 01):
```typescript
export function useCart(): {
  cartQuery: UseQueryResult<CartResponse>
  checkoutMutation: UseMutationResult<OrderResponse, Error, void>
  // ... other mutations
}

export async function fetchOrder(accessToken: string, orderId: number): Promise<OrderResponse>
```

From frontend/src/types/api.generated.ts:
```typescript
type OrderResponse = {
  id: number
  status: string       // "CONFIRMED"
  created_at: string   // ISO datetime string
  items: OrderItemResponse[]
  readonly total_price: string
}

type OrderItemResponse = {
  id: number
  book_id: number | null
  quantity: number
  unit_price: string
  book: { id: number; title: string; author: string } | null
}
```

From frontend/src/auth.ts:
```typescript
// auth() returns session with accessToken
import { auth } from '@/auth'
// session.accessToken is the FastAPI JWT
```

From frontend/src/components/ui/dialog.tsx (installed in Plan 01):
```typescript
import {
  Dialog, DialogContent, DialogDescription,
  DialogFooter, DialogHeader, DialogTitle,
} from '@/components/ui/dialog'
```

From frontend/src/app/cart/_components/CartPageContent.tsx (Plan 03):
```typescript
// Currently calls checkoutMutation.mutate() directly from CartSummary onCheckout
// This plan wraps that in a CheckoutDialog
```

From frontend/src/app/cart/_components/CartSummary.tsx (Plan 03):
```typescript
interface CartSummaryProps {
  totalItems: number
  totalPrice: string
  onCheckout: () => void
  isCheckingOut: boolean
}
```
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create CheckoutDialog and wire into CartPageContent</name>
  <files>
    frontend/src/app/cart/_components/CheckoutDialog.tsx
    frontend/src/app/cart/_components/CartPageContent.tsx
  </files>
  <action>
**Step 1: Create `frontend/src/app/cart/_components/CheckoutDialog.tsx`**

A confirmation dialog per the locked CONTEXT.md decision: "On checkout click: confirm dialog ('Place order for $X.XX?') -> loading state -> redirect to confirmation":

```typescript
import {
  Dialog,
  DialogContent,
  DialogDescription,
  DialogFooter,
  DialogHeader,
  DialogTitle,
} from '@/components/ui/dialog'
import { Button } from '@/components/ui/button'

interface CheckoutDialogProps {
  open: boolean
  onOpenChange: (open: boolean) => void
  totalPrice: string
  onConfirm: () => void
  isPending: boolean
}

export function CheckoutDialog({
  open,
  onOpenChange,
  totalPrice,
  onConfirm,
  isPending,
}: CheckoutDialogProps) {
  return (
    <Dialog open={open} onOpenChange={onOpenChange}>
      <DialogContent>
        <DialogHeader>
          <DialogTitle>Place Order</DialogTitle>
          <DialogDescription>
            Confirm your order for ${totalPrice}?
          </DialogDescription>
        </DialogHeader>
        <DialogFooter>
          <Button
            variant="outline"
            onClick={() => onOpenChange(false)}
            disabled={isPending}
          >
            Cancel
          </Button>
          <Button onClick={onConfirm} disabled={isPending}>
            {isPending ? 'Placing Order...' : 'Place Order'}
          </Button>
        </DialogFooter>
      </DialogContent>
    </Dialog>
  )
}
```

**Step 2: Update `CartPageContent.tsx` to use CheckoutDialog**

Add state for dialog open/close. Change the checkout flow:

1. Add `const [checkoutOpen, setCheckoutOpen] = useState(false)` state
2. Change `CartSummary`'s `onCheckout` to `() => setCheckoutOpen(true)` (opens dialog instead of direct mutation)
3. Render `<CheckoutDialog>` below CartSummary with:
   - `open={checkoutOpen}`
   - `onOpenChange={setCheckoutOpen}`
   - `totalPrice={cart.total_price}`
   - `onConfirm={() => checkoutMutation.mutate()}` — the mutation's onSuccess in useCart already handles redirect to /orders/[id]?confirmed=true and cache clearing
   - `isPending={checkoutMutation.isPending}`
4. When `checkoutMutation.isSuccess` fires (handled in useCart's onSuccess), the router.push redirect will unmount the dialog automatically

Also add an effect to close the dialog if the mutation succeeds:
```typescript
useEffect(() => {
  if (checkoutMutation.isSuccess) {
    setCheckoutOpen(false)
  }
}, [checkoutMutation.isSuccess])
```

The error handling (409/402/422 toasts) is already in the useCart hook from Plan 01 — the dialog just needs to close on error too so the user can see the toast:
```typescript
useEffect(() => {
  if (checkoutMutation.isError) {
    setCheckoutOpen(false)
  }
}, [checkoutMutation.isError])
```
  </action>
  <verify>
    <automated>cd D:/Python/claude-test/frontend && npx tsc --noEmit 2>&1 | head -30</automated>
  </verify>
  <done>
    - CheckoutDialog shows "Place order for $X.XX?" with Cancel and Place Order buttons
    - Place Order button shows "Placing Order..." loading state during mutation
    - Dialog closes on success (router redirects) and on error (user sees toast)
    - CartPageContent opens dialog instead of direct checkout mutation
  </done>
</task>

<task type="auto">
  <name>Task 2: Create order confirmation/detail page at /orders/[id]</name>
  <files>
    frontend/src/app/orders/[id]/page.tsx
    frontend/src/app/orders/[id]/_components/OrderDetail.tsx
  </files>
  <action>
**Step 1: Create `frontend/src/app/orders/[id]/page.tsx`**

A server component that fetches the order using `auth()` for the access token. The route is already protected by proxy.ts (`/orders` is in `protectedPrefixes`).

Per the locked CONTEXT.md decision:
- Route: /orders/[id] — serves as both confirmation (from checkout) and order detail (from history)
- Shows: order number, date, item list with titles/quantities/prices, order total
- Success banner when `?confirmed=true` is present
- CTAs: "Continue Shopping" -> /catalog, "View All Orders" -> /orders

```typescript
import { auth } from '@/auth'
import { redirect } from 'next/navigation'
import { fetchOrder } from '@/lib/cart'
import { OrderDetail } from './_components/OrderDetail'

export const metadata = {
  title: 'Order Details',
}

export default async function OrderDetailPage({
  params,
  searchParams,
}: {
  params: Promise<{ id: string }>
  searchParams: Promise<{ confirmed?: string }>
}) {
  const session = await auth()
  if (!session?.accessToken) redirect('/login')

  const { id } = await params
  const { confirmed } = await searchParams

  let order
  try {
    order = await fetchOrder(session.accessToken, Number(id))
  } catch {
    // Order not found or forbidden — redirect to catalog
    redirect('/catalog')
  }

  return (
    <div className="mx-auto max-w-3xl px-4 py-8">
      <OrderDetail order={order} isConfirmed={confirmed === 'true'} />
    </div>
  )
}
```

Note: `fetchOrder` needs to work server-side. Since `fetchOrder` is a plain async function using `apiFetch` (which uses `fetch`), it works in both client and server environments. The `accessToken` is passed explicitly, so no session hook dependency.

**Step 2: Create `frontend/src/app/orders/[id]/_components/OrderDetail.tsx`**

A client component (needs Suspense boundary for search params if needed, but since we pass `isConfirmed` as a prop from the server, it can be a simple component — however, making it a client component allows for interactive CTAs and future enhancements):

Actually, this can be a simple server component since all data is passed as props. But for consistency with project patterns and to allow for future client-side interactions, make it a regular component (no 'use client' needed since it receives all data as props and only renders):

```typescript
import Link from 'next/link'
import { CheckCircle } from 'lucide-react'
import { Button } from '@/components/ui/button'
import { Separator } from '@/components/ui/separator'
import type { components } from '@/types/api.generated'

type OrderResponse = components['schemas']['OrderResponse']

interface OrderDetailProps {
  order: OrderResponse
  isConfirmed: boolean
}

export function OrderDetail({ order, isConfirmed }: OrderDetailProps) {
  const orderDate = new Date(order.created_at).toLocaleDateString(undefined, {
    year: 'numeric', month: 'long', day: 'numeric',
  })

  return (
    <div className="space-y-6">
      {/* Success banner — shown when arriving from checkout */}
      {isConfirmed && (
        <div className="flex items-center gap-3 rounded-lg border border-green-200 bg-green-50 dark:border-green-800 dark:bg-green-950 p-4">
          <CheckCircle className="h-6 w-6 text-green-600 dark:text-green-400 shrink-0" />
          <div>
            <p className="font-semibold text-green-800 dark:text-green-200">Order Confirmed!</p>
            <p className="text-sm text-green-700 dark:text-green-300">
              Your order has been placed successfully.
            </p>
          </div>
        </div>
      )}

      {/* Order header */}
      <div>
        <h1 className="text-2xl font-bold">Order #{order.id}</h1>
        <p className="text-muted-foreground text-sm mt-1">
          Placed on {orderDate} · Status: {order.status}
        </p>
      </div>

      <Separator />

      {/* Order items */}
      <div className="space-y-4">
        <h2 className="font-semibold">Items</h2>
        {order.items.map((item) => (
          <div key={item.id} className="flex justify-between items-center py-2">
            <div>
              <p className="font-medium text-sm">
                {item.book ? item.book.title : 'Deleted Book'}
              </p>
              {item.book && (
                <p className="text-xs text-muted-foreground">{item.book.author}</p>
              )}
              <p className="text-xs text-muted-foreground">
                Qty: {item.quantity} x ${parseFloat(item.unit_price).toFixed(2)}
              </p>
            </div>
            <p className="font-medium text-sm">
              ${(parseFloat(item.unit_price) * item.quantity).toFixed(2)}
            </p>
          </div>
        ))}
      </div>

      <Separator />

      {/* Order total */}
      <div className="flex justify-between font-semibold text-lg">
        <span>Total</span>
        <span>${order.total_price}</span>
      </div>

      <Separator />

      {/* CTAs */}
      <div className="flex flex-wrap gap-4">
        <Link href="/catalog">
          <Button>Continue Shopping</Button>
        </Link>
        <Link href="/orders">
          <Button variant="outline">View All Orders</Button>
        </Link>
      </div>
    </div>
  )
}
```

Note: The "View All Orders" link goes to /orders which doesn't exist yet (Phase 23). That's fine — it will be a dead link until Phase 23 implements order history. The route protection in proxy.ts already covers /orders.
  </action>
  <verify>
    <automated>cd D:/Python/claude-test/frontend && npx tsc --noEmit 2>&1 | head -30</automated>
  </verify>
  <done>
    - /orders/[id] page fetches order server-side with auth session token
    - OrderDetail shows order number, date, status, item list with prices, and total
    - Success banner appears when ?confirmed=true is in the URL
    - "Continue Shopping" links to /catalog, "View All Orders" links to /orders
    - Handles order not found by redirecting to /catalog
  </done>
</task>

</tasks>

<verification>
1. `cd frontend && npx tsc --noEmit` passes
2. `cd frontend && npm run build` completes without errors
3. Cart page Checkout button opens confirmation dialog with correct total
4. Confirming dialog places order and redirects to /orders/[id]?confirmed=true
5. Order confirmation page shows green success banner, order details, and CTAs
6. Canceling dialog closes it without action
7. Checkout errors (409/402/422) close dialog and show appropriate toasts
</verification>

<success_criteria>
- Checkout flow: Cart -> Confirm Dialog -> Place Order -> Redirect to /orders/[id]?confirmed=true
- Confirmation dialog shows total and has Cancel/Place Order buttons with loading state
- Order page displays order number, date, items with prices, and total
- Success banner visible only when arriving from checkout (?confirmed=true)
- Error states handled with specific toast messages
</success_criteria>

<output>
After completion, create `.planning/phases/22-cart-and-checkout/22-04-SUMMARY.md`
</output>
