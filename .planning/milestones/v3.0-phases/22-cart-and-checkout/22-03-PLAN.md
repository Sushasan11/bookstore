---
phase: 22-cart-and-checkout
plan: 03
type: execute
wave: 2
depends_on: ["22-01"]
files_modified:
  - frontend/src/app/cart/page.tsx
  - frontend/src/app/cart/loading.tsx
  - frontend/src/app/cart/_components/CartPageContent.tsx
  - frontend/src/app/cart/_components/CartItem.tsx
  - frontend/src/app/cart/_components/QuantityStepper.tsx
  - frontend/src/app/cart/_components/CartSummary.tsx
autonomous: true
requirements: [SHOP-02, SHOP-03, SHOP-04, SHOP-10]

must_haves:
  truths:
    - "User can view their cart with all items, quantities, and correct total"
    - "User can increase or decrease item quantity using inline stepper controls"
    - "User can remove an item from the cart"
    - "Cart shows empty state with 'Your cart is empty' and 'Browse Books' CTA when no items"
    - "Updating quantity optimistically changes the displayed total immediately"
    - "Removing an item optimistically removes it from the list with rollback on error"
  artifacts:
    - path: "frontend/src/app/cart/page.tsx"
      provides: "Cart page server shell"
      min_lines: 5
    - path: "frontend/src/app/cart/loading.tsx"
      provides: "Cart loading skeleton"
      min_lines: 5
    - path: "frontend/src/app/cart/_components/CartPageContent.tsx"
      provides: "Client component that fetches cart and renders items + summary"
      contains: "'use client'"
    - path: "frontend/src/app/cart/_components/CartItem.tsx"
      provides: "Single cart item row with cover, title, author, price, quantity stepper, remove button"
      min_lines: 20
    - path: "frontend/src/app/cart/_components/QuantityStepper.tsx"
      provides: "Inline quantity control: minus / number / plus"
      min_lines: 15
    - path: "frontend/src/app/cart/_components/CartSummary.tsx"
      provides: "Sticky sidebar (desktop) / fixed bottom bar (mobile) with totals and checkout button"
      min_lines: 20
  key_links:
    - from: "frontend/src/app/cart/_components/CartPageContent.tsx"
      to: "frontend/src/lib/cart.ts"
      via: "useCart() hook for data + mutations"
      pattern: "useCart"
    - from: "frontend/src/app/cart/_components/CartItem.tsx"
      to: "frontend/src/app/cart/_components/QuantityStepper.tsx"
      via: "QuantityStepper rendered inside CartItem"
      pattern: "<QuantityStepper"
    - from: "frontend/src/app/cart/_components/CartPageContent.tsx"
      to: "frontend/src/app/cart/_components/CartSummary.tsx"
      via: "CartSummary receives cart data and checkout handler"
      pattern: "<CartSummary"
---

<objective>
Build the cart page UI with item list, quantity controls, remove functionality, order summary sidebar, and empty state.

Purpose: Users can view and manage their shopping cart — see all items, adjust quantities, remove items, and see the correct running total.
Output: Complete /cart page with CartPageContent, CartItem, QuantityStepper, CartSummary, loading skeleton, and empty state.
</objective>

<execution_context>
@C:/Users/Sushasan/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Sushasan/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/22-cart-and-checkout/22-01-SUMMARY.md

<interfaces>
<!-- Key contracts from Plan 01 -->

From frontend/src/lib/cart.ts (created in Plan 01):
```typescript
export const CART_KEY = ['cart'] as const

export function useCart(): {
  cartQuery: UseQueryResult<CartResponse>
  addItem: UseMutationResult<CartItemResponse, Error, { bookId: number }>
  updateItem: UseMutationResult<CartItemResponse, Error, { itemId: number; quantity: number }>
  removeItem: UseMutationResult<void, Error, number>
  checkoutMutation: UseMutationResult<OrderResponse, Error, void>
}
```

From frontend/src/types/api.generated.ts:
```typescript
type CartResponse = {
  items: CartItemResponse[]
  readonly total_items: number
  readonly total_price: string  // e.g. "49.98"
}

type CartItemResponse = {
  id: number
  book_id: number
  quantity: number
  book: {
    id: number; title: string; author: string;
    price: string; cover_image_url: string | null
  }
}
```

From frontend/src/components/ui/ (available):
- button, card, skeleton, badge, separator (installed in Plan 01)

Existing patterns:
- Catalog page uses server shell + client content
- Skeleton loading follows existing patterns in frontend/src/app/catalog/loading.tsx
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create cart page shell, loading state, and CartPageContent</name>
  <files>
    frontend/src/app/cart/page.tsx
    frontend/src/app/cart/loading.tsx
    frontend/src/app/cart/_components/CartPageContent.tsx
  </files>
  <action>
**Step 1: Create `frontend/src/app/cart/page.tsx`**

A thin server shell that renders the client component. Cart data is fetched client-side (personalized, dynamic, not ISR-appropriate):

```typescript
import { CartPageContent } from './_components/CartPageContent'

export const metadata = {
  title: 'Shopping Cart',
}

export default function CartPage() {
  return (
    <div className="mx-auto max-w-7xl px-4 py-8">
      <h1 className="text-2xl font-bold mb-6">Shopping Cart</h1>
      <CartPageContent />
    </div>
  )
}
```

**Step 2: Create `frontend/src/app/cart/loading.tsx`**

Skeleton loading state matching the cart layout — use shadcn Skeleton component:

```typescript
import { Skeleton } from '@/components/ui/skeleton'

export default function CartLoading() {
  return (
    <div className="mx-auto max-w-7xl px-4 py-8">
      <Skeleton className="h-8 w-48 mb-6" />
      <div className="lg:flex lg:gap-8">
        <div className="flex-1 space-y-4">
          {[1, 2, 3].map((i) => (
            <div key={i} className="flex gap-4 p-4 border rounded-lg">
              <Skeleton className="h-24 w-16 rounded" />
              <div className="flex-1 space-y-2">
                <Skeleton className="h-5 w-3/4" />
                <Skeleton className="h-4 w-1/2" />
                <Skeleton className="h-4 w-20" />
              </div>
            </div>
          ))}
        </div>
        <Skeleton className="h-48 w-full lg:w-80 mt-6 lg:mt-0 rounded-lg" />
      </div>
    </div>
  )
}
```

**Step 3: Create `frontend/src/app/cart/_components/CartPageContent.tsx`**

A `'use client'` component that is the main cart orchestrator:

- Import `useCart` from `@/lib/cart`
- Destructure `{ cartQuery, updateItem, removeItem, checkoutMutation }` from `useCart()`
- Loading state: Show skeleton (reuse similar pattern to loading.tsx but inline, since the page shell already rendered the `<h1>`)
- Empty state: When `cartQuery.data?.items.length === 0`, show an empty cart illustration (use a `ShoppingCart` lucide icon at large size as the "illustration") + "Your cart is empty" heading + "Browse Books" button linking to /catalog
- Non-empty state: Two-column layout on lg (items list left, summary right):
  - Left: `<div className="flex-1 space-y-4">` mapping cart items to `<CartItem>` components
  - Right: `<CartSummary>` component

Pass to each `<CartItem>`:
- `item` (CartItemResponse)
- `onUpdateQuantity: (itemId: number, quantity: number) => void` — calls `updateItem.mutate({ itemId, quantity })`
- `onRemove: (itemId: number) => void` — calls `removeItem.mutate(itemId)`

Pass to `<CartSummary>`:
- `totalItems: cart.total_items`
- `totalPrice: cart.total_price`
- `onCheckout: () => void` — calls `checkoutMutation.mutate()`
- `isCheckingOut: checkoutMutation.isPending`

Error state: If `cartQuery.isError`, show a simple error message with a retry button calling `cartQuery.refetch()`.
  </action>
  <verify>
    <automated>cd D:/Python/claude-test/frontend && npx tsc --noEmit 2>&1 | head -30</automated>
  </verify>
  <done>
    - Cart page server shell renders title and CartPageContent
    - Loading skeleton shows 3 placeholder cart items + sidebar
    - CartPageContent fetches cart via useCart, shows loading/empty/error/populated states
    - Empty state has ShoppingCart icon + "Your cart is empty" + "Browse Books" CTA
    - Non-empty state renders CartItem list + CartSummary in two-column layout
  </done>
</task>

<task type="auto">
  <name>Task 2: Create CartItem, QuantityStepper, and CartSummary components</name>
  <files>
    frontend/src/app/cart/_components/CartItem.tsx
    frontend/src/app/cart/_components/QuantityStepper.tsx
    frontend/src/app/cart/_components/CartSummary.tsx
  </files>
  <action>
**Step 1: Create `frontend/src/app/cart/_components/QuantityStepper.tsx`**

Inline stepper control with minus / number display / plus buttons per the locked CONTEXT.md decision:

```typescript
import { Minus, Plus } from 'lucide-react'
import { Button } from '@/components/ui/button'

interface QuantityStepperProps {
  quantity: number
  onUpdate: (newQuantity: number) => void
  disabled?: boolean
}

export function QuantityStepper({ quantity, onUpdate, disabled }: QuantityStepperProps) {
  return (
    <div className="flex items-center gap-1">
      <Button
        variant="outline"
        size="icon"
        className="h-8 w-8"
        disabled={disabled || quantity <= 1}  // min 1, disable minus at 1
        onClick={() => onUpdate(Math.max(1, quantity - 1))}
        aria-label="Decrease quantity"
      >
        <Minus className="h-3 w-3" />
      </Button>
      <span className="w-8 text-center text-sm font-medium">{quantity}</span>
      <Button
        variant="outline"
        size="icon"
        className="h-8 w-8"
        disabled={disabled}
        onClick={() => onUpdate(quantity + 1)}
        aria-label="Increase quantity"
      >
        <Plus className="h-3 w-3" />
      </Button>
    </div>
  )
}
```

**Step 2: Create `frontend/src/app/cart/_components/CartItem.tsx`**

Each cart item row showing cover thumbnail, title, author, unit price, quantity control, line total, and remove button per the locked CONTEXT.md decision:

```typescript
import Image from 'next/image'
import Link from 'next/link'
import { Trash2 } from 'lucide-react'
import { Button } from '@/components/ui/button'
import { Separator } from '@/components/ui/separator'
import { QuantityStepper } from './QuantityStepper'
import type { components } from '@/types/api.generated'

type CartItemResponse = components['schemas']['CartItemResponse']

interface CartItemProps {
  item: CartItemResponse
  onUpdateQuantity: (itemId: number, quantity: number) => void
  onRemove: (itemId: number) => void
}

export function CartItem({ item, onUpdateQuantity, onRemove }: CartItemProps) {
  const unitPrice = parseFloat(item.book.price)
  const lineTotal = (unitPrice * item.quantity).toFixed(2)

  return (
    <div className="flex gap-4 p-4 border rounded-lg">
      {/* Cover thumbnail — link to book detail */}
      <Link href={`/books/${item.book_id}`} className="shrink-0">
        {item.book.cover_image_url ? (
          <Image
            src={item.book.cover_image_url}
            alt={item.book.title}
            width={64}
            height={96}
            className="rounded object-cover"
          />
        ) : (
          <div className="w-16 h-24 rounded bg-muted flex items-center justify-center text-xs text-muted-foreground">
            No cover
          </div>
        )}
      </Link>

      {/* Item details */}
      <div className="flex-1 min-w-0">
        <Link href={`/books/${item.book_id}`} className="hover:underline">
          <p className="font-medium text-sm line-clamp-1">{item.book.title}</p>
        </Link>
        <p className="text-xs text-muted-foreground">{item.book.author}</p>
        <p className="text-sm text-muted-foreground mt-1">${unitPrice.toFixed(2)} each</p>

        <div className="flex items-center justify-between mt-3">
          <QuantityStepper
            quantity={item.quantity}
            onUpdate={(qty) => onUpdateQuantity(item.id, qty)}
          />
          <div className="flex items-center gap-4">
            <p className="font-semibold text-sm">${lineTotal}</p>
            <Button
              variant="ghost"
              size="icon"
              className="h-8 w-8 text-muted-foreground hover:text-destructive"
              onClick={() => onRemove(item.id)}
              aria-label={`Remove ${item.book.title} from cart`}
            >
              <Trash2 className="h-4 w-4" />
            </Button>
          </div>
        </div>
      </div>
    </div>
  )
}
```

**Step 3: Create `frontend/src/app/cart/_components/CartSummary.tsx`**

Per the locked CONTEXT.md decision, this component has two distinct presentations:
- **Desktop (lg+):** Sticky sidebar with items count, subtotal, total, and checkout button
- **Mobile (<lg):** A fixed bottom bar pinned to viewport bottom showing total + "Checkout" button, plus a normal-flow detailed summary section above it (hidden behind the bar via bottom padding on the page)

The component renders TWO elements:
1. A **detailed summary card** (visible on all viewports, sticky on desktop)
2. A **mobile fixed bottom bar** (visible only below lg breakpoint) — simplified strip with total price + Checkout button

The CartPageContent parent must add `pb-20 lg:pb-0` to its outermost container to prevent the fixed bar from obscuring content on mobile.

```typescript
import { Button } from '@/components/ui/button'
import { Separator } from '@/components/ui/separator'

interface CartSummaryProps {
  totalItems: number
  totalPrice: string
  onCheckout: () => void
  isCheckingOut: boolean
}

export function CartSummary({ totalItems, totalPrice, onCheckout, isCheckingOut }: CartSummaryProps) {
  return (
    <>
      {/* Full summary card — sticky sidebar on desktop, normal flow on mobile */}
      <div className="lg:sticky lg:top-24 rounded-lg border p-6 space-y-4 h-fit">
        <h2 className="font-semibold text-lg">Order Summary</h2>
        <Separator />
        <div className="flex justify-between text-sm">
          <span className="text-muted-foreground">Items ({totalItems})</span>
          <span>${totalPrice}</span>
        </div>
        <Separator />
        <div className="flex justify-between font-semibold">
          <span>Total</span>
          <span>${totalPrice}</span>
        </div>
        {/* Desktop checkout button (hidden on mobile since the fixed bar has one) */}
        <Button
          className="w-full hidden lg:flex"
          size="lg"
          onClick={onCheckout}
          disabled={isCheckingOut}
        >
          {isCheckingOut ? 'Placing Order...' : 'Checkout'}
        </Button>
      </div>

      {/* Mobile fixed bottom bar — visible only below lg breakpoint */}
      <div className="fixed bottom-0 left-0 right-0 z-40 border-t bg-background p-4 flex items-center justify-between lg:hidden">
        <div className="font-semibold">
          Total: <span>${totalPrice}</span>
        </div>
        <Button
          size="lg"
          onClick={onCheckout}
          disabled={isCheckingOut}
        >
          {isCheckingOut ? 'Placing Order...' : 'Checkout'}
        </Button>
      </div>
    </>
  )
}
```

The CartSummary `onCheckout` will open the CheckoutDialog in Plan 04. For now, wire it to call `checkoutMutation.mutate()` directly from CartPageContent. Plan 04 will wrap this in a confirmation dialog.

Layout in CartPageContent — note `pb-20 lg:pb-0` on the outer container to prevent the mobile fixed bottom bar from obscuring cart items:
```tsx
<div className="lg:flex lg:gap-8 pb-20 lg:pb-0">
  <div className="flex-1 space-y-4">
    {cart.items.map((item) => <CartItem key={item.id} ... />)}
  </div>
  <div className="w-full lg:w-80 mt-6 lg:mt-0">
    <CartSummary ... />
  </div>
</div>
```
  </action>
  <verify>
    <automated>cd D:/Python/claude-test/frontend && npx tsc --noEmit 2>&1 | head -30</automated>
  </verify>
  <done>
    - CartItem shows cover thumbnail, title, author, unit price, QuantityStepper, line total, and remove button
    - QuantityStepper has minus/plus buttons with min=1 enforcement (minus disabled at 1)
    - CartSummary shows items count, subtotal, total, and Checkout button in a sticky sidebar on desktop
    - CartSummary renders a fixed bottom bar on mobile (<lg) with total price and Checkout button
    - CartPageContent adds pb-20 lg:pb-0 so mobile fixed bar does not obscure content
    - All components use shadcn/ui primitives (Button, Separator) and lucide-react icons
    - TypeScript compiles without errors
  </done>
</task>

</tasks>

<verification>
1. `cd frontend && npx tsc --noEmit` passes
2. `cd frontend && npm run build` completes without errors
3. /cart page shows loading skeleton while cart fetches
4. Empty cart shows illustration + "Your cart is empty" + "Browse Books" CTA
5. Cart with items shows item list with quantity controls and summary sidebar
6. Changing quantity optimistically updates line total and order total
7. Removing item optimistically removes from list with rollback on error
</verification>

<success_criteria>
- Complete cart page with loading, empty, error, and populated states
- Cart items show cover, title, author, unit price, quantity stepper, line total, remove button
- Quantity stepper enforces min=1 with disabled minus button
- Order summary sidebar is sticky on desktop, shows items count and total
- On mobile, a fixed bottom bar shows total + Checkout button (per locked CONTEXT.md decision)
- All mutations are optimistic via useCart hook from Plan 01
</success_criteria>

<output>
After completion, create `.planning/phases/22-cart-and-checkout/22-03-SUMMARY.md`
</output>
