---
phase: 25-reviews
plan: "02"
type: execute
wave: 2
depends_on: ["25-01"]
files_modified:
  - frontend/src/app/books/[id]/_components/ReviewsSection.tsx
  - frontend/src/app/books/[id]/_components/ReviewForm.tsx
  - frontend/src/app/books/[id]/page.tsx
  - frontend/src/app/books/[id]/_components/RatingDisplay.tsx
autonomous: false
requirements: [REVW-01, REVW-02, REVW-03, REVW-04, REVW-05]

must_haves:
  truths:
    - "Book detail page displays all reviews with star rating, author name, optional text, and date"
    - "Authenticated user who purchased a book sees a Write a Review form with interactive star selector"
    - "User who already reviewed sees their review with Edit and Delete buttons"
    - "Clicking Edit pre-populates the form with existing rating and text"
    - "Clicking Delete opens a confirmation dialog; confirming removes the review"
    - "Unauthenticated users see the review list but not the write form"
    - "RatingDisplay star rating in the hero links to the reviews section via anchor"
  artifacts:
    - path: "frontend/src/app/books/[id]/_components/ReviewsSection.tsx"
      provides: "Reviews list container with query, form, and delete dialog"
      exports: ["ReviewsSection"]
    - path: "frontend/src/app/books/[id]/_components/ReviewForm.tsx"
      provides: "Write/edit review form with StarSelector and Textarea"
      exports: ["ReviewForm"]
    - path: "frontend/src/app/books/[id]/page.tsx"
      provides: "Extended page with server-side review fetch and ReviewsSection"
      contains: "fetchReviews"
    - path: "frontend/src/app/books/[id]/_components/RatingDisplay.tsx"
      provides: "Updated with anchor link to #reviews section"
      contains: "href=\"#reviews\""
  key_links:
    - from: "frontend/src/app/books/[id]/page.tsx"
      to: "frontend/src/lib/reviews.ts"
      via: "fetchReviews import for server-side initial data"
      pattern: "import.*fetchReviews.*from.*reviews"
    - from: "frontend/src/app/books/[id]/_components/ReviewsSection.tsx"
      to: "frontend/src/lib/reviews.ts"
      via: "useReviews hook for client-side mutations and cache"
      pattern: "useReviews"
    - from: "frontend/src/app/books/[id]/_components/ReviewForm.tsx"
      to: "frontend/src/app/books/[id]/_components/StarSelector.tsx"
      via: "StarSelector import for rating input"
      pattern: "import.*StarSelector"
    - from: "frontend/src/app/books/[id]/_components/RatingDisplay.tsx"
      to: "#reviews section"
      via: "anchor tag href"
      pattern: "href.*#reviews"
---

<objective>
Wire the reviews UI into the book detail page: create ReviewsSection (server-seeded list + client cache takeover), ReviewForm (write/edit with StarSelector + delete with confirmation dialog), extend page.tsx with server-side review fetch, and update RatingDisplay with a scroll-to-reviews anchor link. Conclude with human verification of all REVW requirements.

Purpose: Complete the reviews feature on the book detail page — the last feature of the v3.0 Customer Storefront milestone.
Output: Working reviews section on `/books/[id]` page with read, write, edit, and delete functionality. All REVW-01 through REVW-05 requirements satisfied.
</objective>

<execution_context>
@C:/Users/Sushasan/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Sushasan/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/25-reviews/25-RESEARCH.md
@.planning/phases/25-reviews/25-01-SUMMARY.md

<interfaces>
<!-- From Plan 25-01 outputs — executor uses these directly -->

From frontend/src/lib/reviews.ts (created in 25-01):
```typescript
export const REVIEWS_KEY = (bookId: number) => ['reviews', bookId] as const

export async function fetchReviews(bookId: number): Promise<ReviewListResponse>
export async function createReview(accessToken: string, bookId: number, body: ReviewCreate): Promise<ReviewResponse>
export async function updateReview(accessToken: string, reviewId: number, body: ReviewUpdate): Promise<ReviewResponse>
export async function deleteReview(accessToken: string, reviewId: number): Promise<void>

export function useReviews(bookId: number): {
  reviewsQuery: UseQueryResult<ReviewListResponse>
  createMutation: UseMutationResult
  updateMutation: UseMutationResult
  deleteMutation: UseMutationResult
  myReview: ReviewResponse | null
}
```

From frontend/src/app/books/[id]/_components/StarSelector.tsx (created in 25-01):
```typescript
export function StarSelector({ value, onChange, disabled }: {
  value: number; onChange: (rating: number) => void; disabled?: boolean
})
```

From frontend/src/app/books/[id]/_components/ReviewCard.tsx (created in 25-01):
```typescript
export function ReviewCard({ review, isOwn, onEdit, onDelete }: {
  review: ReviewResponse; isOwn: boolean; onEdit?: () => void; onDelete?: () => void
})
```

From frontend/src/types/api.generated.ts:
```typescript
ReviewCreate: { rating: number; text?: string | null }
ReviewUpdate: { rating?: number | null; text?: string | null }
ReviewResponse: {
  id: number; book_id: number; user_id: number; rating: number;
  text: string | null; verified_purchase: boolean;
  created_at: string; updated_at: string;
  author: { user_id: number; display_name: string; avatar_url: string | null };
  book: { book_id: number; title: string; cover_image_url: string | null };
}
ReviewListResponse: { items: ReviewResponse[]; total: number; page: number; size: number }
```

From frontend/src/auth.ts (session shape on client):
```typescript
session.accessToken   // FastAPI JWT string
session.user.id       // FastAPI user ID as string (from JWT sub claim)
```

From frontend/src/app/cart/_components/CheckoutDialog.tsx (Dialog pattern):
```typescript
import { Dialog, DialogContent, DialogDescription, DialogFooter, DialogHeader, DialogTitle } from '@/components/ui/dialog'
import { Button } from '@/components/ui/button'
// Controlled: open={open} onOpenChange={onOpenChange}
// Footer: Cancel (outline) + destructive action button
```

From frontend/src/app/books/[id]/page.tsx (current structure):
```typescript
// Server component with ISR (revalidate = 3600)
// React.cache wraps fetchBook for deduplication
// Renders: BreadcrumbNav, BookDetailHero, ActionButtons, Description, MoreInGenre
// ReviewsSection should be inserted between Description and MoreInGenre
```

From frontend/src/app/books/[id]/_components/RatingDisplay.tsx (current):
```typescript
// Line 41: {/* TODO: Phase 25 — link to reviews section */}
// Wrapping div has: className="flex items-center gap-2 mt-2 cursor-pointer"
// Need to change wrapping div to <a href="#reviews"> anchor
```
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ReviewForm and ReviewsSection components</name>
  <files>
    frontend/src/app/books/[id]/_components/ReviewForm.tsx
    frontend/src/app/books/[id]/_components/ReviewsSection.tsx
  </files>
  <action>
**Step 1: Create `ReviewForm.tsx`** — a `'use client'` component for writing and editing reviews.

Props interface:
```typescript
interface ReviewFormProps {
  bookId: number
  existingReview?: components['schemas']['ReviewResponse'] | null  // null = create mode, review = edit mode
  onSubmitSuccess?: () => void  // callback to reset edit mode in parent
  createMutation: UseMutationResult  // from useReviews
  updateMutation: UseMutationResult  // from useReviews
}
```

Implementation:
- Internal state: `rating` (number, default: `existingReview?.rating ?? 0`), `text` (string, default: `existingReview?.text ?? ''`).
- When `existingReview` changes (edit mode toggled), reset local state with a `useEffect` that sets `rating` and `text` from `existingReview`.
- Renders a heading: "Edit Your Review" when `existingReview` is provided, "Write a Review" otherwise.
- Renders `StarSelector` with `value={rating}` and `onChange={setRating}`.
- Renders shadcn `Textarea` for optional review text (import from `@/components/ui/textarea`). Placeholder: "Share your thoughts about this book (optional)". Rows: 3. Value bound to `text` state.
- Submit button (shadcn `Button`): Disabled when `rating === 0` (must select at least 1 star) or when mutation is pending. Label: "Submit Review" (create mode) or "Update Review" (edit mode).
- On submit: prevent default form submit. Build the request body:
  - **Create mode:** `{ rating, text: text.trim() || undefined }` — pass to `createMutation.mutate(...)`. The mutation function in the hook already takes `{ bookId, body }` or similar — check the actual hook signature from 25-01-SUMMARY and call accordingly. If the hook's createMutation.mutate expects the body directly (like `createMutation.mutate({ rating, text })`), use that.
  - **Edit mode:** Build a partial `ReviewUpdate` body. ONLY include fields that actually changed from the original (Pitfall 4 — partial update semantics): if `rating !== existingReview.rating`, include `rating`; if `text.trim() !== (existingReview.text ?? '')`, include `text: text.trim() || null` (null clears text). Call `updateMutation.mutate(...)` with reviewId and the partial body.
  - On success: call `onSubmitSuccess?.()` to let parent reset edit state, and reset local form state (rating=0, text='') for create mode.
- Cancel button (edit mode only): renders next to Submit, calls `onSubmitSuccess?.()` to exit edit mode without saving.

Import `StarSelector` from `./StarSelector`. Import `Textarea` from `@/components/ui/textarea`. Import `Button` from `@/components/ui/button`.

**Step 2: Create `ReviewsSection.tsx`** — a `'use client'` component that is the main reviews container rendered on the book detail page.

Props interface:
```typescript
interface ReviewsSectionProps {
  bookId: number
  initialReviews: components['schemas']['ReviewListResponse']
}
```

Implementation:
- Use `useReviews(bookId)` hook to get `reviewsQuery`, `createMutation`, `updateMutation`, `deleteMutation`, `myReview`.
- Provide `initialData` to the reviews query: The `useReviews` hook uses `useQuery` without initialData. To support server-seeded data, pass `initialReviews` via TanStack Query's `initialData` option. **IMPORTANT:** Check how the hook is structured from 25-01. If the hook's `useQuery` doesn't accept `initialData` from outside, the ReviewsSection should call its own `useQuery` with `queryKey: REVIEWS_KEY(bookId)`, `queryFn: () => fetchReviews(bookId)`, `initialData: initialReviews`, `staleTime: 30_000`. Import `REVIEWS_KEY` and `fetchReviews` from `@/lib/reviews`. Then use the hook for mutations only.

  **Preferred approach:** Call `useReviews(bookId)` for mutations + myReview, and a separate `useQuery` for the reviews list data with `initialData: initialReviews`. Both share the same `REVIEWS_KEY(bookId)` cache key — TanStack Query will deduplicate. This avoids modifying the hook from Plan 25-01.

- Use `useSession()` to get session state. Extract `userId = session?.user?.id ? Number(session.user.id) : null`.
- **Internal state:** `editingReview` (ReviewResponse | null, default null) — tracks which review is being edited. `deleteDialogOpen` (boolean, default false). `reviewToDelete` (number | null, default null) — reviewId to delete.
- Wrap the whole section in `<section id="reviews" className="mt-12">` — the `id="reviews"` is the anchor target for the RatingDisplay link.
- **Section header:** `<h2 className="text-xl font-semibold mb-6">Reviews</h2>` with review count from query data (e.g., "Reviews (12)").
- **Review form area:**
  - If user is NOT authenticated (`!session?.accessToken`): render a "Sign in to write a review" prompt with a link to `/login`.
  - If user IS authenticated AND `myReview` is null AND `editingReview` is null: render `<ReviewForm bookId={bookId} createMutation={createMutation} updateMutation={updateMutation} />` in create mode.
  - If user IS authenticated AND `myReview` is not null AND `editingReview` is null: show a message "You've already reviewed this book" (REVW-05 satisfied by the edit/delete buttons on their ReviewCard).
  - If `editingReview` is not null: render `<ReviewForm bookId={bookId} existingReview={editingReview} createMutation={createMutation} updateMutation={updateMutation} onSubmitSuccess={() => setEditingReview(null)} />` in edit mode.
- **Review list:** Map over `reviews.items` (from query data) and render `<ReviewCard>` for each. For each review:
  - `isOwn={review.author.user_id === userId}` — true if this is the current user's review.
  - `onEdit={() => setEditingReview(review)}` — switches to edit mode with pre-populated form.
  - `onDelete={() => { setReviewToDelete(review.id); setDeleteDialogOpen(true) }}` — opens delete confirmation.
  - Sort: user's own review first (if exists), then rest by `created_at` descending (most recent first). Apply this sort client-side: `const sortedReviews = [...items].sort(...)` placing own review at top.
- **Delete confirmation dialog:** Render shadcn `Dialog` (same pattern as CheckoutDialog):
  ```tsx
  <Dialog open={deleteDialogOpen} onOpenChange={setDeleteDialogOpen}>
    <DialogContent>
      <DialogHeader>
        <DialogTitle>Delete Review</DialogTitle>
        <DialogDescription>
          Are you sure you want to delete your review? This cannot be undone.
        </DialogDescription>
      </DialogHeader>
      <DialogFooter>
        <Button variant="outline" onClick={() => setDeleteDialogOpen(false)} disabled={deleteMutation.isPending}>
          Cancel
        </Button>
        <Button variant="destructive" disabled={deleteMutation.isPending} onClick={() => {
          if (reviewToDelete) {
            deleteMutation.mutate({ reviewId: reviewToDelete })
            // On success the mutation handler in the hook will invalidate + toast
            // Close dialog on settled:
          }
        }}>
          {deleteMutation.isPending ? 'Deleting...' : 'Delete'}
        </Button>
      </DialogFooter>
    </DialogContent>
  </Dialog>
  ```
  Add a `useEffect` watching `deleteMutation.isSuccess` to close the dialog and reset state: `setDeleteDialogOpen(false); setReviewToDelete(null); setEditingReview(null)`.
- **Empty state:** If reviews list is empty and no form is showing, render "No reviews yet. Be the first to review this book!" (only for authenticated users) or "No reviews yet." (for unauthenticated).

Import all Dialog parts from `@/components/ui/dialog`. Import `ReviewCard` from `./ReviewCard`. Import `ReviewForm` from `./ReviewForm`. Import `useReviews`, `REVIEWS_KEY`, `fetchReviews` from `@/lib/reviews`. Import `useSession` from `next-auth/react`. Import `useQuery` from `@tanstack/react-query`.
  </action>
  <verify>
    <automated>cd frontend && npx tsc --noEmit</automated>
  </verify>
  <done>
    - ReviewForm renders create mode (empty form) and edit mode (pre-populated) with StarSelector and Textarea
    - ReviewsSection shows review list with own-review-first sorting, form for authenticated users, delete confirmation dialog
    - Already-reviewed state shows edit/delete on user's own ReviewCard
    - TypeScript compiles with zero errors
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire ReviewsSection into page.tsx and update RatingDisplay anchor</name>
  <files>
    frontend/src/app/books/[id]/page.tsx
    frontend/src/app/books/[id]/_components/RatingDisplay.tsx
  </files>
  <action>
**Step 1: Extend `page.tsx`** to fetch reviews server-side and render ReviewsSection.

Add import at top of file:
```typescript
import { fetchReviews } from '@/lib/reviews'
import { ReviewsSection } from './_components/ReviewsSection'
```

Add type import for ReviewListResponse:
```typescript
import type { components } from '@/types/api.generated'
type ReviewListResponse = components['schemas']['ReviewListResponse']
```

Inside `BookDetailPage` server component, after the `relatedBooks` fetch block, add:
```typescript
let initialReviews: ReviewListResponse = { items: [], total: 0, page: 1, size: 50 }
try {
  initialReviews = await fetchReviews(book.id)
} catch {
  // Show empty state — don't crash the page
}
```

In the JSX, insert `<ReviewsSection>` between the Description section and the MoreInGenre section:
```tsx
{/* After description div, before MoreInGenre */}
<ReviewsSection bookId={book.id} initialReviews={initialReviews} />
```

**Step 2: Update `RatingDisplay.tsx`** to resolve the Phase 25 TODO.

Change the wrapping `<div>` to an `<a>` tag linking to the reviews section. Replace:
```tsx
<div
  className="flex items-center gap-2 mt-2 cursor-pointer"
  title={`${avgRating.toFixed(1)} out of 5 stars — ${reviewLabel}`}
>
  {/* TODO: Phase 25 — link to reviews section */}
```

With:
```tsx
<a
  href="#reviews"
  className="flex items-center gap-2 mt-2 cursor-pointer hover:underline"
  title={`${avgRating.toFixed(1)} out of 5 stars — ${reviewLabel}`}
>
```

And change the closing `</div>` to `</a>`.

Remove the TODO comment entirely — Phase 25 is resolving it.

Note: This is a pure HTML anchor — no client-side boundary needed. The `RatingDisplay` stays as a server component. The `#reviews` anchor targets the `id="reviews"` on the `<section>` element in `ReviewsSection`.
  </action>
  <verify>
    <automated>cd frontend && npx tsc --noEmit && npm run build</automated>
  </verify>
  <done>
    - page.tsx fetches reviews server-side and passes initialReviews to ReviewsSection
    - ReviewsSection renders between Description and MoreInGenre on the book detail page
    - RatingDisplay links to #reviews section via anchor tag
    - Production build succeeds
    - TODO comment removed from RatingDisplay
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Human verification of all REVW requirements</name>
  <files>none</files>
  <action>
Human verification checkpoint — no automated action. Present the verification steps below to the user and wait for approval.
  </action>
  <verify>User types "approved" or describes issues to fix</verify>
  <done>All REVW-01 through REVW-05 requirements verified by human in browser</done>
  <what-built>Complete reviews feature on the book detail page: review list display, write/edit/delete functionality with star rating selector, delete confirmation dialog, already-reviewed state, and RatingDisplay scroll anchor.</what-built>
  <how-to-verify>
Prerequisites: Backend running (`cd backend && poetry run uvicorn app.main:app --reload`), Frontend running (`cd frontend && npm run dev`). You need a user account that has purchased at least one book.

**REVW-01: Review list display**
1. Navigate to a book detail page (`/books/{id}`) for a book that has reviews in the database
2. Scroll down — verify reviews section appears below the description
3. Each review shows: star rating (filled stars), author name, optional text, date, and "Verified Purchase" badge if applicable
4. Click the star rating in the book hero area — verify it scrolls to the reviews section

**REVW-02: Write a review (purchase gate)**
1. Sign in as a user who has purchased a book
2. Go to that book's detail page
3. Verify a "Write a Review" form appears with an interactive star selector and text area
4. Click stars to set a rating (hover should preview), type optional text, click "Submit Review"
5. Verify toast success appears and the review shows up in the list immediately
6. (Optional) Try writing a review for a book you haven't purchased — verify you get a toast error about purchasing first

**REVW-03: Edit own review**
1. On the book you just reviewed, find your review in the list
2. Click the Edit (pencil) button on your review
3. Verify the form switches to "Edit Your Review" mode with your existing rating and text pre-populated
4. Change the rating or text, click "Update Review"
5. Verify toast success appears and the updated review shows in the list

**REVW-04: Delete own review**
1. On the book you reviewed, click the Delete (trash) button on your review
2. Verify a confirmation dialog appears: "Are you sure you want to delete your review?"
3. Click "Delete" — verify the review disappears from the list and a toast confirms deletion
4. Verify the "Write a Review" form reappears (you can review again)

**REVW-05: Already reviewed state**
1. Write a review for a book, then revisit the page
2. Verify the "Write a Review" form is NOT shown (since you already reviewed)
3. Verify your review appears in the list with Edit and Delete buttons
4. Verify other users' reviews do NOT show Edit/Delete buttons

**Unauthenticated state:**
1. Sign out
2. Visit a book detail page with reviews
3. Verify reviews are visible but "Write a Review" form is replaced with a "Sign in to write a review" prompt
  </how-to-verify>
  <resume-signal>Type "approved" to complete Phase 25, or describe any issues found</resume-signal>
</task>

</tasks>

<verification>
1. `cd frontend && npx tsc --noEmit` — zero TypeScript errors
2. `cd frontend && npm run build` — production build succeeds
3. Book detail page shows reviews section with all reviews
4. Authenticated user with purchase can write, edit, and delete reviews
5. Already-reviewed state shows edit/delete options, no duplicate form
6. RatingDisplay star rating in hero links to #reviews anchor
7. Delete confirmation uses shadcn Dialog (not window.confirm)
8. Unauthenticated users see reviews but not the write form
</verification>

<success_criteria>
- REVW-01: Reviews with rating, author, text, date visible on book detail page
- REVW-02: Purchase-gated review form with interactive star selector works end-to-end
- REVW-03: Edit mode pre-populates form and updates review on submit
- REVW-04: Delete confirmation dialog removes review and re-enables write form
- REVW-05: Already-reviewed users see their review with edit/delete, no duplicate write form
- Human verification approved
</success_criteria>

<output>
After completion, create `.planning/phases/25-reviews/25-02-SUMMARY.md`
</output>
