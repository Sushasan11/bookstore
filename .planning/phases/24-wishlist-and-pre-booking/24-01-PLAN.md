---
phase: 24-wishlist-and-pre-booking
plan: "01"
type: execute
wave: 1
depends_on: []
files_modified:
  - frontend/src/lib/wishlist.ts
  - frontend/src/lib/prebook.ts
  - frontend/src/app/catalog/_components/BookCard.tsx
  - frontend/src/app/books/[id]/_components/ActionButtons.tsx
  - frontend/src/app/books/[id]/page.tsx
autonomous: true
requirements: [WISH-01, WISH-02, WISH-04, PREB-01, PREB-02]

must_haves:
  truths:
    - "User can tap heart on BookCard (catalog grid) and it fills red instantly (optimistic)"
    - "User can tap heart on ActionButtons (book detail page) and it fills red instantly (optimistic)"
    - "A second tap on a filled heart unfills it and removes the book from wishlist"
    - "Unauthenticated user tapping heart gets toast error and redirect to /login"
    - "Out-of-stock book shows Pre-book button instead of Add to Cart on book detail page"
    - "User can click Pre-book and receives success toast; duplicate pre-book shows descriptive error"
  artifacts:
    - path: "frontend/src/lib/wishlist.ts"
      provides: "useWishlist hook with optimistic toggle, WISHLIST_KEY shared cache"
      exports: ["useWishlist", "WISHLIST_KEY"]
    - path: "frontend/src/lib/prebook.ts"
      provides: "usePrebook hook with pre-book mutation"
      exports: ["usePrebook"]
  key_links:
    - from: "frontend/src/app/catalog/_components/BookCard.tsx"
      to: "frontend/src/lib/wishlist.ts"
      via: "useWishlist() hook consumption"
      pattern: "useWishlist\\(\\)"
    - from: "frontend/src/app/books/[id]/_components/ActionButtons.tsx"
      to: "frontend/src/lib/wishlist.ts"
      via: "useWishlist() hook consumption"
      pattern: "useWishlist\\(\\)"
    - from: "frontend/src/app/books/[id]/_components/ActionButtons.tsx"
      to: "frontend/src/lib/prebook.ts"
      via: "usePrebook() hook consumption"
      pattern: "usePrebook\\(\\)"
---

<objective>
Create the wishlist data layer (useWishlist hook) and pre-booking hook (usePrebook), then wire the heart toggle into BookCard and ActionButtons, and add the Pre-book button for out-of-stock books on the detail page.

Purpose: Enables users to save books for later via a single-tap heart icon on any book surface, and reserve out-of-stock titles from the book detail page. This is the interactive core of Phase 24.

Output: Two new hook files (wishlist.ts, prebook.ts) and updated BookCard + ActionButtons components with live wishlist toggle and pre-book action.
</objective>

<execution_context>
@C:/Users/Sushasan/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Sushasan/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/24-wishlist-and-pre-booking/24-RESEARCH.md

<interfaces>
<!-- Key types and contracts the executor needs. Extracted from codebase. -->
<!-- Executor should use these directly — no codebase exploration needed. -->

From frontend/src/lib/api.ts:
```typescript
export class ApiError extends Error {
  constructor(message: string, public status: number, public detail?: string, public data?: unknown) { ... }
}
export async function apiFetch<T>(path: string, options?: RequestInit): Promise<T>
```

From frontend/src/lib/cart.ts (pattern to mirror):
```typescript
export const CART_KEY = ['cart'] as const
export function useCart() {
  // Returns: { cartQuery, addItem, updateItem, removeItem, checkoutMutation }
  // Pattern: useSession() for accessToken, useQuery for cache, useMutation with onMutate/onError/onSettled
}
```

From frontend/src/app/catalog/_components/BookCard.tsx (current structure):
```typescript
// 'use client' — already a client component
// Imports: useCart, useSession, useRouter, toast, BookResponse
// Has: handleAddToCart with e.preventDefault()+e.stopPropagation(), absolute-positioned cart icon top-right
// Cart icon: opacity-100 md:opacity-0 md:group-hover:opacity-100
```

From frontend/src/app/books/[id]/_components/ActionButtons.tsx (current structure):
```typescript
interface ActionButtonsProps { bookId: number; inStock: boolean }
// Has: disabled Heart button placeholder ("Add to Wishlist"), useCart().addItem for cart
// Unauthenticated guard: !session?.accessToken → toast.error + router.push('/login')
```

From frontend/src/app/books/[id]/page.tsx:
```typescript
// Server component, passes: <ActionButtons bookId={book.id} inStock={book.in_stock} />
```

Generated types already available in api.generated.ts:
```typescript
components['schemas']['WishlistResponse']       // { items: WishlistItemResponse[] }
components['schemas']['WishlistItemResponse']    // { id, book_id, added_at, book: BookSummary }
components['schemas']['PreBookResponse']         // { id, book_id, book_title, book_author, status, created_at, notified_at, cancelled_at }
```

Backend API endpoints (already implemented):
- POST /wishlist { book_id } → WishlistItemResponse (409 WISHLIST_ITEM_DUPLICATE)
- DELETE /wishlist/{book_id} → 204
- GET /wishlist → WishlistResponse
- POST /prebooks { book_id } → PreBookResponse (409 PREBOOK_BOOK_IN_STOCK, 409 PREBOOK_DUPLICATE)
- DELETE /prebooks/{prebook_id} → 204
- GET /prebooks → PreBookListResponse
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create useWishlist hook and usePrebook hook</name>
  <files>
    frontend/src/lib/wishlist.ts
    frontend/src/lib/prebook.ts
  </files>
  <action>
Create `frontend/src/lib/wishlist.ts` following the exact pattern of `cart.ts`:

1. `'use client'` directive at top.
2. Import `useQuery`, `useMutation`, `useQueryClient` from `@tanstack/react-query`, `useSession` from `next-auth/react`, `useRouter` from `next/navigation`, `toast` from `sonner`, `apiFetch` and `ApiError` from `@/lib/api`, types from `@/types/api.generated`.
3. Type aliases: `WishlistResponse = components['schemas']['WishlistResponse']`, `WishlistItemResponse = components['schemas']['WishlistItemResponse']`.
4. Export `WISHLIST_KEY = ['wishlist'] as const`.
5. Three API functions (export each):
   - `fetchWishlist(accessToken: string): Promise<WishlistResponse>` — GET /wishlist
   - `addToWishlist(accessToken: string, bookId: number): Promise<WishlistItemResponse>` — POST /wishlist with `{ book_id: bookId }`
   - `removeFromWishlist(accessToken: string, bookId: number): Promise<void>` — DELETE /wishlist/${bookId}
6. `useWishlist()` hook:
   - `useSession()` for accessToken, `useQueryClient()`, `useRouter()`.
   - `wishlistQuery = useQuery({ queryKey: WISHLIST_KEY, queryFn: () => fetchWishlist(accessToken), enabled: !!accessToken, staleTime: 60_000 })`.
   - Derive `wishlistedIds = new Set(wishlistQuery.data?.items.map(i => i.book_id) ?? [])` — O(1) lookup for heart state.
   - `toggleWishlist = useMutation`:
     - `mutationFn: ({ bookId, isWishlisted }) =>` calls `removeFromWishlist` if `isWishlisted`, else `addToWishlist`.
     - `onMutate`: cancel queries, snapshot previous, optimistic update — if removing: filter out item; if adding: append stub item `{ id: -1, book_id: bookId, added_at: new Date().toISOString(), book: {} as any }`.
     - `onError`: rollback to snapshot, `toast.error(isWishlisted ? 'Failed to remove from wishlist' : 'Failed to add to wishlist')`.
     - `onSuccess`: `toast.success(isWishlisted ? 'Removed from wishlist' : 'Added to wishlist')`.
     - `onSettled`: `queryClient.invalidateQueries({ queryKey: WISHLIST_KEY })`.
   - `handleToggle(bookId: number)`: check `!session?.accessToken` → `toast.error('Please sign in to save books to your wishlist')` + `router.push('/login')` + return. Otherwise `toggleWishlist.mutate({ bookId, isWishlisted: wishlistedIds.has(bookId) })`.
   - Return `{ wishlistQuery, wishlistedIds, handleToggle, isPending: toggleWishlist.isPending }`.

Create `frontend/src/lib/prebook.ts`:

1. `'use client'` directive.
2. Same imports pattern as wishlist.ts.
3. Type alias: `PreBookResponse = components['schemas']['PreBookResponse']`.
4. Export `PREBOOK_KEY = ['prebooks'] as const`.
5. Two API functions:
   - `createPrebook(accessToken: string, bookId: number): Promise<PreBookResponse>` — POST /prebooks with `{ book_id: bookId }`.
   - `cancelPrebook(accessToken: string, prebookId: number): Promise<void>` — DELETE /prebooks/${prebookId}.
   - `fetchPrebooks(accessToken: string): Promise<components['schemas']['PreBookListResponse']>` — GET /prebooks.
6. `usePrebook()` hook:
   - `useSession()`, `useRouter()`.
   - `prebookMutation = useMutation`:
     - `mutationFn: ({ bookId }) => createPrebook(accessToken, bookId)`.
     - `onSuccess`: `toast.success('Pre-booking confirmed! We will notify you when this book is back in stock.')`.
     - `onError(err)`: check `err instanceof ApiError && err.status === 409` — if error detail contains 'PREBOOK_DUPLICATE' or 'already', show `toast.error('You already have an active pre-booking for this book')`. If 'IN_STOCK', show `toast.error('This book is now in stock — add it to your cart instead!')`. Otherwise `toast.error('Failed to create pre-booking')`.
   - `handlePrebook(bookId: number)`: check `!session?.accessToken` → `toast.error('Please sign in to pre-book')` + `router.push('/login')` + return. Otherwise `prebookMutation.mutate({ bookId })`.
   - Return `{ handlePrebook, isPending: prebookMutation.isPending }`.
  </action>
  <verify>
    <automated>cd frontend && npx tsc --noEmit 2>&1 | head -30</automated>
  </verify>
  <done>
    - wishlist.ts exports useWishlist, WISHLIST_KEY, fetchWishlist, addToWishlist, removeFromWishlist
    - prebook.ts exports usePrebook, PREBOOK_KEY, createPrebook, cancelPrebook, fetchPrebooks
    - No TypeScript errors
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire heart icon on BookCard and ActionButtons + Pre-book button</name>
  <files>
    frontend/src/app/catalog/_components/BookCard.tsx
    frontend/src/app/books/[id]/_components/ActionButtons.tsx
    frontend/src/app/books/[id]/page.tsx
  </files>
  <action>
**BookCard.tsx modifications:**

1. Add import: `import { Heart } from 'lucide-react'` and `import { useWishlist } from '@/lib/wishlist'`.
2. Inside `BookCard` component, call `const { wishlistedIds, handleToggle, isPending: wishlistPending } = useWishlist()`.
3. Derive: `const isWishlisted = wishlistedIds.has(book.id)`.
4. Add `handleHeartClick` handler (mirrors `handleAddToCart` pattern):
   ```
   const handleHeartClick = (e: React.MouseEvent) => {
     e.preventDefault()
     e.stopPropagation()
     handleToggle(book.id)
   }
   ```
5. Add heart button BEFORE the cart icon button (inside the outer `<div>`, sibling to `<Link>` and cart button), positioned top-left:
   ```
   <Button
     variant="secondary"
     size="icon"
     className="absolute top-2 left-2 h-8 w-8 opacity-100 md:opacity-0 md:group-hover:opacity-100 transition-opacity shadow-sm z-10"
     onClick={handleHeartClick}
     disabled={wishlistPending}
     aria-label={isWishlisted ? `Remove ${book.title} from wishlist` : `Add ${book.title} to wishlist`}
   >
     <Heart className={`h-4 w-4 ${isWishlisted ? 'fill-red-500 text-red-500' : ''}`} />
   </Button>
   ```
   - Heart goes top-LEFT (left-2), cart stays top-RIGHT (right-2) — no conflict.
   - Same visibility pattern as cart icon: always visible on mobile, hover on desktop.
   - The heart button is a sibling to the Link, not nested inside it (same as the cart button).

**ActionButtons.tsx modifications:**

1. Add imports: `import { useWishlist } from '@/lib/wishlist'` and `import { usePrebook } from '@/lib/prebook'`.
2. Inside the component, add: `const { wishlistedIds, handleToggle, isPending: wishlistPending } = useWishlist()` and `const { handlePrebook, isPending: prebookPending } = usePrebook()`.
3. Derive: `const isWishlisted = wishlistedIds.has(bookId)`.
4. Replace the cart/stock button section with a conditional:
   - When `inStock` is true: keep existing Add to Cart button (unchanged).
   - When `inStock` is false: render a Pre-book button:
     ```
     <Button size="lg" variant="outline" onClick={() => handlePrebook(bookId)} disabled={prebookPending}>
       {prebookPending ? 'Pre-booking...' : 'Pre-book'}
     </Button>
     ```
5. Replace the disabled Heart button with a live one:
   ```
   <Button
     size="lg"
     variant="outline"
     onClick={() => handleToggle(bookId)}
     disabled={wishlistPending}
   >
     <Heart className={isWishlisted ? 'fill-red-500 text-red-500' : ''} />
     {isWishlisted ? 'Wishlisted' : 'Add to Wishlist'}
   </Button>
   ```
6. No animation on toggle — per locked decision. Simple state swap of class.

**page.tsx (book detail) — NO changes needed.** It already passes `bookId={book.id} inStock={book.in_stock}` to ActionButtons. Confirm this is unchanged.

Key points to NOT mess up:
- BookCard heart: MUST use `e.preventDefault()` + `e.stopPropagation()` — otherwise clicking heart navigates to book detail.
- Heart icon filled state: `fill-red-500 text-red-500` when wishlisted, no extra classes when not (lucide-react Heart defaults to stroke-only).
- No animation — per CONTEXT.md locked decision.
- Unauthenticated pattern: same as existing cart — `toast.error` + `router.push('/login')`. Already handled inside `handleToggle` and `handlePrebook` in the hooks.
  </action>
  <verify>
    <automated>cd frontend && npx tsc --noEmit 2>&1 | head -30 && npm run build 2>&1 | tail -20</automated>
  </verify>
  <done>
    - BookCard shows heart icon (top-left) alongside cart icon (top-right), toggle works with optimistic update
    - ActionButtons shows live heart button (not disabled) and shows "Pre-book" when inStock is false
    - No TypeScript errors, production build passes
  </done>
</task>

</tasks>

<verification>
1. `cd frontend && npx tsc --noEmit` — zero type errors
2. `cd frontend && npm run build` — production build succeeds
3. Heart icon appears on BookCard in catalog grid (top-left corner)
4. Heart icon toggles filled/outline state on click
5. ActionButtons shows "Add to Cart" for in-stock books, "Pre-book" for out-of-stock books
6. ActionButtons heart button is live (not disabled)
7. Unauthenticated clicks redirect to /login with toast
</verification>

<success_criteria>
- useWishlist hook provides shared wishlist state across BookCard and ActionButtons via WISHLIST_KEY
- usePrebook hook provides pre-book mutation with proper 409 error handling
- Heart icon on BookCard: top-left, same hover visibility pattern as cart icon, stopPropagation prevents navigation
- Heart icon on ActionButtons: live toggle with "Wishlisted"/"Add to Wishlist" label
- Pre-book button replaces disabled "Out of Stock" on ActionButtons when !inStock
- All optimistic updates with rollback on error
- Toast notifications match cart pattern (sonner)
</success_criteria>

<output>
After completion, create `.planning/phases/24-wishlist-and-pre-booking/24-01-SUMMARY.md`
</output>
