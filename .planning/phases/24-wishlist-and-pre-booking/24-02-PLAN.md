---
phase: 24-wishlist-and-pre-booking
plan: "02"
type: execute
wave: 2
depends_on: ["24-01"]
files_modified:
  - frontend/src/app/wishlist/page.tsx
  - frontend/src/app/wishlist/_components/WishlistList.tsx
  - frontend/src/app/wishlist/loading.tsx
  - frontend/src/app/account/page.tsx
  - frontend/src/app/account/_components/PrebookingsList.tsx
  - frontend/src/components/layout/Header.tsx
  - frontend/src/components/layout/MobileNav.tsx
autonomous: true
requirements: [WISH-03, PREB-03, PREB-04]

must_haves:
  truths:
    - "User can view /wishlist page showing all saved books with cover, title, author, price, and stock badge"
    - "User can remove a book from the wishlist page and the item disappears immediately (optimistic)"
    - "User can see active pre-bookings listed on the /account page"
    - "User can cancel a pre-booking and it disappears from the list"
    - "Wishlist link appears in Header nav and MobileNav drawer"
  artifacts:
    - path: "frontend/src/app/wishlist/page.tsx"
      provides: "Server-rendered wishlist page with auth guard"
      contains: "auth()"
    - path: "frontend/src/app/wishlist/_components/WishlistList.tsx"
      provides: "Client component for wishlist items with remove capability"
      contains: "useWishlist"
    - path: "frontend/src/app/wishlist/loading.tsx"
      provides: "Loading skeleton for wishlist page"
    - path: "frontend/src/app/account/_components/PrebookingsList.tsx"
      provides: "Client component for pre-booking list with cancel mutation"
      contains: "cancelPrebook"
    - path: "frontend/src/app/account/page.tsx"
      provides: "Updated account hub with wishlist card and pre-bookings section"
      contains: "PrebookingsList"
  key_links:
    - from: "frontend/src/app/wishlist/_components/WishlistList.tsx"
      to: "frontend/src/lib/wishlist.ts"
      via: "useWishlist() for remove mutation"
      pattern: "useWishlist\\(\\)"
    - from: "frontend/src/app/account/_components/PrebookingsList.tsx"
      to: "frontend/src/lib/prebook.ts"
      via: "cancelPrebook and PREBOOK_KEY for cache invalidation"
      pattern: "cancelPrebook|PREBOOK_KEY"
    - from: "frontend/src/app/account/page.tsx"
      to: "frontend/src/lib/prebook.ts"
      via: "fetchPrebooks server-side call"
      pattern: "fetchPrebooks"
---

<objective>
Create the /wishlist page for viewing saved books, add pre-bookings section to the /account page with cancel capability, and add Wishlist to site navigation.

Purpose: Users need a dedicated page to view their wishlist and manage their pre-bookings from their account hub. This completes the remaining WISH-03, PREB-03, and PREB-04 requirements.

Output: Wishlist page with list layout, updated account page with pre-bookings section and wishlist card, Wishlist link in Header and MobileNav.
</objective>

<execution_context>
@C:/Users/Sushasan/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Sushasan/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/24-wishlist-and-pre-booking/24-RESEARCH.md
@.planning/phases/24-wishlist-and-pre-booking/24-01-SUMMARY.md

<interfaces>
<!-- Key types and contracts from Plan 01 and existing codebase. -->

From frontend/src/lib/wishlist.ts (created in 24-01):
```typescript
export const WISHLIST_KEY = ['wishlist'] as const
export function fetchWishlist(accessToken: string): Promise<WishlistResponse>
export function removeFromWishlist(accessToken: string, bookId: number): Promise<void>
export function useWishlist(): {
  wishlistQuery: UseQueryResult<WishlistResponse>
  wishlistedIds: Set<number>
  handleToggle: (bookId: number) => void
  isPending: boolean
}
```

From frontend/src/lib/prebook.ts (created in 24-01):
```typescript
export const PREBOOK_KEY = ['prebooks'] as const
export function fetchPrebooks(accessToken: string): Promise<PreBookListResponse>
export function cancelPrebook(accessToken: string, prebookId: number): Promise<void>
export function usePrebook(): {
  handlePrebook: (bookId: number) => void
  isPending: boolean
}
```

From frontend/src/lib/api.ts:
```typescript
export class ApiError extends Error { constructor(message, status, detail?, data?) }
export async function apiFetch<T>(path: string, options?: RequestInit): Promise<T>
```

From frontend/src/app/orders/page.tsx (page pattern to mirror):
```typescript
// Server component, auth guard, try/catch fetchOrders, renders OrderHistoryList
```

From frontend/src/app/account/page.tsx (current structure):
```typescript
// Server component, auth guard, grid of Card links (Order History)
// Line 29: {/* Wishlist and Pre-bookings — Phase 24 */}
```

From frontend/src/components/layout/Header.tsx:
```typescript
// Desktop nav: <nav> with Link to /catalog and /account
```

From frontend/src/components/layout/MobileNav.tsx:
```typescript
const navLinks = [
  { href: '/', label: 'Home' },
  { href: '/catalog', label: 'Books' },
  { href: '/cart', label: 'Cart' },
  { href: '/account', label: 'Account' },
]
```

Generated types:
```typescript
// WishlistItemResponse.book (BookSummary):
{ id, title, author, price: string, stock_quantity: number, cover_image_url: string|null }

// PreBookResponse:
{ id, book_id, book_title, book_author, status: string, created_at, notified_at, cancelled_at }
```

Proxy.ts already protects /wishlist (already in protectedPrefixes array).
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create /wishlist page with WishlistList component</name>
  <files>
    frontend/src/app/wishlist/page.tsx
    frontend/src/app/wishlist/_components/WishlistList.tsx
    frontend/src/app/wishlist/loading.tsx
  </files>
  <action>
**Create `frontend/src/app/wishlist/page.tsx`** — server component, mirrors orders/page.tsx pattern:

1. Import `auth` from `@/auth`, `redirect` from `next/navigation`, `fetchWishlist` from `@/lib/wishlist`, `WishlistList` from `./_components/WishlistList`.
2. Import type `components` from `@/types/api.generated`, create `type WishlistResponse = components['schemas']['WishlistResponse']`.
3. Export `metadata = { title: 'My Wishlist' }`.
4. `export default async function WishlistPage()`:
   - `const session = await auth()` — `if (!session?.accessToken) redirect('/login')`.
   - Try/catch: `const data = await fetchWishlist(session.accessToken)`. On catch, default to `{ items: [] }`.
   - Render: `<div className="mx-auto max-w-3xl px-4 py-8">`, `<h1 className="text-2xl font-bold mb-6">My Wishlist</h1>`, `<WishlistList items={data.items} />`.

**Create `frontend/src/app/wishlist/_components/WishlistList.tsx`** — `'use client'` component:

1. Props: `{ items: WishlistItemResponse[] }` where `type WishlistItemResponse = components['schemas']['WishlistItemResponse']`.
2. Import `useWishlist`, `WISHLIST_KEY` from `@/lib/wishlist`, `Image` from `next/image`, `Link` from `next/link`, `Badge` from `@/components/ui/badge`, `Button` from `@/components/ui/button`, `Trash2` from `lucide-react`.
3. Inside the component:
   - `const { wishlistQuery, handleToggle } = useWishlist()`.
   - Use `wishlistQuery.data?.items ?? items` as the display list — TanStack Query cache takes over after first client-side fetch, initial SSR items are the fallback.
   - If list is empty: show empty state — "Your wishlist is empty" with a Link to `/catalog`.
4. For each item, render a row (list layout, not grid — per Claude's discretion):
   - Left: Small cover image thumbnail (48x72, aspect-[2/3]) or color placeholder. Wrap in `<Link href={/books/${item.book_id}}>`.
   - Middle: Title (font-medium), Author (text-sm text-muted-foreground), Price (font-semibold), Stock badge (green "In Stock" if `item.book.stock_quantity > 0`, red "Out of Stock" otherwise).
   - Right: Remove button — `<Button variant="ghost" size="icon" onClick={() => handleToggle(item.book_id)}>` with `<Trash2 className="h-4 w-4" />`. The `handleToggle` call with a wishlisted book ID triggers removal.
5. Each row: `flex items-center gap-4 py-4 border-b last:border-b-0`.

**Create `frontend/src/app/wishlist/loading.tsx`** — loading skeleton:

1. Import `Skeleton` from `@/components/ui/skeleton`.
2. Render 3 placeholder rows matching the wishlist row layout: skeleton rectangle for cover, skeleton lines for title/author/price, skeleton circle for remove button.
  </action>
  <verify>
    <automated>cd frontend && npx tsc --noEmit 2>&1 | head -30</automated>
  </verify>
  <done>
    - /wishlist page renders server-fetched wishlist items with auth guard
    - WishlistList displays items with cover, title, author, price, stock badge, and remove button
    - Empty state shows when wishlist is empty
    - Loading skeleton shows during page load
  </done>
</task>

<task type="auto">
  <name>Task 2: Add pre-bookings to account page and Wishlist to navigation</name>
  <files>
    frontend/src/app/account/page.tsx
    frontend/src/app/account/_components/PrebookingsList.tsx
    frontend/src/components/layout/Header.tsx
    frontend/src/components/layout/MobileNav.tsx
  </files>
  <action>
**Create `frontend/src/app/account/_components/PrebookingsList.tsx`** — `'use client'` component:

1. Props: `{ prebooks: PreBookResponse[] }` where `type PreBookResponse = components['schemas']['PreBookResponse']`.
2. Imports: `useMutation`, `useQueryClient` from `@tanstack/react-query`, `useSession` from `next-auth/react`, `toast` from `sonner`, `cancelPrebook`, `PREBOOK_KEY` from `@/lib/prebook`, `Button` from `@/components/ui/button`, `Badge` from `@/components/ui/badge`, `X` from `lucide-react`.
3. Inside component:
   - `const { data: session } = useSession()`, `const accessToken = session?.accessToken ?? ''`, `const queryClient = useQueryClient()`.
   - `cancelMutation = useMutation`:
     - `mutationFn: ({ prebookId }: { prebookId: number }) => cancelPrebook(accessToken, prebookId)`.
     - `onSuccess`: `toast.success('Pre-booking cancelled')`.
     - `onError(err)`: check `ApiError` with status 409 — if detail includes 'ALREADY_CANCELLED' show `toast.error('This pre-booking was already cancelled')`, else `toast.error('Failed to cancel pre-booking')`.
     - `onSettled`: `queryClient.invalidateQueries({ queryKey: PREBOOK_KEY })`.
   - State: `const [localPrebooks, setLocalPrebooks] = useState(prebooks)` — for optimistic removal.
   - In `onMutate` of cancelMutation: save previous list, remove item from `localPrebooks` optimistically. In `onError`: restore previous list.
   - Actually, simpler approach since this is a server-rendered initial list: use `useState(prebooks)` and in the cancel handler, optimistically filter out the cancelled item from local state. On error, restore. On settled, the page can revalidate (or just keep local state since it's a one-shot action).
4. If `localPrebooks` is empty: render "No active pre-bookings".
5. For each pre-booking, render a row:
   - Book title (font-medium), book author (text-sm text-muted-foreground), status Badge (yellow "Waiting" for status=waiting, blue "Notified" for status=notified), created date (text-xs).
   - Cancel button: `<Button variant="ghost" size="sm" onClick={() => handleCancel(prebook.id)} disabled={cancelMutation.isPending}>` with `<X className="h-4 w-4 mr-1" />Cancel`. Only show cancel for status === 'waiting'.
6. Each row: `flex items-center justify-between py-3 border-b last:border-b-0`.

**Update `frontend/src/app/account/page.tsx`:**

1. Add imports: `import { Heart, BookOpen } from 'lucide-react'`, `import { fetchPrebooks } from '@/lib/prebook'`, `import { PrebookingsList } from './_components/PrebookingsList'`, `import type { components } from '@/types/api.generated'`.
2. Add type: `type PreBookResponse = components['schemas']['PreBookResponse']`.
3. After the session guard, fetch pre-bookings server-side: `let prebooks: PreBookResponse[] = []; try { const data = await fetchPrebooks(session.accessToken); prebooks = data.items.filter(p => p.status !== 'cancelled'); } catch { prebooks = []; }`.
4. Replace the `{/* Wishlist and Pre-bookings — Phase 24 */}` comment with:
   - A Wishlist card link (same pattern as Order History card): `<Link href="/wishlist"><Card className="p-6 hover:bg-accent transition-colors cursor-pointer"><Heart className="h-6 w-6 mb-3 text-muted-foreground" /><h2 className="font-semibold">Wishlist</h2><p className="text-sm text-muted-foreground mt-1">Books you saved for later</p></Card></Link>`.
5. Below the cards grid, add a pre-bookings section:
   ```
   <div className="mt-8">
     <h2 className="text-lg font-semibold mb-4">Pre-bookings</h2>
     <PrebookingsList prebooks={prebooks} />
   </div>
   ```
   This renders inline on the account page (per Claude's discretion — pre-bookings are a small bounded list, not worth a separate page).

**Update `frontend/src/components/layout/Header.tsx`:**

Add a "Wishlist" link to the desktop nav, between "Books" and "Account":
```tsx
<Link href="/wishlist" className="text-sm font-medium text-muted-foreground hover:text-foreground transition-colors">
  Wishlist
</Link>
```

**Update `frontend/src/components/layout/MobileNav.tsx`:**

Add wishlist entry to `navLinks` array, after 'Cart' and before 'Account':
```typescript
{ href: '/wishlist', label: 'Wishlist' },
```
  </action>
  <verify>
    <automated>cd frontend && npx tsc --noEmit 2>&1 | head -30 && npm run build 2>&1 | tail -20</automated>
  </verify>
  <done>
    - /wishlist page accessible from nav with list of saved books and remove capability
    - /account page shows Wishlist card link and pre-bookings section with cancel buttons
    - Header desktop nav includes Wishlist link
    - MobileNav drawer includes Wishlist entry
    - No TypeScript errors, production build passes
  </done>
</task>

</tasks>

<verification>
1. `cd frontend && npx tsc --noEmit` — zero type errors
2. `cd frontend && npm run build` — production build succeeds
3. /wishlist page shows saved books in list layout with remove button
4. /wishlist shows empty state when no items
5. /account page shows Wishlist card and pre-bookings section
6. Pre-booking cancel removes the item from the list
7. Wishlist link in both desktop Header nav and mobile MobileNav drawer
</verification>

<success_criteria>
- /wishlist page follows the server-fetch + client-list pattern established by /orders
- WishlistList shows cover thumbnail, title, author, price, stock badge, remove button per item
- PrebookingsList shows book title, author, status badge, cancel button per active pre-booking
- Cancel only appears for "waiting" status pre-bookings
- Account page has both Wishlist card and inline pre-bookings section
- Navigation updated in both Header and MobileNav
- All routes auth-protected via proxy.ts (already configured)
</success_criteria>

<output>
After completion, create `.planning/phases/24-wishlist-and-pre-booking/24-02-SUMMARY.md`
</output>
