---
phase: 26-admin-foundation
plan: 02
type: execute
wave: 2
depends_on:
  - 26-01
files_modified:
  - frontend/src/lib/admin.ts
  - frontend/src/app/admin/overview/page.tsx
autonomous: true
requirements:
  - DASH-01
  - DASH-02
  - DASH-03
  - DASH-04
  - DASH-05

must_haves:
  truths:
    - "Admin can view KPI cards showing revenue, order count, and AOV on the dashboard overview page"
    - "Admin can switch between Today, This Week, and This Month — KPI values update for the selected period"
    - "Each KPI card shows a colored delta badge: green up arrow for positive, red down arrow for negative, grey dash for flat/null"
    - "Admin can see a low-stock count card with amber accent color that links to /admin/inventory"
    - "Admin can view a top-5 best-selling books mini-table with Rank, Title, Author, and Revenue columns"
  artifacts:
    - path: "frontend/src/lib/admin.ts"
      provides: "Admin fetch functions and TanStack Query key factory"
      exports: ["adminKeys", "fetchSalesSummary", "fetchTopBooks", "fetchLowStock", "SalesSummaryResponse", "TopBooksResponse", "LowStockResponse"]
    - path: "frontend/src/app/admin/overview/page.tsx"
      provides: "Dashboard overview page with KPI cards, period selector, low-stock card, and top-5 table"
      contains: "useQuery"
  key_links:
    - from: "frontend/src/app/admin/overview/page.tsx"
      to: "frontend/src/lib/admin.ts"
      via: "import fetchSalesSummary, fetchTopBooks, fetchLowStock, adminKeys"
      pattern: "import.*from.*lib/admin"
    - from: "frontend/src/lib/admin.ts"
      to: "/admin/analytics/sales/summary"
      via: "apiFetch with Bearer token"
      pattern: "apiFetch.*admin/analytics/sales/summary"
    - from: "frontend/src/app/admin/overview/page.tsx"
      to: "TanStack Query"
      via: "useQuery with adminKeys.sales.summary(period)"
      pattern: "adminKeys\\.sales\\.summary.*period"
---

<objective>
Create the admin API fetch layer with typed functions and query key namespace, then build the dashboard overview page with KPI cards, period selector, delta badges, low-stock card, and top-5 best-sellers mini-table.

Purpose: Establishes the data layer pattern (adminKeys + typed fetch) that all admin pages reuse, and delivers the first visible admin feature — the dashboard overview with real API data.

Output: `src/lib/admin.ts` with fetch functions and query keys; `/admin/overview` page with interactive KPI cards and top-sellers table.
</objective>

<execution_context>
@C:/Users/Sushasan/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Sushasan/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/26-admin-foundation/26-CONTEXT.md
@.planning/phases/26-admin-foundation/26-RESEARCH.md
@.planning/phases/26-admin-foundation/26-01-SUMMARY.md

<interfaces>
<!-- Key types and contracts the executor needs. Extracted from codebase and research. -->

From frontend/src/lib/api.ts:
```typescript
const API_BASE = process.env.NEXT_PUBLIC_API_URL ?? 'http://localhost:8000'
export class ApiError extends Error {
  constructor(message: string, public status: number, public detail?: string, public data?: unknown)
}
export async function apiFetch<T>(path: string, options?: RequestInit): Promise<T>
```

From frontend/src/auth.ts (session shape):
```typescript
// session.accessToken — JWT for Authorization header
// session.user.role — 'admin' | 'user'
interface Session {
  accessToken: string
  user: { id: string; role: string; email?: string; name?: string }
}
```

From backend analytics_schemas.py (response shapes):
```typescript
// GET /admin/analytics/sales/summary?period=today|week|month
type SalesSummaryResponse = {
  period: string          // "today" | "week" | "month"
  revenue: number         // float
  order_count: number     // int
  aov: number             // float (0.0 when no orders)
  delta_percentage: number | null  // null when prior period has no revenue
}

// GET /admin/analytics/sales/top-books?sort_by=revenue&limit=5
type TopBooksResponse = {
  sort_by: string         // "revenue" | "volume"
  items: Array<{
    book_id: number
    title: string
    author: string
    total_revenue: number
    units_sold: number
  }>
}

// GET /admin/analytics/inventory/low-stock?threshold=10
type LowStockResponse = {
  threshold: number
  total_low_stock: number  // count for the KPI card
  items: Array<{
    book_id: number
    title: string
    author: string
    current_stock: number
    threshold: number
  }>
}
```

Existing shadcn components available:
```typescript
// Card, CardContent, CardHeader, CardTitle — for KPI cards
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card'
// Badge — for delta indicators
import { Badge } from '@/components/ui/badge'
// Button — for period selector segmented buttons
import { Button } from '@/components/ui/button'
// Skeleton — for loading states
import { Skeleton } from '@/components/ui/skeleton'
```

User decisions (locked):
- 4 cards in a single row: Revenue, Orders, AOV, Low Stock (responsive stacking)
- Period selector: segmented button group (Today | This Week | This Month), right-aligned with heading
- Delta: green "▲ 12.3%" for positive, red "▼ 2.4%" for negative, grey "— 0%" for flat
- Currency: whole dollars with comma separators ($12,450) — no cents
- Low-stock card: same shape/size, amber/warning accent, count + link to Inventory Alerts
- Top-5 mini-table: Rank, Title, Author, Revenue columns
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Admin fetch layer and query key namespace</name>
  <files>frontend/src/lib/admin.ts</files>
  <action>
Create `frontend/src/lib/admin.ts` with three sections: query key factory, TypeScript types, and fetch functions.

**Section 1: Query key factory (adminKeys)**

```typescript
export const adminKeys = {
  all: ['admin'] as const,
  sales: {
    all: ['admin', 'sales'] as const,
    summary: (period: string) => ['admin', 'sales', 'summary', period] as const,
    topBooks: (limit: number, sortBy: string = 'revenue') =>
      ['admin', 'sales', 'top-books', sortBy, limit] as const,
  },
  inventory: {
    all: ['admin', 'inventory'] as const,
    lowStock: (threshold: number) =>
      ['admin', 'inventory', 'low-stock', threshold] as const,
  },
  // Placeholder keys for future phases (27-29) — add here as needed
  catalog: {
    all: ['admin', 'catalog'] as const,
  },
  users: {
    all: ['admin', 'users'] as const,
  },
  reviews: {
    all: ['admin', 'reviews'] as const,
  },
} as const
```

Hierarchical structure enables scoped invalidation: `queryClient.invalidateQueries({ queryKey: adminKeys.all })` clears ALL admin cache. `queryClient.invalidateQueries({ queryKey: adminKeys.sales.all })` clears only sales cache.

**Section 2: TypeScript types mirroring backend response schemas**

Define the three response types exactly matching `backend/app/admin/analytics_schemas.py`:

```typescript
export type SalesSummaryResponse = {
  period: string
  revenue: number
  order_count: number
  aov: number
  delta_percentage: number | null
}

export type TopBookEntry = {
  book_id: number
  title: string
  author: string
  total_revenue: number
  units_sold: number
}

export type TopBooksResponse = {
  sort_by: string
  items: TopBookEntry[]
}

export type LowStockEntry = {
  book_id: number
  title: string
  author: string
  current_stock: number
  threshold: number
}

export type LowStockResponse = {
  threshold: number
  total_low_stock: number
  items: LowStockEntry[]
}
```

**Section 3: Fetch functions — all require accessToken**

```typescript
import { apiFetch } from '@/lib/api'

export async function fetchSalesSummary(
  accessToken: string,
  period: 'today' | 'week' | 'month'
): Promise<SalesSummaryResponse> {
  return apiFetch<SalesSummaryResponse>(
    `/admin/analytics/sales/summary?period=${period}`,
    { headers: { Authorization: `Bearer ${accessToken}` } }
  )
}

export async function fetchTopBooks(
  accessToken: string,
  limit: number = 5,
  sortBy: 'revenue' | 'volume' = 'revenue'
): Promise<TopBooksResponse> {
  return apiFetch<TopBooksResponse>(
    `/admin/analytics/sales/top-books?sort_by=${sortBy}&limit=${limit}`,
    { headers: { Authorization: `Bearer ${accessToken}` } }
  )
}

export async function fetchLowStock(
  accessToken: string,
  threshold: number = 10
): Promise<LowStockResponse> {
  return apiFetch<LowStockResponse>(
    `/admin/analytics/inventory/low-stock?threshold=${threshold}`,
    { headers: { Authorization: `Bearer ${accessToken}` } }
  )
}
```

**CRITICAL:** All `/admin/analytics/*` endpoints enforce `require_admin` in FastAPI — they return 403 without a valid Bearer token. The `accessToken` from `session.accessToken` MUST be passed as `Authorization: Bearer ${accessToken}`. Do NOT omit this header.

The `apiFetch` utility already sets `Content-Type: application/json` and handles error responses. The `{ headers: { Authorization: ... } }` will be spread-merged with the defaults by `apiFetch`.
  </action>
  <verify>
    <automated>cd D:/Python/claude-test/frontend && npx tsc --noEmit --pretty 2>&1 | tail -20</automated>
  </verify>
  <done>
    - admin.ts exports adminKeys, SalesSummaryResponse, TopBooksResponse, LowStockResponse, fetchSalesSummary, fetchTopBooks, fetchLowStock
    - Query keys are hierarchical with ['admin'] as root prefix
    - All fetch functions require accessToken parameter and pass it as Bearer token
    - TypeScript compiles without errors
  </done>
</task>

<task type="auto">
  <name>Task 2: Dashboard overview page with KPI cards, period selector, and top-5 table</name>
  <files>frontend/src/app/admin/overview/page.tsx</files>
  <action>
Create `frontend/src/app/admin/overview/page.tsx` as a Client Component with three sections: KPI card row with period selector, low-stock quick-link card, and top-5 best-sellers mini-table.

**Page structure:**

```
┌─────────────────────────────────────────────────────────────────┐
│ Dashboard Overview                 [Today] [This Week] [Month] │  ← heading + period selector
├──────────┬──────────┬──────────┬──────────────────────────────┤
│ Revenue  │ Orders   │ AOV      │ Low Stock ⚠                  │  ← 4 KPI cards in a row
│ $12,450  │ 47       │ $265     │ 3 books                      │
│ ▲ 12.3%  │ ▼ 2.4%  │ — 0%    │ View Inventory →             │
├──────────┴──────────┴──────────┴──────────────────────────────┤
│ Top 5 Best Sellers                                             │  ← mini-table
│ Rank | Title        | Author      | Revenue                    │
│ 1    | The Great... | F. Scott... | $4,230                     │
│ ...                                                            │
└─────────────────────────────────────────────────────────────────┘
```

**Component details:**

1. **Period state and queries:**
   - `useState<'today' | 'week' | 'month'>('today')` for period selection
   - `useSession()` to get `session.accessToken`
   - Three `useQuery` calls:
     - `adminKeys.sales.summary(period)` → `fetchSalesSummary(accessToken, period)` — refetches on period change
     - `adminKeys.sales.topBooks(5, 'revenue')` → `fetchTopBooks(accessToken, 5, 'revenue')` — static query (not period-dependent on overview page)
     - `adminKeys.inventory.lowStock(10)` → `fetchLowStock(accessToken, 10)` — static query
   - All queries: `enabled: !!accessToken`, `staleTime: 60_000` (60 seconds)

2. **Page heading with period selector:**
   - `<h1>Dashboard Overview</h1>` styled with `text-2xl font-bold tracking-tight`
   - Period selector: three `Button` components in a flex container, right-aligned
   - Active period button uses `variant="default"`, inactive uses `variant="outline"`
   - Clicking a button calls `setPeriod(...)` which changes the query key and triggers refetch

3. **KPI cards row (4 cards):**
   - Grid layout: `grid grid-cols-1 gap-4 sm:grid-cols-2 lg:grid-cols-4` (responsive stacking)
   - Revenue card: CardTitle "Revenue", CardContent shows formatted currency, DeltaBadge below
   - Orders card: CardTitle "Orders", CardContent shows `order_count`, DeltaBadge below
   - AOV card: CardTitle "Avg. Order Value", CardContent shows formatted currency, DeltaBadge below
   - Low-stock card: Same Card shape but with amber accent (`border-amber-500/50 bg-amber-50 dark:bg-amber-950/20`), shows `total_low_stock` count + "View Inventory" link to `/admin/inventory`

4. **DeltaBadge helper component (inline or extracted):**
   ```typescript
   function DeltaBadge({ delta }: { delta: number | null }) {
     if (delta === null || delta === 0) {
       return <span className="text-sm text-muted-foreground">— 0%</span>
     }
     if (delta > 0) {
       return <span className="text-sm text-green-600 dark:text-green-400">▲ {delta.toFixed(1)}%</span>
     }
     return <span className="text-sm text-red-600 dark:text-red-400">▼ {Math.abs(delta).toFixed(1)}%</span>
   }
   ```

5. **Currency formatter:**
   ```typescript
   function formatCurrency(value: number): string {
     return `$${Math.round(value).toLocaleString('en-US')}`
   }
   ```
   Produces `$12,450` (no cents, comma separators) per user decision.

6. **Top-5 best-sellers mini-table:**
   - Below the card row, in a `Card` container with `CardHeader` title "Top 5 Best Sellers"
   - Simple HTML `<table>` (NOT a DataTable — that's Phase 28):
     - Columns: Rank (#), Title, Author, Revenue
     - Rank is the 1-based index
     - Revenue formatted with `formatCurrency()`
     - Title truncated with `truncate` class if too long
   - Style with `w-full text-sm` and `border-b` between rows
   - Table header cells: `text-left font-medium text-muted-foreground`

7. **Loading states:**
   - While `summaryQuery.isLoading`, show 3 Skeleton cards (same card shape, with `Skeleton` for title and content)
   - While `topBooksQuery.isLoading`, show Skeleton rows in the table area
   - While `lowStockQuery.isLoading`, show Skeleton in the low-stock card

8. **Error states:**
   - If any query has `isError`, show a subtle error message inside the card: `text-destructive text-sm` with "Failed to load" message
   - Do NOT show a full-page error — individual cards fail gracefully

**IMPORTANT — AOV calculation note:**
The backend returns `aov: 0.0` when there are no orders. Display `$0` in that case — do not divide or compute AOV on the frontend. The backend already computes it.

**IMPORTANT — delta_percentage note:**
The backend returns `null` when the prior period has no revenue (can't compute percentage change). Display as grey dash `— 0%` per user decision. Do NOT attempt to calculate delta on the frontend.
  </action>
  <verify>
    <automated>cd D:/Python/claude-test/frontend && npx next build 2>&1 | tail -20</automated>
  </verify>
  <done>
    - /admin/overview renders a Dashboard Overview heading with period selector (Today, This Week, This Month)
    - 4 KPI cards display in a responsive grid: Revenue, Orders, AOV, Low Stock
    - Switching period re-fetches sales summary data via TanStack Query
    - Delta badges show colored arrows: green up for positive, red down for negative, grey dash for flat/null
    - Currency formatted as whole dollars with comma separators
    - Low-stock card has amber accent and links to /admin/inventory
    - Top-5 best-sellers mini-table shows Rank, Title, Author, Revenue columns
    - Loading states use Skeleton components
    - Error states show graceful per-card error messages
    - `next build` succeeds
  </done>
</task>

</tasks>

<verification>
1. `cd frontend && npx next build` — must succeed
2. `npx tsc --noEmit` — no type errors in admin.ts or overview/page.tsx
3. adminKeys factory produces hierarchical query keys with ['admin'] root
4. Period selector changes query key → triggers refetch → KPI values update
5. DeltaBadge renders correct colors for positive/negative/null values
6. Low-stock card has amber styling and links to /admin/inventory
7. Top-5 table renders 5 rows with Rank, Title, Author, Revenue
8. Loading/error states handled gracefully per card
</verification>

<success_criteria>
- admin.ts exports typed fetch functions + adminKeys namespace
- Dashboard overview page renders KPI cards with real API data
- Period selector toggles between Today/Week/Month and re-fetches
- Delta badges use correct colors per user specification
- Low-stock card is visually distinct (amber) and links to inventory
- Top-5 mini-table is visible on the overview page
- Build and type-check pass
</success_criteria>

<output>
After completion, create `.planning/phases/26-admin-foundation/26-02-SUMMARY.md`
</output>
