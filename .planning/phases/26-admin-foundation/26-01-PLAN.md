---
phase: 26-admin-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - frontend/src/app/layout.tsx
  - frontend/src/app/(store)/layout.tsx
  - frontend/src/app/(store)/page.tsx
  - frontend/src/proxy.ts
  - frontend/src/app/admin/layout.tsx
  - frontend/src/app/admin/page.tsx
  - frontend/src/components/admin/AppSidebar.tsx
  - frontend/src/components/admin/SidebarFooterUser.tsx
  - frontend/src/components/layout/UserMenu.tsx
  - frontend/src/components/ui/sidebar.tsx
autonomous: true
requirements:
  - ADMF-01
  - ADMF-02
  - ADMF-03
  - ADMF-04

must_haves:
  truths:
    - "Admin visiting /admin sees a sidebar layout with Overview, Sales, Catalog, Users, Reviews navigation — customer Header and Footer do not appear"
    - "Non-admin user navigating to /admin is silently redirected to / — no error message, no toast"
    - "Admin sidebar highlights the currently active section based on the URL path"
    - "Sidebar collapses to icon-only mode on toggle and expands back with labels"
    - "Customer storefront pages (/, /catalog, /books, etc.) still render with Header and Footer"
    - "Admin link appears in UserMenu dropdown only for admin-role users"
  artifacts:
    - path: "frontend/src/app/(store)/layout.tsx"
      provides: "Customer layout with Header + Footer wrapper"
      contains: "Header"
    - path: "frontend/src/app/admin/layout.tsx"
      provides: "Admin layout with auth() role check and SidebarProvider"
      contains: "auth()"
    - path: "frontend/src/components/admin/AppSidebar.tsx"
      provides: "Admin sidebar with navigation items and active state detection"
      contains: "usePathname"
    - path: "frontend/src/components/admin/SidebarFooterUser.tsx"
      provides: "User info and sign-out button in sidebar footer"
      contains: "useSession"
    - path: "frontend/src/proxy.ts"
      provides: "Middleware with admin role check added"
      contains: "admin"
  key_links:
    - from: "frontend/src/proxy.ts"
      to: "/admin routes"
      via: "adminPrefixes role check"
      pattern: "pathname\\.startsWith.*admin"
    - from: "frontend/src/app/admin/layout.tsx"
      to: "auth()"
      via: "Server Component role check — defense-in-depth"
      pattern: "session\\.user\\.role.*admin"
    - from: "frontend/src/components/admin/AppSidebar.tsx"
      to: "usePathname()"
      via: "isActive prop on SidebarMenuButton"
      pattern: "pathname\\.startsWith.*item\\.href"
---

<objective>
Restructure the Next.js app into route groups so admin and customer sections have independent layouts, install the shadcn sidebar component, build the admin layout shell with defense-in-depth role protection, and add an admin link to the customer UserMenu.

Purpose: Establishes the structural foundation that all admin pages (Phases 26-29) depend on — separate layout hierarchy, sidebar navigation, and two-layer security gate.

Output: Route group restructure complete, admin layout with sidebar renders at /admin, proxy.ts enforces admin role, UserMenu shows admin link for admin users.
</objective>

<execution_context>
@C:/Users/Sushasan/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Sushasan/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/26-admin-foundation/26-CONTEXT.md
@.planning/phases/26-admin-foundation/26-RESEARCH.md

<interfaces>
<!-- Key types and contracts the executor needs. Extracted from codebase. -->

From frontend/src/auth.ts:
```typescript
// Session includes accessToken, user.id, user.role
declare module "next-auth" {
  interface Session {
    accessToken: string
    error?: string
    user: { id: string; role: string } & DefaultSession["user"]
  }
}
// auth() export for Server Components
export const { handlers, auth, signIn, signOut } = NextAuth({ ... })
```

From frontend/src/proxy.ts:
```typescript
// Current protected prefixes — admin prefix NOT yet included
const protectedPrefixes = ["/account", "/orders", "/checkout", "/wishlist", "/prebook", "/cart"]
const authOnlyPaths = ["/login", "/register"]
export const proxy = auth((req) => { ... })
export const config = { matcher: ["/((?!api|_next/static|_next/image|favicon.ico).*)"] }
```

From frontend/src/app/layout.tsx (CURRENT — will be restructured):
```typescript
// Currently: html + body + Providers + Header + main + Footer all in root layout
// AFTER: root becomes Providers-only; Header/Footer move to (store)/layout.tsx
export default function RootLayout({ children }) {
  return (
    <html><body>
      <Providers>
        <div><Header /><main>{children}</main><Footer /></div>
      </Providers>
    </body></html>
  )
}
```

From frontend/src/components/providers.tsx:
```typescript
// Providers includes SessionProvider, QueryClientProvider, ThemeProvider, AuthGuard, Toaster
export function Providers({ children }: { children: React.ReactNode })
```

From frontend/src/components/layout/Header.tsx:
```typescript
export function Header()
```

From frontend/src/components/layout/Footer.tsx:
```typescript
export function Footer()
```

From frontend/src/components/layout/UserMenu.tsx:
```typescript
// Client component using useSession() — shows Sign In / email + Sign Out
export function UserMenu()
```

Existing app directory structure:
```
frontend/src/app/
├── layout.tsx          # Root layout (to be restructured)
├── page.tsx            # Home page (to move into (store)/)
├── not-found.tsx       # 404 page (stays at root)
├── globals.css         # Styles (stays at root)
├── favicon.ico
├── (auth)/             # Login/register route group (stays — no Header/Footer after restructure is OK)
│   └── layout.tsx      # Centered form layout
├── account/            # Customer pages — all move to (store)/
├── books/
├── cart/
├── catalog/
├── orders/
├── wishlist/
└── api/                # API routes (stays at root, NOT moved)
```
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Route group restructure and shadcn sidebar install</name>
  <files>
    frontend/src/app/layout.tsx,
    frontend/src/app/(store)/layout.tsx,
    frontend/src/app/(store)/page.tsx,
    frontend/src/components/ui/sidebar.tsx
  </files>
  <action>
**Step 1: Install shadcn sidebar component.**

Run from frontend/ directory:
```bash
npx shadcn@latest add sidebar
```
This installs `components/ui/sidebar.tsx` and its peer dependencies (tooltip, collapsible). If tooltip.tsx or collapsible.tsx don't appear in components/ui/ after install, run them separately:
```bash
npx shadcn@latest add tooltip collapsible
```

**Step 2: Restructure root layout to Providers-only shell.**

Edit `frontend/src/app/layout.tsx` to remove Header, Footer, and the inner div wrapper. Root layout becomes:

```typescript
import type { Metadata } from 'next'
import { Providers } from '@/components/providers'
import './globals.css'

export const metadata: Metadata = {
  title: { default: 'Bookstore', template: '%s | Bookstore' },
  description: 'Discover and purchase books from our curated catalog',
}

export default function RootLayout({
  children,
}: Readonly<{ children: React.ReactNode }>) {
  return (
    <html lang="en" suppressHydrationWarning>
      <body className="min-h-screen bg-background font-sans antialiased">
        <Providers>{children}</Providers>
      </body>
    </html>
  )
}
```

Remove the Header and Footer imports. Remove the `div.relative.flex.min-h-screen.flex-col` wrapper.

**Step 3: Create (store) route group layout.**

Create `frontend/src/app/(store)/layout.tsx`:

```typescript
import { Header } from '@/components/layout/Header'
import { Footer } from '@/components/layout/Footer'

export default function StoreLayout({
  children,
}: {
  children: React.ReactNode
}) {
  return (
    <div className="relative flex min-h-screen flex-col">
      <Header />
      <main className="flex-1">{children}</main>
      <Footer />
    </div>
  )
}
```

This takes the exact `div > Header + main + Footer` structure that was previously in the root layout.

**Step 4: Move customer pages into (store)/ route group.**

Move the following directories/files into the `(store)/` route group using `git mv` to preserve history:

```bash
cd frontend/src/app
git mv page.tsx "(store)/page.tsx"
git mv account "(store)/account"
git mv books "(store)/books"
git mv cart "(store)/cart"
git mv catalog "(store)/catalog"
git mv orders "(store)/orders"
git mv wishlist "(store)/wishlist"
```

**CRITICAL: Do NOT move these:**
- `(auth)/` — stays at root level (auth pages don't need Header/Footer — they have their own centered layout)
- `api/` — stays at root level (API routes)
- `not-found.tsx` — stays at root level (global 404)
- `globals.css` — stays at root level (imported by root layout)
- `favicon.ico` — stays at root level
- `layout.tsx` — stays at root level (already modified in Step 2)

**IMPORTANT URL note:** Route groups don't change URLs. After this move:
- `/` still works (from `(store)/page.tsx`)
- `/catalog` still works (from `(store)/catalog/`)
- `/login` still works (from `(auth)/login/`)
- Auth pages will no longer show Header/Footer — this is intentional. The `(auth)/layout.tsx` provides its own centered layout that looks clean without the store chrome.

**Step 5: Verify no duplicate routes.**

After the move, ensure `app/page.tsx` no longer exists at root level (only `(store)/page.tsx`). Having both would cause a "Conflicting paths" build error.
  </action>
  <verify>
    <automated>cd D:/Python/claude-test/frontend && npx next build 2>&1 | tail -20</automated>
  </verify>
  <done>
    - Root layout.tsx contains only html + body + Providers — no Header/Footer imports
    - (store)/layout.tsx wraps children with Header + main + Footer
    - All customer pages (page.tsx, account/, books/, cart/, catalog/, orders/, wishlist/) live inside (store)/
    - (auth)/, api/, not-found.tsx, globals.css remain at app root
    - sidebar.tsx exists in components/ui/
    - `next build` succeeds without route conflicts
  </done>
</task>

<task type="auto">
  <name>Task 2: Admin layout with defense-in-depth, sidebar, and proxy.ts role check</name>
  <files>
    frontend/src/proxy.ts,
    frontend/src/app/admin/layout.tsx,
    frontend/src/app/admin/page.tsx,
    frontend/src/components/admin/AppSidebar.tsx,
    frontend/src/components/admin/SidebarFooterUser.tsx,
    frontend/src/components/layout/UserMenu.tsx
  </files>
  <action>
**Step 1: Add admin role check to proxy.ts (Layer 1 — UX redirect).**

Modify `frontend/src/proxy.ts` to add admin route protection. Add an `adminPrefixes` array and a role check block after the existing protected-route check:

```typescript
import { auth } from "@/auth"
import { NextResponse } from "next/server"

const protectedPrefixes = ["/account", "/orders", "/checkout", "/wishlist", "/prebook", "/cart"]
const adminPrefixes = ["/admin"]
const authOnlyPaths = ["/login", "/register"]

export const proxy = auth((req) => {
  const isLoggedIn = !!req.auth
  const { pathname } = req.nextUrl

  // Protected routes require authentication
  const isProtected = protectedPrefixes.some((p) => pathname.startsWith(p))
  if (isProtected && !isLoggedIn) {
    const url = new URL("/login", req.nextUrl.origin)
    url.searchParams.set("callbackUrl", pathname)
    return NextResponse.redirect(url)
  }

  // Admin routes require admin role — silent redirect to / (don't reveal route exists)
  const isAdminRoute = adminPrefixes.some((p) => pathname.startsWith(p))
  if (isAdminRoute) {
    if (!isLoggedIn) {
      return NextResponse.redirect(new URL("/", req.nextUrl.origin))
    }
    if (req.auth?.user?.role !== "admin") {
      return NextResponse.redirect(new URL("/", req.nextUrl.origin))
    }
  }

  // Redirect authenticated users away from auth pages
  const isAuthPage = authOnlyPaths.some((p) => pathname === p)
  if (isAuthPage && isLoggedIn) {
    return NextResponse.redirect(new URL("/", req.nextUrl.origin))
  }

  return NextResponse.next()
})

export const config = {
  matcher: ["/((?!api|_next/static|_next/image|favicon.ico).*)"],
}
```

Note: proxy.ts uses `req.auth?.user?.role` which is available because the NextAuth `auth()` wrapper populates `req.auth` from the session. The `role` field is set in the JWT callback in auth.ts.

**IMPORTANT: The proxy.ts middleware is NOT currently wired as Next.js middleware.** There is no `middleware.ts` file that re-exports from proxy.ts. Check if a `frontend/src/middleware.ts` or `frontend/middleware.ts` exists. If NOT, create one:

```typescript
// frontend/src/middleware.ts
export { proxy as middleware, config } from './proxy'
```

This connects proxy.ts to Next.js middleware. Without this file, the proxy.ts role check never runs. If middleware.ts already exists, skip this step.

**Step 2: Create admin layout with defense-in-depth role check (Layer 2 — real security boundary).**

Create `frontend/src/app/admin/layout.tsx` as a Server Component:

```typescript
import { auth } from '@/auth'
import { redirect } from 'next/navigation'
import { SidebarProvider, SidebarInset, SidebarTrigger } from '@/components/ui/sidebar'
import { AppSidebar } from '@/components/admin/AppSidebar'

export default async function AdminLayout({
  children,
}: {
  children: React.ReactNode
}) {
  // Layer 2: Real security boundary — NOT reliant on middleware
  // Defense-in-depth against CVE-2025-29927 (middleware bypass)
  const session = await auth()
  if (!session?.user || session.user.role !== 'admin') {
    redirect('/')
  }

  return (
    <SidebarProvider>
      <AppSidebar />
      <SidebarInset>
        <header className="flex h-14 items-center gap-2 border-b px-4">
          <SidebarTrigger />
        </header>
        <div className="flex-1 overflow-y-auto p-6">
          {children}
        </div>
      </SidebarInset>
    </SidebarProvider>
  )
}
```

Key points:
- `auth()` reads session cookie directly — does NOT rely on middleware state
- `redirect('/')` is a silent redirect — no error message (per user decision)
- `SidebarProvider` wraps the entire admin area so all children can use `useSidebar()`
- `SidebarInset` handles responsive margin when sidebar expands/collapses
- `SidebarTrigger` is the hamburger/toggle button in the admin header bar

**Step 3: Create admin index redirect page.**

Create `frontend/src/app/admin/page.tsx`:

```typescript
import { redirect } from 'next/navigation'

export default function AdminPage() {
  redirect('/admin/overview')
}
```

This ensures `/admin` redirects to `/admin/overview` (the dashboard page created in Plan 02).

**Step 4: Create AppSidebar component.**

Create `frontend/src/components/admin/AppSidebar.tsx` as a Client Component:

```typescript
'use client'

import { usePathname } from 'next/navigation'
import Link from 'next/link'
import {
  Sidebar,
  SidebarContent,
  SidebarHeader,
  SidebarFooter,
  SidebarMenu,
  SidebarMenuItem,
  SidebarMenuButton,
  SidebarGroup,
  SidebarGroupContent,
} from '@/components/ui/sidebar'
import {
  LayoutDashboard,
  TrendingUp,
  BookOpen,
  Users,
  Star,
  ChevronLeft,
} from 'lucide-react'
import { Badge } from '@/components/ui/badge'
import { SidebarFooterUser } from './SidebarFooterUser'

const navItems = [
  { href: '/admin/overview', label: 'Overview', icon: LayoutDashboard },
  { href: '/admin/sales', label: 'Sales', icon: TrendingUp },
  { href: '/admin/catalog', label: 'Catalog', icon: BookOpen },
  { href: '/admin/users', label: 'Users', icon: Users },
  { href: '/admin/reviews', label: 'Reviews', icon: Star },
]

export function AppSidebar() {
  const pathname = usePathname()

  return (
    <Sidebar collapsible="icon">
      <SidebarHeader>
        <div className="flex items-center gap-2 px-2 py-1.5">
          <BookOpen className="h-5 w-5 shrink-0" />
          <span className="font-bold text-lg group-data-[collapsible=icon]:hidden">
            BookStore
          </span>
          <Badge
            variant="secondary"
            className="text-xs group-data-[collapsible=icon]:hidden"
          >
            Admin
          </Badge>
        </div>
        <SidebarMenu>
          <SidebarMenuItem>
            <SidebarMenuButton asChild tooltip="Back to Store">
              <Link href="/">
                <ChevronLeft className="h-4 w-4" />
                <span>Back to Store</span>
              </Link>
            </SidebarMenuButton>
          </SidebarMenuItem>
        </SidebarMenu>
      </SidebarHeader>

      <SidebarContent>
        <SidebarGroup>
          <SidebarGroupContent>
            <SidebarMenu>
              {navItems.map((item) => (
                <SidebarMenuItem key={item.href}>
                  <SidebarMenuButton
                    asChild
                    isActive={pathname.startsWith(item.href)}
                    tooltip={item.label}
                  >
                    <Link href={item.href}>
                      <item.icon className="h-4 w-4" />
                      <span>{item.label}</span>
                    </Link>
                  </SidebarMenuButton>
                </SidebarMenuItem>
              ))}
            </SidebarMenu>
          </SidebarGroupContent>
        </SidebarGroup>
      </SidebarContent>

      <SidebarFooter>
        <SidebarFooterUser />
      </SidebarFooter>
    </Sidebar>
  )
}
```

Key points:
- `collapsible="icon"` enables the expand/collapse toggle with icon-only mode
- `isActive={pathname.startsWith(item.href)}` highlights current nav section (ADMF-04)
- `tooltip={item.label}` shows label as tooltip when collapsed to icon mode
- `group-data-[collapsible=icon]:hidden` hides text elements when sidebar is in icon mode — this is the shadcn Sidebar convention for responsive text
- "Back to Store" link navigates to `/` — full page reload is expected (different layout hierarchy)
- `BookOpen` icon used for branding (a book icon matching the bookstore theme); user decision says branding at top with "BookStore" + "Admin" badge

**Step 5: Create SidebarFooterUser component.**

Create `frontend/src/components/admin/SidebarFooterUser.tsx` as a Client Component:

```typescript
'use client'

import { useSession, signOut } from 'next-auth/react'
import {
  SidebarMenu,
  SidebarMenuItem,
  SidebarMenuButton,
} from '@/components/ui/sidebar'
import { LogOut, User } from 'lucide-react'

export function SidebarFooterUser() {
  const { data: session } = useSession()
  const email = session?.user?.email ?? ''

  return (
    <SidebarMenu>
      <SidebarMenuItem>
        <SidebarMenuButton tooltip={email}>
          <User className="h-4 w-4 shrink-0" />
          <span className="truncate text-sm">{email}</span>
        </SidebarMenuButton>
      </SidebarMenuItem>
      <SidebarMenuItem>
        <SidebarMenuButton
          onClick={() => signOut({ callbackUrl: '/' })}
          tooltip="Sign Out"
        >
          <LogOut className="h-4 w-4" />
          <span>Sign Out</span>
        </SidebarMenuButton>
      </SidebarMenuItem>
    </SidebarMenu>
  )
}
```

Key points:
- Uses `useSession()` (client hook) not `auth()` (server function) — this is a Client Component
- `tooltip` prop on SidebarMenuButton shows the email/label when sidebar is collapsed to icon mode
- `signOut({ callbackUrl: '/' })` redirects to store homepage after sign out
- The shadcn Sidebar automatically hides `<span>` text inside `SidebarMenuButton` when collapsed — no need for manual `useSidebar()` state checks. The `group-data-[collapsible=icon]` CSS selector handles this.

**Step 6: Add admin link to UserMenu.**

Modify `frontend/src/components/layout/UserMenu.tsx` to add an "Admin" link visible only for admin-role users. In the authenticated state block, add a conditional admin link before the Sign Out button:

```typescript
'use client'

import { useEffect, useState } from 'react'
import Link from 'next/link'
import { useSession, signOut } from 'next-auth/react'
import { Button } from '@/components/ui/button'

export function UserMenu() {
  const { data: session, status } = useSession()
  const [mounted, setMounted] = useState(false)

  useEffect(() => {
    setMounted(true)
  }, [])

  if (!mounted) return null

  if (status === 'loading') {
    return (
      <div className="h-8 w-20 animate-pulse rounded-md bg-muted" aria-hidden="true" />
    )
  }

  if (status === 'unauthenticated') {
    return (
      <Link href="/login">
        <Button variant="ghost" size="sm">
          Sign In
        </Button>
      </Link>
    )
  }

  const email = session?.user?.email ?? ''
  const truncatedEmail = email.length > 20 ? `${email.slice(0, 17)}...` : email
  const isAdmin = session?.user?.role === 'admin'

  return (
    <div className="flex items-center gap-2">
      <span
        className="hidden text-sm text-muted-foreground sm:block"
        title={email}
      >
        {truncatedEmail}
      </span>
      {isAdmin && (
        <Link href="/admin">
          <Button variant="ghost" size="sm">
            Admin
          </Button>
        </Link>
      )}
      <Button
        variant="ghost"
        size="sm"
        onClick={() => signOut({ callbackUrl: '/' })}
      >
        Sign Out
      </Button>
    </div>
  )
}
```

Per user decision: admin link is in UserMenu dropdown area, only visible for admin-role users — NOT in main Header nav.
  </action>
  <verify>
    <automated>cd D:/Python/claude-test/frontend && npx next build 2>&1 | tail -20</automated>
  </verify>
  <done>
    - proxy.ts includes admin role check that silently redirects non-admins to /
    - middleware.ts exists and re-exports proxy as middleware (if it didn't exist before)
    - admin/layout.tsx is a Server Component that independently calls auth() and checks role — defense-in-depth
    - admin/page.tsx redirects to /admin/overview
    - AppSidebar renders 5 nav items (Overview, Sales, Catalog, Users, Reviews) with icons
    - AppSidebar uses collapsible="icon" for expand/collapse toggle
    - Active sidebar item is highlighted based on pathname
    - SidebarFooterUser shows user email and sign out button
    - UserMenu shows "Admin" button only for admin-role users
    - `next build` succeeds
  </done>
</task>

</tasks>

<verification>
1. `cd frontend && npx next build` — must succeed without errors
2. Customer routes (/, /catalog, /books/[id], /cart, /orders, /account, /wishlist) must render with Header and Footer
3. Auth routes (/login, /register) render without Header/Footer (intentional — they have their own centered layout)
4. /admin requires admin role at both proxy.ts and layout Server Component levels
5. /admin/page.tsx redirects to /admin/overview
6. Sidebar has 5 navigation items with correct icons and active state detection
7. Sidebar toggle collapses to icon-only mode and expands back
8. UserMenu shows "Admin" link only for admin-role users
</verification>

<success_criteria>
- Build passes without errors
- Route group restructure preserves all existing customer URLs
- Admin layout is completely separate from customer storefront (no Header/Footer)
- Two-layer security: proxy.ts (UX) + admin/layout.tsx (real boundary)
- Sidebar is collapsible with icon mode, active highlighting, and user footer
- Admin link conditionally visible in customer UserMenu
</success_criteria>

<output>
After completion, create `.planning/phases/26-admin-foundation/26-01-SUMMARY.md`
</output>
