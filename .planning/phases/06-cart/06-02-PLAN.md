---
phase: 06-cart
plan: 02
type: tdd
wave: 2
depends_on:
  - "06-01"
files_modified:
  - tests/test_cart.py
autonomous: true
requirements:
  - COMM-01
  - COMM-02

must_haves:
  truths:
    - "Tests prove user can add a book to cart and see it via GET /cart (COMM-01)"
    - "Tests prove user can update cart item quantity via PUT (COMM-02)"
    - "Tests prove user can remove cart item via DELETE (COMM-02)"
    - "Tests prove adding out-of-stock book returns 409 (COMM-01 edge case)"
    - "Tests prove cart persists across sessions — logout and re-login shows same cart"
    - "Tests prove ownership enforcement — user cannot modify another user's cart items"
  artifacts:
    - path: "tests/test_cart.py"
      provides: "Integration tests covering COMM-01 and COMM-02"
      min_lines: 150
  key_links:
    - from: "tests/test_cart.py"
      to: "app/cart/router.py"
      via: "HTTP requests through AsyncClient"
      pattern: "client\\.(post|get|put|delete).*cart"
---

<objective>
Write integration tests for the cart feature covering all 4 endpoints and both requirements (COMM-01: add to cart, COMM-02: update/remove items). Tests verify happy paths, error cases, stock validation, ownership enforcement, and cross-session persistence.

Purpose: Prove COMM-01 and COMM-02 work end-to-end through the HTTP layer with real database transactions. TDD approach: write tests first (RED), then confirm they pass against the Plan 01 implementation (GREEN).

Output: `tests/test_cart.py` with 15+ test cases covering all cart behaviors.
</objective>

<execution_context>
@C:/Users/Sushasan/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Sushasan/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-cart/06-RESEARCH.md
@.planning/phases/06-cart/06-01-SUMMARY.md
@app/cart/router.py
@app/cart/service.py
@app/cart/schemas.py
@app/cart/models.py
@tests/conftest.py
@tests/test_catalog.py
@tests/test_discovery.py
</context>

<feature>
  <name>Cart API Integration Tests</name>
  <files>tests/test_cart.py</files>
  <behavior>
    COMM-01 — Add books to cart:
    - POST /cart/items {book_id, quantity} -> 201 with CartItemResponse (id, book_id, quantity, book summary)
    - POST /cart/items with out-of-stock book -> 409 CART_BOOK_OUT_OF_STOCK
    - POST /cart/items with nonexistent book_id -> 404 BOOK_NOT_FOUND
    - POST /cart/items with duplicate book_id -> 409 CART_ITEM_DUPLICATE
    - POST /cart/items with quantity=0 -> 422 validation error (ge=1)
    - GET /cart -> 200 with CartResponse (items, total_items, total_price)
    - GET /cart for new user (no cart) -> 200 with empty items list
    - GET /cart without auth -> 401

    COMM-02 — Update/remove items:
    - PUT /cart/items/{item_id} {quantity: 5} -> 200 with updated CartItemResponse
    - PUT /cart/items/{item_id} with nonexistent item -> 404
    - PUT /cart/items/{item_id} belonging to another user -> 403 CART_ITEM_FORBIDDEN
    - DELETE /cart/items/{item_id} -> 204
    - DELETE /cart/items/{item_id} with nonexistent item -> 404

    Cross-session persistence (COMM-01 success criteria #5):
    - Add item, login again with new token, GET /cart still shows item

    Computed fields:
    - total_items = sum of all item quantities
    - total_price = sum of (book.price * quantity) for each item
  </behavior>
  <implementation>
Create `tests/test_cart.py` following the established test patterns from test_catalog.py and test_discovery.py:

**Fixtures** (using pytest_asyncio.fixture):
- `user_headers(client, db_session)`: Create a regular user via UserRepository, login via /auth/login, return Bearer headers dict
- `other_user_headers(client, db_session)`: Create a second regular user for ownership tests
- `admin_headers(client, db_session)`: Create admin user for creating books (catalog endpoints require admin)
- `sample_book(client, admin_headers)`: Create a book via POST /books with stock_quantity > 0, return book dict (id, price, etc.)
- `out_of_stock_book(client, admin_headers)`: Create a book with stock_quantity=0

**Test functions** (no @pytest.mark.asyncio needed — asyncio_mode=auto):

COMM-01 tests:
1. `test_add_item_to_cart` — POST /cart/items, assert 201, response has id/book_id/quantity/book (with title, price)
2. `test_get_cart_with_items` — Add item, GET /cart, assert 200, items list contains the item, total_items and total_price correct
3. `test_get_cart_empty` — GET /cart without adding anything, assert 200, items=[], total_items=0, total_price=0
4. `test_get_cart_unauthenticated` — GET /cart without headers, assert 401
5. `test_add_item_out_of_stock` — POST /cart/items with out_of_stock_book, assert 409, code=CART_BOOK_OUT_OF_STOCK
6. `test_add_item_nonexistent_book` — POST /cart/items with book_id=99999, assert 404, code=BOOK_NOT_FOUND
7. `test_add_item_duplicate` — POST /cart/items twice with same book, second assert 409, code=CART_ITEM_DUPLICATE
8. `test_add_item_invalid_quantity` — POST /cart/items with quantity=0, assert 422

COMM-02 tests:
9. `test_update_item_quantity` — Add item, PUT /cart/items/{id} with new quantity, assert 200, quantity updated
10. `test_update_item_not_found` — PUT /cart/items/99999, assert 404
11. `test_update_item_forbidden` — User A adds item, User B tries PUT on that item_id, assert 403
12. `test_delete_item` — Add item, DELETE /cart/items/{id}, assert 204, GET /cart shows empty
13. `test_delete_item_not_found` — DELETE /cart/items/99999, assert 404

Cross-session and computed:
14. `test_cart_persists_across_sessions` — Add item, login again (POST /auth/login, get new token), GET /cart with new token shows item
15. `test_cart_totals_multiple_items` — Add 2 different books with different quantities, GET /cart, verify total_items and total_price are correct sums

**Key patterns:**
- Use `int(current_user["sub"])` implicitly through the auth flow — just pass Bearer headers
- Create books via admin HTTP endpoints (not direct DB insert) to ensure full stack
- Use `assert resp.json()["code"] == "CART_BOOK_OUT_OF_STOCK"` for error code checks — matches AppError JSON structure
- All tests are function-scoped with automatic rollback via conftest.py fixtures
  </implementation>
</feature>

<verification>
1. `poetry run pytest tests/test_cart.py -v` — all tests pass
2. `poetry run pytest tests/test_cart.py -v --tb=short` — no failures, no warnings
3. `poetry run pytest tests/ -v` — full suite passes (no regressions from Phase 1-5)
4. `poetry run ruff check tests/test_cart.py` — no lint errors
5. `poetry run ruff format --check tests/test_cart.py` — formatting clean
</verification>

<success_criteria>
- tests/test_cart.py exists with 15+ test functions
- All tests pass against the Plan 01 implementation
- COMM-01 covered: add to cart (happy + out-of-stock + duplicate + nonexistent book + validation)
- COMM-02 covered: update quantity (happy + not found + forbidden) and delete (happy + not found)
- Cross-session persistence test passes
- Ownership enforcement test (403) passes
- Full test suite (all phases) passes without regression
</success_criteria>

<output>
After completion, create `.planning/phases/06-cart/06-02-SUMMARY.md`
</output>
