---
phase: 20-auth-integration
plan: 03
type: execute
wave: 3
depends_on: ["20-02"]
files_modified: []
autonomous: false
requirements: [AUTH-01, AUTH-02, AUTH-03, AUTH-04, AUTH-05, AUTH-06, AUTH-07, AUTH-08]

must_haves:
  truths:
    - "Full auth flow verified by human: register, login, Google sign-in, session persistence, logout, route protection, deactivation handling"
  artifacts: []
  key_links: []
---

<objective>
Verify the complete auth integration flow end-to-end with the running application.

Purpose: Confirm all 8 AUTH requirements work in the browser before proceeding to downstream phases (Cart, Checkout, etc.) that depend on auth.

Output: Human-verified auth flow confirmation.
</objective>

<execution_context>
@C:/Users/Sushasan/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Sushasan/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/20-auth-integration/20-01-SUMMARY.md
@.planning/phases/20-auth-integration/20-02-SUMMARY.md
</context>

<tasks>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 1: Verify complete auth flow in browser</name>
  <what-built>
Complete NextAuth.js v5 integration with FastAPI backend:
- Email/password registration and login
- Google OAuth sign-in
- Session persistence (encrypted httpOnly cookie with FastAPI token pair)
- Transparent token refresh
- Route protection (proxy.ts redirects to /login)
- Logout functionality
- Header auth state display
- 403 auto-signout for deactivated users
  </what-built>
  <how-to-verify>
**Prerequisites:** Both backend and frontend must be running:
```bash
# Terminal 1: Start backend
cd backend && poetry run task dev

# Terminal 2: Start frontend
cd frontend && npm run dev
```

Ensure `frontend/.env.local` has valid values for:
- `AUTH_SECRET` (run `cd frontend && npx auth secret` to generate)
- `AUTH_GOOGLE_ID` and `AUTH_GOOGLE_SECRET` (from Google Cloud Console — only needed for Google sign-in test)
- `NEXT_PUBLIC_API_URL=http://localhost:8000`

**Test 1 — Registration (AUTH-01):**
1. Visit http://localhost:3000/register
2. Enter a new email and password (min 8 chars)
3. Click "Create account"
4. Expect: Redirect to home page, Header shows user email and Sign Out button

**Test 2 — Logout (AUTH-05):**
1. Click "Sign Out" in the Header
2. Expect: Redirect to home page, Header shows "Sign In" link instead of user info

**Test 3 — Login (AUTH-02):**
1. Visit http://localhost:3000/login
2. Enter the email and password from Test 1
3. Click "Sign in"
4. Expect: Redirect to home page, Header shows user email

**Test 4 — Session Persistence (AUTH-04):**
1. While logged in, press F5 to refresh the page
2. Expect: Still logged in (Header still shows user email)
3. Navigate to a different page and back
4. Expect: Still logged in

**Test 5 — Route Protection (AUTH-06):**
1. Log out first
2. Visit http://localhost:3000/account directly
3. Expect: Redirect to /login?callbackUrl=/account
4. Log in
5. Expect: Redirect back to /account (or home if /account page doesn't exist yet — the redirect attempt is what matters)

**Test 6 — Google OAuth (AUTH-03) [skip if no Google credentials]:**
1. Visit http://localhost:3000/login
2. Click "Continue with Google"
3. Complete Google consent flow
4. Expect: Redirect to home page, Header shows Google account email

**Test 7 — Auth page redirect:**
1. While logged in, visit http://localhost:3000/login
2. Expect: Redirect to home page (authenticated users shouldn't see login page)

**Test 8 — Error handling:**
1. Visit http://localhost:3000/login
2. Enter wrong password for existing account
3. Expect: Error message "Invalid email or password" (no redirect, stays on login page)

**Note:** AUTH-07 (transparent token refresh) and AUTH-08 (deactivated user auto-signout) are difficult to verify manually without special tooling. AUTH-07 works if session persists beyond 15 minutes. AUTH-08 can be verified by deactivating a user via admin API then making any API call.
  </how-to-verify>
  <resume-signal>Type "approved" if auth flow works correctly, or describe any issues found</resume-signal>
</task>

</tasks>

<verification>
All 8 AUTH requirements verified by human testing in browser:
- AUTH-01: Registration works (new user → signed in)
- AUTH-02: Login works (existing user → signed in)
- AUTH-03: Google OAuth works (Google account → signed in)
- AUTH-04: Session persists across refresh and navigation
- AUTH-05: Logout works (signed out → header updated)
- AUTH-06: Protected routes redirect to login with callbackUrl
- AUTH-07: Token refresh is transparent (session survives beyond access token TTL)
- AUTH-08: Deactivated users are signed out on next API call
</verification>

<success_criteria>
- Human confirms all testable auth flows work correctly in the browser
- No JavaScript console errors during auth flows
- Dark mode works on auth pages
- Mobile layout works for login/register forms
</success_criteria>

<output>
After completion, create `.planning/phases/20-auth-integration/20-03-SUMMARY.md`
</output>
