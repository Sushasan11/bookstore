---
phase: 16-sales-analytics
plan: 1
type: execute
wave: 1
depends_on: []
files_modified:
  - app/admin/analytics_repository.py
  - app/admin/analytics_service.py
  - app/admin/analytics_schemas.py
  - app/admin/analytics_router.py
  - app/main.py
autonomous: true
requirements:
  - SALES-01
  - SALES-02

must_haves:
  truths:
    - "Admin can call GET /admin/analytics/sales/summary?period=today and receive total revenue, order count, and AOV for today"
    - "Admin can call GET /admin/analytics/sales/summary?period=week and receive revenue summary with delta_percentage comparing current week to previous week"
    - "Admin can call GET /admin/analytics/sales/summary?period=month and receive revenue summary with delta_percentage comparing current month to previous month"
    - "Zero orders in a period returns {revenue: 0.00, order_count: 0, aov: 0.00, delta_percentage: null}"
    - "Previous period has zero revenue and current has revenue returns delta_percentage: null"
    - "Only CONFIRMED orders are included in all revenue calculations"
    - "Non-admin users receive 403 on the summary endpoint"
  artifacts:
    - path: "app/admin/analytics_repository.py"
      provides: "AnalyticsRepository with revenue_summary() method"
      contains: "class AnalyticsRepository"
    - path: "app/admin/analytics_service.py"
      provides: "AdminAnalyticsService with sales_summary() method, period bounds, delta calculation"
      contains: "class AdminAnalyticsService"
    - path: "app/admin/analytics_schemas.py"
      provides: "SalesSummaryResponse Pydantic schema"
      contains: "class SalesSummaryResponse"
    - path: "app/admin/analytics_router.py"
      provides: "Analytics router with GET /admin/analytics/sales/summary endpoint"
      contains: "router = APIRouter"
  key_links:
    - from: "app/admin/analytics_router.py"
      to: "app/admin/analytics_service.py"
      via: "AdminAnalyticsService instantiation in endpoint"
      pattern: "AdminAnalyticsService"
    - from: "app/admin/analytics_service.py"
      to: "app/admin/analytics_repository.py"
      via: "AnalyticsRepository.revenue_summary() calls"
      pattern: "self\\.repo\\.revenue_summary"
    - from: "app/main.py"
      to: "app/admin/analytics_router.py"
      via: "include_router registration"
      pattern: "include_router.*analytics_router"
---

<objective>
Create the analytics data layer (repository + service), response schemas, and the revenue summary endpoint for Phase 16.

Purpose: Establishes the full analytics stack (repository, service, schemas, router) and delivers the revenue summary with period-over-period comparison — the core "how is the store performing?" capability.

Output: Four new files in `app/admin/` (analytics_repository.py, analytics_service.py, analytics_schemas.py, analytics_router.py) and one modification to `app/main.py`. Admin can call `GET /admin/analytics/sales/summary?period=today|week|month` and receive revenue, order count, AOV, and delta percentage.
</objective>

<execution_context>
@C:/Users/Sushasan/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Sushasan/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/16-sales-analytics/16-RESEARCH.md

<interfaces>
<!-- Key types and contracts the executor needs. Extracted from codebase. -->

From app/core/deps.py:
```python
DbSession = Annotated[AsyncSession, Depends(get_db)]
AdminUser = Annotated[dict, Depends(require_admin)]

def require_admin(current_user: Annotated[dict, Depends(get_active_user)]) -> dict:
    """Require admin role. Raises AppError(403) if role is not admin."""
```

From app/orders/models.py:
```python
class OrderStatus(enum.StrEnum):
    CONFIRMED = "confirmed"
    PAYMENT_FAILED = "payment_failed"

class Order(Base):
    __tablename__ = "orders"
    id: Mapped[int] = mapped_column(primary_key=True)
    user_id: Mapped[int]
    status: Mapped[OrderStatus]
    created_at: Mapped[datetime] = mapped_column(DateTime(timezone=True), server_default=func.now())
    items: Mapped[list[OrderItem]] = relationship(back_populates="order")

class OrderItem(Base):
    __tablename__ = "order_items"
    id: Mapped[int] = mapped_column(primary_key=True)
    order_id: Mapped[int]
    book_id: Mapped[int | None]  # nullable, ondelete="SET NULL"
    quantity: Mapped[int]
    unit_price: Mapped[Decimal] = mapped_column(Numeric(10, 2))
```

From app/admin/router.py (existing pattern):
```python
router = APIRouter(prefix="/admin/users", tags=["admin"])
# Uses _admin: AdminUser per endpoint + _make_service helper
```

From app/main.py (include_router pattern):
```python
from app.admin.router import router as admin_users_router
application.include_router(admin_users_router)
```
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create AnalyticsRepository, AdminAnalyticsService, and SalesSummaryResponse schema</name>
  <files>
    app/admin/analytics_repository.py
    app/admin/analytics_service.py
    app/admin/analytics_schemas.py
  </files>
  <action>
Create three new files in `app/admin/`:

**analytics_repository.py** — `AnalyticsRepository` class:
- Constructor takes `AsyncSession` (same pattern as `OrderRepository` and `UserRepository`).
- `async def revenue_summary(self, *, period_start: datetime, period_end: datetime) -> dict` — returns `{"revenue": Decimal, "order_count": int}`.
- SQL: `select(func.coalesce(func.sum(OrderItem.quantity * OrderItem.unit_price), Decimal("0")).label("revenue"), func.count(Order.id.distinct()).label("order_count")).join(OrderItem, OrderItem.order_id == Order.id).where(Order.status == OrderStatus.CONFIRMED, Order.created_at >= period_start, Order.created_at < period_end)`.
- Execute with `.one()` and return `{"revenue": row.revenue, "order_count": row.order_count}`.
- Import `Order`, `OrderItem`, `OrderStatus` from `app.orders.models`.
- Use `func.coalesce(..., Decimal("0"))` so empty periods return `Decimal("0")` not `None`.

**analytics_service.py** — `AdminAnalyticsService` class + helper functions:
- Module-level `_period_bounds(now: datetime, period: str) -> tuple[datetime, datetime]` — returns (start, end=now) for current partial period:
  - "today": start = today's midnight UTC (replace hour=0, minute=0, second=0, microsecond=0)
  - "week": start = Monday 00:00 UTC of current ISO week (`now - timedelta(days=now.weekday())` then replace time to midnight)
  - "month": start = 1st of current month 00:00 UTC (replace day=1 + time to midnight)
  - Raise `ValueError` for unknown period values.
- Module-level `_prior_period_bounds(now: datetime, period: str) -> tuple[datetime, datetime]` — returns (start, end) for full previous period:
  - "today": (yesterday midnight, today midnight)
  - "week": (previous Monday midnight, this Monday midnight)
  - "month": (1st of previous month midnight, 1st of current month midnight) — compute via `(this_month_start - timedelta(days=1)).replace(day=1, ...)` to handle varying month lengths
- `AdminAnalyticsService.__init__(self, repo: AnalyticsRepository)`.
- `async def sales_summary(self, period: str) -> dict`:
  - `now = datetime.now(timezone.utc)` — NEVER use `datetime.now()` without timezone.
  - Compute bounds via `_period_bounds(now, period)` and `_prior_period_bounds(now, period)`.
  - Call `self.repo.revenue_summary(period_start=..., period_end=...)` twice (current + prior).
  - AOV: `float(round(current_rev / order_count, 2)) if order_count > 0 else 0.0` — per locked decision, return 0.00 (not null) when no orders.
  - Delta: `float(round((current_rev - prior_rev) / prior_rev * 100, 2)) if prior_rev > 0 else None` — per locked decision, null when prior=0.
  - Return `{"period": period, "revenue": float(round(current_rev, 2)), "order_count": order_count, "aov": aov, "delta_percentage": delta_pct}`.
  - All revenue values must be converted via `float(round(val, 2))` before returning to avoid Decimal serialization issues.

**analytics_schemas.py** — Pydantic response schemas:
- `SalesSummaryResponse(BaseModel)` with fields: `period: str`, `revenue: float`, `order_count: int`, `aov: float`, `delta_percentage: float | None`.
- All money fields as `float` (not `Decimal`) — Pydantic v2 serializes Decimal as string by default.
- Import from `pydantic import BaseModel` only.
  </action>
  <verify>
    <automated>python -c "from app.admin.analytics_repository import AnalyticsRepository; from app.admin.analytics_service import AdminAnalyticsService; from app.admin.analytics_schemas import SalesSummaryResponse; print('All imports OK')"</automated>
  </verify>
  <done>
    - AnalyticsRepository exists with revenue_summary() that filters CONFIRMED orders and uses func.coalesce for zero handling
    - AdminAnalyticsService exists with sales_summary() that computes period bounds in UTC and calculates delta_percentage
    - SalesSummaryResponse schema exists with float money fields
    - Period bounds follow locked decisions exactly: today=UTC midnight, week=ISO Monday, month=1st of month
  </done>
</task>

<task type="auto">
  <name>Task 2: Create analytics router with sales summary endpoint and register in main.py</name>
  <files>
    app/admin/analytics_router.py
    app/main.py
  </files>
  <action>
**analytics_router.py** — Analytics API router:
- `router = APIRouter(prefix="/admin/analytics", tags=["admin-analytics"], dependencies=[Depends(require_admin)])` — admin auth at router level, not per-endpoint.
- Import `Depends`, `Query` from `fastapi`.
- Import `AdminUser`, `DbSession` from `app.core.deps`. Also import `require_admin` from `app.core.deps` for the router-level dependency.
- `@router.get("/sales/summary", response_model=SalesSummaryResponse)`:
  - Parameters: `db: DbSession`, `_admin: AdminUser`, `period: str = Query("today", pattern="^(today|week|month)$")`.
  - Body: create `AnalyticsRepository(db)`, create `AdminAnalyticsService(repo)`, call `await svc.sales_summary(period)`, return `SalesSummaryResponse(**data)`.
  - The `pattern` on the Query parameter ensures FastAPI returns 422 for invalid period values automatically — no manual validation needed.
- Note: the `_admin: AdminUser` parameter is kept per-endpoint for documentation even though `dependencies=[Depends(require_admin)]` already protects the router. This follows the existing admin router pattern.

**main.py** — Register the analytics router:
- Add import: `from app.admin.analytics_router import router as analytics_router`
- Add `application.include_router(analytics_router)` after the existing `application.include_router(admin_users_router)` line.
- Keep all existing imports and router registrations untouched.
  </action>
  <verify>
    <automated>python -c "from app.main import app; routes = [r.path for r in app.routes]; assert '/admin/analytics/sales/summary' in routes, f'Route not found in: {routes}'; print('Router registered OK')"</automated>
  </verify>
  <done>
    - GET /admin/analytics/sales/summary endpoint exists and is protected by admin auth
    - period query parameter validates via regex pattern (today|week|month) — invalid values return 422
    - Analytics router registered in main.py app
    - Endpoint wires repository -> service -> schema correctly
  </done>
</task>

</tasks>

<verification>
1. All four new files exist in app/admin/: analytics_repository.py, analytics_service.py, analytics_schemas.py, analytics_router.py
2. `python -c "from app.main import app; print([r.path for r in app.routes])"` includes `/admin/analytics/sales/summary`
3. Import chain works: router -> service -> repository -> models (no circular imports)
4. Revenue query filters `Order.status == OrderStatus.CONFIRMED` (grep for `OrderStatus.CONFIRMED` in analytics_repository.py)
5. All datetime usage is `datetime.now(timezone.utc)` — no naive datetimes (grep for `datetime.now(` must all include `timezone.utc`)
6. All money fields in schema are `float`, not `Decimal`
</verification>

<success_criteria>
- Admin can hit GET /admin/analytics/sales/summary?period=today and receive a JSON response with period, revenue, order_count, aov, and delta_percentage fields
- Invalid period values (e.g., ?period=year) return 422
- The analytics stack (repository/service/schemas/router) is established for Plan 16-02 to extend
</success_criteria>

<output>
After completion, create `.planning/phases/16-sales-analytics/16-01-SUMMARY.md`
</output>
