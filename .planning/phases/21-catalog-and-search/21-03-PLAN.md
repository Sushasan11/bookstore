---
phase: 21-catalog-and-search
plan: "03"
type: execute
wave: 2
depends_on: ["21-01"]
files_modified:
  - frontend/src/app/books/[id]/page.tsx
  - frontend/src/app/books/[id]/_components/BookDetailHero.tsx
  - frontend/src/app/books/[id]/_components/BreadcrumbNav.tsx
  - frontend/src/app/books/[id]/_components/RatingDisplay.tsx
  - frontend/src/app/books/[id]/_components/ActionButtons.tsx
  - frontend/src/app/books/[id]/_components/MoreInGenre.tsx
autonomous: true
requirements:
  - CATL-02
  - CATL-06
  - CATL-07

must_haves:
  truths:
    - "User can view a book detail page at /books/{id} showing all book metadata"
    - "Book detail page shows description, average rating, review count, and stock status"
    - "Book detail page HTML source contains JSON-LD Book schema"
    - "Book detail page HTML source contains Open Graph meta tags"
    - "Book detail page is ISR-cached (revalidate = 3600)"
    - "Breadcrumbs show Home > Genre > Book Title"
    - "More in this genre section shows 4-6 books from the same genre"
    - "Action buttons (Add to Cart, Wishlist) render as disabled placeholders"
  artifacts:
    - path: "frontend/src/app/books/[id]/page.tsx"
      provides: "ISR book detail page with generateMetadata and JSON-LD"
      contains: "revalidate.*3600"
    - path: "frontend/src/app/books/[id]/_components/BookDetailHero.tsx"
      provides: "Two-column cover + details layout"
      min_lines: 40
    - path: "frontend/src/app/books/[id]/_components/BreadcrumbNav.tsx"
      provides: "Home > Genre > Title breadcrumbs"
      contains: "Home"
    - path: "frontend/src/app/books/[id]/_components/RatingDisplay.tsx"
      provides: "Star rating display with review count"
      contains: "avg_rating|review_count"
    - path: "frontend/src/app/books/[id]/_components/ActionButtons.tsx"
      provides: "Disabled Add to Cart and Wishlist buttons"
      contains: "disabled"
    - path: "frontend/src/app/books/[id]/_components/MoreInGenre.tsx"
      provides: "Horizontal row of 4-6 same-genre books"
      contains: "BookCard"
  key_links:
    - from: "frontend/src/app/books/[id]/page.tsx"
      to: "frontend/src/lib/catalog.ts"
      via: "fetchBook, fetchBooks, fetchGenres"
      pattern: "import.*fetchBook.*from.*@/lib/catalog"
    - from: "frontend/src/app/books/[id]/page.tsx"
      to: "SEO metadata"
      via: "generateMetadata and JSON-LD script tag"
      pattern: "generateMetadata|application/ld\\+json"
    - from: "frontend/src/app/books/[id]/_components/MoreInGenre.tsx"
      to: "frontend/src/app/catalog/_components/BookCard.tsx"
      via: "BookCard reuse"
      pattern: "import.*BookCard"
---

<objective>
Build the book detail page at `/books/[id]` with ISR, SEO metadata (JSON-LD Book schema + Open Graph), two-column layout, breadcrumbs, rating display, disabled action button placeholders, and a "More in this genre" section.

Purpose: The book detail page is the primary conversion surface — users decide whether to purchase here. SEO metadata ensures discoverability via search engines. ISR provides fast, cached pages with hourly revalidation. Disabled action buttons establish the layout for later phases to enable.

Output: Complete `/books/[id]` page with ISR, Open Graph metadata, JSON-LD structured data, all sub-components, and related books section.
</objective>

<execution_context>
@C:/Users/Sushasan/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Sushasan/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/21-catalog-and-search/21-RESEARCH.md
@.planning/phases/21-catalog-and-search/21-01-SUMMARY.md

<interfaces>
<!-- Built by Plan 21-01 — executor can use directly -->

From frontend/src/lib/catalog.ts:
```typescript
export type BookResponse = components['schemas']['BookResponse']
export type BookDetailResponse = components['schemas']['BookDetailResponse']
export type GenreResponse = components['schemas']['GenreResponse']

export async function fetchBook(id: number): Promise<BookDetailResponse | null>
export async function fetchBooks(params: { genre_id?: number; size?: number; ... }): Promise<BookListResponse>
export async function fetchGenres(): Promise<GenreResponse[]>
```

BookDetailResponse fields:
```typescript
{
  id: number; title: string; author: string; price: string;
  isbn: string | null; genre_id: number | null; description: string | null;
  cover_image_url: string | null; publish_date: string | null;
  stock_quantity: number; avg_rating?: number | null;
  review_count: number; readonly in_stock: boolean;
}
```

From frontend/src/app/catalog/_components/BookCard.tsx:
```typescript
export function BookCard({ book }: { book: BookResponse })
```
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create book detail page with ISR, generateMetadata, and JSON-LD</name>
  <files>
    frontend/src/app/books/[id]/page.tsx
  </files>
  <action>
Create `frontend/src/app/books/[id]/page.tsx` as a server component:

**ISR Configuration:**
```typescript
export const revalidate = 3600  // Revalidate once per hour
```

**React.cache for request deduplication:**
Use `React.cache()` to wrap the fetch call so `generateMetadata` and the page component share the same request:
```typescript
import { cache } from 'react'
import { fetchBook, fetchBooks, fetchGenres } from '@/lib/catalog'

const getBook = cache(async (id: number) => fetchBook(id))
```

**Page props type (Next.js 16 — params is Promise):**
```typescript
type PageProps = { params: Promise<{ id: string }> }
```

**generateMetadata function:**
```typescript
export async function generateMetadata({ params }: PageProps): Promise<Metadata> {
  const { id } = await params
  const book = await getBook(Number(id))
  if (!book) return { title: 'Book Not Found' }

  return {
    title: `${book.title} by ${book.author}`,
    description: book.description ?? `${book.title} — available at Bookstore`,
    openGraph: {
      title: `${book.title} by ${book.author}`,
      description: book.description ?? `Browse ${book.title} at Bookstore`,
      type: 'book',
      images: book.cover_image_url ? [{ url: book.cover_image_url, alt: book.title }] : [],
    },
  }
}
```

**Page component:**
- `const { id } = await params`
- `const book = await getBook(Number(id))` — if null, call `notFound()` from `next/navigation`
- Fetch genres for breadcrumb: `const genres = await fetchGenres()` — use `{ cache: 'force-cache' }` if calling apiFetch directly. Since we use `fetchGenres()`, the genres list is stable and small.
- Find genre name: `const genre = genres.find(g => g.id === book.genre_id)`
- Fetch related books for "More in Genre": if `book.genre_id`, fetch `fetchBooks({ genre_id: book.genre_id, size: 7 })`. Filter out the current book from results. Slice to max 6.
- Build JSON-LD object (Book schema per schema.org):
  ```typescript
  const jsonLd = {
    '@context': 'https://schema.org',
    '@type': 'Book',
    name: book.title,
    author: { '@type': 'Person', name: book.author },
    isbn: book.isbn ?? undefined,
    description: book.description ?? undefined,
    image: book.cover_image_url ?? undefined,
    offers: {
      '@type': 'Offer',
      price: book.price,
      priceCurrency: 'USD',
      availability: book.in_stock
        ? 'https://schema.org/InStock'
        : 'https://schema.org/OutOfStock',
    },
    ...(book.avg_rating != null ? {
      aggregateRating: {
        '@type': 'AggregateRating',
        ratingValue: book.avg_rating,
        reviewCount: book.review_count,
      },
    } : {}),
  }
  ```
- Render JSON-LD with XSS escaping:
  ```tsx
  <script
    type="application/ld+json"
    dangerouslySetInnerHTML={{
      __html: JSON.stringify(jsonLd).replace(/</g, '\\u003c'),
    }}
  />
  ```
- Render structure:
  1. Container: `<div className="mx-auto max-w-7xl px-4 py-8">`
  2. `<BreadcrumbNav genre={genre} bookTitle={book.title} />`
  3. `<BookDetailHero book={book} />`
  4. `<ActionButtons inStock={book.in_stock} />`
  5. Description section (if exists): `<div className="mt-8">` with heading "Description" and `book.description` in prose.
  6. `<MoreInGenre books={relatedBooks} genreName={genre?.name} />` (only if relatedBooks.length > 0)
  </action>
  <verify>
    <automated>cd frontend && npx tsc --noEmit</automated>
  </verify>
  <done>
    /books/[id] page renders with ISR (revalidate=3600), generates Open Graph metadata via generateMetadata, includes JSON-LD Book schema with XSS escaping, and calls notFound() for invalid IDs. React.cache prevents duplicate fetches between generateMetadata and page.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create BookDetailHero, BreadcrumbNav, RatingDisplay, ActionButtons, and MoreInGenre components</name>
  <files>
    frontend/src/app/books/[id]/_components/BookDetailHero.tsx
    frontend/src/app/books/[id]/_components/BreadcrumbNav.tsx
    frontend/src/app/books/[id]/_components/RatingDisplay.tsx
    frontend/src/app/books/[id]/_components/ActionButtons.tsx
    frontend/src/app/books/[id]/_components/MoreInGenre.tsx
  </files>
  <action>
**BookDetailHero.tsx** — Server component:

Props: `book: BookDetailResponse`

- Two-column layout on desktop (md:flex md:gap-8), stacks vertically on mobile
- Left column (md:w-1/3): Cover image area
  - If `book.cover_image_url`: use `<Image>` from `next/image` with `width={400}`, `height={600}`, `className="rounded-lg object-cover w-full"`, `priority` (LCP image)
  - If null: styled placeholder (same deterministic color scheme as BookCard, but larger). Use `aspect-[2/3]` container with rounded-lg, showing title and author centered.
- Right column (md:w-2/3): Book details
  - Title: `<h1 className="text-3xl font-bold">{book.title}</h1>`
  - Author: `<p className="text-lg text-muted-foreground mt-1">by {book.author}</p>`
  - `<RatingDisplay avgRating={book.avg_rating} reviewCount={book.review_count} />`
  - Price: `<p className="text-2xl font-semibold mt-4">${book.price}</p>`
  - Stock status: Badge showing "In Stock" (green) or "Out of Stock" (red), same as BookCard pattern
  - Metadata grid (mt-6): show ISBN, Genre (genre name if available, or genre_id), Publish Date (formatted as locale date string). Use a definition-list-like layout with `<dl>` or label/value pairs. Only show fields that are non-null.

**BreadcrumbNav.tsx** — Server component:

Props: `genre?: { id: number; name: string } | undefined`, `bookTitle: string`

- Render breadcrumb trail: `Home > {Genre Name} > {Book Title}`
  - "Home" links to `/`
  - Genre name links to `/catalog?genre_id={genre.id}` (takes user to catalog filtered by this genre)
  - Book title is plain text (current page, no link)
- If no genre (genre_id is null), skip the genre crumb: `Home > {Book Title}`
- Use `>` or `/` separator with `text-muted-foreground`
- Breadcrumb text uses `text-sm text-muted-foreground`, links have `hover:text-foreground`

**RatingDisplay.tsx** — Server component:

Props: `avgRating: number | null | undefined`, `reviewCount: number`

- If `avgRating == null` or `reviewCount === 0`: render "No reviews yet" in muted text
- Otherwise: render filled/empty stars (5 total). Use simple star characters or SVG spans:
  - Full stars: `Math.floor(avgRating)` filled stars (text-yellow-500)
  - Half star: if `avgRating % 1 >= 0.5`, add one half-filled star (can use a partially-filled approach or just round)
  - Empty stars: remaining out of 5 (text-muted-foreground)
  - After stars: `{avgRating.toFixed(1)} ({reviewCount} review{reviewCount !== 1 ? 's' : ''})`
- The stars and count are clickable (per CONTEXT.md — "clickable, but full review section is Phase 25"). Wrap in an anchor-like element with a comment `{/* TODO: Phase 25 — link to reviews section */}` and `cursor-pointer` class for now. Do NOT link anywhere yet.

**ActionButtons.tsx** — Server component:

Props: `inStock: boolean`

- Render two buttons side by side (flex gap-4 mt-6):
  1. "Add to Cart" button — `<Button disabled size="lg">` with ShoppingCart icon from lucide-react. If out of stock, change label to "Out of Stock". Use `variant="default"`.
  2. "Add to Wishlist" button — `<Button disabled variant="outline" size="lg">` with Heart icon from lucide-react.
- Both buttons are `disabled` — Phase 22 and 24 will enable them.
- Add a small `text-xs text-muted-foreground` note: "Coming soon" below the buttons (or inside the disabled state styling).

**MoreInGenre.tsx** — Server component:

Props: `books: BookResponse[]`, `genreName?: string`

- If `books.length === 0`, render nothing (return null)
- Heading: `<h2 className="text-2xl font-semibold mt-12 mb-6">More in {genreName ?? 'this Genre'}</h2>`
- Horizontal scroll container OR grid: Use a grid `grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4` to show up to 6 related books.
- Render each book using `<BookCard book={book} />` imported from `@/app/catalog/_components/BookCard`

Verify: `cd frontend && npm run build` — this catches all SSR/ISR issues, Suspense problems, and type errors.
  </action>
  <verify>
    <automated>cd frontend && npm run build 2>&1 | tail -20</automated>
  </verify>
  <done>
    BookDetailHero shows cover-left, details-right layout that stacks on mobile. BreadcrumbNav renders Home > Genre > Title with correct links. RatingDisplay shows aggregate stars and review count. ActionButtons shows disabled Add to Cart and Wishlist. MoreInGenre shows related books. Production build succeeds.
  </done>
</task>

</tasks>

<verification>
1. `cd frontend && npm run build` succeeds
2. Navigating to `/books/1` shows the book detail page with all metadata
3. View page source at `/books/1` contains `<script type="application/ld+json">` with Book schema
4. View page source at `/books/1` contains Open Graph meta tags (og:title, og:description, og:type=book)
5. Breadcrumbs show "Home > Genre > Book Title" with correct links
6. Rating display shows stars and review count (or "No reviews yet")
7. "Add to Cart" and "Wishlist" buttons are visible but disabled
8. "More in this genre" section shows related books from the same genre
9. Navigating to `/books/99999` shows the 404 page
</verification>

<success_criteria>
- Book detail page loads with ISR (revalidate=3600)
- JSON-LD Book schema is present in page source with correct fields
- Open Graph meta tags are generated for social sharing
- Cover-left details-right layout on desktop, stacked on mobile
- All sub-components render correctly
- Production build succeeds
</success_criteria>

<output>
After completion, create `.planning/phases/21-catalog-and-search/21-03-SUMMARY.md`
</output>
