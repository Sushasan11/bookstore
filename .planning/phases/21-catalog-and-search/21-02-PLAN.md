---
phase: 21-catalog-and-search
plan: "02"
type: execute
wave: 2
depends_on: ["21-01"]
files_modified:
  - frontend/src/app/catalog/page.tsx
  - frontend/src/app/catalog/loading.tsx
  - frontend/src/app/catalog/_components/SearchControls.tsx
  - frontend/src/app/catalog/_components/BookGrid.tsx
  - frontend/src/app/catalog/_components/Pagination.tsx
  - frontend/src/app/catalog/_components/NoResults.tsx
  - frontend/src/components/layout/Header.tsx
  - frontend/src/components/layout/MobileNav.tsx
autonomous: true
requirements:
  - CATL-01
  - CATL-03
  - CATL-04
  - CATL-05
  - CATL-07

must_haves:
  truths:
    - "User can browse a paginated grid of books at /catalog"
    - "User can search by typing in the search bar and see results update after 300ms debounce"
    - "User can filter by genre using a dropdown"
    - "User can filter by price range using preset range buttons"
    - "User can sort by relevance, price asc/desc, newest, or highest rated (sort=avg_rating)"
    - "URL query params reflect all search/filter/sort/page state and reproduce results when shared"
    - "Empty results show a friendly no-results message with suggestions and a grid of ~4 popular books below"
    - "Catalog page is server-rendered (no 'use client' on page.tsx)"
  artifacts:
    - path: "frontend/src/app/catalog/page.tsx"
      provides: "Server-rendered catalog page reading searchParams"
      contains: "await searchParams"
    - path: "frontend/src/app/catalog/_components/SearchControls.tsx"
      provides: "Client component with search input, genre dropdown, price filter, sort dropdown"
      contains: "use client"
    - path: "frontend/src/app/catalog/_components/BookGrid.tsx"
      provides: "Server component rendering grid of BookCard, fetches popular books on empty results"
      contains: "BookCard|fetchBooks|NoResults"
    - path: "frontend/src/app/catalog/_components/Pagination.tsx"
      provides: "Client component with numbered page links"
      contains: "use client"
    - path: "frontend/src/app/catalog/_components/NoResults.tsx"
      provides: "Empty state with helpful suggestions and popular books grid"
      contains: "Popular Books|popularBooks"
      min_lines: 20
    - path: "frontend/src/app/catalog/loading.tsx"
      provides: "Auto Suspense fallback for route navigation"
      contains: "BookGridSkeleton"
  key_links:
    - from: "frontend/src/app/catalog/page.tsx"
      to: "frontend/src/lib/catalog.ts"
      via: "fetchBooks and fetchGenres calls"
      pattern: "import.*fetchBooks.*fetchGenres.*from.*@/lib/catalog"
    - from: "frontend/src/app/catalog/_components/SearchControls.tsx"
      to: "next/navigation"
      via: "useSearchParams + useRouter for URL state"
      pattern: "useSearchParams|useRouter"
    - from: "frontend/src/app/catalog/_components/SearchControls.tsx"
      to: "use-debounce"
      via: "useDebouncedCallback for search input"
      pattern: "useDebouncedCallback"
    - from: "frontend/src/app/catalog/_components/BookGrid.tsx"
      to: "frontend/src/lib/catalog.ts"
      via: "fetchBooks import for popular books on empty results"
      pattern: "import.*fetchBooks.*from.*@/lib/catalog"
---

<objective>
Build the catalog browsing page at `/catalog` with server-rendered book grid, client-side search/filter/sort controls, URL-persisted state, pagination, and loading states.

Purpose: This is the primary discovery surface for the bookstore. Users can browse, search, and filter the catalog with all state bookmarkable and shareable via URL params. The catalog page is server-rendered for SEO with client-only interactivity in the SearchControls and Pagination components.

Output: Fully functional `/catalog` page with debounced search, genre and price filters, sort options, numbered pagination, skeleton loading, and no-results state.
</objective>

<execution_context>
@C:/Users/Sushasan/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Sushasan/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/21-catalog-and-search/21-RESEARCH.md
@.planning/phases/21-catalog-and-search/21-01-SUMMARY.md

<interfaces>
<!-- Built by Plan 21-01 — executor can use directly -->

From frontend/src/lib/catalog.ts:
```typescript
export type BookResponse = components['schemas']['BookResponse']
export type BookListResponse = components['schemas']['BookListResponse']
export type GenreResponse = components['schemas']['GenreResponse']

export async function fetchBooks(params: {
  q?: string; genre_id?: number; min_price?: number; max_price?: number;
  sort?: string; sort_dir?: 'asc' | 'desc'; page?: number; size?: number;
}): Promise<BookListResponse>

export async function fetchGenres(): Promise<GenreResponse[]>
```

From frontend/src/app/catalog/_components/BookCard.tsx:
```typescript
// Server component — renders book card with cover, title, author, price, stock badge
export function BookCard({ book }: { book: BookResponse })
```

From frontend/src/app/catalog/_components/BookCardSkeleton.tsx:
```typescript
export function BookCardSkeleton()
export function BookGridSkeleton()
```

From frontend/src/components/layout/Header.tsx:
```typescript
// Server component — has nav link to "/books" that should be updated to "/catalog"
<Link href="/books" ...>Books</Link>
```
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create SearchControls, Pagination, NoResults, and BookGrid components</name>
  <files>
    frontend/src/app/catalog/_components/SearchControls.tsx
    frontend/src/app/catalog/_components/Pagination.tsx
    frontend/src/app/catalog/_components/NoResults.tsx
    frontend/src/app/catalog/_components/BookGrid.tsx
  </files>
  <action>
**SearchControls.tsx** — `'use client'` component:

Props: `genres: GenreResponse[]` (passed from server page), no `initialValues` needed since component reads from URL params directly.

- Import `useSearchParams`, `useRouter`, `usePathname` from `next/navigation`
- Import `useDebouncedCallback` from `use-debounce`
- Import shadcn `Input`, `Select` (install via `npx shadcn@latest add select input --yes` if not already installed), `Button`
- Layout: horizontal flex bar with wrap on mobile. Contains:
  1. **Search input**: `<Input>` with `placeholder="Search by title, author, or genre..."`, `defaultValue={searchParams.get('q') ?? ''}`, `onChange` triggers debounced URL update (300ms). Use `useDebouncedCallback`.
  2. **Genre filter**: shadcn `<Select>` dropdown. Options: "All Genres" (value=""), plus each genre from props. `onValueChange` updates URL param `genre_id`, resets page to 1.
  3. **Price range filter**: Use preset range buttons (not slider — simpler UX per discretion). Options: "Any Price", "$0-$10", "$10-$25", "$25-$50", "$50+". Each button sets `min_price` and `max_price` URL params. Active range highlighted with different variant. Implement as a group of small Button components with `variant={isActive ? "default" : "outline"}`.
  4. **Sort dropdown**: shadcn `<Select>`. Options map to backend sort+sort_dir combinations (per locked CONTEXT.md decision — Relevance, Price low-to-high, Price high-to-low, Newest, Highest rated):
     - "Relevance" → remove sort and sort_dir params (backend defaults)
     - "Price: Low to High" → sort=price, sort_dir=asc
     - "Price: High to Low" → sort=price, sort_dir=desc
     - "Newest" → sort=created_at (backend defaults to desc for created_at)
     - "Highest Rated" → sort=avg_rating, sort_dir=desc

- URL update pattern: `const params = new URLSearchParams(searchParams.toString())`, set/delete params, `replace(\`${pathname}?${params.toString()}\`)`.
- Always reset `page` to `1` when any filter/search/sort changes.
- CRITICAL: This component uses `useSearchParams()` — the parent page MUST wrap it in `<Suspense>`.

**Pagination.tsx** — `'use client'` component:

Props: `total: number`, `page: number`, `size: number`

- Calculate `totalPages = Math.ceil(total / size)`
- If totalPages <= 1, render nothing
- Render: Previous button (disabled on page 1), page number buttons (show at most 7 pages: first, last, current +/- 2, with ellipsis), Next button (disabled on last page)
- Each page button updates the `page` URL param using `useSearchParams` + `useRouter().replace()`
- Current page has `variant="default"`, others `variant="outline"`
- Use `useSearchParams()` to read current params and preserve them when changing page
- CRITICAL: This component uses `useSearchParams()` — parent MUST wrap in `<Suspense>`.

**NoResults.tsx** — server component:

Props: `query?: string`, `popularBooks?: BookResponse[]`

- Render a centered container with:
  - "No books found" heading (or "No books found for '{query}'" when query is provided)
  - Suggestions list: "Check your spelling", "Try a broader search term", "Browse by genre using the filter above"
  - Use text-muted-foreground for secondary text
  - **Popular books section:** If `popularBooks` is provided and has items, render a "Popular Books" heading (`text-lg font-semibold mt-8 mb-4`) followed by a small grid of BookCard components: `grid grid-cols-2 md:grid-cols-4 gap-6`. This fulfills the locked CONTEXT.md decision: "No-results state: friendly message with suggestions and popular books below."

**BookGrid.tsx** — server component:

Props: `books: BookResponse[]`, `query?: string`

- If `books.length === 0`:
  - Fetch popular books: `const popular = await fetchBooks({ sort: 'avg_rating', sort_dir: 'desc', size: 4 })`
  - Render `<NoResults query={query} popularBooks={popular.items} />`
- Otherwise, render a grid: `grid grid-cols-2 md:grid-cols-4 gap-6`
- Map over books rendering `<BookCard book={book} key={book.id} />`
- Import `fetchBooks` from `@/lib/catalog` (already available from Plan 21-01)
  </action>
  <verify>
    <automated>cd frontend && npx tsc --noEmit</automated>
  </verify>
  <done>
    SearchControls renders search input with 300ms debounce, genre dropdown, price range presets, and sort dropdown. All filter changes update URL params and reset page to 1. Pagination renders numbered pages with previous/next. BookGrid renders card grid or NoResults with popular books (fetched via fetchBooks sort=avg_rating). TypeScript compiles.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create catalog page, loading state, and update Header nav link</name>
  <files>
    frontend/src/app/catalog/page.tsx
    frontend/src/app/catalog/loading.tsx
    frontend/src/components/layout/Header.tsx
    frontend/src/components/layout/MobileNav.tsx
  </files>
  <action>
**catalog/page.tsx** — Server component (NO `'use client'`):

```typescript
import { Suspense } from 'react'
import type { Metadata } from 'next'
import { fetchBooks, fetchGenres } from '@/lib/catalog'
import { SearchControls } from './_components/SearchControls'
import { BookGrid } from './_components/BookGrid'
import { BookGridSkeleton } from './_components/BookCardSkeleton'
import { Pagination } from './_components/Pagination'

export const metadata: Metadata = {
  title: 'Browse Books',
  description: 'Browse, search, and filter our book catalog',
}

type CatalogPageProps = {
  searchParams: Promise<{
    q?: string
    genre_id?: string
    min_price?: string
    max_price?: string
    sort?: string
    sort_dir?: string
    page?: string
  }>
}
```

- CRITICAL: `searchParams` is a `Promise` in Next.js 16 — must `await searchParams` at the top of the component.
- Parse params: `q`, `genre_id` (parse to number if present), `min_price`/`max_price` (parse to number), `sort`, `sort_dir`, `page` (default 1).
- Fetch books and genres in parallel using `Promise.all([fetchBooks({...}), fetchGenres()])`.
- Render structure:
  1. Container: `<div className="mx-auto max-w-7xl px-4 py-8">`
  2. Page heading: `<h1 className="text-3xl font-bold mb-6">Browse Books</h1>`
  3. SearchControls wrapped in `<Suspense fallback={null}>`: pass `genres` as prop.
  4. BookGrid: pass `books={booksData.items}` and optionally `query={q}` for NoResults display.
  5. Pagination wrapped in `<Suspense fallback={null}>`: pass `total={booksData.total}`, `page`, `size={20}`.

- Note: The Suspense boundaries around SearchControls and Pagination are REQUIRED because they use `useSearchParams()`. The build will fail without them (per project Pitfall from Phase 20-02 experience).

**catalog/loading.tsx** — Auto Suspense fallback:
```typescript
import { BookGridSkeleton } from './_components/BookCardSkeleton'

export default function CatalogLoading() {
  return (
    <div className="mx-auto max-w-7xl px-4 py-8">
      <div className="h-9 w-48 bg-muted rounded mb-6" /> {/* Title skeleton */}
      <div className="h-10 w-full bg-muted rounded mb-6" /> {/* Search bar skeleton */}
      <BookGridSkeleton />
    </div>
  )
}
```

**Update Header.tsx** — Change the nav link from `/books` to `/catalog`:
- Update `<Link href="/books">Books</Link>` to `<Link href="/catalog">Browse</Link>` (or keep as "Books" if preferred — the important change is the href to `/catalog`)

**Update MobileNav.tsx** — Same change: update the `/books` nav link to `/catalog` if MobileNav has one. Read the file first to check.

**Verify build:**
```bash
cd frontend && npm run build
```
This catches Suspense boundary issues, `useSearchParams` problems, and any other build-time errors that dev mode misses.
  </action>
  <verify>
    <automated>cd frontend && npm run build 2>&1 | tail -20</automated>
  </verify>
  <done>
    /catalog page server-renders with all search params. SearchControls and Pagination wrapped in Suspense. Header links to /catalog. `npm run build` succeeds without errors. URL like /catalog?q=fantasy&genre_id=1&sort=price&sort_dir=desc&page=2 loads correctly with all filters applied.
  </done>
</task>

</tasks>

<verification>
1. `cd frontend && npm run build` succeeds with zero errors
2. Navigating to `/catalog` shows the book grid with search bar, filters, and pagination
3. Typing in the search bar debounces for 300ms then updates URL with `?q=` param
4. Selecting a genre updates URL with `?genre_id=N` and resets page to 1
5. Clicking a price range preset updates URL with `?min_price=N&max_price=N`
6. Changing sort updates URL with `?sort=X&sort_dir=Y`
7. Clicking page numbers updates `?page=N` and preserves all other params
8. Copying the URL and opening in a new tab reproduces the exact same results
9. Empty results show the NoResults component with helpful suggestions and a grid of ~4 popular books below
</verification>

<success_criteria>
- User can browse paginated books at /catalog with 4 columns on desktop, 2 on mobile
- Debounced search, genre filter, price range filter, and sort all update URL params
- Sharing a URL reproduces the exact search state
- Catalog page is server-rendered (searchParams read server-side, no 'use client' on page.tsx)
- Production build succeeds
</success_criteria>

<output>
After completion, create `.planning/phases/21-catalog-and-search/21-02-SUMMARY.md`
</output>
