---
phase: 09-email-infrastructure
plan: 01
subsystem: infra
tags: [fastapi-mail, jinja2, smtp, email, backgroundtasks, pydantic-settings]

# Dependency graph
requires:
  - phase: 01-infrastructure
    provides: Settings/get_settings pattern from app/core/config.py
  - phase: 02-core-auth
    provides: BackgroundTasks usage pattern established in routers
provides:
  - EmailService class with enqueue(), _send(), _strip_html(), _render_plain_text()
  - get_email_service() cached factory function
  - EmailSvc Annotated type alias for FastAPI Depends injection
  - get_email_config() ConnectionConfig builder from Settings
  - app/email/templates/base.html shared Jinja2 base layout
  - MAIL_* settings fields in Settings with safe defaults
affects:
  - 09-email-infrastructure (plan 02+)
  - 12-email-notifications (uses EmailSvc for order/restock emails)

# Tech tracking
tech-stack:
  added:
    - fastapi-mail 1.6.2 (SMTP email sending with Jinja2 templates)
    - aiosmtplib 5.1.0 (async SMTP transport, transitive)
    - blinker 1.9.0 (signal support for fastapi-mail, enables record_messages() in tests)
    - regex 2025.11.3 (transitive dependency)
  patterns:
    - EmailService injected via EmailSvc = Annotated[EmailService, Depends(get_email_service)]
    - enqueue() adds to BackgroundTasks (post-commit safe by structural guarantee)
    - plain-text fallback auto-generated by stripping HTML — no separate .txt templates
    - MAIL_SUPPRESS_SEND=1 default ensures no emails sent in dev/test without explicit config

key-files:
  created:
    - app/email/__init__.py
    - app/email/service.py
    - app/email/templates/base.html
  modified:
    - app/core/config.py (added MAIL_* settings fields)
    - pyproject.toml (added fastapi-mail dependency)
    - poetry.lock (updated)

key-decisions:
  - "MAIL_SUPPRESS_SEND defaults to 1 (suppressed) — safe for dev/test; production sets to 0 via env var"
  - "plain-text fallback auto-generated via _strip_html() on rendered HTML — no separate .txt template files"
  - "get_email_service() decorated with @lru_cache — FastMail instance reused across requests; tests call cache_clear() to reset"
  - "BackgroundTasks structural guarantee: enqueue() never blocks response and email never sent before DB commit (post-commit safety)"

patterns-established:
  - "EmailService injection: use EmailSvc = Annotated[EmailService, Depends(get_email_service)] in router function signatures"
  - "Template rendering: templates live in app/email/templates/, extend base.html via Jinja2 block inheritance"
  - "Error handling: _send() catches all exceptions, logs error, and drops (no re-raise) to protect background task runner"

requirements-completed: [EMAL-01, EMAL-04, EMAL-05, EMAL-06]

# Metrics
duration: 5min
completed: 2026-02-26
---

# Phase 9 Plan 01: Email Infrastructure Summary

**fastapi-mail 1.6.2 EmailService with BackgroundTasks enqueueing, Jinja2 HTML templates, and plain-text auto-generation via HTML stripping**

## Performance

- **Duration:** 5 min
- **Started:** 2026-02-26T05:12:23Z
- **Completed:** 2026-02-26T05:17:01Z
- **Tasks:** 2
- **Files modified:** 6

## Accomplishments
- EmailService class wired to fastapi-mail FastMail with ConnectionConfig from Settings
- enqueue() adds email send to BackgroundTasks post-commit safe (structural guarantee via get_db pattern)
- plain-text fallback auto-generated by _render_plain_text() -> _strip_html() — no separate .txt templates
- base.html Jinja2 template with table-based layout, title/content/footer blocks for inheritance
- MAIL_* settings with safe defaults (SUPPRESS_SEND=1) added to Settings class

## Task Commits

Each task was committed atomically:

1. **Task 1: Install fastapi-mail and add MAIL_* settings to config** - `e6f5723` (feat)
2. **Task 2: Create EmailService class and base.html template** - `5cfdf37` (feat)

**Plan metadata:** _(to be added after STATE.md update commit)_

## Files Created/Modified
- `app/email/__init__.py` - Package init (empty)
- `app/email/service.py` - EmailService class, get_email_config, get_email_service, EmailSvc
- `app/email/templates/base.html` - Shared base layout with header, content block, footer
- `app/core/config.py` - Added MAIL_USERNAME, MAIL_PASSWORD, MAIL_FROM, MAIL_PORT, MAIL_SERVER, MAIL_FROM_NAME, MAIL_SUPPRESS_SEND fields
- `pyproject.toml` - Added fastapi-mail>=1.6,<2 dependency
- `poetry.lock` - Updated with fastapi-mail 1.6.2, aiosmtplib 5.1.0, blinker 1.9.0, regex 2025.11.3

## Decisions Made
- MAIL_SUPPRESS_SEND defaults to 1 so dev/test never accidentally sends real emails
- plain-text fallback via _strip_html() on rendered HTML output avoids duplicate template maintenance
- @lru_cache on get_email_service() reuses FastMail instance; tests call .cache_clear() to reset
- BackgroundTasks post-commit structural guarantee: because get_db commits before response, BackgroundTasks (which run after response) always fire after commit

## Deviations from Plan

None - plan executed exactly as written.

## Issues Encountered
- Test database (port 5433) not running in this environment — pytest test_health.py fails with ConnectionRefusedError. This is a pre-existing infrastructure issue unrelated to email changes.

## User Setup Required
None - no external service configuration required. Production deployment needs MAIL_* environment variables set in .env file:
- MAIL_USERNAME, MAIL_PASSWORD (SMTP credentials)
- MAIL_FROM (sender address)
- MAIL_SERVER, MAIL_PORT (SMTP server)
- MAIL_SUPPRESS_SEND=0 (to enable actual sending)

## Next Phase Readiness
- EmailService ready for injection into any router via EmailSvc type alias
- base.html template ready for extension by concrete email templates (Phase 12)
- Plan 02 of Phase 09 can proceed (integration tests for EmailService)

## Self-Check: PASSED

- app/email/__init__.py: FOUND
- app/email/service.py: FOUND
- app/email/templates/base.html: FOUND
- .planning/phases/09-email-infrastructure/09-01-SUMMARY.md: FOUND
- Commit e6f5723 (Task 1): FOUND
- Commit 5cfdf37 (Task 2): FOUND

---
*Phase: 09-email-infrastructure*
*Completed: 2026-02-26*
